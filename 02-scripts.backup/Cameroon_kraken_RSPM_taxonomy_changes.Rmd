---
title: "Cameroon plaque taxonomy analysis - Kraken RefSeq database w/ & w/o Pasolli MAGs"
author: "Irina Velsko"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output:
    github_document:
        fig_width: 8
        fig_height: 6
        toc: true
---

```{r load_libraries, echo = F, message = F}
library(knitr)
library(data.table)
library(janitor)
library(taxize)
library(myTAI)
library(plyr)
library(tidyverse)
library(gplots)
library(ggrepel)
library(viridis)
library(cowplot)
opts_chunk$set(echo=F, warning=F, message=F, dpi=150)
```

```{r setup}
knitr::opts_knit$set(root.dir = normalizePath(".."))
```



```{r taxon_differences}

db_phylum_compare <- rso_reports %>%
  filter(str_detect(SampleID, "CMC")) %>%
  filter(str_detect(Rank, "P")) %>%
  group_by(SampleID, SciName) %>%
  summarize(Rooted_avg = mean(Number_rooted)) %>%
  mutate(Database = "RefSeqOnly") %>%
  select(SciName, SampleID, Database, Rooted_avg) %>%
  bind_rows(., rsmp_reports %>%
              filter(str_detect(SampleID, "CMC")) %>%
              filter(str_detect(Rank, "P")) %>%
              group_by(SampleID, SciName) %>%
              summarize(Rooted_avg = mean(Number_rooted)) %>%
              mutate(Database = "RefSeqPasolliMAGs") %>%
              select(SciName, SampleID, Database, Rooted_avg)) %>%
  group_by(Database, SciName) %>%
  summarize(Total_rooted = sum(Rooted_avg)) %>%
  spread(Database, Total_rooted) %>%
  select(SciName, RefSeqOnly, RefSeqPasolliMAGs) %>%
  mutate(Read_difference = RefSeqPasolliMAGs - RefSeqOnly, 
         Fold_difference = log2(RefSeqPasolliMAGs/RefSeqOnly)) %>%
  arrange(desc(Fold_difference))

db_genus_compare <- rso_reports %>%
  filter(str_detect(SampleID, "CMC")) %>%
  filter(str_detect(Rank, "G")) %>%
  group_by(SampleID, SciName) %>%
  summarize(Rooted_avg = mean(Number_rooted)) %>%
  mutate(Database = "RefSeqOnly") %>%
  select(SciName, SampleID, Database, Rooted_avg) %>%
  bind_rows(., rsmp_reports %>%
              filter(str_detect(SampleID, "CMC")) %>%
              filter(str_detect(Rank, "G")) %>%
              group_by(SampleID, SciName) %>%
              summarize(Rooted_avg = mean(Number_rooted)) %>%
              mutate(Database = "RefSeqPasolliMAGs") %>%
              select(SciName, SampleID, Database, Rooted_avg)) %>%
  group_by(Database, SciName) %>%
  summarize(Total_rooted = sum(Rooted_avg)) %>%
  spread(Database, Total_rooted) %>%
  select(SciName, RefSeqOnly, RefSeqPasolliMAGs) %>%
  mutate(Read_difference = RefSeqPasolliMAGs - RefSeqOnly, 
         Fold_difference = log2(RefSeqPasolliMAGs/RefSeqOnly)) %>%
  arrange(desc(Fold_difference))

db_species_compare <- rso_reports %>%
  filter(str_detect(SampleID, "CMC")) %>%
  filter(str_detect(Rank, "S")) %>%
  group_by(SampleID, SciName) %>%
  summarize(Rooted_avg = mean(Number_rooted)) %>%
  mutate(Database = "RefSeqOnly") %>%
  select(SciName, SampleID, Database, Rooted_avg) %>%
  bind_rows(., rsmp_reports %>%
              filter(str_detect(SampleID, "CMC")) %>%
              filter(str_detect(Rank, "S")) %>%
              group_by(SampleID, SciName) %>%
              summarize(Rooted_avg = mean(Number_rooted)) %>%
              mutate(Database = "RefSeqPasolliMAGs") %>%
              select(SciName, SampleID, Database, Rooted_avg)) %>%
  group_by(Database, SciName) %>%
  summarize(Total_rooted = sum(Rooted_avg)) %>%
  spread(Database, Total_rooted) %>%
  select(SciName, RefSeqOnly, RefSeqPasolliMAGs) %>%
  mutate(Read_difference = RefSeqPasolliMAGs - RefSeqOnly, 
         Fold_difference = log2(RefSeqPasolliMAGs/RefSeqOnly)) %>%
  arrange(desc(Fold_difference))


```


```{r}
db_species_compare_short <- db_species_compare %>%
  filter(RefSeqOnly >=100, RefSeqPasolliMAGs >= 100, Read_difference >=100 | Read_difference <= -100)

db_genus_compare_short <- db_genus_compare %>%
  filter(RefSeqOnly >=100, RefSeqPasolliMAGs >= 100, Read_difference >=100 | Read_difference <= -100)

db_phylum_compare_short <- db_phylum_compare %>%
  filter(RefSeqOnly >=100, RefSeqPasolliMAGs >= 100, Read_difference >=100 | Read_difference <= -100)

db_species_compare_phage <- db_species_compare %>%
  filter(str_detect(SciName, "phage")) %>%
  filter(!str_detect(SciName, "Bacteria"))

```


```{r mag_info}
# this is where the Pasolli MAG info is: 
# /projects1/microbiome_calculus/Cameroon_plaque/00-documentation.backup/Pasolli2019_SGBinfo.csv
# maybe parse this?


mag_info <- fread("00-documentation.backup/Pasolli2019_SGBinfo.csv")
mag_info <- as_tibble(mag_info)
mag_info %>% filter(str_detect(closestTaxLevel, "Corynebacterium")) %>% select(-estTaxonomy) %>% arrange(closestTaxLevel) %>% print(., n = 59)

# total counts at each level
mag_info %>%
  group_by(estTaxLevel) %>%
  count()

# counts of each entry at the specified levels
mag_info %>%
  filter(estTaxLevel == "Other") %>%
  select(closestTaxLevel) %>%
  mutate(phylum = sapply(closestTaxLevel, function(f) {
                                  unlist(str_split(f, "\\|"))[2]
                           })) %>%
  filter(!str_detect(phylum, "c__|o__|f__|g__|s__")) %>%
  count(phylum) %>%
  arrange(desc(n)) 
# %>%
#   summarize(total = sum(n))

mag_info %>%
  filter(estTaxLevel == "Family") %>%
  select(closestTaxLevel) %>%
  mutate(family = sapply(closestTaxLevel, function(f) {
                                  unlist(str_split(f, "\\|"))[5]
                           })) %>%
  filter(!str_detect(family, "p__|c__|o__|g__|s__")) %>%
  count(family) %>%
  arrange(desc(n)) 
# %>%
#   summarize(total = sum(n))

mag_info %>%
  filter(estTaxLevel == "Genus") %>%
  select(closestTaxLevel) %>%
  mutate(genus = sapply(closestTaxLevel, function(f) {
                                  unlist(str_split(f, "\\|"))[6]
                           })) %>%
  filter(!str_detect(genus, "p__|c__|o__|f__|s__")) %>%
  count(genus) %>%
  arrange(desc(n)) 
# %>%
#   summarize(total = sum(n))

mag_info %>%
  filter(estTaxLevel == "Species") %>%
  select(closestTaxLevel) %>%
  mutate(species = sapply(closestTaxLevel, function(f) {
                                  unlist(str_split(f, "\\|"))[7]
                           })) %>%
  filter(!str_detect(species, "p__|c__|o__|f__|g__")) %>%
  count(species) %>%
  arrange(desc(n)) 
# %>%
#   summarize(total = sum(n))


```

```{r, eval = F}
table_temp <- fread("./04-analysis/kraken/output/RefSeqPasolliMAGs/SRR514329_S0_L001_R1_000.fastq.combined.fq.prefixed.extractunmapped.bam.fastq.gz.output.1.kraken")

table_temp1 <- table_temp %>%
  filter(V3 == 0, V1 != "U")
```







