---
title: "Cameroon hunter-gatherer calculus/plaque MALT"
author: "Irina Velsko"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output:
    github_document:
        fig_width: 8
        fig_height: 6
        toc: true
---

```{r load_libraries, echo = F, message = F}
library(knitr)
library(decontam)
library(data.table)
library(psych)
library(vegan)
library(ape)
library(mixOmics)
library(compositions)
library(vegan)
library(janitor)
library(pander)
library(tidyverse)
library(gplots)
library(ggrepel)
library(viridis)
library(cowplot)
opts_chunk$set(echo=F, warning=F, message=F, dpi=150)
```

Set the working directory of the notebook to the parent directory of the 
notebook itself.  

```{r setup}
knitr::opts_knit$set(root.dir = normalizePath(".."))
```

```{r colors_shapes}
# lacroix_palette("PeachPear", n = 8, type = "continuous")
# "#FF3200" "#EF8158" "#E9BD8E" "#CBDDA7" "#38BCAD" "#0B91B5" "#065FA3" "#172869"

Village_colors <- c(`202` = "#FF3200", `205` = "#EF8158", `204` = "#E9BD8E", `203` = "#CBDDA7", `206` = "#38BCAD",
                    Yanomami = "#C70E7B", HMP = "#172869", HMP10M = "#065FA3", JAE10M = "#ffeda0", JAE = "#feb24c",
                     ExtractionGauze = "#252525", ExtractionBlank = "#737373", LibraryBlank = "#bdbdbd")
Village_shapes <- c(`202` = 15, `203` = 16, `205` = 17,`204` = 18, `206` = 25, Yanomami = 14, HMP = 7, HMP10M = 9, JAE = 7, JAE10M = 9,
                    ExtractionGauze = 8, ExtractionBlank = 4, LibraryBlank = 3)

Ethnic_Group_colors <- c(Baka = "#FF3200", Nzime = "#172869", Yanomami = "#C70E7B", HMP = "#969696", HMP10M = "#d9d9d9", 
                         JAE10M = "#ffeda0", JAE = "#feb24c",ExtractionGauze = "#252525", ExtractionBlank = "#737373", LibraryBlank = "#bdbdbd")
Ethnic_Group_shapes <- c(Baka = 19, Nzime = 17,  Yanomami = 14, HMP = 7, HMP10M = 9, JAE = 7, JAE10M = 9,
                         ExtractionGauze = 8, ExtractionBlank = 4, LibraryBlank = 3)

Env_colors <- c(HunterGatherer = "#FF3200", HMP = "#172869", HMP10M = "#065FA3", JAE10M = "#ffeda0", JAE = "#feb24c",
                ExtractionGauze = "#252525", ExtractionBlank = "#737373", LibraryBlank = "#bdbdbd")
Env_shapes <- c(HunterGatherer = 19, HMP = 7, HMP10M = 9, JAE = 7, JAE10M = 9, ExtractionGauze = 8, ExtractionBlank = 4, LibraryBlank = 3)

Description_colors <- c(HunterGatherer = "#FF3200", Yanomami = "#C70E7B", HMP_supPlaque = "#172869", HMP_subPlaque = "#172869", 
                        HMP10M_supPlaque = "#065FA3", HMP10M_subPlaque = "#065FA3", JAE10M = "#ffeda0", JAE = "#feb24c",
                        ExtractionGauze = "#252525", ExtractionBlank = "#737373", LibraryBlank = "#bdbdbd")
Description_shapes <- c(HunterGatherer = 19, Yanomami = 14, HMP_supPlaque = 7, HMP_subPlaque = 7, HMP10M_supPlaque = 9, 
                        HMP10M_subPlaque = 9, JAE = 7, JAE10M = 9, ExtractionGauze = 8, ExtractionBlank = 4, LibraryBlank = 3)

Market_economy_colors <- c(logging_road = "#FF3200", forrest_camp = "#172869", farming = "#82CDAA", Yanomami = "#C70E7B", Industrial = "#969696",
                           ExtractionGauze = "#252525", ExtractionBlank = "#737373", LibraryBlank = "#bdbdbd")
Market_economy_shapes <- c(logging_road = 19, forrest_camp = 17, farming = 18, Yanomami = 14, HMP = 7, HMP10M = 9, Industrial = 15,
                           ExtractionGauze = 8, ExtractionBlank = 4, LibraryBlank = 3)

Age_group_colors <- c(`18-29` = "#FF3200", `30-39` = "#E9B186", `40-49` = "#82CDAA", `50-59` = "#0686B8", `60+` = "#172869",
                      `10-18` = "#C70E7B", HMP = "#969696", HMP10M = "#d9d9d9",
                      ExtractionGauze = "#252525", ExtractionBlank = "#737373", LibraryBlank = "#bdbdbd")
Age_group_shapes <- c(`18-29` = 15, `30-39` = 16, `40-49` = 17, `50-59` = 18, `60+` = 25, `10-18` = 14, HMP = 7, HMP10M = 9,
                      ExtractionGauze = 8, ExtractionBlank = 4, LibraryBlank = 3)

Sex_colors <- c(Female = "#FF3200", Male = "#172869", HMP = "#969696", HMP10M = "#d9d9d9",
                ExtractionGauze = "#252525", ExtractionBlank = "#737373", LibraryBlank = "#bdbdbd")
Sex_shapes <- c(Female = 19, Male = 17,  HMP = 7, HMP10M = 9,ExtractionGauze = 8, ExtractionBlank = 4, LibraryBlank = 3)

Tooth_site_colors <- c(Anterior = "#FF3200", Posterior = "#172869", Buccal_mucosa = "#C70E7B", HMP = "#969696", HMP10M = "#d9d9d9",
                       ExtractionGauze = "#252525", ExtractionBlank = "#737373", LibraryBlank = "#bdbdbd")
Tooth_site_shapes <- c(Anterior = 19, Posterior = 17,  Buccal_mucosa = 14, HMP = 7, HMP10M = 9,
                       ExtractionGauze = 8, ExtractionBlank = 4, LibraryBlank = 3)

Database_colors <- c(nt = "#172869", RefSeqCustom = "#FF3200")

```

```{r load_data}
malt_species <- fread("./05-results.backup/CMC_HMP_JAE_Yano_MALT_RSC_species_bacteria_archaea.txt")
malt_genus <- fread("./05-results.backup/CMC_HMP_JAE_Yano_MALT_RSC_genus_bacteria_archaea.txt")

# clean the file names
malt_species <- rename(malt_species, Species = `#Datasets`)
colnames(malt_species) <- gsub(".SG1.1_S0_L001_R1_001.fastq.combined.fq.prefixed.extractunmapped.bam","", colnames(malt_species))
colnames(malt_species) <- gsub("_S0_L001_R1_000.fastq.combined.fq.prefixed.extractunmapped.bam","", colnames(malt_species))
colnames(malt_species) <- gsub("_S0_L001_R1_001.fastq.combined.fq.prefixed.extractunmapped.bam.10M","_10M", colnames(malt_species))
colnames(malt_species) <- gsub("_S0_L001_R1_000.10M.fastq.combined.fq.prefixed.extractunmapped.bam","_10M", colnames(malt_species))
colnames(malt_species) <- gsub("_S0_L001_R1_001.fastq.combined.fq.prefixed.extractunmapped.bam","", colnames(malt_species))
colnames(malt_species) <- gsub(".fastq.truncated","", colnames(malt_species))


# remove human and unassigned reads
malt_species <- malt_species %>% filter(!str_detect(Species, "Homo sapiens"))
malt_species <- malt_species %>% filter(!str_detect(Species, "Not assigned"))
# get rid of the extra column
malt_species <- malt_species %>% select(-Comparison_CMC_HMP_JAE_MALT_RSC)

malt_genus <- rename(malt_genus, Species = `#Datasets`)
colnames(malt_genus) <- gsub(".SG1.1_S0_L001_R1_001.fastq.combined.fq.prefixed.extractunmapped.bam","", colnames(malt_genus))
colnames(malt_genus) <- gsub("_S0_L001_R1_000.fastq.combined.fq.prefixed.extractunmapped.bam","", colnames(malt_genus))
colnames(malt_genus) <- gsub("_S0_L001_R1_000.10M.fastq.combined.fq.prefixed.extractunmapped.bam","_10M", colnames(malt_genus))
colnames(malt_genus) <- gsub("_S0_L001_R1_001.fastq.combined.fq.prefixed.extractunmapped.bam.10M","_10M", colnames(malt_genus))
colnames(malt_genus) <- gsub("_S0_L001_R1_001.fastq.combined.fq.prefixed.extractunmapped.bam","", colnames(malt_genus))
colnames(malt_genus) <- gsub(".fastq.truncated","", colnames(malt_genus))

# remove human and unassigned reads
malt_genus <- malt_genus %>% filter(!str_detect(Species, "Homo sapiens"))
malt_genus <- malt_genus %>% filter(!str_detect(Species, "Not assigned"))
# get rid of the extra column at the begining
malt_genus <- malt_genus %>% select(-Comparison_CMC_HMP_JAE_MALT_RSC)


# load the metadata file
metadata <- fread("00-documentation.backup/01-cameroon_hunter_gatherer_metadata.tsv")
metadata <- metadata %>%
  rename(SampleID = `#SampleID`)  %>%
  as_tibble() %>%
  mutate(Description = fct_relevel(Description, "HunterGatherer", "Yanomami", "HMP_supPlaque", "HMP_subPlaque",
                                   "HMP10M_supPlaque", "HMP10M_subPlaque","JAE","JAE10M",
                                   "ExtractionGauze","ExtractionBlank","LibraryBlank"),
         Ethnic_Group = fct_relevel(Ethnic_Group, "Baka","Nzime","Yanomami","HMP","HMP10M","JAE","JAE10M",
                                     "ExtractionGauze","ExtractionBlank","LibraryBlank"),
         Env = fct_relevel(Env, "HunterGatherer","HMP","HMP10M","JAE","JAE10M",
                                     "ExtractionGauze","ExtractionBlank","LibraryBlank"),
         Market_economy = fct_relevel(Market_economy, "logging_road","forrest_camp","farming","Yanomami",
                                      "Industrial","ExtractionGauze","ExtractionBlank","LibraryBlank"),
         Age_group = fct_relevel(Age_group, "10-18","18-29","30-39","40-49","50-59","60+","HMP","HMP10M"),
         Sex = fct_relevel(Sex, "Male","Female","HMP","HMP10M"),
         Tooth_site = fct_relevel(Tooth_site, "Anterior","Posterior","Buccal_mucosa","HMP","HMP10M"),
         Type = fct_relevel(Type, "Calculus","Plaque","Blank"),
         Village = fct_relevel(Village, "202","205","204","203","206","Yanomami","HMP","HMP10M","JAE","JAE10M",
                               "ExtractionGauze","ExtractionBlank","LibraryBlank"))

```

```{r to_remove}

outliers <- c("CMC002.B0201","CMC032.B0101","CMC037.B0201","CMC047.A0201",
              "EXB059.A1901","EXB059.A1301","EXB059.A1101","EXB059.A0901",
              "SRR1646041","SRR1646032","SRR1646042","SRR1646045","SRR1646030","SRR1646047")

outliersCMC <- c("CMC002.B0201","CMC032.B0101","CMC037.B0201","CMC047.A0201")

# these were created from running decontam in the Cameroon_h-g_taxonomy.Rmd file
contaminants_species <- fread("05-results.backup/malt_contaminants_species.tsv", sep = "\t")
contaminants_genus <- fread("05-results.backup/malt_contaminants_genus.tsv")

```

```{r decontaminate}
malt_species.decontam <- malt_species %>%
  anti_join(., contaminants_species)

malt_genus.decontam <- malt_genus %>%
  anti_join(., contaminants_genus)

```


```{r pca_plotting_functions}
# plotting PCA with colored dots
plot_pca <- function(df, pc1, pc2, metadata_group) {
    metadata_group_colors <- get(paste(metadata_group, "_colors", sep = ""))
    metadata_group_shapes <- get(paste(metadata_group, "_shapes", sep = ""))

    exp_var <- paste0(round(df$explained_variance * 100, 2), "%")
    df_X <- df$variates$X %>%
              as.data.frame() %>%
              rownames_to_column("SampleID") %>%
              inner_join(metadata %>%
                           select(SampleID, Env, Description, Ethnic_Group, Age_group, Sex, Market_economy, Village, Tooth_site, Type), by = "SampleID")
    
    metadata_group = df_X[[metadata_group]]
    
                       if (pc1 == 'PC1') {
                           pc1 <- df_X$PC1
                           exp_var_pc1 <- exp_var[1]
                           xaxis <- c("PC1")
                       }  else if (pc1 == 'PC2') {
                           pc1 <- df_X$PC2
                           exp_var_pc1 <- exp_var[2]
                           xaxis <- c("PC2")
                       } else if (pc1 == 'PC3') {
                           pc1 <- df_X$PC3
                           exp_var_pc1 <- exp_var[3]
                           xaxis <- c("PC3")
                       }

                       if (pc2 == 'PC1') {
                           pc2 <- df_X$PC1
                           exp_var_pc2 <- exp_var[1]
                           yaxis <- c("PC1")
                       }  else if (pc2 == 'PC2') {
                           pc2 <- df_X$PC2
                           exp_var_pc2 <- exp_var[2]
                           yaxis <- c("PC2")
                       } else if (pc2 == 'PC3') {
                           pc2 <- df_X$PC3
                           exp_var_pc2 <- exp_var[3]
                           yaxis <- c("PC3")
                       }

    pca_plot <- ggplot(df_X, aes(pc1, pc2, colour = metadata_group, shape = metadata_group)) +
                        geom_point(size = 4) +
                        scale_colour_manual(values = metadata_group_colors) +
                        scale_shape_manual(values = metadata_group_shapes) +
                        # stat_ellipse() +
                        xlab(paste(xaxis, " - ", exp_var_pc1)) +
                        ylab(paste(yaxis, " - ", exp_var_pc2)) +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

    return(pca_plot)
}

# this function plots the PCA with the sample names instead of points
plot_pca_names <- function(df, pc1, pc2, metadata_group) {
    metadata_group_colors <- get(paste(metadata_group, "_colors", sep = ""))

    exp_var <- paste0(round(df$explained_variance * 100, 2), "%")
    df_X <- df$variates$X %>%
              as.data.frame() %>%
              rownames_to_column("SampleID") %>%
              inner_join(metadata %>%
                           select(SampleID, Env, Description, Ethnic_Group, Age_group, Sex, Market_economy, Village, Tooth_site, Type), by = "SampleID")
    
    metadata_group = df_X[[metadata_group]]
    
                       if (pc1 == 'PC1') {
                           pc1 <- df_X$PC1
                           exp_var_pc1 <- exp_var[1]
                           xaxis <- c("PC1")
                       }  else if (pc1 == 'PC2') {
                           pc1 <- df_X$PC2
                           exp_var_pc1 <- exp_var[2]
                           xaxis <- c("PC2")
                       } else if (pc1 == 'PC3') {
                           pc1 <- df_X$PC3
                           exp_var_pc1 <- exp_var[3]
                           xaxis <- c("PC3")
                       }

                       if (pc2 == 'PC1') {
                           pc2 <- df_X$PC1
                           exp_var_pc2 <- exp_var[1]
                           yaxis <- c("PC1")
                       }  else if (pc2 == 'PC2') {
                           pc2 <- df_X$PC2
                           exp_var_pc2 <- exp_var[2]
                           yaxis <- c("PC2")
                       } else if (pc2 == 'PC3') {
                           pc2 <- df_X$PC3
                           exp_var_pc2 <- exp_var[3]
                           yaxis <- c("PC3")
                       }

    pca_plot_names <- ggplot(df_X, aes(pc1, pc2, colour = metadata_group)) +
                        geom_text(aes(label = df_X$SampleID), size = 2) +
                        scale_colour_manual(values = metadata_group_colors) +
                        # stat_ellipse() +
                        xlab(paste(xaxis, " - ", exp_var_pc1)) +
                        ylab(paste(yaxis, " - ", exp_var_pc2)) +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

    return(pca_plot_names)
}


# plot PCA with colored dots and the title including the # of species or genera
plot_pca_titles <- function(df, pc1, pc2, color_group, shape_group, ncomps, title_text) {
    metadata_group_colors <- get(paste(color_group, "_colors", sep = ""))
    metadata_group_shapes <- get(paste(shape_group, "_shapes", sep = ""))

    pca.list <- mixOmics::pca(df, ncomp = ncomps, logratio = 'CLR')

    exp_var <- paste0(round(pca.list$explained_variance * 100, 2), "%")
    df_X <- pca.list$variates$X %>%
              as.data.frame() %>%
              rownames_to_column("SampleID") %>%
              inner_join(metadata %>%
                           select(SampleID, Env, Description, Ethnic_Group, Age_group, Sex, Market_economy, Village, Tooth_site, Type), by = "SampleID")
    
    color_group = df_X[[color_group]]
    shape_group = df_X[[shape_group]]
   
                       if (pc1 == 'PC1') {
                           pc1 <- df_X$PC1
                           exp_var_pc1 <- exp_var[1]
                           xaxis <- c("PC1")
                       }  else if (pc1 == 'PC2') {
                           pc1 <- df_X$PC2
                           exp_var_pc1 <- exp_var[2]
                           xaxis <- c("PC2")
                       } else if (pc1 == 'PC3') {
                           pc1 <- df_X$PC3
                           exp_var_pc1 <- exp_var[3]
                           xaxis <- c("PC3")
                       }

                       if (pc2 == 'PC1') {
                           pc2 <- df_X$PC1
                           exp_var_pc2 <- exp_var[1]
                           yaxis <- c("PC1")
                       }  else if (pc2 == 'PC2') {
                           pc2 <- df_X$PC2
                           exp_var_pc2 <- exp_var[2]
                           yaxis <- c("PC2")
                       } else if (pc2 == 'PC3') {
                           pc2 <- df_X$PC3
                           exp_var_pc2 <- exp_var[3]
                           yaxis <- c("PC3")
                       }


    pca_plot <- ggplot(df_X, aes(pc1, pc2, colour = color_group, shape = shape_group)) +
                        geom_point(size = 4) +
                        scale_colour_manual(values = metadata_group_colors) +
                        scale_shape_manual(values = metadata_group_shapes) +
                        # stat_ellipse() +
                        xlab(paste(xaxis, " - ", exp_var_pc1)) +
                        ylab(paste(yaxis, " - ", exp_var_pc2)) +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        ggtitle(title_text)

    return(pca_plot)
}

```

```{r graphing_functions}

# plotting box and whisker
plot_box_whisker <- function(df, hasmtdta = c("TRUE","FALSE"), stat_info, metadata_group, fill_group, title_text) {
    fill_group_colors <- get(paste(fill_group, "_colors", sep = ""))

    if (hasmtdta == T) { 
      df_X <- df
      fill_group = df_X[[fill_group]]
    } else {
      df_X <- df %>%
              inner_join(metadata %>%
                           select(SampleID, Env, Description, Ethnic_Group, Age_group,
                                  Sex, Market_economy, Village, Tooth_site, Type), by = "SampleID")
      fill_group = df_X[[metadata_group]]
    }
   
    stat_info_table = df_X[[stat_info]]
    metadata_group = df_X[[metadata_group]]

    bx_wh_plot <- ggplot(df_X, aes(x = metadata_group, y = stat_info_table, fill = fill_group)) +
                         geom_boxplot() +
                         scale_fill_manual(values = fill_group_colors) +
                         theme_minimal() +
                         #scale_y_continuous(trans='log10') +
                         #scale_y_continuous(trans='pseudo_log') +
                         theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
                         ylab(stat_info) +
                         ggtitle(title_text)

    return(bx_wh_plot)
}

```

Let's also check the metadata categories - are there clear differences between groups for any of them?
```{r metadata_barplots}
# plot percent of X in the population 

village_age <- metadata %>%
  filter(str_detect(SampleID, "CMC")) %>%
  filter(str_detect(Tooth_site, "Posterior")) %>%
  group_by(Village, Age_group) %>%
  count()

village_sex <- metadata %>%
  filter(str_detect(SampleID, "CMC")) %>%
  filter(str_detect(Tooth_site, "Posterior")) %>%
  group_by(Village, Sex) %>%
  count()

village_tooth <- metadata %>%
  filter(str_detect(SampleID, "CMC")) %>%
  # filter(str_detect(Tooth_site, "Posterior")) %>%
  group_by(Village, Tooth_site) %>%
  count()

ethnicGroup_market <- metadata %>%
  filter(str_detect(SampleID, "CMC")) %>%
  # filter(str_detect(Tooth_site, "Posterior")) %>%
  group_by(Ethnic_Group, Market_economy) %>%
  count()

village_age %>%
  ggplot(., aes(x = Village, y = n, fill = Age_group)) +
         geom_bar(stat = "identity", position = "dodge") +
         scale_fill_manual(values = Age_group_colors) +
         theme_minimal() +
         theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
         ylab("Count") #+
         # ggtitle(title_text)

village_age %>%
  ggplot(., aes(x = Age_group, y = n, fill = Village)) +
         geom_bar(stat = "identity", position = "dodge") +
         scale_fill_manual(values = Village_colors) +
         theme_minimal() +
         theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
         ylab("Count") #+
         # ggtitle(title_text)

village_sex %>%
    ggplot(., aes(x = Village, y = n, fill = Sex)) +
         geom_bar(stat = "identity", position = "dodge") +
         scale_fill_manual(values = Sex_colors) +
         theme_minimal() +
         theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
         ylab("Count") #+
         # ggtitle(title_text)

village_tooth %>%
    ggplot(., aes(x = Village, y = n, fill = Tooth_site)) +
         geom_bar(stat = "identity", position = "dodge") +
         scale_fill_manual(values = Tooth_site_colors) +
         theme_minimal() +
         theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
         ylab("Count") #+
         # ggtitle(title_text)

ethnicGroup_market %>%
    ggplot(., aes(x = Ethnic_Group, y = n, fill = Market_economy)) +
         geom_bar(stat = "identity", position = "dodge") +
         scale_fill_manual(values = Market_economy_colors) +
         theme_minimal() +
         theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
         ylab("Count") #+
         # ggtitle(title_text)

```
Age groups are different between the villages (and therefore ethnic group and
the market economy). Villages 202 and 205, are Baka villages along the logging
road,  204 is a Baka village in a forrest camp, while 203 and 206 are Nzime
villages that practice farming. There is an imbalance in the nubmer of
individuals from the 18-29 and 60+ age ranges, with no individuals age 18-29 in
villages 203 or 206, and no individuals age 60+ in villages 202 or 205. Does
this difference in age affect the results we see? The oral microbiome (plaque
community) does change with age. The change is likely related to changes in
immune responses and immune status during ageing. To see whether the composition
of the age groups is substantially different, let's plot PCAs of the composition
at the species level where we leave out one age group each time. Does the
plot/clustering change substantially when leaving out the different age groups?
(Do I need to do this with only one tooth site per individual? Because the bar
plots above are only the posterior tooth samples, and the only separation
visible in the PCA is by tooth site. This is also the only metadata category
with significantly differnt plotting according to PERMANOVA with vegan::adonis.
See Cameroon_h-g_plaque_assignment.Rmd)


```{r separate_groups_list}

age_18 <- metadata %>%
  filter(Age_group == "18-29") %>%
  select(SampleID) %>%
  pull()

age_30 <- metadata %>%
  filter(Age_group == "30-39") %>%
  select(SampleID) %>%
  pull()

age_40 <- metadata %>%
  filter(Age_group == "40-49") %>%
  select(SampleID) %>%
  pull()

age_50 <- metadata %>%
  filter(Age_group == "50-59") %>%
  select(SampleID) %>%
  pull()

age_60 <- metadata %>%
  filter(Age_group == "60+") %>%
  select(SampleID) %>%
  pull()

posterior <- metadata %>%
  filter(Tooth_site == "Posterior") %>%
  select(SampleID) %>%
  pull()

anterior <- metadata %>%
  filter(Tooth_site == "Anterior") %>%
  select(SampleID) %>%
  pull()

```



```{r jackknife_pca_all_toothsites}
# All ages
malt_species.decontam_filtered <- malt_species.decontam %>%
                                         select(matches("CMC|Species")) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
                                         select(-one_of(outliersCMC)) %>%
                                         mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
                                         filter(Percent > 0.005) %>%
                                         select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts)

rownames(malt_species.decontam_filtered) <- malt_species.decontam_filtered$SampleID

malt_species.decontam_filtered <- malt_species.decontam_filtered %>% select(-SampleID)

malt_species.decontam_filtered = malt_species.decontam_filtered+1

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_economy", 3, "All age groups, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_economy", 3, "All age groups, PC3-PC2")

# no 18-29
malt_species.decontam_filtered <- malt_species.decontam %>%
                                         select(matches("CMC|Species")) %>%
                                         select(-one_of(age_18)) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
                                         select(-one_of(outliersCMC)) %>%
                                         mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
                                         filter(Percent > 0.005) %>%
                                         select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts)

rownames(malt_species.decontam_filtered) <- malt_species.decontam_filtered$SampleID

malt_species.decontam_filtered <- malt_species.decontam_filtered %>% select(-SampleID)

malt_species.decontam_filtered = malt_species.decontam_filtered+1

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_economy", 3, "no 18-29, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_economy", 3, "no 18-29, PC3-PC2")

# no 30-39
malt_species.decontam_filtered <- malt_species.decontam %>%
                                         select(matches("CMC|Species")) %>%
                                         select(-one_of(age_30)) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
                                         select(-one_of(outliersCMC)) %>%
                                         mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
                                         filter(Percent > 0.005) %>%
                                         select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts)

rownames(malt_species.decontam_filtered) <- malt_species.decontam_filtered$SampleID

malt_species.decontam_filtered <- malt_species.decontam_filtered %>% select(-SampleID)

malt_species.decontam_filtered = malt_species.decontam_filtered+1

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_economy", 3, "no 30-39, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_economy", 3, "no 30-39, PC3-PC2")

# no 40-49
malt_species.decontam_filtered <- malt_species.decontam %>%
                                         select(matches("CMC|Species")) %>%
                                         select(-one_of(age_40)) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
                                         select(-one_of(outliersCMC)) %>%
                                         mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
                                         filter(Percent > 0.005) %>%
                                         select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts)

rownames(malt_species.decontam_filtered) <- malt_species.decontam_filtered$SampleID

malt_species.decontam_filtered <- malt_species.decontam_filtered %>% select(-SampleID)

malt_species.decontam_filtered = malt_species.decontam_filtered+1

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_economy", 3, "no 40-49, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_economy", 3, "no 40-49, PC3-PC2")

# no 50-59
malt_species.decontam_filtered <- malt_species.decontam %>%
                                         select(matches("CMC|Species")) %>%
                                         select(-one_of(age_50)) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
                                         select(-one_of(outliersCMC)) %>%
                                         mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
                                         filter(Percent > 0.005) %>%
                                         select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts)

rownames(malt_species.decontam_filtered) <- malt_species.decontam_filtered$SampleID

malt_species.decontam_filtered <- malt_species.decontam_filtered %>% select(-SampleID)

malt_species.decontam_filtered = malt_species.decontam_filtered+1

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_economy", 3, "no 50-59, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_economy", 3, "no 50-59, PC3-PC2")

# no 60+
malt_species.decontam_filtered <- malt_species.decontam %>%
                                         select(matches("CMC|Species")) %>%
                                         select(-one_of(age_60)) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
                                         select(-one_of(outliersCMC)) %>%
                                         mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
                                         filter(Percent > 0.005) %>%
                                         select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts)

rownames(malt_species.decontam_filtered) <- malt_species.decontam_filtered$SampleID

malt_species.decontam_filtered <- malt_species.decontam_filtered %>% select(-SampleID)

malt_species.decontam_filtered = malt_species.decontam_filtered+1

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_economy", 3, "no 60+, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_economy", 3, "no 60+, PC3-PC2")


```
Each PCA plot with one of the age groups removed looks much like the full plot
with all age groups. The samples largely stay in a similar plotting pattern,
with separation between the anterior and posterior samples. Age does not appear
to affect the compositional profile of the samples. So no need to run linear
modelling? There are very few samples (relatively speaking),so having more might
change this.

```{r jackknife_pca_posterior_toothsites}

# All ages
malt_species.decontam_filtered <- malt_species.decontam %>%
                                         select(matches("CMC|Species")) %>%
                                         select(-one_of(anterior)) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
                                         select(-one_of(outliersCMC)) %>%
                                         mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
                                         filter(Percent > 0.005) %>%
                                         select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts)

rownames(malt_species.decontam_filtered) <- malt_species.decontam_filtered$SampleID

malt_species.decontam_filtered <- malt_species.decontam_filtered %>% select(-SampleID)

malt_species.decontam_filtered = malt_species.decontam_filtered+1

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_economy", 3, "Posterior tooth site, all age groups, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_economy", 3, "Posterior tooth site, all age groups, PC3-PC2")

# no 18-29
malt_species.decontam_filtered <- malt_species.decontam %>%
                                         select(matches("CMC|Species")) %>%
                                         select(-one_of(anterior)) %>%
                                         select(-one_of(age_18)) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
                                         select(-one_of(outliersCMC)) %>%
                                         mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
                                         filter(Percent > 0.005) %>%
                                         select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts)

rownames(malt_species.decontam_filtered) <- malt_species.decontam_filtered$SampleID

malt_species.decontam_filtered <- malt_species.decontam_filtered %>% select(-SampleID)

malt_species.decontam_filtered = malt_species.decontam_filtered+1

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_economy", 3, "Posterior tooth site, no 18-29, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_economy", 3, "Posterior tooth site, no 18-29, PC3-PC2")

# no 30-39
malt_species.decontam_filtered <- malt_species.decontam %>%
                                         select(matches("CMC|Species")) %>%
                                         select(-one_of(anterior)) %>%
                                         select(-one_of(age_30)) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
                                         select(-one_of(outliersCMC)) %>%
                                         mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
                                         filter(Percent > 0.005) %>%
                                         select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts)

rownames(malt_species.decontam_filtered) <- malt_species.decontam_filtered$SampleID

malt_species.decontam_filtered <- malt_species.decontam_filtered %>% select(-SampleID)

malt_species.decontam_filtered = malt_species.decontam_filtered+1

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_economy", 3, "Posterior tooth site, no 30-39, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_economy", 3, "Posterior tooth site, no 30-39, PC3-PC2")

# no 40-49
malt_species.decontam_filtered <- malt_species.decontam %>%
                                         select(matches("CMC|Species")) %>%
                                         select(-one_of(anterior)) %>%
                                         select(-one_of(age_40)) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
                                         select(-one_of(outliersCMC)) %>%
                                         mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
                                         filter(Percent > 0.005) %>%
                                         select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts)

rownames(malt_species.decontam_filtered) <- malt_species.decontam_filtered$SampleID

malt_species.decontam_filtered <- malt_species.decontam_filtered %>% select(-SampleID)

malt_species.decontam_filtered = malt_species.decontam_filtered+1

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_economy", 3, "Posterior tooth site, no 40-49, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_economy", 3, "Posterior tooth site, no 40-49, PC3-PC2")

# no 50-59
malt_species.decontam_filtered <- malt_species.decontam %>%
                                         select(matches("CMC|Species")) %>%
                                         select(-one_of(anterior)) %>%
                                         select(-one_of(age_50)) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
                                         select(-one_of(outliersCMC)) %>%
                                         mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
                                         filter(Percent > 0.005) %>%
                                         select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts)

rownames(malt_species.decontam_filtered) <- malt_species.decontam_filtered$SampleID

malt_species.decontam_filtered <- malt_species.decontam_filtered %>% select(-SampleID)

malt_species.decontam_filtered = malt_species.decontam_filtered+1

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_economy", 3, "Posterior tooth site, no 50-59, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_economy", 3, "Posterior tooth site, no 50-59, PC3-PC2")

# no 60+
malt_species.decontam_filtered <- malt_species.decontam %>%
                                         select(matches("CMC|Species")) %>%
                                         select(-one_of(anterior)) %>%
                                         select(-one_of(age_60)) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
                                         select(-one_of(outliersCMC)) %>%
                                         mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
                                         filter(Percent > 0.005) %>%
                                         select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts)

rownames(malt_species.decontam_filtered) <- malt_species.decontam_filtered$SampleID

malt_species.decontam_filtered <- malt_species.decontam_filtered %>% select(-SampleID)

malt_species.decontam_filtered = malt_species.decontam_filtered+1

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_economy", 3, "Posterior tooth site, no 60+, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_economy", 3, "Posterior tooth site, no 60+, PC3-PC2")


```
Using only the posterior tooth sites gives a similar pattern, where removing
each age group doesn't really change the plotting/clustering in a noteicable way. So no
need to run linear modelling? There are very few samples (relatively
speaking),so having more might change this.






















