---
title: "Cameroon hunter-gatherer calculus/plaque HUMAnN2 heatmaps"
author: "Irina Velsko"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output:
    github_document:
        fig_width: 8
        fig_height: 6
        toc: true
---

```{r load_libraries, echo = F, message = F}
library(knitr)
library(data.table)
library(vegan)
library(mixOmics)
library(compositions)
library(janitor)
library(tidyverse)
library(gplots)
library(viridis)
library(cowplot)
opts_chunk$set(echo=F, warning=F, message=F, dpi=150)
```

Set the working directory of the notebook to the parent directory of the 
notebook itself.  

```{r setup}
knitr::opts_knit$set(root.dir = normalizePath(".."))
```

```{r load_data}
load("./05-results.backup/CMC_humann2_tables.RData")
load("./05-results.backup/CMC_metadata.RData")

# remove unmapped and ungrouped reads
humann2_KOs <- humann2_KOs_full %>% filter(Ortholog != "UNMAPPED") %>% filter(!str_detect(Ortholog, "UNGROUPED"))

# the list of MR1, MR2, MR3 orthologs
humann2_KO_noblanks.fa_KO <- fread("./05-results.backup/minres_oblimin_noblanks.fa_KO.tsv")

humann2_KO_cmc.fa_KO <- fread("./05-results.backup/minres_oblimin_cmc.fa_KO.tsv")

# read in the ortholog factors for KEGG Orthologs
minres_oblimin_nobl_fa_species <- fread("./05-results.backup/minres_oblimin_noblanks.fa_KO.tsv", sep = "\t")
minres_oblimin_cmc_fa_species <- fread("./05-results.backup/minres_oblimin_cmc.fa_KO.tsv", sep = "\t")

# read in metadata again to get it without all the factors
metadata_hm <- fread("00-documentation.backup/01-cameroon_hunter_gatherer_metadata.tsv")


```

Order the metadata for plotting
```{r metadata_heatmaps}
# order the samples so they can be ordered this way in the heat maps
# order the CMC samples by Village
cmc_order <- metadata_hm %>%
  rename(SampleID = `#SampleID`)  %>%
  as_tibble() %>%
  filter(str_detect(SampleID, "CMC")) %>%
  mutate(Village = fct_relevel(Village, "202","205","204","203","206")) %>%
  select(SampleID, Village) %>%
  arrange(Village) %>%
  pull(SampleID)

# order the HMP samples by subplaque, supraplaque
hmp_order <- metadata_hm %>%
  rename(SampleID = `#SampleID`)  %>%
  as_tibble() %>%
  filter(str_detect(SampleID, "SRR")) %>%
  filter(!str_detect(SampleID, "10M|SRR164")) %>%
  mutate(Description = fct_relevel(Description, "HMP_subPlaque","HMP_supPlaque")) %>%
  select(SampleID, Description) %>%
  arrange(Description) %>%
  pull(SampleID)

# keep JAE samples in alphabetical order
jae_order <- metadata_hm %>%
  rename(SampleID = `#SampleID`)  %>%
  as_tibble() %>%
  filter(str_detect(SampleID, "JAE|VLC")) %>%
  filter(!str_detect(SampleID, "10M")) %>%
  pull(SampleID)

# combine all 3 ordered vectors into a final ordered vector
each_order <- c(cmc_order, jae_order, hmp_order)

```

To change the heatmap label colors by different metadata categories swap out the
sections below
```{r heatmap_label_colors, eval = F}

Village_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Village = c("202","205","204","203","206","Yanomami","Industrial plaque","HMP10M","JAE10M","Industrial calculus","ExtractionGauze","ExtractionBlank","LibraryBlank")) %>%
               filter(!str_detect(Village, "Yanomami|10M|Gauze|Blank")), by = "Village"

Sex_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Sex = c("Female","Male","Unknown","ExtractionGauze","ExtractionBlank","LibraryBlank")) %>%
               filter(!str_detect(Sex, "Gauze|Blank")), by = "Sex"


Age_group_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Age_group = c("18-29","30-39","40-49","50-59","60+","10-18","HMP","HMP10M","ExtractionGauze","ExtractionBlank","LibraryBlank")) %>%
               filter(!str_detect(Age_group, "10|10M|Gauze|Blank")), by = "Age_group"


```

# Industrial and non-industrial Cameroon samples

## MetaCyc Pathways
We'll use the pathways present in at least 33% of the groups
```{r heatmap_pathways}
# MetaCyc pathways, no blanks
# potential contaminant pathways removed and only pathways present in at least 33% of one ethnic group
h2_path_test <- humann2_path.decontam %>%
  filter(!str_detect(Pathway, "\\|")) %>%
  select(-matches("EXB|LIB|SRR164|10M|ERR|SRS")) %>%
  # convert to binary present absent 1/0
  mutate_if(is.numeric, ~1 * (. > 0)) %>%
  gather("SampleID","CPM",2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Ethnic_Group), by = "SampleID") %>%
  group_by(Ethnic_Group, Pathway) %>%
  summarize(Percent_presence = sum(CPM)/length(SampleID)*100) %>%
  # select the SEED proteins that are present in at least 30% of at least one group
  ungroup() %>%
  filter(Percent_presence <= 90) %>%
  filter(Percent_presence >= 10) %>%
  distinct(Pathway) %>%
  select(Pathway)

humann2_paths.decontam_noblanks_33 <- humann2_path.decontam %>%
  select(-matches("EXB|LIB|SRR164|10M|ERR|SRS")) %>%
  inner_join(., h2_path_test, by = "Pathway") %>%
  gather("SampleID","CPM", 2:ncol(.)) %>%
  mutate(CPM = CPM + 1) %>%
  spread(Pathway, CPM) %>%
  column_to_rownames("SampleID")
  

# CLR-transform the matrix for plotting the heatmap
humann2_paths.decontam_noblanks_33_clr <- clr(humann2_paths.decontam_noblanks_33)
humann2_paths.decontam_noblanks_33_clr <- as.matrix(humann2_paths.decontam_noblanks_33_clr)

# orient the matrix with correct rows/columns to run the distance calculation for the seed protein, not the samples (columns are SampleID, rows are proteins)
humann2_paths.decontam_noblanks_33_clr_sp <- humann2_paths.decontam_noblanks_33_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Ortholog","Counts",2:ncol(.)) %>%
  spread(SampleID,Counts) %>%
  column_to_rownames("Ortholog")

# perform a distance calculation for hierarchical clustering for the protein ordering
humann2_paths.decontam_noblanks_33_clr_dist <- vegdist(humann2_paths.decontam_noblanks_33_clr_sp, method = "euclidian")
# cluster the data with hclust
humann2_paths.decontam_noblanks_33_clr_dist_hr <- hclust(humann2_paths.decontam_noblanks_33_clr_dist)
# humann2_paths.decontam_noblanks_33_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
sp_all_order <- humann2_paths.decontam_noblanks_33_clr_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

```

```{r}
# use the dendrogram order to pull out the pathways in the correct order for the heatmap
humann2_paths.decontam_noblanks_33_clr_order <- humann2_paths.decontam_noblanks_33_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Ortholog","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(SpOrder = as.character(seq(1,141))) %>%
  select(Ortholog, SpOrder, everything()) %>%
  mutate(SpOrder = fct_relevel(SpOrder, sp_all_order)) %>%
  arrange(SpOrder) %>%
  pull(Ortholog)

# make the protein a factor so they're in the correct order for the heatmap using the vector from the step above
humann2_paths.decontam_noblanks_33_clr_long <- humann2_paths.decontam_noblanks_33_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Ortholog","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Ortholog = fct_relevel(Ortholog, humann2_paths.decontam_noblanks_33_clr_order)) %>%
  arrange(Ortholog) %>%
  gather("SampleID","CLR", 2:ncol(.))

# now cluster by sample
# convert the matrix to a data.frame
humann2_paths.decontam_noblanks_33_clr_smp <- humann2_paths.decontam_noblanks_33_clr %>%
  as.data.frame()

# perform a distance calculation for hierarchical clustering for the species ordering
humann2_paths.decontam_noblanks_33_clr_smp_dist <- vegdist(humann2_paths.decontam_noblanks_33_clr_smp, method = "euclidian")
# cluster the data with hclust
humann2_paths.decontam_noblanks_33_clr_smp_dist_hr <- hclust(humann2_paths.decontam_noblanks_33_clr_smp_dist)
# humann2_paths.decontam_noblanks_33_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
smp_all_order <- humann2_paths.decontam_noblanks_33_clr_smp_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
humann2_paths.decontam_noblanks_33_clr_smp_order <- humann2_paths.decontam_noblanks_33_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Species,CLR) %>%
  mutate(SmpOrder = as.character(seq(1,122))) %>%  
  select(SampleID, SmpOrder, everything()) %>%
  mutate(SmpOrder = fct_relevel(SmpOrder, smp_all_order)) %>%
  arrange(SmpOrder) %>%
  pull(SampleID)

```

```{r}
# Plot the heatmap with samples ordered by the clustering from above
# make the SampleIDs a factor so they're in the correct order for the heatmap using the vector from the step above
humann2_paths.decontam_noblanks_33_clr_long <- humann2_paths.decontam_noblanks_33_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, humann2_paths.decontam_noblanks_33_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Village), by = "SampleID") %>%
  inner_join(., Village_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Village = c("202","205","204","203","206","Yanomami","Industrial plaque","HMP10M","JAE10M","Industrial calculus","ExtractionGauze","ExtractionBlank","LibraryBlank")) %>%
               filter(!str_detect(Village, "Yanomami|10M|Gauze|Blank")), by = "Village") %>%
  mutate(SampleID = fct_relevel(SampleID, humann2_paths.decontam_noblanks_33_clr_smp_order)) %>%
  arrange(SampleID)

vector_color = humann2_paths.decontam_noblanks_33_clr_long %>%
  select(SampleID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_smp_cluster <- ggplot(humann2_paths.decontam_noblanks_33_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_smp_cluster

```

```{r}
# Plot the heatmap with samples ordered by Village, then alphabetical
# make the SampleIDs a factor so they're in the correct order for the heatmap using the vector from the step above
humann2_paths.decontam_noblanks_33_clr_long <- humann2_paths.decontam_noblanks_33_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, humann2_paths.decontam_noblanks_33_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Village), by = "SampleID") %>%
  inner_join(., Village_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Village = c("202","205","204","203","206","Yanomami","Industrial plaque","HMP10M","JAE10M","Industrial calculus","ExtractionGauze","ExtractionBlank","LibraryBlank")) %>%
               filter(!str_detect(Village, "Yanomami|10M|Gauze|Blank")), by = "Village") %>%
  mutate(SampleID = fct_relevel(SampleID, each_order)) %>%
  arrange(SampleID)

vector_color = humann2_paths.decontam_noblanks_33_clr_long %>%
  select(SampleID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_smp_village <- ggplot(humann2_paths.decontam_noblanks_33_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_smp_village
# ggsave("05-results.backup/presentation_pdfs/noblanks_fa_heatmap.pdf", plot = heatmap_base, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

```

## KEGG Orthologs
Make a heat map of the orthologs in MR1 and MR2 to see how they're different between the groups

Try changing the sample order to group them by the different metadata categories
(currently have Industrialization/Ethnic group/Market economy/Village grouping).
Need to look at: Tooth site, Age group, Sex, others? Also try clustering the
samples to see if they fall into any recognizable categories.
```{r heatmap_noblanks_noyanomami}
# select the KEGG orthologs in MR1 and MR2 for the FA
humann2_KOs.decontam_FA_all <- humann2_KOs.decontam %>%
  select(matches("Ortholog|CMC")) %>%
  inner_join(., humann2_KO_noblanks.fa_KO %>%
               filter(Residual == "MR1") %>%
               select(-Residual), by = "Ortholog") %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Ortholog,Counts) %>%
  column_to_rownames("SampleID")

# CLR-transform the matrix for plotting the heatmap
humann2_KOs.decontam_FA_all_clr <- clr(humann2_KOs.decontam_FA_all)
humann2_KOs.decontam_FA_all_clr <- as.matrix(humann2_KOs.decontam_FA_all_clr)

# orient the matrix with correct rows/columns to run the distance calculation for the seed protein, not the samples (columns are SampleID, rows are proteins)
humann2_KOs.decontam_FA_all_clr_sp <- humann2_KOs.decontam_FA_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Ortholog","Counts",2:ncol(.)) %>%
  spread(SampleID,Counts)

#add the rownames back
rownames(humann2_KOs.decontam_FA_all_clr_sp) <- humann2_KOs.decontam_FA_all_clr_sp$Ortholog
humann2_KOs.decontam_FA_all_clr_sp <- humann2_KOs.decontam_FA_all_clr_sp %>% select(-Ortholog)

# perform a distance calculation for hierarchical clustering for the protein ordering
humann2_KOs.decontam_FA_all_clr_dist <- vegdist(humann2_KOs.decontam_FA_all_clr_sp, method = "euclidian")
# cluster the data with hclust
humann2_KOs.decontam_FA_all_clr_dist_hr <- hclust(humann2_KOs.decontam_FA_all_clr_dist)
# humann2_KOs.decontam_FA_all_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
sp_all_order <- humann2_KOs.decontam_FA_all_clr_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the SEED protein in the correct order for the heatmap
humann2_KOs.decontam_FA_all_clr_order <- humann2_KOs.decontam_FA_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Ortholog","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(SpOrder = as.character(seq(1,1016))) %>% # MR1 - 716; MR2 - 848
  select(Ortholog, SpOrder, everything()) %>%
  mutate(SpOrder = fct_relevel(SpOrder, sp_all_order)) %>%
  arrange(SpOrder) %>%
  pull(Ortholog)

# make the protein a factor so they're in the correct order for the heatmap using the vector from the step above
humann2_KOs.decontam_FA_all_clr_long <- humann2_KOs.decontam_FA_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Ortholog","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Ortholog = fct_relevel(Ortholog, humann2_KOs.decontam_FA_all_clr_order)) %>%
  arrange(Ortholog) %>%
  gather("SampleID","CLR", 2:ncol(.))

# now cluster by sample
# convert the matrix to a data.frame
humann2_KOs.decontam_FA_all_clr_smp <- humann2_KOs.decontam_FA_all_clr %>%
  as.data.frame()

# perform a distance calculation for hierarchical clustering for the species ordering
humann2_KOs.decontam_FA_all_clr_smp_dist <- vegdist(humann2_KOs.decontam_FA_all_clr_smp, method = "euclidian")
# cluster the data with hclust
humann2_KOs.decontam_FA_all_clr_smp_dist_hr <- hclust(humann2_KOs.decontam_FA_all_clr_smp_dist)
# humann2_KOs.decontam_FA_all_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
smp_all_order <- humann2_KOs.decontam_FA_all_clr_smp_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
humann2_KOs.decontam_FA_all_clr_smp_order <- humann2_KOs.decontam_FA_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Species,CLR) %>%
  mutate(SmpOrder = as.character(seq(1,84))) %>%  
  select(SampleID, SmpOrder, everything()) %>%
  mutate(SmpOrder = fct_relevel(SmpOrder, smp_all_order)) %>%
  arrange(SmpOrder) %>%
  pull(SampleID)

# Plot the heatmap with samples ordered by the clustering from above
# make the SampleIDs a factor so they're in the correct order for the heatmap using the vector from the step above
humann2_KOs.decontam_FA_all_clr_long <- humann2_KOs.decontam_FA_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, humann2_KOs.decontam_FA_all_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Village), by = "SampleID") %>%
  inner_join(., Village_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Village = c("202","205","204","203","206","Yanomami","Industrial plaque","HMP10M","JAE10M","Industrial calculus","ExtractionGauze","ExtractionBlank","LibraryBlank")) %>%
               filter(!str_detect(Village, "Yanomami|10M|Gauze|Blank")), by = "Village") %>%
  mutate(SampleID = fct_relevel(SampleID, humann2_KOs.decontam_FA_all_clr_smp_order)) %>%
  arrange(SampleID)

vector_color = humann2_KOs.decontam_FA_all_clr_long %>%
  select(SampleID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_smp_cluster <- ggplot(humann2_KOs.decontam_FA_all_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_smp_cluster


# Plot the heatmap with samples ordered by Village, then alphabetical
# make the SampleIDs a factor so they're in the correct order for the heatmap using the vector from the step above
humann2_KOs.decontam_FA_all_clr_long <- humann2_KOs.decontam_FA_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, humann2_KOs.decontam_FA_all_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Village), by = "SampleID") %>%
  inner_join(., Village_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Village = c("202","205","204","203","206","Yanomami","HMP","HMP10M","JAE10M","JAE","ExtractionGauze","ExtractionBlank","LibraryBlank")), by = "Village") %>%
  mutate(SampleID = fct_relevel(SampleID, each_order)) %>%
  arrange(SampleID)

vector_color = humann2_KOs.decontam_FA_all_clr_long %>%
  select(SampleID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_smp_village <- ggplot(humann2_KOs.decontam_FA_all_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_smp_village
# ggsave("05-results.backup/presentation_pdfs/noblanks_fa_heatmap.pdf", plot = heatmap_base, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

```


# Cameroon samples only
## MetaCyc Pathways
We'll use the pathways present in at least 33% of the groups
```{r heatmap_pathways}
# MetaCyc pathways, no blanks
# potential contaminant pathways removed and only pathways present in at least 33% of one ethnic group
h2_path_test <- humann2_path.decontam %>%
  filter(!str_detect(Pathway, "\\|")) %>%
  select(matches("Pathway|CMC")) %>%
  mutate_if(is.numeric, ~1 * (. > 0)) %>%
  gather("SampleID","CPM",2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Ethnic_Group), by = "SampleID") %>%
  group_by(Ethnic_Group, Pathway) %>%
  summarize(Percent_presence = sum(CPM)/length(SampleID)*100) %>%
  # select the SEED proteins that are present in at least 30% of at least one group
  ungroup() %>%
  filter(Percent_presence <= 95) %>%
  filter(Percent_presence >= 30) %>%
  distinct(Pathway) %>%
  select(Pathway)

humann2_paths.decontam_cmc_33 <- humann2_path.decontam %>%
  select(matches("Pathway|CMC")) %>%
  inner_join(., h2_path_test, by = "Pathway") %>%
  gather("SampleID","CPM", 2:ncol(.)) %>%
  mutate(CPM = CPM + 1) %>%
  spread(Pathway, CPM) %>%
  column_to_rownames("SampleID")
  

# CLR-transform the matrix for plotting the heatmap
humann2_paths.decontam_cmc_33_clr <- clr(humann2_paths.decontam_cmc_33)
humann2_paths.decontam_cmc_33_clr <- as.matrix(humann2_paths.decontam_cmc_33_clr)

# orient the matrix with correct rows/columns to run the distance calculation for the seed protein, not the samples (columns are SampleID, rows are proteins)
humann2_paths.decontam_cmc_33_clr_sp <- humann2_paths.decontam_cmc_33_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Ortholog","Counts",2:ncol(.)) %>%
  spread(SampleID,Counts) %>%
  column_to_rownames("Ortholog")

# perform a distance calculation for hierarchical clustering for the protein ordering
humann2_paths.decontam_cmc_33_clr_dist <- vegdist(humann2_paths.decontam_cmc_33_clr_sp, method = "euclidian")
# cluster the data with hclust
humann2_paths.decontam_cmc_33_clr_dist_hr <- hclust(humann2_paths.decontam_cmc_33_clr_dist)
# humann2_paths.decontam_cmc_33_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
sp_all_order <- humann2_paths.decontam_cmc_33_clr_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the pathways in the correct order for the heatmap
humann2_paths.decontam_cmc_33_clr_order <- humann2_paths.decontam_cmc_33_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Ortholog","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(SpOrder = as.character(seq(1,82))) %>%
  select(Ortholog, SpOrder, everything()) %>%
  mutate(SpOrder = fct_relevel(SpOrder, sp_all_order)) %>%
  arrange(SpOrder) %>%
  pull(Ortholog)

# make the protein a factor so they're in the correct order for the heatmap using the vector from the step above
humann2_paths.decontam_cmc_33_clr_long <- humann2_paths.decontam_cmc_33_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Ortholog","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Ortholog = fct_relevel(Ortholog, humann2_paths.decontam_cmc_33_clr_order)) %>%
  arrange(Ortholog) %>%
  gather("SampleID","CLR", 2:ncol(.))

# now cluster by sample
# convert the matrix to a data.frame
humann2_paths.decontam_cmc_33_clr_smp <- humann2_paths.decontam_cmc_33_clr %>%
  as.data.frame()

# perform a distance calculation for hierarchical clustering for the species ordering
humann2_paths.decontam_cmc_33_clr_smp_dist <- vegdist(humann2_paths.decontam_cmc_33_clr_smp, method = "euclidian")
# cluster the data with hclust
humann2_paths.decontam_cmc_33_clr_smp_dist_hr <- hclust(humann2_paths.decontam_cmc_33_clr_smp_dist)
# humann2_paths.decontam_cmc_33_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
smp_all_order <- humann2_paths.decontam_cmc_33_clr_smp_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the pathways in the correct order for the heatmap
humann2_paths.decontam_cmc_33_clr_smp_order <- humann2_paths.decontam_cmc_33_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Species,CLR) %>%
  mutate(SmpOrder = as.character(seq(1,84))) %>%  
  select(SampleID, SmpOrder, everything()) %>%
  mutate(SmpOrder = fct_relevel(SmpOrder, smp_all_order)) %>%
  arrange(SmpOrder) %>%
  pull(SampleID)

# Plot the heatmap with samples ordered by the clustering from above
# make the SampleIDs a factor so they're in the correct order for the heatmap using the vector from the step above
humann2_paths.decontam_cmc_33_clr_long <- humann2_paths.decontam_cmc_33_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, humann2_paths.decontam_cmc_33_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Village), by = "SampleID") %>%
  inner_join(., Village_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Village = c("202","205","204","203","206","Yanomami","HMP","HMP10M","JAE10M","JAE","ExtractionGauze","ExtractionBlank","LibraryBlank")), by = "Village") %>%
  mutate(SampleID = fct_relevel(SampleID, humann2_paths.decontam_cmc_33_clr_smp_order)) %>%
  arrange(SampleID)

vector_color = humann2_paths.decontam_cmc_33_clr_long %>%
  select(SampleID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_smp_cluster <- ggplot(humann2_paths.decontam_cmc_33_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_smp_cluster


# Plot the heatmap with samples ordered by Village, then alphabetical
# make the SampleIDs a factor so they're in the correct order for the heatmap using the vector from the step above
humann2_paths.decontam_cmc_33_clr_long <- humann2_paths.decontam_cmc_33_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, humann2_paths.decontam_cmc_33_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Village), by = "SampleID") %>%
  inner_join(., Village_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Village = c("202","205","204","203","206","Yanomami","HMP","HMP10M","JAE10M","JAE","ExtractionGauze","ExtractionBlank","LibraryBlank")), by = "Village") %>%
  mutate(SampleID = fct_relevel(SampleID, each_order)) %>%
  arrange(SampleID)

vector_color = humann2_paths.decontam_cmc_33_clr_long %>%
  select(SampleID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_smp_village <- ggplot(humann2_paths.decontam_cmc_33_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_smp_village
# ggsave("05-results.backup/presentation_pdfs/cmc_fa_heatmap.pdf", plot = heatmap_base, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

```

## KEGG Orthologs
Make a heat map of the species in MR1 and MR2 to see how they're different between the groups
```{r metadata_heatmaps}
# minres_oblimin_nobl_noyano_fa_species <- fread("./05-results.backup/minres_oblimin_noyanomami.fa_species.tsv", sep = "\t")
# minres_oblimin_cmc_fa_species <- fread("./05-results.backup/minres_oblimin_cmc.fa_species.tsv", sep = "\t")

# read in metadata again to get it without all the factors
metadata_hm <- fread("00-documentation.backup/01-cameroon_hunter_gatherer_metadata.tsv")

# order the samples so they can be ordered this way in the heat maps

# order the CMC samples by Village
cmc_order <- metadata_hm %>%
  rename(SampleID = `#SampleID`)  %>%
  as_tibble() %>%
  filter(str_detect(SampleID, "CMC")) %>%
  mutate(Village = fct_relevel(Village, "202","205","204","203","206")) %>%
  select(SampleID, Village) %>%
  arrange(Village) %>%
  pull(SampleID)


```

Try changing the sample order to group them by the different metadata categories
(currently have Industrialization/Ethnic group/Market economy/Village grouping).
Need to look at: Tooth site, Age group, Sex, others? Also try clustering the
samples to see if they fall into any recognizable categories.
```{r heatmap_cmc_noyanomami}
# select the SEED proteins in MR1 and MR2 for the FA
humann2_KOs.decontam_FA_cmc <- humann2_KOs.decontam %>%
  select(matches("Ortholog|CMC")) %>%
  inner_join(., humann2_KO_cmc.fa_KO %>%
               filter(Residual == "MR1") %>%
               select(-Residual), by = "Ortholog") %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Ortholog,Counts) %>%
  column_to_rownames("SampleID")

# CLR-transform the matrix for plotting the heatmap
humann2_KOs.decontam_FA_cmc_clr <- clr(humann2_KOs.decontam_FA_cmc)
humann2_KOs.decontam_FA_cmc_clr <- as.matrix(humann2_KOs.decontam_FA_cmc_clr)

# orient the matrix with correct rows/columns to run the distance calculation for the seed protein, not the samples (columns are SampleID, rows are proteins)
humann2_KOs.decontam_FA_cmc_clr_sp <- humann2_KOs.decontam_FA_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Ortholog","Counts",2:ncol(.)) %>%
  spread(SampleID,Counts)

#add the rownames back
rownames(humann2_KOs.decontam_FA_cmc_clr_sp) <- humann2_KOs.decontam_FA_cmc_clr_sp$Ortholog
humann2_KOs.decontam_FA_cmc_clr_sp <- humann2_KOs.decontam_FA_cmc_clr_sp %>% select(-Ortholog)

# perform a distance calculation for hierarchical clustering for the protein ordering
humann2_KOs.decontam_FA_cmc_clr_dist <- vegdist(humann2_KOs.decontam_FA_cmc_clr_sp, method = "euclidian")
# cluster the data with hclust
humann2_KOs.decontam_FA_cmc_clr_dist_hr <- hclust(humann2_KOs.decontam_FA_cmc_clr_dist)
# humann2_KOs.decontam_FA_cmc_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
sp_cmc_order <- humann2_KOs.decontam_FA_cmc_clr_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the KEGG Orthologs in the correct order for the heatmap
humann2_KOs.decontam_FA_cmc_clr_order <- humann2_KOs.decontam_FA_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Ortholog","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(SpOrder = as.character(seq(1,1301))) %>% # MR1 - 866; MR2 - 807
  select(Ortholog, SpOrder, everything()) %>%
  mutate(SpOrder = fct_relevel(SpOrder, sp_cmc_order)) %>%
  arrange(SpOrder) %>%
  pull(Ortholog)

# make the protein a factor so they're in the correct order for the heatmap using the vector from the step above
humann2_KOs.decontam_FA_cmc_clr_long <- humann2_KOs.decontam_FA_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Ortholog","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Ortholog = fct_relevel(Ortholog, humann2_KOs.decontam_FA_cmc_clr_order)) %>%
  arrange(Ortholog) %>%
  gather("SampleID","CLR", 2:ncol(.))


# now cluster by sample
# convert the matrix to a data.frame
humann2_KOs.decontam_FA_cmc_clr_smp <- humann2_KOs.decontam_FA_cmc_clr %>%
  as.data.frame()

# perform a distance calculation for hierarchical clustering for the species ordering
humann2_KOs.decontam_FA_cmc_clr_smp_dist <- vegdist(humann2_KOs.decontam_FA_cmc_clr_smp, method = "euclidian")
# cluster the data with hclust
humann2_KOs.decontam_FA_cmc_clr_smp_dist_hr <- hclust(humann2_KOs.decontam_FA_cmc_clr_smp_dist)
# humann2_KOs.decontam_FA_cmc_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
smp_cmc_order <- humann2_KOs.decontam_FA_cmc_clr_smp_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
humann2_KOs.decontam_FA_cmc_clr_smp_order <- humann2_KOs.decontam_FA_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Species,CLR) %>%
  mutate(SmpOrder = as.character(seq(1,84))) %>%  
  select(SampleID, SmpOrder, everything()) %>%
  mutate(SmpOrder = fct_relevel(SmpOrder, smp_cmc_order)) %>%
  arrange(SmpOrder) %>%
  pull(SampleID)

# Plot the heatmap with samples ordered by the clustering from above
# make the SampleIDs a factor so they're in the correct order for the heatmap using the vector from the step above
humann2_KOs.decontam_FA_cmc_clr_long <- humann2_KOs.decontam_FA_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, humann2_KOs.decontam_FA_cmc_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Village), by = "SampleID") %>%
  inner_join(., Village_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Village = c("202","205","204","203","206","Yanomami","HMP","HMP10M","JAE10M","JAE","ExtractionGauze","ExtractionBlank","LibraryBlank")), by = "Village") %>%
  mutate(SampleID = fct_relevel(SampleID, humann2_KOs.decontam_FA_cmc_clr_smp_order)) %>%
  arrange(SampleID)

vector_color = humann2_KOs.decontam_FA_cmc_clr_long %>%
  select(SampleID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_smp_cluster <- ggplot(humann2_KOs.decontam_FA_cmc_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_smp_cluster


# Plot the heatmap with samples ordered by Village, then alphabetical
# make the SampleIDs a factor so they're in the correct order for the heatmap using the vector from the step above
humann2_KOs.decontam_FA_cmc_clr_long <- humann2_KOs.decontam_FA_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, humann2_KOs.decontam_FA_cmc_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Village), by = "SampleID") %>%
  inner_join(., Village_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Village = c("202","205","204","203","206","Yanomami","HMP","HMP10M","JAE10M","JAE","ExtractionGauze","ExtractionBlank","LibraryBlank")), by = "Village") %>%
  mutate(SampleID = fct_relevel(SampleID, each_order)) %>%
  arrange(SampleID)

vector_color = humann2_KOs.decontam_FA_cmc_clr_long %>%
  select(SampleID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_smp_village <- ggplot(humann2_KOs.decontam_FA_cmc_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_smp_village

# ggsave("05-results.backup/presentation_pdfs/cmc_fa_heatmap.pdf", plot = heatmap_base, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

```



