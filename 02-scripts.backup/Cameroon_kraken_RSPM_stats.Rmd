---
title: "Cameroon plaque stats analysis - Kraken RefSeq database w/ & w/o Pasolli MAGs"
author: "Irina Velsko"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output:
    github_document:
        fig_width: 8
        fig_height: 6
        toc: true
---

```{r load_libraries, echo = F, message = F}
library(knitr)
library(data.table)
library(janitor)
library(tidyverse)
library(gplots)
opts_chunk$set(echo=F, warning=F, message=F, dpi=150)
```

Set the working directory of the notebook to the parent directory of the 
notebook itself.  

```{r setup}
knitr::opts_knit$set(root.dir = normalizePath(".."))
```

Load data files 
```{r load_data}
rs_readstats <- fread("./05-results.backup/read_classification_stats.rs.tsv") %>%
  rename(SampleID = 1,
         Classified = 2,
         Unclassified = 3,
         Classified_0 = 4)

rspm_readstats <- fread("./05-results.backup/read_classification_stats.rspm.tsv") %>%
  rename(SampleID = 1,
         Classified = 2,
         Unclassified = 3,
         Classified_0 = 4)


# load the metadata file
load("./05-results.backup/CMC_metadata.RData")

# merge the tables into 1
kraken_readstats <- rs_readstats %>%
  mutate(Unclassified_T = Unclassified + Classified_0,
         Percent_classified = Classified / (Classified + Unclassified_T) *100) %>%
  select(SampleID, Classified, Unclassified_T, Percent_classified) %>%
  pivot_longer(!SampleID, names_to = "Classification", values_to = "Counts") %>%
  mutate(DB = "RefSeqOnly") %>%
  bind_rows(., rspm_readstats %>%
            mutate(Unclassified_T = Unclassified + Classified_0,
         Percent_classified = Classified / (Classified + Unclassified_T) *100) %>%
            select(SampleID, Classified, Unclassified_T, Percent_classified) %>%
            pivot_longer(!SampleID, names_to = "Classification", values_to = "Counts") %>%
            mutate(DB = "RefSeqPasolliMAGs")) %>%
  inner_join(., metadata %>%
               select(SampleID,Env,Description,Ethnic_Group,Market_integration_split,Age_group,Sex,Tooth_site,Type,Village)) %>%
  # remove unneeded sample groups
  filter(!str_detect(Description, "Saliva|Buccal"))


# Kraken_db_colors

```


```{r plot_data}
RSPM_kraken_compare <- kraken_readstats %>%
  filter(Classification == "Percent_classified") %>%
  filter(!str_detect(SampleID, "EXB|LIB|SRR164")) %>%
  ggplot(., aes(x = Village, y = Counts, fill = DB)) +
    geom_boxplot() +
    geom_point(alpha = 0.5, size = 0.5, position=position_jitterdodge(dodge.width = 0.75, jitter.width = 0.1)) +
    # geom_jitter(size = 0.5, alpha = 0.5, width = 0.4) +
    scale_fill_manual(values = Kraken_db_colors) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    xlab("Village") +
    ylab("Percent of reads classified")

RSPM_kraken_compare

# ggsave("05-results.backup/RSPM_kraken_compare_UKY.pdf", plot = RSPM_kraken_compare, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"),
#        dpi = 300)

```

```{r}

RSPM_kraken_compare <- kraken_readstats %>%
  filter(!str_detect(SampleID, "EXB|LIB|10M|SRR164")) %>%
  filter(Classification == "Percent_classified") %>%
  ggplot(., aes(x = Market_integration_split, y = Counts, fill = DB)) +
    geom_boxplot() +
    geom_point(position = position_jitterdodge(dodge.width = 0.85, jitter.width = 0.2), size = 0.5, alpha = 0.5) +
    scale_fill_manual(values = Kraken_db_colors) +
    theme_minimal(base_size = 16) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    xlab("Village") +
    ylab("Reads classified (%)")

RSPM_kraken_compare

# ggsave("05-results.backup/RSPM_kraken_compare_UKY.pdf", plot = RSPM_kraken_compare, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"),
#        dpi = 300)



```


```{r stats}

wilcox_p <- kraken_readstats %>%
  filter(Classification == "Percent_classified") %>%
  filter(!str_detect(SampleID, "EXB|LIB|SRR164")) %>%
  group_by(Market_integration_split) %>%
  summarise(pvalue = pairwise.wilcox.test(Counts, DB, p.adjust.method = "fdr")$p.value)

wilcox_p %>% filter(pvalue <= 0.05)

```

