---
title: "Cameroon hunter-gatherer calculus/plaque MALT alpha diversity"
author: "Irina Velsko"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output:
    github_document:
        fig_width: 8
        fig_height: 6
        toc: true
---

```{r load_libraries, echo = F, message = F}
library(knitr)
library(data.table)
library(rstatix)
library(vegan)
library(compositions)
library(janitor)
library(ggheatmap)
library(tidyverse)
library(gplots)
library(cowplot)
opts_chunk$set(echo=F, warning=F, message=F, dpi=150)
```

Set the working directory of the notebook to the parent directory of the 
notebook itself.  

```{r setup}
knitr::opts_knit$set(root.dir = normalizePath(".."))
```

```{r load_data}

# load the taxonomy tables that have been decontaminated and the column headers are cleaned up
load("./05-results.backup/CMC_taxonomy_tables.RData")

# load the metadata file
load("./05-results.backup/CMC_metadata.RData")

# load the metadata file again without factors for stats
metadata_nofactors <- fread("./00-documentation.backup/01-cameroon_hunter_gatherer_metadata.tsv")
metadata_nofactors <- metadata_nofactors %>% 
  rename(SampleID = `#SampleID`) %>%
  select(SampleID, Env, Age, Age_group, Ethnic_Group, Market_economy, Sex, Tooth_site, Village)

```


```{r box_plotting_functions}

plot_box_whisker <- function(df, stat_info, metadata_group, fill_group, title_text) {
    fill_group_colors <- get(paste(fill_group, "_colors", sep = ""))

      df_X <- df %>%
              inner_join(metadata %>%
                           select(SampleID, Env, Description, Ethnic_Group, Age_group,
                                  Sex, Market_economy, Village, Tooth_site, ExtractionBatch, LibraryBatch, Type), by = "SampleID")

    stat_info_table = df_X[[stat_info]]
    metadata_group = df_X[[metadata_group]]
    fill_group = df_X[[fill_group]]

    bx_wh_plot <- ggplot(df_X, aes(x = metadata_group, y = stat_info_table, fill = fill_group)) +
                         geom_boxplot() +
                         scale_fill_manual(values = fill_group_colors) +
                         theme_minimal() +
                         #scale_y_continuous(trans='log10') +
                         #scale_y_continuous(trans='pseudo_log') +
                         theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
                         ylab(stat_info) +
                         ggtitle(title_text)

    return(bx_wh_plot)
}

```


List the outliers from the plot in section `raw_plot` in `Cameroon_h-g_taxonomy.Rmd` and remove them from the taxonomy table. 
```{r outliers}
outliers <- c("CMC002.B0201","CMC032.B0101","CMC037.B0201","CMC047.A0201",
              "EXB059.A1901","EXB059.A1301","EXB059.A1101","EXB059.A0901",
              "SRR1646041","SRR1646032","SRR1646042","SRR1646045","SRR1646030","SRR1646047")

outliersF <- str_c(outliers, collapse = "|")

```


# Alpha-diversity
First we want to know if there are differences in the total diveristy of
identified species between *XXXMETADATAXXX*. We'll look at alpha-diversity for
this, using both the observed species and Shannon diverity metrics. Observed
species to tell us which *XXXMETADATAXXX* have more species/genera, and Shannon
to tell us which has more even distribution of species/genera.

## Observed Speceies/Genera
```{r observed_species}
# make Relab binary to make a presence/absence table
presabs_table <- malt_species.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam") %>%
                                         mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
                                         select(-one_of(c("Sum_species.decontam","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts) %>%
                                         gather("Species","Counts",2:ncol(.)) %>%
                                         mutate(Counts = ifelse(Counts > 0, 1, 0)) %>%
                                         spread(Species, Counts) %>%
                                         column_to_rownames("SampleID")

# calculate observed species for each sample with janitor 'adorn_totals'
malt_species.decontam.os <- presabs_table %>%
  adorn_totals(., where = "col", name = "Observed_species") %>%
  select(Observed_species) %>%
  rownames_to_column("SampleID") 

plot_box_whisker(malt_species.decontam.os, "Observed_species", "Env", "Env", "Number of species")
plot_box_whisker(malt_species.decontam.os, "Observed_species", "Village", "Village", "Number of species")

# now on filtered tables
presabs_table_f <- malt_species.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam") %>%
                                         mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
                                         filter(Percent > 0.001) %>%
                                         select(-one_of(c("Sum_species.decontam","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts) %>%
                                         gather("Species","Counts",2:ncol(.)) %>%
                                         mutate(Counts = ifelse(Counts > 0, 1, 0)) %>%
                                         spread(Species, Counts) %>%
                                         column_to_rownames("SampleID")
  
# calculate observed species for each sample with janitor 'adorn_totals'
malt_species.decontam_filtered.os <- presabs_table_f %>%
  adorn_totals(., where = "col", name = "Observed_species") %>%
  select(Observed_species) %>%
  rownames_to_column("SampleID") 

plot_box_whisker(malt_species.decontam_filtered.os, "Observed_species", "Env", "Env", "Number of species")
plot_box_whisker(malt_species.decontam_filtered.os, "Observed_species", "Village", "Village", "Number of species")

```

Now at the genus level
```{r observed_genera}
presabs_table <- malt_genus.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         adorn_totals(where = "col", name = "Sum_genus.decontam") %>%
                                         mutate(Percent = Sum_genus.decontam/sum(Sum_genus.decontam)*100) %>%
                                         select(-one_of(c("Sum_genus.decontam","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts) %>%
                                         gather("Species","Counts",2:ncol(.)) %>%
                                         mutate(Counts = ifelse(Counts > 0, 1, 0)) %>%
                                         spread(Species, Counts) %>%
                                         column_to_rownames("SampleID")
  
# calculate observed genus for each sample with janitor 'adorn_totals'
malt_genus.decontam.os <- presabs_table %>%
  adorn_totals(., where = "col", name = "Observed_genera") %>%
  select(Observed_genera) %>%
  rownames_to_column("SampleID") 

plot_box_whisker(malt_genus.decontam.os, "Observed_genera", "Env", "Env", "Number of genera")
plot_box_whisker(malt_genus.decontam.os, "Observed_genera", "Village", "Village", "Number of genera")


# now on the filtered table
presabs_table_filtered <- malt_genus.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         adorn_totals(where = "col", name = "Sum_genus.decontam") %>%
                                         mutate(Percent = Sum_genus.decontam/sum(Sum_genus.decontam)*100) %>%
                                         filter(Percent > 0.001) %>%
                                         select(-one_of(c("Sum_genus.decontam","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts) %>%
                                         gather("Species","Counts",2:ncol(.)) %>%
                                         mutate(Counts = ifelse(Counts > 0, 1, 0)) %>%
                                         spread(Species, Counts) %>%
                                         column_to_rownames("SampleID")
  
# calculate observed genus for each sample with janitor 'adorn_totals'
malt_genus.decontam_filtered.os <- presabs_table_filtered %>%
  adorn_totals(., where = "col", name = "Observed_genera") %>%
  select(Observed_genera) %>%
  rownames_to_column("SampleID")

plot_box_whisker(malt_genus.decontam_filtered.os, "Observed_genera", "Env", "Env", "Number of genera")
plot_box_whisker(malt_genus.decontam_filtered.os, "Observed_genera", "Village", "Village", "Number of genera")

```


## Shannon Index
```{r shannon_diversity}
# Shannon diversity with the package vegan
malt_species.decontam.matrix <- as.matrix(malt_species.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam") %>%
                                         mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
                                         select(-one_of(c("Sum_species.decontam","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts) %>% 
                                         column_to_rownames("SampleID"))
 
malt_species.decontam.shannon <- as.data.frame(diversity(malt_species.decontam.matrix, index = "shannon"))
names(malt_species.decontam.shannon)[1] <- "Shannon_index"

# merge with the metadata file and plot
malt_species.decontam.shannon <- malt_species.decontam.shannon %>%
  rownames_to_column("SampleID") 

plot_box_whisker(malt_species.decontam.shannon, "Shannon_index", "Env", "Env", "Shannon Index")
plot_box_whisker(malt_species.decontam.shannon, "Shannon_index", "Village", "Village", "Shannon Index")


# now with the filtered data
malt_species.decontam_filtered.matrix <- as.matrix(malt_species.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam") %>%
                                         mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
                                         filter(Percent > 0.001) %>%
                                         select(-one_of(c("Sum_species.decontam","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts) %>% 
                                         column_to_rownames("SampleID"))

malt_species.decontam_filtered.shannon <- as.data.frame(diversity(malt_species.decontam_filtered.matrix, index = "shannon"))
names(malt_species.decontam_filtered.shannon)[1] <- "Shannon_index"

# merge with the metadata file and plot
malt_species.decontam_filtered.shannon <- malt_species.decontam_filtered.shannon %>%
  rownames_to_column("SampleID") 

plot_box_whisker(malt_species.decontam_filtered.shannon, "Shannon_index", "Env", "Env", "Shannon Index")
plot_box_whisker(malt_species.decontam_filtered.shannon, "Shannon_index", "Village", "Village", "Shannon Index")


```

At the genus level
```{r shannon_genera}
# Shannon diversity with the package vegan
malt_genus.decontam.matrix <- as.matrix(malt_genus.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         adorn_totals(where = "col", name = "Sum_genus.decontam") %>%
                                         mutate(Percent = Sum_genus.decontam/sum(Sum_genus.decontam)*100) %>%
                                         select(-one_of(c("Sum_genus.decontam","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts) %>% 
                                         column_to_rownames("SampleID"))

malt_genus.decontam.shannon <- as.data.frame(diversity(malt_genus.decontam.matrix, index = "shannon"))
names(malt_genus.decontam.shannon)[1] <- "Shannon_index"

# merge with the metadata file and plot
malt_genus.decontam.shannon <- malt_genus.decontam.shannon %>%
  rownames_to_column("SampleID") 

plot_box_whisker(malt_genus.decontam.shannon, "Shannon_index", "Env", "Env", "Shannon Index")
plot_box_whisker(malt_genus.decontam.shannon, "Shannon_index", "Village", "Village", "Shannon Index")


# now with the filtered data
malt_genus.decontam_filtered.matrix <- as.matrix(malt_genus.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         adorn_totals(where = "col", name = "Sum_genus.decontam") %>%
                                         mutate(Percent = Sum_genus.decontam/sum(Sum_genus.decontam)*100) %>%
                                         filter(Percent > 0.001) %>%
                                         select(-one_of(c("Sum_genus.decontam","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts) %>% 
                                         column_to_rownames("SampleID"))

malt_genus.decontam_filtered.shannon <- as.data.frame(diversity(malt_genus.decontam_filtered.matrix, index = "shannon"))
names(malt_genus.decontam_filtered.shannon)[1] <- "Shannon_index"

# merge with the metadata file and plot
malt_genus.decontam_filtered.shannon <- malt_genus.decontam_filtered.shannon %>%
  rownames_to_column("SampleID") 

plot_box_whisker(malt_genus.decontam_filtered.shannon, "Shannon_index", "Env", "Env", "Shannon Index")
plot_box_whisker(malt_genus.decontam_filtered.shannon, "Shannon_index", "Village", "Village", "Shannon Index")

```


## Pielou's Evenness
Let's also look specifically at evenness of the samples using Pielou's evenness.
This calculation (derived from Shannon's index) gives us a number from 0 to 1,
where 0 is no evenness and 1 is perfect evenness. We want to see if there are
any groups that have substantially greater species/genera evenness than the
others. We're not interested in what the actual number is, or how even the
samples appear to be, except relative to eachother.
```{r evenness_pielou}
evenness.species <- diversity(malt_species.decontam.matrix)
evenness.species <- as.data.frame(evenness.species/log(specnumber(malt_species.decontam.matrix)))
names(evenness.species)[1] <- "Pielou_evenness"

# merge with the metadata file and plot
evenness.species <- evenness.species %>%
  rownames_to_column("SampleID") 

plot_box_whisker(evenness.species, "Pielou_evenness", "Env", "Env", "Pielou's evenness")
plot_box_whisker(evenness.species, "Pielou_evenness", "Village", "Village", "Pielou's evenness")


# now with filtered data
evenness.species_filtered <- diversity(malt_species.decontam_filtered.matrix)
evenness.species_filtered <- as.data.frame(evenness.species_filtered/log(specnumber(malt_species.decontam_filtered.matrix)))
names(evenness.species_filtered)[1] <- "Pielou_evenness"

# merge with the metadata file and plot
evenness.species_filtered <- evenness.species_filtered %>%
  rownames_to_column("SampleID") 

plot_box_whisker(evenness.species_filtered, "Pielou_evenness", "Env", "Env", "Pielou's evenness")
plot_box_whisker(evenness.species_filtered, "Pielou_evenness", "Village", "Village", "Pielou's evenness")

```
In this dataset EXB059.A1601 has no detected genera, and this is the samples
that was removed in the warning notice (it ends up with NA for the evenness
calculation).

At the genus level
```{r evenness_pielou_genus}
evenness.genus <- diversity(malt_genus.decontam.matrix)
evenness.genus <- as.data.frame(evenness.genus/log(specnumber(malt_genus.decontam.matrix)))
names(evenness.genus)[1] <- "Pielou_evenness"

# merge with the metadata file and plot
evenness.genus <- evenness.genus %>%
  rownames_to_column("SampleID") 

plot_box_whisker(evenness.genus, "Pielou_evenness", "Env", "Env", "Pielou's evenness")
plot_box_whisker(evenness.genus, "Pielou_evenness", "Village", "Village", "Pielou's evenness")


# now with the filtered data
evenness_filtered.genus <- diversity(malt_genus.decontam_filtered.matrix)
evenness_filtered.genus <- as.data.frame(evenness_filtered.genus/log(specnumber(malt_genus.decontam_filtered.matrix)))
names(evenness_filtered.genus)[1] <- "Pielou_evenness"

# merge with the metadata file and plot
evenness_filtered.genus <- evenness_filtered.genus %>%
  rownames_to_column("SampleID") 

plot_box_whisker(evenness_filtered.genus, "Pielou_evenness", "Env", "Env", "Pielou's evenness")
plot_box_whisker(evenness_filtered.genus, "Pielou_evenness", "Village", "Village", "Pielou's evenness")

```
In this dataset EXB059.A1601 and LIB050.A0105 have no detected genera, and these
are the 2 samples that were removed in the warning notice (they end up with NA
for the evenness calculation).

### Stats for samples without controls
```{r samples_stats_species_noyanomami}
# Filtered species tables alpha-diversity stats
# get the number of observed species
presabs_table_f <- malt_species.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("10M|EXB|LIB|SRR164")) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam") %>%
                                         mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
                                         filter(Percent > 0.001) %>%
                                         select(-one_of(c("Sum_species.decontam","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts) %>%
                                         gather("Species","Counts",2:ncol(.)) %>%
                                         mutate(Counts = ifelse(Counts > 0, 1, 0)) %>%
                                         spread(Species, Counts) %>%
                                         column_to_rownames("SampleID")
  
# calculate observed species for each sample with janitor 'adorn_totals'
malt_species.decontam_filtered.alpha <- presabs_table_f %>%
  adorn_totals(., where = "col", name = "Observed_species") %>%
  select(Observed_species) %>%
  rownames_to_column("SampleID") 


# get the Shannon index
malt_species.decontam_filtered.matrix <- as.matrix(malt_species.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("10M|EXB|LIB|SRR164")) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam") %>%
                                         mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
                                         filter(Percent > 0.001) %>%
                                         select(-one_of(c("Sum_species.decontam","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts) %>% 
                                         column_to_rownames("SampleID"))

malt_species.decontam_filtered.shannon <- as.data.frame(diversity(malt_species.decontam_filtered.matrix, index = "shannon"))
names(malt_species.decontam_filtered.shannon)[1] <- "Shannon_index"

# convert row names to a column and combine with the observed species table
malt_species.decontam_filtered.alpha <- malt_species.decontam_filtered.alpha %>%
  full_join(., malt_species.decontam_filtered.shannon %>%
  rownames_to_column("SampleID"), by = "SampleID")
  
# Get the evenness index
evenness.species_filtered <- diversity(malt_species.decontam_filtered.matrix)
evenness.species_filtered <- as.data.frame(evenness.species_filtered/log(specnumber(malt_species.decontam_filtered.matrix)))
names(evenness.species_filtered)[1] <- "Pileou_evenness"

# merge with the metadata file and plot
malt_species.decontam_filtered.alpha <- malt_species.decontam_filtered.alpha %>%
  full_join(., evenness.species_filtered %>%
  rownames_to_column("SampleID"), by = "SampleID")

# now plot the observed species
os_env <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Observed_species", "Env", "Env", "Environment")
os_env
os_ethnicity <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Observed_species", "Ethnic_Group", "Ethnic_Group", "Ethnic group")
os_ethnicity
os_market <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Observed_species", "Market_economy", "Market_economy", "Market economy")
os_market

# ggsave("./05-results.backup/os_env.pdf", plot = os_env, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)
# 
# ggsave("./05-results.backup/os_ethnicity.pdf", plot = os_ethnicity, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)
# 
# ggsave("./05-results.backup/os_market.pdf", plot = os_market, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

# add metadata to the table
malt_species.decontam_filtered.alpha_meta <- malt_species.decontam_filtered.alpha %>%
  inner_join(., metadata_nofactors %>%
               select(SampleID, Env, Age, Age_group, Ethnic_Group, 
                      Market_economy, Sex, Tooth_site, Village), by = "SampleID")

# define the metadata categories to test for significnat differences in diversity
Envmt <- colnames(malt_species.decontam_filtered.alpha_meta %>%
                    select(Env, Age, Age_group, Ethnic_Group, 
                           Market_economy, Sex, Tooth_site, Village))

# test for significant differences in diversity between the metadata categories
species_kruskal_pvals <- lapply(Envmt, function(envmt) {
pvalues_envmt <- malt_species.decontam_filtered.alpha_meta %>%
  select(SampleID, Observed_species, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  kruskal_test(Observed_species ~ lastone) %>% # number of species
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., malt_species.decontam_filtered.alpha_meta %>% 
              select(SampleID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            kruskal_test(Shannon_index ~ lastone) %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., malt_species.decontam_filtered.alpha_meta %>% 
              select(SampleID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            kruskal_test(Pileou_evenness ~ lastone) %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble() %>%
  arrange(p)
species_kruskal_pvals

# pull out only the metadata categories that were significantly different between groups from the Kruskal-Wallace test
Envmt_sig <- species_kruskal_pvals %>%
  filter(p <= 0.05) %>%
  distinct(Category) %>%
  pull(Category)

# and run a post-hoc test on those metadata categories to see which groups in them are significantly different
species_wilcox_pvals <- lapply(Envmt_sig, function(envmt) {
pvalues_envmt <- malt_species.decontam_filtered.alpha_meta %>%
  select(SampleID, Observed_species, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  pairwise_wilcox_test(Observed_species ~ lastone, p.adjust.method = "fdr") %>% # number of species
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., malt_species.decontam_filtered.alpha_meta %>% 
              select(SampleID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            pairwise_wilcox_test(Shannon_index ~ lastone, p.adjust.method = "fdr") %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., malt_species.decontam_filtered.alpha_meta %>% 
              select(SampleID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            pairwise_wilcox_test(Pileou_evenness ~ lastone, p.adjust.method = "fdr") %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble( )%>%
  arrange(p.adj)

species_wilcox_pvals

```
Only Env (p = 0.0251), Ethnic group (p = 0.0379), and Market economy (p =
0.0413) have significant differences in diversity, and only in the number of
species (Observed species). The post-hoc test show that the only significant
difference in the Ethnic group category is between Baka and JAE (p.adj = 0.037)
where Baka has a higher average, in the Env category is between HunterGatherer
and JAE (p.adj = 0.046) where HunterGatherer has a higher average, and in Market
economy is  between Industrial and Logging road (p.adj = 0.048) where Logging
road has a higher average.

```{r samples_stats_genus_noyanomami}
# Filtered genus tables alpha-diversity stats
# get the number of observed genus
presabs_table_f <- malt_genus.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("10M|EXB|LIB|SRR164")) %>%
                                         adorn_totals(where = "col", name = "Sum_genus.decontam") %>%
                                         mutate(Percent = Sum_genus.decontam/sum(Sum_genus.decontam)*100) %>%
                                         filter(Percent > 0.001) %>%
                                         select(-one_of(c("Sum_genus.decontam","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts) %>%
                                         gather("Species","Counts",2:ncol(.)) %>%
                                         mutate(Counts = ifelse(Counts > 0, 1, 0)) %>%
                                         spread(Species, Counts) %>%
                                         column_to_rownames("SampleID")
  
# calculate observed genus for each sample with janitor 'adorn_totals'
malt_genus.decontam_filtered.alpha <- presabs_table_f %>%
  adorn_totals(., where = "col", name = "Observed_genera") %>%
  select(Observed_genera) %>%
  rownames_to_column("SampleID") 


# get the Shannon index
malt_genus.decontam_filtered.matrix <- as.matrix(malt_genus.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("10M|EXB|LIB|SRR164")) %>%
                                         adorn_totals(where = "col", name = "Sum_genus.decontam") %>%
                                         mutate(Percent = Sum_genus.decontam/sum(Sum_genus.decontam)*100) %>%
                                         filter(Percent > 0.001) %>%
                                         select(-one_of(c("Sum_genus.decontam","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts) %>% 
                                         column_to_rownames("SampleID"))

malt_genus.decontam_filtered.shannon <- as.data.frame(diversity(malt_genus.decontam_filtered.matrix, index = "shannon"))
names(malt_genus.decontam_filtered.shannon)[1] <- "Shannon_index"

# convert row names to a column and combine with the observed genus table
malt_genus.decontam_filtered.alpha <- malt_genus.decontam_filtered.alpha %>%
  full_join(., malt_genus.decontam_filtered.shannon %>%
  rownames_to_column("SampleID"), by = "SampleID")
  
# Get the evenness index
evenness.genus_filtered <- diversity(malt_genus.decontam_filtered.matrix)
evenness.genus_filtered <- as.data.frame(evenness.genus_filtered/log(specnumber(malt_genus.decontam_filtered.matrix)))
names(evenness.genus_filtered)[1] <- "Pileou_evenness"

# merge with the metadata file and plot
malt_genus.decontam_filtered.alpha <- malt_genus.decontam_filtered.alpha %>%
  full_join(., evenness.genus_filtered %>%
  rownames_to_column("SampleID"), by = "SampleID")

# now plot the observed genus
og_env <- plot_box_whisker(malt_genus.decontam_filtered.alpha, "Observed_genera", "Env", "Env", "Environment")
og_env
og_ethnicity <- plot_box_whisker(malt_genus.decontam_filtered.alpha, "Observed_genera", "Ethnic_Group", "Ethnic_Group", "Ethnic group")
og_ethnicity
og_market <- plot_box_whisker(malt_genus.decontam_filtered.alpha, "Observed_genera", "Market_economy", "Market_economy", "Market economy")
og_market
og_age <- plot_box_whisker(malt_genus.decontam_filtered.alpha, "Observed_genera", "Age_group", "Age_group", "Age group")
og_age
og_village <- plot_box_whisker(malt_genus.decontam_filtered.alpha, "Observed_genera", "Village", "Village", "Village")
og_village
og_tooth <- plot_box_whisker(malt_genus.decontam_filtered.alpha, "Observed_genera", "Tooth_site", "Tooth_site", "Tooth site")
og_tooth
evenness_tooth <- plot_box_whisker(malt_genus.decontam_filtered.alpha, "Pileou_evenness", "Tooth_site", "Tooth_site", "Tooth site")
evenness_tooth

# ggsave("./05-results.backup/og_env.pdf", plot = og_env, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)
# 
# ggsave("./05-results.backup/og_ethnicity.pdf", plot = og_ethnicity, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)
# 
# ggsave("./05-results.backup/og_market.pdf", plot = og_market, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)
# 
# ggsave("./05-results.backup/og_age.pdf", plot = og_age, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)
# 
# ggsave("./05-results.backup/og_village.pdf", plot = og_village, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)
# 
# ggsave("./05-results.backup/og_tooth.pdf", plot = og_tooth, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)
# 
# ggsave("./05-results.backup/evenness_tooth.pdf", plot = evenness_tooth, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

# add metadata to the table
malt_genus.decontam_filtered.alpha_meta <- malt_genus.decontam_filtered.alpha %>%
  inner_join(., metadata_nofactors %>%
               select(SampleID, Env, Age, Age_group, Ethnic_Group, 
                      Market_economy, Sex, Tooth_site, Village), by = "SampleID")

# define the metadata categories to test for significnat differences in diversity
Envmt <- colnames(malt_genus.decontam_filtered.alpha_meta %>%
                    select(Env, Age_group, Ethnic_Group, 
                           Market_economy, Sex, Tooth_site, Village))

# test for significant differences in diversity between the metadata categories
genus_kruskal_pvals <- lapply(Envmt, function(envmt) {
pvalues_envmt <- malt_genus.decontam_filtered.alpha_meta %>%
  select(SampleID, Observed_genera, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  kruskal_test(Observed_genera ~ lastone) %>% # number of genus
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., malt_genus.decontam_filtered.alpha_meta %>% 
              select(SampleID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            kruskal_test(Shannon_index ~ lastone) %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., malt_genus.decontam_filtered.alpha_meta %>% 
              select(SampleID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            kruskal_test(Pileou_evenness ~ lastone) %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble() %>%
  arrange(p)

genus_kruskal_pvals

# pull out only the metadata categories that were significantly different between groups from the Kruskal-Wallace test
Envmt_sig <- genus_kruskal_pvals %>%
  filter(p <= 0.05) %>%
  distinct(Category) %>%
  pull(Category)

# and run a post-hoc test on those metadata categories to see which groups in them are significantly different
genus_wilcox_pvals <- lapply(Envmt_sig, function(envmt) {
pvalues_envmt <- malt_genus.decontam_filtered.alpha_meta %>%
  select(SampleID, Observed_genera, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  pairwise_wilcox_test(Observed_genera ~ lastone, p.adjust.method = "fdr") %>% # number of genus
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., malt_genus.decontam_filtered.alpha_meta %>% 
              select(SampleID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            pairwise_wilcox_test(Shannon_index ~ lastone, p.adjust.method = "fdr") %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., malt_genus.decontam_filtered.alpha_meta %>% 
              select(SampleID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            pairwise_wilcox_test(Pileou_evenness ~ lastone, p.adjust.method = "fdr") %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble( )%>%
  arrange(p.adj)

genus_wilcox_pvals

```
Six metadata categories have significant differences in diversity. Number of
genera: Env (p = 0.00000346), Tooth site (p = 0.00000382), Ethnic group (p =
0.00000438), Village (p = 0.0000055), Age group (p = 0.000111), and Market
economy (p = 0.0000974); Evenness: Tooth site (p = 0.0315). The post-hoc tests
show significant differences in Age group between all age categories and HMP
(18-29,40-49,50-59 p=0.000555; 30-39 p=0.00069; 60+ p=0.014) where HMP is always
lower. Significant differences in Env between HMP and HunterGatherer (p =
0.0000019) and HMP and JAE (p = 0.006) where HMP is lower than both HG and JAE.
Significant differences in Ethnic group between HMP and Baka (p = 0.00000121),
HMP and Nzime (p = 0.003), and HMP and JAE (p = 0.008), where is lower than all
others. Significant differences in Market economy between Industrial and Forrest
camp (p = 0.000163), Industrial and Logging road (p = 0.002), Industrial and
Farming (p = 0.04), where Industrial is lower than all 3. Significant
differences in Village between HMP and 204 (p = 0.0000191), HMP and 202 (p =
0.001), HMP and 205 (p = 0.001), HMP and 203 (p = 0.002), HMP and JAE (p =
0.016), 204 and 206 (p = 0.017), where HMP is lower than all others, and 206 is
lower than 204. Significant differences in number of genera in Tooth site
between HMP and Anterior (p = 0.0000097), and HMP and Posterior (p = 0.0000097),
where HMP is lower than the others, and significnat differences in evenness of
Tooth site between Anterior and Posterior (p = 0.026), where anterior is higher
than posterior.

## Diversity of CMC samples only
Let's also look at the CMC samples alone, without the HMP and JAE samples. Are
there differences in diversity between the various metadata groups?


### Stats for CMC samples only
```{r samples_stats_species_cmc}
# Filtered species tables alpha-diversity stats
# get the number of observed species
presabs_table_f <- malt_species.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("SRR|JAE|EXB|LIB")) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam") %>%
                                         mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
                                         filter(Percent > 0.001) %>%
                                         select(-one_of(c("Sum_species.decontam","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts) %>%
                                         gather("Species","Counts",2:ncol(.)) %>%
                                         mutate(Counts = ifelse(Counts > 0, 1, 0)) %>%
                                         spread(Species, Counts) %>%
                                         column_to_rownames("SampleID")
  
# calculate observed species for each sample with janitor 'adorn_totals'
malt_species.decontam_filtered.alpha <- presabs_table_f %>%
  adorn_totals(., where = "col", name = "Observed_species") %>%
  select(Observed_species) %>%
  rownames_to_column("SampleID") 


# get the Shannon index
malt_species.decontam_filtered.matrix <- as.matrix(malt_species.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("SRR|JAE|EXB|LIB")) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam") %>%
                                         mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
                                         filter(Percent > 0.001) %>%
                                         select(-one_of(c("Sum_species.decontam","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts) %>% 
                                         column_to_rownames("SampleID"))

malt_species.decontam_filtered.shannon <- as.data.frame(diversity(malt_species.decontam_filtered.matrix, index = "shannon"))
names(malt_species.decontam_filtered.shannon)[1] <- "Shannon_index"

# convert row names to a column and combine with the observed species table
malt_species.decontam_filtered.alpha <- malt_species.decontam_filtered.alpha %>%
  full_join(., malt_species.decontam_filtered.shannon %>%
  rownames_to_column("SampleID"), by = "SampleID")
  
# Get the evenness index
evenness.species_filtered <- diversity(malt_species.decontam_filtered.matrix)
evenness.species_filtered <- as.data.frame(evenness.species_filtered/log(specnumber(malt_species.decontam_filtered.matrix)))
names(evenness.species_filtered)[1] <- "Pileou_evenness"

# merge with the metadata file and plot
malt_species.decontam_filtered.alpha <- malt_species.decontam_filtered.alpha %>%
  full_join(., evenness.species_filtered %>%
  rownames_to_column("SampleID"), by = "SampleID")

# now plot the observed species
plot_box_whisker(malt_species.decontam_filtered.alpha, "Observed_species", "Ethnic_Group", "Ethnic_Group", "Ethnic group")
plot_box_whisker(malt_species.decontam_filtered.alpha, "Shannon_index", "Ethnic_Group", "Ethnic_Group", "Ethnic group")
plot_box_whisker(malt_species.decontam_filtered.alpha, "Pileou_evenness", "Ethnic_Group", "Ethnic_Group", "Ethnic group")
shannon_sex <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Shannon_index", "Sex", "Sex", "Sex")
shannon_sex
evenness_sex <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Pileou_evenness", "Sex", "Sex", "Sex")
evenness_sex
os_tooth <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Observed_species", "Tooth_site", "Tooth_site", "Tooth site")
os_tooth

# ggsave("./05-results.backup/shannon_sex.pdf", plot = shannon_sex, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)
# 
# ggsave("./05-results.backup/evenness_sex.pdf", plot = evenness_sex, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)
# 
# ggsave("./05-results.backup/os_tooth.pdf", plot = os_tooth, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

# add metadata to the table
malt_species.decontam_filtered.alpha_meta <- malt_species.decontam_filtered.alpha %>%
  inner_join(., metadata_nofactors %>%
               select(SampleID, Age, Age_group, Ethnic_Group, 
                      Market_economy, Sex, Tooth_site, Village), by = "SampleID")

# define the metadata categories to test for significnat differences in diversity
Envmt <- colnames(malt_species.decontam_filtered.alpha_meta %>%
                    select(Age_group, Ethnic_Group, 
                           Market_economy, Sex, Tooth_site, Village))

# test for significant differences in diversity between the metadata categories
species_kruskal_pvals <- lapply(Envmt, function(envmt) {
pvalues_envmt <- malt_species.decontam_filtered.alpha_meta %>%
  select(SampleID, Observed_species, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  kruskal_test(Observed_species ~ lastone) %>% # number of species
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., malt_species.decontam_filtered.alpha_meta %>% 
              select(SampleID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            kruskal_test(Shannon_index ~ lastone) %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., malt_species.decontam_filtered.alpha_meta %>% 
              select(SampleID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            kruskal_test(Pileou_evenness ~ lastone) %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble() %>%
  arrange(p)
species_kruskal_pvals

# pull out only the metadata categories that were significantly different between groups from the Kruskal-Wallace test
Envmt_sig <- species_kruskal_pvals %>%
  filter(p <= 0.05) %>%
  distinct(Category) %>%
  pull(Category)

# and run a post-hoc test on those metadata categories to see which groups in them are significantly different
species_wilcox_pvals <- lapply(Envmt_sig, function(envmt) {
pvalues_envmt <- malt_species.decontam_filtered.alpha_meta %>%
  select(SampleID, Observed_species, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  pairwise_wilcox_test(Observed_species ~ lastone, p.adjust.method = "fdr") %>% # number of species
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., malt_species.decontam_filtered.alpha_meta %>% 
              select(SampleID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            pairwise_wilcox_test(Shannon_index ~ lastone, p.adjust.method = "fdr") %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., malt_species.decontam_filtered.alpha_meta %>% 
              select(SampleID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            pairwise_wilcox_test(Pileou_evenness ~ lastone, p.adjust.method = "fdr") %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble( )%>%
  arrange(p.adj)

species_wilcox_pvals

```
Two metadata categories have significant differences in diversity, Sex (Shannon
index (p = 0.0392), and Evenness (p = 0.00982)) and Tooth site (number of
species (p = 0.0427)). The post-hoc test show that in the Tooth site category
Anterior is significantly (p.adj = 0.043) is significnatly higher than
Posterior. In the sex category Females are significantly higher in Shannon index
(p = 0.039) and Evenness (p = 0.009) than Males.


```{r samples_stats_genus_cmc}
# Filtered genus tables alpha-diversity stats
# get the number of observed genus
presabs_table_f <- malt_genus.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("SRR|JAE|EXB|LIB")) %>%
                                         adorn_totals(where = "col", name = "Sum_genus.decontam") %>%
                                         mutate(Percent = Sum_genus.decontam/sum(Sum_genus.decontam)*100) %>%
                                         filter(Percent > 0.001) %>%
                                         select(-one_of(c("Sum_genus.decontam","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts) %>%
                                         gather("Species","Counts",2:ncol(.)) %>%
                                         mutate(Counts = ifelse(Counts > 0, 1, 0)) %>%
                                         spread(Species, Counts) %>%
                                         column_to_rownames("SampleID")
  
# calculate observed genus for each sample with janitor 'adorn_totals'
malt_genus.decontam_filtered.alpha <- presabs_table_f %>%
  adorn_totals(., where = "col", name = "Observed_genera") %>%
  select(Observed_genera) %>%
  rownames_to_column("SampleID") 


# get the Shannon index
malt_genus.decontam_filtered.matrix <- as.matrix(malt_genus.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("SRR|JAE|EXB|LIB")) %>%
                                         adorn_totals(where = "col", name = "Sum_genus.decontam") %>%
                                         mutate(Percent = Sum_genus.decontam/sum(Sum_genus.decontam)*100) %>%
                                         filter(Percent > 0.001) %>%
                                         select(-one_of(c("Sum_genus.decontam","Percent"))) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts) %>% 
                                         column_to_rownames("SampleID"))

malt_genus.decontam_filtered.shannon <- as.data.frame(diversity(malt_genus.decontam_filtered.matrix, index = "shannon"))
names(malt_genus.decontam_filtered.shannon)[1] <- "Shannon_index"

# convert row names to a column and combine with the observed genus table
malt_genus.decontam_filtered.alpha <- malt_genus.decontam_filtered.alpha %>%
  full_join(., malt_genus.decontam_filtered.shannon %>%
  rownames_to_column("SampleID"), by = "SampleID")
  
# Get the evenness index
evenness.genus_filtered <- diversity(malt_genus.decontam_filtered.matrix)
evenness.genus_filtered <- as.data.frame(evenness.genus_filtered/log(specnumber(malt_genus.decontam_filtered.matrix)))
names(evenness.genus_filtered)[1] <- "Pileou_evenness"

# merge with the metadata file and plot
malt_genus.decontam_filtered.alpha <- malt_genus.decontam_filtered.alpha %>%
  full_join(., evenness.genus_filtered %>%
  rownames_to_column("SampleID"), by = "SampleID")

# now plot the observed genus
plot_box_whisker(malt_genus.decontam_filtered.alpha, "Observed_genera", "Ethnic_Group", "Ethnic_Group", "Ethnic group")
og_village <- plot_box_whisker(malt_genus.decontam_filtered.alpha, "Observed_genera", "Village", "Village", "Village")
og_village
shannong_tooth <- plot_box_whisker(malt_genus.decontam_filtered.alpha, "Shannon_index", "Tooth_site", "Tooth_site", "Tooth site")
shannong_tooth
evennessg_tooth <- plot_box_whisker(malt_genus.decontam_filtered.alpha, "Pileou_evenness", "Tooth_site", "Tooth_site", "Tooth site")
evennessg_tooth

# ggsave("./05-results.backup/og_village.pdf", plot = og_village, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)
# 
# ggsave("./05-results.backup/shannong_tooth.pdf", plot = shannong_tooth, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)
# 
# ggsave("./05-results.backup/evennessg_tooth.pdf", plot = evennessg_tooth, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

# add metadata to the table
malt_genus.decontam_filtered.alpha_meta <- malt_genus.decontam_filtered.alpha %>%
  inner_join(., metadata_nofactors %>%
               select(SampleID, Env, Age_group, Ethnic_Group, 
                      Market_economy, Sex, Tooth_site, Village), by = "SampleID")

# define the metadata categories to test for significnat differences in diversity
Envmt <- colnames(malt_genus.decontam_filtered.alpha_meta %>%
                    select(Age_group, Ethnic_Group, 
                           Market_economy, Sex, Tooth_site, Village))

# test for significant differences in diversity between the metadata categories
genus_kruskal_pvals <- lapply(Envmt, function(envmt) {
pvalues_envmt <- malt_genus.decontam_filtered.alpha_meta %>%
  select(SampleID, Observed_genera, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  kruskal_test(Observed_genera ~ lastone) %>% # number of genus
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., malt_genus.decontam_filtered.alpha_meta %>% 
              select(SampleID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            kruskal_test(Shannon_index ~ lastone) %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., malt_genus.decontam_filtered.alpha_meta %>% 
              select(SampleID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            kruskal_test(Pileou_evenness ~ lastone) %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble() %>%
  arrange(p)

genus_kruskal_pvals

# pull out only the metadata categories that were significantly different between groups from the Kruskal-Wallace test
Envmt_sig <- genus_kruskal_pvals %>%
  filter(p <= 0.05) %>%
  distinct(Category) %>%
  pull(Category)

# and run a post-hoc test on those metadata categories to see which groups in them are significantly different
genus_wilcox_pvals <- lapply(Envmt_sig, function(envmt) {
pvalues_envmt <- malt_genus.decontam_filtered.alpha_meta %>%
  select(SampleID, Observed_genera, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  pairwise_wilcox_test(Observed_genera ~ lastone, p.adjust.method = "fdr") %>% # number of genus
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., malt_genus.decontam_filtered.alpha_meta %>% 
              select(SampleID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            pairwise_wilcox_test(Shannon_index ~ lastone, p.adjust.method = "fdr") %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., malt_genus.decontam_filtered.alpha_meta %>% 
              select(SampleID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            pairwise_wilcox_test(Pileou_evenness ~ lastone, p.adjust.method = "fdr") %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble( )%>%
  arrange(p.adj)

genus_wilcox_pvals

```
Two metadata categories have significant differences in diversity, Tooth site
(Shannon index (p = 0.0123), and Evenness (p = 0.00185)) and Village (number of
genera (p = 0.0423)). The post-hoc test show that in the Tooth site category
Anterior has higher Shannon index (p.adj = 0.012) and Evenness (p.adj = 0.002)
than Posterior. In the village category 204 has significantly higher number of
genera (p = 0.047) than 206.

## Heatmaps
```{r metadata_heatmaps}
# read in metadata again to get it without all the factors
metadata_hm <- fread("00-documentation.backup/01-cameroon_hunter_gatherer_metadata.tsv")

# order the samples so they can be ordered this way in the heat maps

# order the CMC samples by Village
cmc_order <- metadata_hm %>%
  rename(SampleID = `#SampleID`)  %>%
  as_tibble() %>%
  filter(str_detect(SampleID, "CMC")) %>%
  mutate(Village = fct_relevel(Village, "202","205","204","203","206")) %>%
  select(SampleID, Village) %>%
  arrange(Village) %>%
  pull(SampleID)

# order the HMP samples by subplaque, supraplaque
hmp_order <- metadata_hm %>%
  rename(SampleID = `#SampleID`)  %>%
  as_tibble() %>%
  filter(str_detect(SampleID, "SRR")) %>%
  filter(!str_detect(SampleID, "10M|SRR164")) %>%
  mutate(Description = fct_relevel(Description, "HMP_subPlaque","HMP_supPlaque")) %>%
  select(SampleID, Description) %>%
  arrange(Description) %>%
  pull(SampleID)

# keep JAE samples in alphabetical order
jae_order <- metadata_hm %>%
  rename(SampleID = `#SampleID`)  %>%
  as_tibble() %>%
  filter(str_detect(SampleID, "JAE")) %>%
  filter(!str_detect(SampleID, "10M")) %>%
  pull(SampleID)

# combine all 3 ordered vectors into a final ordered vector
each_order <- c(cmc_order, jae_order, hmp_order)

```


Now make heatmaps of the top 50 most abundant species and genera (as an arbitrary cut-off)
```{r heatmaps_species_all}
# select the top 50 most abundant species for all samples (CMC, JAE, HMP)
malt_species.decontam_top50_all <- malt_species.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("SRR164|10M|EXB|LIB")) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam") %>%
                                         mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
                                         top_n(50, Percent) %>%
                                         select(-one_of("Sum_species.decontam","Percent")) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts)

rownames(malt_species.decontam_top50_all) <- malt_species.decontam_top50_all$SampleID
malt_species.decontam_top50_all <- malt_species.decontam_top50_all %>% select(-SampleID)

# CLR-transform the matrix for plotting the heatmap
malt_species.decontam_top50_all_clr = malt_species.decontam_top50_all+1
malt_species.decontam_top50_all_clr <- clr(malt_species.decontam_top50_all_clr)
malt_species.decontam_top50_all_clr <- as.matrix(malt_species.decontam_top50_all_clr)

# orient the matrix with correct rows/columns to run the distance calculation for the species, not the samples (columns are SampleID, rows are Species)
malt_species.decontam_top50_all_clr_sp <- malt_species.decontam_top50_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","Counts",2:ncol(.)) %>%
  spread(SampleID,Counts)

#add the rownames back
rownames(malt_species.decontam_top50_all_clr_sp) <- malt_species.decontam_top50_all_clr_sp$Species
malt_species.decontam_top50_all_clr_sp <- malt_species.decontam_top50_all_clr_sp %>% select(-Species)

# perform a distance calculation for hierarchical clustering for the species ordering
malt_species.decontam_top50_all_clr_dist <- vegdist(malt_species.decontam_top50_all_clr_sp, method = "euclidian")
# cluster the data with hclust
malt_species.decontam_top50_all_clr_dist_hr <- hclust(malt_species.decontam_top50_all_clr_dist)
# malt_species.decontam_top50_all_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
sp_all_order <- malt_species.decontam_top50_all_clr_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
malt_species.decontam_top50_all_clr_order <- malt_species.decontam_top50_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(SpOrder = as.character(seq(1,50))) %>%
  select(Species, SpOrder, everything()) %>%
  mutate(SpOrder = fct_relevel(SpOrder, sp_all_order)) %>%
  arrange(SpOrder) %>%
  pull(Species)

# make the species a factor so they're in the correct order for the heatmap using the vector from the step above
malt_species.decontam_top50_all_clr_long <- malt_species.decontam_top50_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, malt_species.decontam_top50_all_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.))

# make a heatmap with ggplot
heatmap_base <- ggplot(malt_species.decontam_top50_all_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_base

```

```{r heatmaps_species_cmc}

# select the top 50 most abundant species for CMC samples
malt_species.decontam_top50_cmc <- malt_species.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("SRR|JAE|10M|EXB|LIB")) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam") %>%
                                         mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
                                         top_n(50, Percent) %>%
                                         select(-one_of("Sum_species.decontam","Percent")) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts)

rownames(malt_species.decontam_top50_cmc) <- malt_species.decontam_top50_cmc$SampleID
malt_species.decontam_top50_cmc <- malt_species.decontam_top50_cmc %>% select(-SampleID)

# also save the species as a vector
malt_species.decontam_top50_cmcV <- malt_species.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("SRR|10M|EXB|LIB")) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam") %>%
                                         mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
                                         top_n(50, Percent) %>%
                                         select(-one_of("Sum_species.decontam","Percent")) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(SampleID,Counts) %>%
                                         select(Species) %>%
                                         mutate(CMC = 1)


# CLR-transform the matrix for plotting the heatmap
malt_species.decontam_top50_cmc_clr = malt_species.decontam_top50_cmc+1
malt_species.decontam_top50_cmc_clr <- clr(malt_species.decontam_top50_cmc_clr)
malt_species.decontam_top50_cmc_clr <- as.matrix(malt_species.decontam_top50_cmc_clr)
# orient the matrix with correct rows/columns to run the distance calculation for the species, not the samples (columns are SampleID, rows are Species)
malt_species.decontam_top50_cmc_clr_sp <- malt_species.decontam_top50_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","Counts",2:ncol(.)) %>%
  spread(SampleID,Counts)

#add the rownames back
rownames(malt_species.decontam_top50_cmc_clr_sp) <- malt_species.decontam_top50_cmc_clr_sp$Species
malt_species.decontam_top50_cmc_clr_sp <- malt_species.decontam_top50_cmc_clr_sp %>% select(-Species)

# perform a distance calculation for hierarchical clustering for the species ordering
malt_species.decontam_top50_cmc_clr_dist <- vegdist(malt_species.decontam_top50_cmc_clr_sp, method = "euclidian")
# cluster the data with hclust
malt_species.decontam_top50_cmc_clr_dist_hr <- hclust(malt_species.decontam_top50_cmc_clr_dist)
# malt_species.decontam_top50_cmc_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
sp_cmc_order <- malt_species.decontam_top50_cmc_clr_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
malt_species.decontam_top50_cmc_clr_order <- malt_species.decontam_top50_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(SpOrder = as.character(seq(1,50))) %>%
  select(Species, SpOrder, everything()) %>%
  mutate(SpOrder = fct_relevel(SpOrder, sp_cmc_order)) %>%
  arrange(SpOrder) %>%
  pull(Species)

# make the species a factor so they're in the correct order for the heatmap using the vector from the step above
malt_species.decontam_top50_cmc_clr_long <- malt_species.decontam_top50_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, malt_species.decontam_top50_cmc_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.))

# make a heat map for just the CMC samples
heatmap_base <- ggplot(malt_species.decontam_top50_cmc_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_base

```

```{r heatmaps_species_each}
# the section above for CMC samples has to be run before this one. this section uses output from that one
# select the top 50 most abundant species for HMP samples
malt_species.decontam_top50_hmpV <- malt_species.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("CMC|SRR164|JAE|10M|EXB|LIB")) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam") %>%
                                         mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
                                         top_n(50, Percent) %>%
                                         select(-one_of("Sum_species.decontam","Percent")) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(SampleID,Counts) %>%
                                         select(Species) %>%
                                         mutate(HMP = 1)

# select the top 50 most abundant species for JAE samples
malt_species.decontam_top50_jaeV <- malt_species.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("CMC|SRR|10M|EXB|LIB")) %>%
                                         adorn_totals(where = "col", name = "Sum_species.decontam") %>%
                                         mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
                                         top_n(50, Percent) %>%
                                         select(-one_of("Sum_species.decontam","Percent")) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(SampleID,Counts) %>%
                                         select(Species) %>%
                                         mutate(JAE = 1)


# Now select only those species (top 50 of CMC, HMP, JAE) out of the table to create a new matrix
malt_species.decontam_top50_each_list <- malt_species.decontam_top50_cmcV %>%
  bind_rows(., malt_species.decontam_top50_hmpV) %>%
  bind_rows(., malt_species.decontam_top50_jaeV) %>%
  select(Species) %>%
  unique() %>%
  pull()

malt_species.decontam_top50_each <- malt_species.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("SRR164|10M|EXB|LIB")) %>%
                                         filter(Species %in% malt_species.decontam_top50_each_list) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts)

rownames(malt_species.decontam_top50_each) <- malt_species.decontam_top50_each$SampleID
malt_species.decontam_top50_each <- malt_species.decontam_top50_each %>% select(-SampleID)

# 77 of 150 species are left after unique() - how many species are in the top 50 of all 3 (26)? of JAE and HMP (the same 26)? of CMC and JAE (46)? of CMC and HMP (27)?
all3 <- malt_species.decontam_top50_cmcV %>%
  full_join(., malt_species.decontam_top50_jaeV) %>%
  full_join(., malt_species.decontam_top50_hmpV) %>%
  replace(is.na(.), 0) %>%
  adorn_totals(where = "col")


# CLR-transform the matrix for plotting the heatmap
malt_species.decontam_top50_each_clr = malt_species.decontam_top50_each+1
malt_species.decontam_top50_each_clr <- clr(malt_species.decontam_top50_each_clr)
malt_species.decontam_top50_each_clr <- as.matrix(malt_species.decontam_top50_each_clr)

# orient the matrix with correct rows/columns to run the distance calculation for the species, not the samples (columns are SampleID, rows are Species)
malt_species.decontam_top50_each_clr_sp <- malt_species.decontam_top50_each_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","Counts",2:ncol(.)) %>%
  spread(SampleID,Counts)

#add the rownames back
rownames(malt_species.decontam_top50_each_clr_sp) <- malt_species.decontam_top50_each_clr_sp$Species
malt_species.decontam_top50_each_clr_sp <- malt_species.decontam_top50_each_clr_sp %>% select(-Species)

# perform a distance calculation for hierarchical clustering for the species ordering
malt_species.decontam_top50_each_clr_dist <- vegdist(malt_species.decontam_top50_each_clr_sp, method = "euclidian")
# cluster the data with hclust
malt_species.decontam_top50_each_clr_dist_hr <- hclust(malt_species.decontam_top50_each_clr_dist)
# malt_species.decontam_top50_each_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
sp_each_order <- malt_species.decontam_top50_each_clr_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
malt_species.decontam_top50_each_clr_order <- malt_species.decontam_top50_each_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(SpOrder = as.character(seq(1,77))) %>%
  select(Species, SpOrder, everything()) %>%
  mutate(SpOrder = fct_relevel(SpOrder, sp_each_order)) %>%
  arrange(SpOrder) %>%
  pull(Species)

# make the species a factor so they're in the correct order for the heatmap using the vector from the step above
malt_species.decontam_top50_each_clr_long <- malt_species.decontam_top50_each_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, malt_species.decontam_top50_each_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.))

# make the heatmap with ggplot
heatmap_base <- ggplot(malt_species.decontam_top50_each_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_base

ggsave("./05-results.backup/top50species_each_heatmap.pdf", plot = heatmap_base, device = "pdf",
       scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

```




```{r heatmaps_genus_all}
# select the top 50 most abundant genera for all samples (CMC, JAE, HMP)
malt_genus.decontam_top50_all <- malt_genus.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("SRR164|10M|EXB|LIB")) %>%
                                         adorn_totals(where = "col", name = "Sum_genus.decontam") %>%
                                         mutate(Percent = Sum_genus.decontam/sum(Sum_genus.decontam)*100) %>%
                                         top_n(50, Percent) %>%
                                         select(-one_of("Sum_genus.decontam","Percent")) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts)

rownames(malt_genus.decontam_top50_all) <- malt_genus.decontam_top50_all$SampleID
malt_genus.decontam_top50_all <- malt_genus.decontam_top50_all %>% select(-SampleID)

# CLR-transform the matrix for plotting the heatmap
malt_genus.decontam_top50_all_clr = malt_genus.decontam_top50_all+1
malt_genus.decontam_top50_all_clr <- clr(malt_genus.decontam_top50_all_clr)
malt_genus.decontam_top50_all_clr <- as.matrix(malt_genus.decontam_top50_all_clr)

# orient the matrix with correct rows/columns to run the distance calculation for the genera, not the samples (columns are SampleID, rows are genera)
malt_genus.decontam_top50_all_clr_sp <- malt_genus.decontam_top50_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("genus","Counts",2:ncol(.)) %>%
  spread(SampleID,Counts)

#add the rownames back
rownames(malt_genus.decontam_top50_all_clr_sp) <- malt_genus.decontam_top50_all_clr_sp$genus
malt_genus.decontam_top50_all_clr_sp <- malt_genus.decontam_top50_all_clr_sp %>% select(-genus)

# perform a distance calculation for hierarchical clustering for the genus ordering
malt_genus.decontam_top50_all_clr_dist <- vegdist(malt_genus.decontam_top50_all_clr_sp, method = "euclidian")
# cluster the data with hclust
malt_genus.decontam_top50_all_clr_dist_hr <- hclust(malt_genus.decontam_top50_all_clr_dist)
# malt_genus.decontam_top50_all_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
sp_all_order <- malt_genus.decontam_top50_all_clr_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the genus in the correct order for the heatmap
malt_genus.decontam_top50_all_clr_order <- malt_genus.decontam_top50_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("genus","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(SpOrder = as.character(seq(1,50))) %>%
  select(genus, SpOrder, everything()) %>%
  mutate(SpOrder = fct_relevel(SpOrder, sp_all_order)) %>%
  arrange(SpOrder) %>%
  pull(genus)

# make the genera a factor so they're in the correct order for the heatmap using the vector from the step above
malt_genus.decontam_top50_all_clr_long <- malt_genus.decontam_top50_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("genus","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(genus = fct_relevel(genus, malt_genus.decontam_top50_all_clr_order)) %>%
  arrange(genus) %>%
  gather("SampleID","CLR", 2:ncol(.))

# make a heatmap with ggplot
heatmap_base <- ggplot(malt_genus.decontam_top50_all_clr_long, aes(SampleID, genus, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_base

ggsave("./05-results.backup/top50genera_each_heatmap.pdf", plot = heatmap_base, device = "pdf",
       scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

```

```{r heatmaps_genus_cmc}

# select the top 50 most abundant genera for CMC samples
malt_genus.decontam_top50_cmc <- malt_genus.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("SRR|JAE|10M|EXB|LIB")) %>%
                                         adorn_totals(where = "col", name = "Sum_genus.decontam") %>%
                                         mutate(Percent = Sum_genus.decontam/sum(Sum_genus.decontam)*100) %>%
                                         top_n(50, Percent) %>%
                                         select(-one_of("Sum_genus.decontam","Percent")) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts)

rownames(malt_genus.decontam_top50_cmc) <- malt_genus.decontam_top50_cmc$SampleID
malt_genus.decontam_top50_cmc <- malt_genus.decontam_top50_cmc %>% select(-SampleID)

# also save the genera as a vector
malt_genus.decontam_top50_cmcV <- malt_genus.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("SRR|10M|EXB|LIB")) %>%
                                         adorn_totals(where = "col", name = "Sum_genus.decontam") %>%
                                         mutate(Percent = Sum_genus.decontam/sum(Sum_genus.decontam)*100) %>%
                                         top_n(50, Percent) %>%
                                         select(-one_of("Sum_genus.decontam","Percent")) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(SampleID,Counts) %>%
                                         select(Species) %>%
                                         mutate(CMC = 1)


# CLR-transform the matrix for plotting the heatmap
malt_genus.decontam_top50_cmc_clr = malt_genus.decontam_top50_cmc+1
malt_genus.decontam_top50_cmc_clr <- clr(malt_genus.decontam_top50_cmc_clr)
malt_genus.decontam_top50_cmc_clr <- as.matrix(malt_genus.decontam_top50_cmc_clr)
# orient the matrix with correct rows/columns to run the distance calculation for the genus, not the samples (columns are SampleID, rows are genus)
malt_genus.decontam_top50_cmc_clr_sp <- malt_genus.decontam_top50_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("genus","Counts",2:ncol(.)) %>%
  spread(SampleID,Counts)

#add the rownames back
rownames(malt_genus.decontam_top50_cmc_clr_sp) <- malt_genus.decontam_top50_cmc_clr_sp$genus
malt_genus.decontam_top50_cmc_clr_sp <- malt_genus.decontam_top50_cmc_clr_sp %>% select(-genus)

# perform a distance calculation for hierarchical clustering for the genus ordering
malt_genus.decontam_top50_cmc_clr_dist <- vegdist(malt_genus.decontam_top50_cmc_clr_sp, method = "euclidian")
# cluster the data with hclust
malt_genus.decontam_top50_cmc_clr_dist_hr <- hclust(malt_genus.decontam_top50_cmc_clr_dist)
# malt_genus.decontam_top50_cmc_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
sp_cmc_order <- malt_genus.decontam_top50_cmc_clr_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the genera in the correct order for the heatmap
malt_genus.decontam_top50_cmc_clr_order <- malt_genus.decontam_top50_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("genus","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(SpOrder = as.character(seq(1,50))) %>%
  select(genus, SpOrder, everything()) %>%
  mutate(SpOrder = fct_relevel(SpOrder, sp_cmc_order)) %>%
  arrange(SpOrder) %>%
  pull(genus)

# make the genera a factor so they're in the correct order for the heatmap using the vector from the step above
malt_genus.decontam_top50_cmc_clr_long <- malt_genus.decontam_top50_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("genus","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(genus = fct_relevel(genus, malt_genus.decontam_top50_cmc_clr_order)) %>%
  arrange(genus) %>%
  gather("SampleID","CLR", 2:ncol(.))

# make a heat map for just the CMC samples
heatmap_base <- ggplot(malt_genus.decontam_top50_cmc_clr_long, aes(SampleID, genus, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_base

```

```{r heatmaps_genus_each}
# the section above for CMC samples has to be run before this one. this section uses output from that one
# select the top 50 most abundant genera for HMP samples
malt_genus.decontam_top50_hmpV <- malt_genus.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("CMC|SRR164|JAE|10M|EXB|LIB")) %>%
                                         adorn_totals(where = "col", name = "Sum_genus.decontam") %>%
                                         mutate(Percent = Sum_genus.decontam/sum(Sum_genus.decontam)*100) %>%
                                         top_n(50, Percent) %>%
                                         select(-one_of("Sum_genus.decontam","Percent")) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(SampleID,Counts) %>%
                                         select(Species) %>%
                                         mutate(HMP = 1)

# select the top 50 most abundant genera for JAE samples
malt_genus.decontam_top50_jaeV <- malt_genus.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("CMC|SRR|10M|EXB|LIB")) %>%
                                         adorn_totals(where = "col", name = "Sum_genus.decontam") %>%
                                         mutate(Percent = Sum_genus.decontam/sum(Sum_genus.decontam)*100) %>%
                                         top_n(50, Percent) %>%
                                         select(-one_of("Sum_genus.decontam","Percent")) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(SampleID,Counts) %>%
                                         select(Species) %>%
                                         mutate(JAE = 1)


# Now select only those genera (top 50 of CMC, HMP, JAE) out of the table to create a new matrix
malt_genus.decontam_top50_each_list <- malt_genus.decontam_top50_cmcV %>%
  bind_rows(., malt_genus.decontam_top50_hmpV) %>%
  bind_rows(., malt_genus.decontam_top50_jaeV) %>%
  select(Species) %>%
  unique() %>%
  pull()

malt_genus.decontam_top50_each <- malt_genus.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("SRR164|10M|EXB|LIB")) %>%
                                         filter(Species %in% malt_genus.decontam_top50_each_list) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         spread(Species,Counts)

rownames(malt_genus.decontam_top50_each) <- malt_genus.decontam_top50_each$SampleID
malt_genus.decontam_top50_each <- malt_genus.decontam_top50_each %>% select(-SampleID)

# XX of XX genera are left after unique() - how many genus are in the top 50 of all 3 (XX)? of JAE and HMP (XX)? of CMC and JAE (XX)? of CMC and HMP (XX)?
all3 <- malt_genus.decontam_top50_cmcV %>%
  full_join(., malt_genus.decontam_top50_jaeV) %>%
  full_join(., malt_genus.decontam_top50_hmpV) %>%
  replace(is.na(.), 0) %>%
  adorn_totals(where = "col")


# CLR-transform the matrix for plotting the heatmap
malt_genus.decontam_top50_each_clr = malt_genus.decontam_top50_each+1
malt_genus.decontam_top50_each_clr <- clr(malt_genus.decontam_top50_each_clr)
malt_genus.decontam_top50_each_clr <- as.matrix(malt_genus.decontam_top50_each_clr)

# orient the matrix with correct rows/columns to run the distance calculation for the genera, not the samples (columns are SampleID, rows are genera)
malt_genus.decontam_top50_each_clr_sp <- malt_genus.decontam_top50_each_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("genus","Counts",2:ncol(.)) %>%
  spread(SampleID,Counts)

#add the rownames back
rownames(malt_genus.decontam_top50_each_clr_sp) <- malt_genus.decontam_top50_each_clr_sp$genus
malt_genus.decontam_top50_each_clr_sp <- malt_genus.decontam_top50_each_clr_sp %>% select(-genus)

# perform a distance calculation for hierarchical clustering for the genus ordering
malt_genus.decontam_top50_each_clr_dist <- vegdist(malt_genus.decontam_top50_each_clr_sp, method = "euclidian")
# cluster the data with hclust
malt_genus.decontam_top50_each_clr_dist_hr <- hclust(malt_genus.decontam_top50_each_clr_dist)
# malt_genus.decontam_top50_each_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
sp_each_order <- malt_genus.decontam_top50_each_clr_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the genera in the correct order for the heatmap
malt_genus.decontam_top50_each_clr_order <- malt_genus.decontam_top50_each_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("genus","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(SpOrder = as.character(seq(1,60))) %>%
  select(genus, SpOrder, everything()) %>%
  mutate(SpOrder = fct_relevel(SpOrder, sp_each_order)) %>%
  arrange(SpOrder) %>%
  pull(genus)

# make the genera a factor so they're in the correct order for the heatmap using the vector from the step above
malt_genus.decontam_top50_each_clr_long <- malt_genus.decontam_top50_each_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("genus","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(genus = fct_relevel(genus, malt_genus.decontam_top50_each_clr_order)) %>%
  arrange(genus) %>%
  gather("SampleID","CLR", 2:ncol(.))

# make the heatmap with ggplot
heatmap_base <- ggplot(malt_genus.decontam_top50_each_clr_long, aes(SampleID, genus, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_base

```

```{r samples_heatmap_uky}
heatmap_base <- ggplot(malt_species.decontam_top50_each_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_base

# ggsave("05-results.backup/heatmap_species_UKY.pdf", plot = heatmap_base, device = "pdf",
#        scale = 1, width = 7, height = 7, units = c("in"),
#        dpi = 300)

```


```{r heatmap_from_james, eval = F}

data_heatmap <- otu_matrix_pseudo_clr %>%  
  as_tibble(rownames = "Individual") %>%
  gather(Taxon, CLR, 2:ncol(.)) %>%
  left_join(raw_metadata) %>%
  left_join(common_colours_tbl) %>%
  mutate(Individual = factor(Individual, levels = list_individual), 
         Taxon = factor(Taxon, levels = list_taxa)) %>%
  arrange(Individual) %>%
  mutate(Host_Common = as_factor(Host_Common),
         Colour = as_factor(Colour))

vector_colour <- data_heatmap %>% 
  dplyr::select(Individual, Colour) %>% 
  unique %>% 
  pull(Colour) %>% 
  as.character()

heatmap_base <- ggplot(data_heatmap, aes(Taxon, Individual, fill = CLR)) +
  geom_tile() +
  ggtitle(paste("Centered Log Ratio Transformed Heatmap at", tax_level ,"level"), subtitle = paste0("Database: ", db, 
                                                                   ". Sources: ", sources, 
                                                                   ". Controls: ", controls, 
                                                                   ". Bad Samples: ", bad_samples,
                                                                   ". Min Support: ", minsupp_threshold,
                                                                   ". \nZero replacement: ", zero_trans,
                                                                   ". Min. Prevalence (Inds): ", prevalence_filter,
                                                                   ". Individual clustering: ", best_method,
                                                                   ". Taxon clustering: ", best_method_tax)) +
  #scale_fill_viridis_c() +
  scale_fill_distiller(palette = "Spectral") +
  scale_colour_manual(values = NA) +
  scale_x_discrete(position = "top") +
  theme_minimal(base_family = "Roboto", base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = -0.001),
        axis.text.y = element_text(colour = vector_colour),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")
# if colour sample labels wanted theme(element_text(colour = vector_colour))


```





























