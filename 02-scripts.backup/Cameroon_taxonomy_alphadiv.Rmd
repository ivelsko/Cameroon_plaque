---
title: "Cameroon hunter-gatherer calculus/plaque MALT alpha diversity"
author: "Irina Velsko"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output:
    github_document:
        fig_width: 8
        fig_height: 6
        toc: true
---

```{r load_libraries, echo = F, message = F}
library(knitr)
library(data.table)
library(rstatix)
library(vegan)
library(compositions)
library(janitor)
library(ggheatmap)
library(tidyverse)
library(gplots)
library(cowplot)
opts_chunk$set(echo=F, warning=F, message=F, dpi=150)
```

Set the working directory of the notebook to the parent directory of the 
notebook itself.

```{r setup}
knitr::opts_knit$set(root.dir = normalizePath(".."))
```

```{r load_data}

# load the taxonomy tables that have been decontaminated and the column headers are cleaned up
load("./05-results.backup/CMC_taxonomy_tables.RData")

# load the metadata file
load("./05-results.backup/CMC_metadata.RData")

# load the metadata file again with limited factors 
metadata_factors <- fread("./00-documentation.backup/01-cameroon_hunter_gatherer_metadata.tsv") %>%
  rename(SampleID = `#SampleID`) %>%
  mutate(Age_group = fct_relevel(Age_group, "10-18","18-29","30-39","40-49","50-59","60+","HMP","HMP10M"),
         Ethnic_Group = fct_relevel(Ethnic_Group, "Baka","Nzime","Yanomami","Industrial plaque","Industrial calculus","JAE10M",
                                     "ExtractionGauze","ExtractionBlank","LibraryBlank"),
         Env = fct_relevel(Env, "CMC","Industrial plaque","Industrial calculus",
                                     "ExtractionGauze","ExtractionBlank","LibraryBlank"),
         Market_integration = fct_relevel(Market_integration, "Logging road","Forrest camp","Farming","Yanomami",
                                      "Industrial","ExtractionGauze","ExtractionBlank","LibraryBlank"),
         Market_integration_split = fct_relevel(Market_integration_split, "Forrest camp","Logging road","Farming","Yanomami",
                                      "Industrial plaque","Industrial calculus", "ExtractionGauze","ExtractionBlank","LibraryBlank"),
         Sex = fct_relevel(Sex, "Female","Male"),
         Tooth_site = fct_relevel(Tooth_site, "Anterior","Posterior","Buccal_mucosa","HMP","HMP10M"),
         Type = fct_relevel(Type, "Calculus","Plaque","Blank"),
         Village = fct_relevel(Village, "202","205","204","203","206","Industrial plaque","Industrial calculus",
                               "ExtractionGauze","ExtractionBlank","LibraryBlank"))


# load the metadata file again without factors for stats
# so don't have extra unnecessary categories with factors
metadata_nofactors <- fread("./00-documentation.backup/01-cameroon_hunter_gatherer_metadata.tsv") %>%
  rename(SampleID = `#SampleID`)

# set limited colors w/o extra groups
Age_group_colors <- c(`18-29` = "#FF3200", `30-39` = "#E9B186", `40-49` = "#82CDAA", `50-59` = "#0686B8", `60+` = "#172869")
Age_group_shapes <- c(`18-29` = 15, `30-39` = 16, `40-49` = 17, `50-59` = 18, `60+` = 25)
Env_colors <- c(CMC = "#FF3200", `Industrial plaque` = "#969696", `Industrial calculus` = "#feb24c",  ExtractionGauze = "#252525", ExtractionBlank = "#737373", LibraryBlank = "#bdbdbd")
Env_shapes <- c(CMC = 19, HMP = 7, JAE = 7, ExtractionGauze = 8, ExtractionBlank = 4, LibraryBlank = 3)
Ethnic_Group_shapes <- c(Baka = 19, Nzime = 17,  Yanomami = 14, `Industrial plaque` = 7, `Industrial calculus` = 7)
Ethnic_Group_colors <- c(Baka = "#FF3200", Nzime = "#065FA3", `Industrial plaque` = "#969696", `Industrial calculus` = "#feb24c")
Market_integration_colors <- c(`Logging road` = "#FF3200", `Forrest camp` = "#065FA3", Farming = "#82CDAA")
Market_integration_shapes <- c(`Logging road` = 19, `Forrest camp` = 17, Farming = 18, Industrial = 15)
Village_colors <- c(`202` = "#FF3200", `205` = "#EF8158", `204` = "#E9BD8E", `203` = "#CBDDA7", `206` = "#38BCAD", `Industrial plaque` = "#969696", `Industrial calculus` = "#feb24c", ExtractionGauze = "#252525", ExtractionBlank = "#737373", LibraryBlank = "#bdbdbd")
Village_shapes <- c(`202` = 15, `203` = 16, `205` = 17,`204` = 18, `206` = 25, `Industrial plaque` = 7, `Industrial calculus` = 7)
Sex_colors <- c(Female = "#FF3200", Male = "#065FA3")
Sex_shapes <- c(Female = 19, Male = 17)
Tooth_site_colors <- c(Anterior = "#FF3200", Posterior = "#065FA3")
Tooth_site_shapes <- c(Anterior = 19, Posterior = 17)

```



```{r box_plotting_functions}

plot_box_whisker <- function(df, stat_info, metadata_group, fill_group, title_text) {
    fill_group_colors <- get(paste(fill_group, "_colors", sep = ""))

      df_X <- df %>%
              inner_join(metadata_factors %>%
                           select(SampleID, Env, Description, Ethnic_Group, Age_group, Sex, Market_integration,
                                  Market_integration_split, Village, Tooth_site, ExtractionBatch, LibraryBatch, Type), by = "SampleID")

    stat_info_table = df_X[[stat_info]]
    metadata_group = df_X[[metadata_group]]
    fill_group = df_X[[fill_group]]

    bx_wh_plot <- ggplot(df_X, aes(x = metadata_group, y = stat_info_table, fill = fill_group)) +
                         geom_boxplot() +
                         scale_fill_manual(values = fill_group_colors) +
                         theme_minimal(base_size = 18) +
                         #scale_y_continuous(trans='log10') +
                         #scale_y_continuous(trans='pseudo_log') +
                         theme(axis.text.x = element_text(angle = 45, hjust = 1),
                               text = element_text(size=20)) +
                         ylab(stat_info) +
                         xlab(metadata_group) +
                         ggtitle(title_text)

    return(bx_wh_plot)
}

```


List the outliers from the plot in section `raw_plot` in `Cameroon_h-g_taxonomy.Rmd` and remove them from the taxonomy table. 
```{r outliers}
outliers <- c("CMC032.B0101",
              "EXB059.A1901","EXB059.A1301","EXB059.A1101","EXB059.A0901",
              "SRR1646041")

outliersF <- str_c(outliers, collapse = "|")

```


# Alpha-diversity of all samples
First we want to know if there are differences in the total diveristy of
identified species between various metadata categories. We'll look at
alpha-diversity for this, using both the observed species and Shannon diverity
metrics. Observed species to tell us which metadata categories have more
species/genera, and Shannon to tell us which has more even distribution of
species/genera.

## Observed Speceies/Genera
```{r observed_species}
# make Relab binary to make a presence/absence table
presabs_table <- malt_species.decontam %>%
  select(-one_of(outliers)) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  select(-one_of(c("Sum_species.decontam","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  spread(Species,Counts) %>%
  gather("Species","Counts",2:ncol(.)) %>%
  mutate(Counts = ifelse(Counts > 0, 1, 0)) %>%
  spread(Species, Counts) %>%
  column_to_rownames("SampleID")

# calculate observed species for each sample with janitor 'adorn_totals'
malt_species.decontam.os <- presabs_table %>%
  adorn_totals(., where = "col", name = "Observed_species") %>%
  select(Observed_species) %>%
  rownames_to_column("SampleID") 

plot_box_whisker(malt_species.decontam.os, "Observed_species", "Env", "Env", "Number of species")
plot_box_whisker(malt_species.decontam.os, "Observed_species", "Village", "Village", "Number of species")

os_plot <-malt_species.decontam.os %>%
  inner_join(metadata_factors %>%
               select(SampleID, Env, Description, Ethnic_Group, Age_group,
                      Sex, Market_integration, Village, Tooth_site, Type), by = "SampleID") %>%
  filter(!str_detect(Village, "Yanomami")) %>%
  ggplot(., aes(x = Village, y = Observed_species, fill = Village)) +
                         geom_boxplot() +
                         scale_fill_manual(values = Village_colors) +
                         theme_minimal(base_size = 18) +
                         #scale_y_continuous(trans='log10') +
                         #scale_y_continuous(trans='pseudo_log') +
                         theme(axis.text.x = element_text(angle = 45, hjust = 1),
                              text = element_text(size=18)) +
                         ylab("Number of Species") +
                         xlab("")
os_plot

# ggsave("./06-publication/supplemental_figures/SXX5/SXX5_os.pdf", plot = os_plot, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

# now on filtered tables
presabs_table_f <- malt_species.decontam %>%
  select(-one_of(outliers)) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  filter(Percent > 0.001) %>%
  select(-one_of(c("Sum_species.decontam","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  spread(Species,Counts) %>%
  gather("Species","Counts",2:ncol(.)) %>%
  mutate(Counts = ifelse(Counts > 0, 1, 0)) %>%
  spread(Species, Counts) %>%
  column_to_rownames("SampleID")
  
# calculate observed species for each sample with janitor 'adorn_totals'
malt_species.decontam_filtered.os <- presabs_table_f %>%
  adorn_totals(., where = "col", name = "Observed_species") %>%
  select(Observed_species) %>%
  rownames_to_column("SampleID") 

plot_box_whisker(malt_species.decontam_filtered.os, "Observed_species", "Env", "Env", "Number of species")
plot_box_whisker(malt_species.decontam_filtered.os, "Observed_species", "Village", "Village", "Number of species")

```


## Shannon Index
```{r shannon_diversity}
# Shannon diversity with the package vegan
malt_species.decontam.matrix <- as.matrix(malt_species.decontam %>%
  select(-one_of(outliers)) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  select(-one_of(c("Sum_species.decontam","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  spread(Species,Counts) %>% 
  column_to_rownames("SampleID"))
 
malt_species.decontam.shannon <- as.data.frame(diversity(malt_species.decontam.matrix, index = "shannon"))
names(malt_species.decontam.shannon)[1] <- "Shannon_index"

# merge with the metadata file and plot
malt_species.decontam.shannon <- malt_species.decontam.shannon %>%
  rownames_to_column("SampleID") 

plot_box_whisker(malt_species.decontam.shannon, "Shannon_index", "Env", "Env", "Shannon Index")
plot_box_whisker(malt_species.decontam.shannon, "Shannon_index", "Village", "Village", "Shannon Index")

shannon_sp_plot <-malt_species.decontam.shannon %>%
  inner_join(metadata_factors %>%
               select(SampleID, Env, Description, Ethnic_Group, Age_group,
                      Sex, Market_integration, Village, Tooth_site, Type), by = "SampleID") %>%
  filter(!str_detect(Village, "Yanomami")) %>%
  ggplot(., aes(x = Village, y = Shannon_index, fill = Village)) +
                         geom_boxplot() +
                         scale_fill_manual(values = Village_colors) +
                         theme_minimal(base_size = 18) +
                         #scale_y_continuous(trans='log10') +
                         #scale_y_continuous(trans='pseudo_log') +
                         theme(axis.text.x = element_text(angle = 45, hjust = 1),
                              text = element_text(size=18)) +
                         ylab("Shannon index") +
                         xlab("")
shannon_sp_plot

# ggsave("./06-publication/supplemental_figures/SXX5/SXX5_shannon_sp.pdf", plot = shannon_sp_plot, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)


# now with the filtered data
malt_species.decontam_filtered.matrix <- as.matrix(malt_species.decontam %>%
  select(-one_of(outliers)) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  filter(Percent > 0.001) %>%
  select(-one_of(c("Sum_species.decontam","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  spread(Species,Counts) %>% 
  column_to_rownames("SampleID"))

malt_species.decontam_filtered.shannon <- as.data.frame(diversity(malt_species.decontam_filtered.matrix, index = "shannon"))
names(malt_species.decontam_filtered.shannon)[1] <- "Shannon_index"

# merge with the metadata file and plot
malt_species.decontam_filtered.shannon <- malt_species.decontam_filtered.shannon %>%
  rownames_to_column("SampleID") 

plot_box_whisker(malt_species.decontam_filtered.shannon, "Shannon_index", "Env", "Env", "Shannon Index")
plot_box_whisker(malt_species.decontam_filtered.shannon, "Shannon_index", "Village", "Village", "Shannon Index")


```


## Pielou's Evenness
Let's also look specifically at evenness of the samples using Pielou's evenness.
This calculation (derived from Shannon's index) gives us a number from 0 to 1,
where 0 is no evenness and 1 is perfect evenness. We want to see if there are
any groups that have substantially greater species/genera evenness than the
others. We're not interested in what the actual number is, or how even the
samples appear to be, except relative to eachother.
```{r evenness_pielou, eval = F}
evenness.species <- diversity(malt_species.decontam.matrix)
evenness.species <- as.data.frame(evenness.species/log(specnumber(malt_species.decontam.matrix)))
names(evenness.species)[1] <- "Pileou_evenness"

# merge with the metadata file and plot
evenness.species <- evenness.species %>%
  rownames_to_column("SampleID") 

plot_box_whisker(evenness.species, "Pileou_evenness", "Env", "Env", "Pielou's evenness")
plot_box_whisker(evenness.species, "Pileou_evenness", "Village", "Village", "Pielou's evenness")

pe_sp_plot <-evenness.species %>%
  inner_join(metadata_factors %>%
               select(SampleID, Env, Description, Ethnic_Group, Age_group,
                      Sex, Market_integration, Village, Tooth_site, Type), by = "SampleID") %>%
  filter(!str_detect(Village, "Yanomami")) %>%
  ggplot(., aes(x = Village, y = Pileou_evenness, fill = Village)) +
                         geom_boxplot() +
                         scale_fill_manual(values = Village_colors) +
                         theme_minimal(base_size = 18) +
                         #scale_y_continuous(trans='log10') +
                         #scale_y_continuous(trans='pseudo_log') +
                         theme(axis.text.x = element_text(angle = 45, hjust = 1),
                              text = element_text(size=18)) +
                         ylab("Pielou's evenness") +
                         xlab("")
pe_sp_plot

# ggsave("./06-publication/supplemental_figures/SXX5/SXX5_pe_sp.pdf", plot = pe_sp_plot, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

# now with filtered data
evenness.species_filtered <- diversity(malt_species.decontam_filtered.matrix)
evenness.species_filtered <- as.data.frame(evenness.species_filtered/log(specnumber(malt_species.decontam_filtered.matrix)))
names(evenness.species_filtered)[1] <- "Pileou_evenness"

# merge with the metadata file and plot
evenness.species_filtered <- evenness.species_filtered %>%
  rownames_to_column("SampleID") 

plot_box_whisker(evenness.species_filtered, "Pileou_evenness", "Env", "Env", "Pielou's evenness")
plot_box_whisker(evenness.species_filtered, "Pileou_evenness", "Village", "Village", "Pielou's evenness")

```


## Stats for Industrial + Cameroon samples without controls
```{r samples_stats_species}
# Filtered species tables alpha-diversity stats
# get the number of observed species
presabs_table_f <- malt_species.decontam %>%
  select(-one_of(outliers)) %>%
  select(-matches("10M|EXB|LIB|SRR164|ERR|SRS")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  filter(Percent > 0.001) %>%
  select(-one_of(c("Sum_species.decontam","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  spread(Species,Counts) %>%
  gather("Species","Counts",2:ncol(.)) %>%
  mutate(Counts = ifelse(Counts > 0, 1, 0)) %>%
  spread(Species, Counts) %>%
  column_to_rownames("SampleID")
  
# calculate observed species for each sample with janitor 'adorn_totals'
malt_species.decontam_filtered.alpha <- presabs_table_f %>%
  adorn_totals(., where = "col", name = "Observed_species") %>%
  select(Observed_species) %>%
  rownames_to_column("SampleID") 


# get the Shannon index
malt_species.decontam_filtered.matrix <- as.matrix(malt_species.decontam %>%
  select(-one_of(outliers)) %>%
  select(-matches("10M|EXB|LIB|SRR164|ERR|SRS")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  filter(Percent > 0.001) %>%
  select(-one_of(c("Sum_species.decontam","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  spread(Species,Counts) %>% 
  column_to_rownames("SampleID"))

malt_species.decontam_filtered.shannon <- as.data.frame(diversity(malt_species.decontam_filtered.matrix, index = "shannon"))
names(malt_species.decontam_filtered.shannon)[1] <- "Shannon_index"

# convert row names to a column and combine with the observed species table
malt_species.decontam_filtered.alpha <- malt_species.decontam_filtered.alpha %>%
  full_join(., malt_species.decontam_filtered.shannon %>%
  rownames_to_column("SampleID"), by = "SampleID")
  
# Get the evenness index
evenness.species_filtered <- diversity(malt_species.decontam_filtered.matrix)
evenness.species_filtered <- as.data.frame(evenness.species_filtered/log(specnumber(malt_species.decontam_filtered.matrix)))
names(evenness.species_filtered)[1] <- "Pileou_evenness"

# merge with the metadata file and plot
malt_species.decontam_filtered.alpha <- malt_species.decontam_filtered.alpha %>%
  full_join(., evenness.species_filtered %>%
  rownames_to_column("SampleID"), by = "SampleID") %>%
  left_join(., metadata_nofactors %>% 
              select(SampleID, Is_Oral), by = "SampleID") %>%
  filter(str_detect(Is_Oral, "Plaque|Calculus")) %>%
  select(-Is_Oral)

# now plot the observed species
os_env <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Observed_species", "Env", "Env", "Environment")
os_env
shannon_env <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Shannon_index", "Env", "Env", "Environment")
shannon_env
# pe_env <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Pileou_evenness", "Env", "Env", "Environment")
# pe_env

os_ethnicity <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Observed_species", "Ethnic_Group", "Ethnic_Group", "Ethnic group")
os_ethnicity
shannon_ethnicity <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Shannon_index", "Ethnic_Group", "Ethnic_Group", "Ethnic group")
shannon_ethnicity
# pe_ethnicity <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Pileou_evenness", "Ethnic_Group", "Ethnic_Group", "Ethnic group")
# pe_ethnicity

os_market <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Observed_species", "Market_integration", "Market_integration", "Market integration")
os_market
shannon_market <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Shannon_index", "Market_integration", "Market_integration", "Market integration")
shannon_market
# pe_market <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Pileou_evenness", "Market_integration", "Market_integration", "Market integration")
# pe_market

os_market_split <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Observed_species", "Market_integration_split", "Market_integration_split", "Market integration")
os_market_split
shannon_market_split <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Shannon_index", "Market_integration_split", "Market_integration_split", "Market integration")
shannon_market_split

# ggsave("./06-publication/supplemental_figures/SXX6/panel_parts/Figure_SXX6_os_env.pdf", plot = os_env, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)
# 
# ggsave("./06-publication/supplemental_figures/SXX6/panel_parts/Figure_SXX6_shannon_env.pdf", plot = shannon_env, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)
# 
# ggsave("./06-publication/supplemental_figures/SXX6/panel_parts/Figure_SXX6_os_ethnicity.pdf", plot = os_ethnicity, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)
# 
# ggsave("./06-publication/supplemental_figures/SXX6/panel_parts/Figure_SXX6_shannon_ethnicity.pdf", plot = shannon_ethnicity, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)
# 
# ggsave("./06-publication/supplemental_figures/SXX6/panel_parts/Figure_SXX6_os_market.pdf", plot = os_market, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)
# 
# ggsave("./06-publication/supplemental_figures/SXX6/panel_parts/Figure_SXX6_shannon_market.pdf", plot = shannon_market, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

```

```{r}
# add metadata to the table
malt_species.decontam_filtered.alpha_meta <- malt_species.decontam_filtered.alpha %>%
  inner_join(., metadata_nofactors %>%
               select(SampleID, Env, Age, Age_group, Ethnic_Group, 
                      Market_integration, Market_integration_split, Sex, Tooth_site, Village), by = "SampleID")

# define the metadata categories to test for significnat differences in diversity
Envmt <- colnames(malt_species.decontam_filtered.alpha_meta %>%
                    select(Env, Age, Age_group, Ethnic_Group, 
                           Market_integration, Market_integration_split, Sex, Tooth_site, Village))

# test for significant differences in diversity between the metadata categories
species_kruskal_pvals <- lapply(Envmt, function(envmt) {
pvalues_envmt <- malt_species.decontam_filtered.alpha_meta %>%
  select(SampleID, Observed_species, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  kruskal_test(Observed_species ~ lastone) %>% # number of species
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., malt_species.decontam_filtered.alpha_meta %>% 
              select(SampleID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            kruskal_test(Shannon_index ~ lastone) %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., malt_species.decontam_filtered.alpha_meta %>% 
              select(SampleID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            kruskal_test(Pileou_evenness ~ lastone) %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble() %>%
  arrange(p)
species_kruskal_pvals

# fwrite(species_kruskal_pvals, "./06-publication/supplemental_tables/alphadiv_kruskal_wallace_all_sp.tsv", sep = "\t", quote = F)

#*Note no groups are significantly different*

# pull out only the metadata categories that were significantly different between groups from the Kruskal-Wallace test
Envmt_sig <- species_kruskal_pvals %>%
  filter(p <= 0.07) %>%
  distinct(Category) %>%
  pull(Category)

# run a post-hoc test on those metadata categories to see which groups in them are significantly different
species_wilcox_pvals <- lapply(Envmt_sig, function(envmt) {
pvalues_envmt <- malt_species.decontam_filtered.alpha_meta %>%
  select(SampleID, Observed_species, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  mutate(lastone = fct_drop(lastone)) %>%
  pairwise_wilcox_test(Observed_species ~ lastone, p.adjust.method = "fdr") %>% 
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., malt_species.decontam_filtered.alpha_meta %>% 
              select(SampleID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
              mutate(lastone = fct_drop(lastone)) %>%
              pairwise_wilcox_test(Shannon_index ~ lastone, p.adjust.method = "fdr") %>% # Shannon index
              mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., malt_species.decontam_filtered.alpha_meta %>% 
              select(SampleID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
              mutate(lastone = fct_drop(lastone)) %>%
              pairwise_wilcox_test(Pileou_evenness ~ lastone, p.adjust.method = "fdr") %>% # Pileou's evenness
              mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble( )%>%
  # filter(p.adj <= 0.05) %>%
  rename(Index = .y.) %>%
  select(Index, Category, everything())
species_wilcox_pvals

# and check the effect size
species_wilcox_effs <- lapply(Envmt_sig, function(envmt) {
pvalues_envmt <- malt_species.decontam_filtered.alpha_meta %>%
  select(SampleID, Observed_species, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  mutate(lastone = fct_drop(lastone)) %>% 
  wilcox_effsize(Observed_species ~ lastone) %>% # number of species Observed_species
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., malt_species.decontam_filtered.alpha_meta %>% 
              select(SampleID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
              mutate(lastone = fct_drop(lastone)) %>%
              wilcox_effsize(Shannon_index ~ lastone) %>% # Shannon index
              mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., malt_species.decontam_filtered.alpha_meta %>% 
              select(SampleID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
              mutate(lastone = fct_drop(lastone)) %>%
              wilcox_effsize(Pileou_evenness ~ lastone) %>% # Pileou's evenness
              mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble( ) %>%
  select(.y.,Category, everything()) %>%
  arrange(desc(effsize)) %>%
  rename(Index = .y.)
species_wilcox_effs

IC_species_p_es <- species_wilcox_pvals %>%
  full_join(., species_wilcox_effs, by = c("Index","Category","group1","group2","n1","n2")) %>%
  select(Index, Category, everything()) %>%
  arrange(p.adj)
  
IC_species_p_es

# fwrite(IC_species_p_es, "./06-publication/supplemental_tables/alphadiv_wilcox_all_sp.tsv", sep = "\t", quote = F)

```
None of the categories are significantly different. 

## Diversity of CMC samples only
Let's also look at the CMC samples alone, without the HMP and JAE samples. Are
there differences in diversity between the various metadata groups?


### Stats for CMC samples only
```{r samples_stats_species_cmc}
# Filtered species tables alpha-diversity stats
# get the number of observed species
presabs_table_f <- malt_species.decontam %>%
  select(-one_of(outliers)) %>%
  select(matches("Species|CMC")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  filter(Percent > 0.001) %>%
  select(-one_of(c("Sum_species.decontam","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  spread(Species,Counts) %>%
  gather("Species","Counts",2:ncol(.)) %>%
  mutate(Counts = ifelse(Counts > 0, 1, 0)) %>%
  spread(Species, Counts) %>%
  column_to_rownames("SampleID")
  
# calculate observed species for each sample with janitor 'adorn_totals'
malt_species.decontam_filtered.alpha <- presabs_table_f %>%
  adorn_totals(., where = "col", name = "Observed_species") %>%
  select(Observed_species) %>%
  rownames_to_column("SampleID") 


# get the Shannon index
malt_species.decontam_filtered.matrix <- as.matrix(malt_species.decontam %>%
  select(-one_of(outliers)) %>%
  select(matches("Species|CMC")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  filter(Percent > 0.001) %>%
  select(-one_of(c("Sum_species.decontam","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  spread(Species,Counts) %>% 
  column_to_rownames("SampleID"))

malt_species.decontam_filtered.shannon <- as.data.frame(diversity(malt_species.decontam_filtered.matrix, index = "shannon"))
names(malt_species.decontam_filtered.shannon)[1] <- "Shannon_index"

# convert row names to a column and combine with the observed species table
malt_species.decontam_filtered.alpha <- malt_species.decontam_filtered.alpha %>%
  full_join(., malt_species.decontam_filtered.shannon %>%
  rownames_to_column("SampleID"), by = "SampleID")
  
# Get the evenness index
evenness.species_filtered <- diversity(malt_species.decontam_filtered.matrix)
evenness.species_filtered <- as.data.frame(evenness.species_filtered/log(specnumber(malt_species.decontam_filtered.matrix)))
names(evenness.species_filtered)[1] <- "Pileou_evenness"

# merge with the metadata file and plot
malt_species.decontam_filtered.alpha <- malt_species.decontam_filtered.alpha %>%
  full_join(., evenness.species_filtered %>%
  rownames_to_column("SampleID"), by = "SampleID")

# now plot the observed species
plot_box_whisker(malt_species.decontam_filtered.alpha, "Observed_species", "Ethnic_Group", "Ethnic_Group", "Ethnic group")
plot_box_whisker(malt_species.decontam_filtered.alpha, "Shannon_index", "Ethnic_Group", "Ethnic_Group", "Ethnic group")
# plot_box_whisker(malt_species.decontam_filtered.alpha, "Pileou_evenness", "Ethnic_Group", "Ethnic_Group", "Ethnic group")
shannon_sex <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Shannon_index", "Sex", "Sex", "Sex")
shannon_sex
evenness_sex <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Pileou_evenness", "Sex", "Sex", "Sex")
evenness_sex
os_tooth <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Observed_species", "Tooth_site", "Tooth_site", "Tooth site")
os_tooth
# pe_tooth <- plot_box_whisker(malt_species.decontam_filtered.alpha, "Pileou_evenness", "Tooth_site", "Tooth_site", "Tooth site")
# pe_tooth

# ggsave("./05-results.backup/shannon_sex.pdf", plot = shannon_sex, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)
# 
# ggsave("./05-results.backup/os_tooth.pdf", plot = os_tooth, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

# add metadata to the table
malt_species.decontam_filtered.alpha_meta <- malt_species.decontam_filtered.alpha %>%
  inner_join(., metadata_nofactors %>%
               select(SampleID, Age, Age_group, Ethnic_Group, 
                      Market_integration, Sex, Tooth_site, Village), by = "SampleID")

# define the metadata categories to test for significnat differences in diversity
Envmt <- colnames(malt_species.decontam_filtered.alpha_meta %>%
                    select(Age_group, Ethnic_Group, 
                           Market_integration, Sex, Tooth_site, Village))

# test for significant differences in diversity between the metadata categories
species_kruskal_pvals <- lapply(Envmt, function(envmt) {
pvalues_envmt <- malt_species.decontam_filtered.alpha_meta %>%
  select(SampleID, Observed_species, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  kruskal_test(Observed_species ~ lastone) %>% # number of species
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., malt_species.decontam_filtered.alpha_meta %>% 
              select(SampleID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            kruskal_test(Shannon_index ~ lastone) %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., malt_species.decontam_filtered.alpha_meta %>% 
              select(SampleID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            kruskal_test(Pileou_evenness ~ lastone) %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble() %>%
  arrange(p)
species_kruskal_pvals

fwrite(species_kruskal_pvals, "./06-publication/supplemental_tables/alphadiv_kruskal_wallace_cmc_sp.tsv", sep = "\t", quote = F)

# pull out only the metadata categories that were significantly different between groups from the Kruskal-Wallace test
Envmt_sig <- species_kruskal_pvals %>%
  filter(p <= 0.05) %>%
  distinct(Category) %>%
  pull(Category)

# run a post-hoc test on those metadata categories to see which groups in them are significantly different
species_wilcox_pvals <- lapply(Envmt_sig, function(envmt) {
pvalues_envmt <- malt_species.decontam_filtered.alpha_meta %>%
  select(SampleID, Observed_species, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  pairwise_wilcox_test(Observed_species ~ lastone, p.adjust.method = "fdr") %>% # number of species
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., malt_species.decontam_filtered.alpha_meta %>% 
              select(SampleID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            pairwise_wilcox_test(Shannon_index ~ lastone, p.adjust.method = "fdr") %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., malt_species.decontam_filtered.alpha_meta %>% 
              select(SampleID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            pairwise_wilcox_test(Pileou_evenness ~ lastone, p.adjust.method = "fdr") %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble( ) %>%
  rename(Index = .y.)


# and check the effect size
species_wilcox_effs <- lapply(Envmt_sig, function(envmt) {
pvalues_envmt <- malt_species.decontam_filtered.alpha_meta %>%
  select(SampleID, Observed_species, !!enquo(envmt)) %>%
  rename(lastone = !!enquo(envmt)) %>% # this is the way I found to get the rstatix functions to recognize the column name
  wilcox_effsize(Observed_species ~ lastone) %>% # number of species
  mutate(Category = !!enquo(envmt)) %>% # adds the name of the metadata category as a new column
  bind_rows(., malt_species.decontam_filtered.alpha_meta %>% 
              select(SampleID, Shannon_index, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            wilcox_effsize(Shannon_index ~ lastone) %>% # Shannon index
            mutate(Category = !!enquo(envmt))) %>%
  bind_rows(., malt_species.decontam_filtered.alpha_meta %>% 
              select(SampleID, Pileou_evenness, !!enquo(envmt)) %>%
              rename(lastone = !!enquo(envmt)) %>%
            wilcox_effsize(Pileou_evenness ~ lastone) %>% # Pileou's evenness
            mutate(Category = !!enquo(envmt)))
}) %>%
  bind_rows(.) %>%
  as_tibble( ) %>%
  select(.y.,Category, everything()) %>%
  arrange(desc(effsize)) %>%
  rename(Index = .y.)


IC_species_cmc_p_es <- species_wilcox_pvals %>%
  full_join(., species_wilcox_effs, by = c("Index","Category","group1","group2","n1","n2")) %>%
  select(Index, Category, everything()) %>%
  arrange(p.adj)

IC_species_cmc_p_es

fwrite(IC_species_cmc_p_es, "./06-publication/supplemental_tables/alphadiv_wilcox_cmc_sp.tsv", sep = "\t", quote = F)

```
Two metadata categories have significant differences in diversity, Tooth site
(number of species p = 0.00481, Shannon p = 0.02440) and Sex (Evenness p =
0.03170). The post-hoc test show that in the Tooth site category Observed
species (p.adj = 0.005 es=0.3) and Shannon index (p.adj = 0.024 es = 0.24) are
significantly different. In the sex category Evenness (p = 0.032 es=0.23)is
significantly different.


There is a significant difference in species diversity between Females and
Males. We'll split each village by sex to see if there are differences in alpha
diversity between the sexes in each village
```{r sex_by_village_species}
# pairwise wilcox test
wilcox_sex <- malt_species.decontam_filtered.alpha_meta %>%
  drop_na(Sex) %>%
  group_by(Village) %>%
  pairwise_wilcox_test(Observed_species ~ Sex, p.adjust.method = "fdr") %>%
  bind_rows(malt_species.decontam_filtered.alpha_meta %>%
            drop_na(Sex) %>%
            group_by(Village) %>%
            pairwise_wilcox_test(Shannon_index ~ Sex, p.adjust.method = "fdr")) %>%
  bind_rows(malt_species.decontam_filtered.alpha_meta %>%
            drop_na(Sex) %>%
            group_by(Village) %>%
            pairwise_wilcox_test(Pileou_evenness ~ Sex, p.adjust.method = "fdr")) %>%
  arrange(p.adj) %>%
  rename(Index = .y.)

# check the effect size
wilcox_es_sex <- malt_species.decontam_filtered.alpha_meta %>%
  drop_na(Sex) %>%
  group_by(Village) %>%
  wilcox_effsize(Observed_species ~ Sex) %>%
  bind_rows(malt_species.decontam_filtered.alpha_meta %>%
            drop_na(Sex) %>%
            group_by(Village) %>%
            wilcox_effsize(Shannon_index ~ Sex)) %>%
  bind_rows(malt_species.decontam_filtered.alpha_meta %>%
            drop_na(Sex) %>%
            group_by(Village) %>%
            wilcox_effsize(Pileou_evenness ~ Sex)) %>%
  arrange(desc(effsize)) %>%
  rename(Index = .y.)

wilcox_sex_p_es <- wilcox_sex %>%
  full_join(., wilcox_es_sex, by = c("Index","group1","group2","n1","n2")) %>%
  select(Index, everything()) %>%
  arrange(p.adj)

wilcox_sex_p_es

# make a plot of village split by sex
malt_species.decontam_filtered.alpha_meta %>% 
  drop_na(Sex) %>%
  mutate(Village = fct_relevel(Village, "202","205","204","203","206")) %>%
  ggplot(., aes(x = Village, y = Observed_species, fill = Sex)) +
         geom_boxplot(outlier.size = 0) +
         geom_point(position = position_jitterdodge(jitter.width = 0), alpha = 0.5) +
         scale_fill_manual(values = Sex_colors) +
         theme_minimal() +
         theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
         ylab("Observed species") +
         xlab("Sex") +
         ggtitle("Observed species per village by sex")

# make a plot of village split by sex
shannon_village_split_sex <- malt_species.decontam_filtered.alpha_meta %>%
  drop_na(Sex) %>%
  mutate(Village = fct_relevel(Village, "202","205","204","203","206")) %>%
  ggplot(., aes(x = Village, y = Shannon_index, fill = Sex)) +
         geom_boxplot(outlier.size = 0) +
         geom_point(position = position_jitterdodge(jitter.width = 0), alpha = 0.5) +
         scale_fill_manual(values = Sex_colors) +
         theme_minimal() +
         theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
         ylab("Shannon index") +
         xlab("Sex") +
         ggtitle("Species Shannon index per village by sex")

shannon_village_split_sex

# make a plot of village split by sex
malt_species.decontam_filtered.alpha_meta %>%
  drop_na(Sex) %>%
  mutate(Village = fct_relevel(Village, "202","205","204","203","206")) %>%
  ggplot(., aes(x = Village, y = Pileou_evenness, fill = Sex)) +
         geom_boxplot(outlier.size = 0) +
         geom_point(position = position_jitterdodge(jitter.width = 0), alpha = 0.5) +
         scale_fill_manual(values = Sex_colors) +
         theme_minimal() +
         theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
         ylab("Evenness") +
         xlab("Sex") +
         ggtitle("Species evenness per village by sex")

```
The only significant difference in species-level diversity between females and
males in each village is in village 206 by Shannon index (p = 0.029 es=0.56), and
Pileou's evenness (p = 0.029 es=0.56). However, there is a lot of spread in the points
of these groups, so it may not be significant if more samples are added.

# Heatmaps
```{r metadata_heatmaps}
# read in metadata again to get it without all the factors
metadata_hm <- fread("00-documentation.backup/01-cameroon_hunter_gatherer_metadata.tsv")

# order the samples so they can be ordered this way in the heat maps

# order the CMC samples by Village
cmc_order <- metadata_hm %>%
  rename(SampleID = `#SampleID`)  %>%
  as_tibble() %>%
  filter(str_detect(SampleID, "CMC")) %>%
  mutate(Village = fct_relevel(Village, "202","205","204","203","206")) %>%
  select(SampleID, Village) %>%
  arrange(Village) %>%
  pull(SampleID)

# order the HMP samples by subplaque, supraplaque
hmp_order <- metadata_hm %>%
  rename(SampleID = `#SampleID`)  %>%
  as_tibble() %>%
  filter(str_detect(SampleID, "SRR")) %>%
  filter(!str_detect(SampleID, "10M|SRR164")) %>%
  mutate(Description = fct_relevel(Description, "HMP_subPlaque","HMP_supPlaque")) %>%
  select(SampleID, Description) %>%
  arrange(Description) %>%
  pull(SampleID)

# keep JAE samples in alphabetical order
jae_order <- metadata_hm %>%
  rename(SampleID = `#SampleID`)  %>%
  as_tibble() %>%
  filter(str_detect(SampleID, "JAE|VLC")) %>%
  filter(!str_detect(SampleID, "10M")) %>%
  pull(SampleID)

# combine all 3 ordered vectors into a final ordered vector
each_order <- c(cmc_order, jae_order, hmp_order)

```


Now make heatmaps of the top 50 most abundant species and genera (as an arbitrary cut-off)
```{r heatmaps_species_all}
# select the top 50 most abundant species for all samples (CMC, JAE, HMP)
malt_species.decontam_top50_all <- malt_species.decontam %>%
  select(-one_of(outliers)) %>%
  select(-matches("SRR164|10M|EXB|LIB|ERR|SRS")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  top_n(50, Percent) %>%
  select(-one_of("Sum_species.decontam","Percent")) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("SampleID")

# CLR-transform the matrix for plotting the heatmap
malt_species.decontam_top50_all_clr <- clr(malt_species.decontam_top50_all)
malt_species.decontam_top50_all_clr <- as.matrix(malt_species.decontam_top50_all_clr)

# orient the matrix with correct rows/columns to run the distance calculation for the species, not the samples (columns are SampleID, rows are Species)
malt_species.decontam_top50_all_clr_sp <- malt_species.decontam_top50_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","Counts",2:ncol(.)) %>%
  spread(SampleID,Counts)

#add the rownames back
rownames(malt_species.decontam_top50_all_clr_sp) <- malt_species.decontam_top50_all_clr_sp$Species
malt_species.decontam_top50_all_clr_sp <- malt_species.decontam_top50_all_clr_sp %>% select(-Species)

# perform a distance calculation for hierarchical clustering for the species ordering
malt_species.decontam_top50_all_clr_dist <- vegdist(malt_species.decontam_top50_all_clr_sp, method = "euclidian")
# cluster the data with hclust
malt_species.decontam_top50_all_clr_dist_hr <- hclust(malt_species.decontam_top50_all_clr_dist)
# malt_species.decontam_top50_all_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
sp_all_order <- malt_species.decontam_top50_all_clr_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
malt_species.decontam_top50_all_clr_order <- malt_species.decontam_top50_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(SpOrder = as.character(seq(1,50))) %>%
  select(Species, SpOrder, everything()) %>%
  mutate(SpOrder = fct_relevel(SpOrder, sp_all_order)) %>%
  arrange(SpOrder) %>%
  pull(Species)

# make the species a factor so they're in the correct order for the heatmap using the vector from the step above
malt_species.decontam_top50_all_clr_long <- malt_species.decontam_top50_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, malt_species.decontam_top50_all_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.))

# now cluster by sample
# convert the matrix to a data.frame
malt_species.decontam_top50_all_clr_smp <- malt_species.decontam_top50_all_clr %>%
  as.data.frame()

# perform a distance calculation for hierarchical clustering for the species ordering
malt_species.decontam_top50_all_clr_smp_dist <- vegdist(malt_species.decontam_top50_all_clr_smp, method = "euclidian")
# cluster the data with hclust
malt_species.decontam_top50_all_clr_smp_dist_hr <- hclust(malt_species.decontam_top50_all_clr_smp_dist)
# malt_species.decontam_top50_all_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
smp_all_order <- malt_species.decontam_top50_all_clr_smp_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
malt_species.decontam_top50_all_clr_smp_order <- malt_species.decontam_top50_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Species,CLR) %>%
  mutate(SmpOrder = as.character(seq(1,122))) %>%  
  select(SampleID, SmpOrder, everything()) %>%
  mutate(SmpOrder = fct_relevel(SmpOrder, smp_all_order)) %>%
  arrange(SmpOrder) %>%
  pull(SampleID)

# Plot the heatmap with samples ordered by the clustering from above
# make the SampleIDs a factor so they're in the correct order for the heatmap using the vector from the step above
malt_species.decontam_top50_all_clr_long <- malt_species.decontam_top50_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, malt_species.decontam_top50_all_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.)) %>%
  inner_join(., metadata_factors %>%
               select(SampleID, Village), by = "SampleID") %>%
  inner_join(., Village_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Village = c("202","205","204","203","206","Industrial plaque","Industrial calculus","ExtractionGauze","ExtractionBlank","LibraryBlank")), by = "Village") %>%
  mutate(SampleID = fct_relevel(SampleID, malt_species.decontam_top50_all_clr_smp_order)) %>%
  arrange(SampleID)

vector_color = malt_species.decontam_top50_all_clr_long %>%
  select(SampleID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_base <- ggplot(malt_species.decontam_top50_all_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 11) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_base

# Plot the heatmap with samples ordered by Village
# make the SampleIDs a factor so they're in the correct order for the heatmap using the vector from the step above
malt_species.decontam_top50_all_clr_long <- malt_species.decontam_top50_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, malt_species.decontam_top50_all_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Village), by = "SampleID") %>%
  inner_join(., Village_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Village = c("202","205","204","203","206","Industrial plaque","Industrial calculus","ExtractionGauze","ExtractionBlank","LibraryBlank")), by = "Village") %>%
  mutate(SampleID = fct_relevel(SampleID, each_order)) %>%
  arrange(SampleID)

vector_color = malt_species.decontam_top50_all_clr_long %>%
  select(SampleID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_base <- ggplot(malt_species.decontam_top50_all_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 11) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_base

```

```{r heatmaps_species_cmc}

# select the top 50 most abundant species for CMC samples
malt_species.decontam_top50_cmc <- malt_species.decontam %>%
  select(-one_of(outliers)) %>%
  select(matches("Species|CMC")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  top_n(50, Percent) %>%
  select(-one_of("Sum_species.decontam","Percent")) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("SampleID")

# also save the species as a vector
malt_species.decontam_top50_cmcV <- malt_species.decontam %>%
  select(-one_of(outliers)) %>%
  select(matches("Species|CMC")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  top_n(50, Percent) %>%
  select(-one_of("Sum_species.decontam","Percent")) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  spread(SampleID,Counts) %>%
  select(Species) %>%
  mutate(CMC = 1)


# CLR-transform the matrix for plotting the heatmap
malt_species.decontam_top50_cmc_clr <- clr(malt_species.decontam_top50_cmc)
malt_species.decontam_top50_cmc_clr <- as.matrix(malt_species.decontam_top50_cmc_clr)
# orient the matrix with correct rows/columns to run the distance calculation for the species, not the samples (columns are SampleID, rows are Species)
malt_species.decontam_top50_cmc_clr_sp <- malt_species.decontam_top50_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","Counts",2:ncol(.)) %>%
  spread(SampleID,Counts)

#add the rownames back
rownames(malt_species.decontam_top50_cmc_clr_sp) <- malt_species.decontam_top50_cmc_clr_sp$Species
malt_species.decontam_top50_cmc_clr_sp <- malt_species.decontam_top50_cmc_clr_sp %>% select(-Species)

# perform a distance calculation for hierarchical clustering for the species ordering
malt_species.decontam_top50_cmc_clr_dist <- vegdist(malt_species.decontam_top50_cmc_clr_sp, method = "euclidian")
# cluster the data with hclust
malt_species.decontam_top50_cmc_clr_dist_hr <- hclust(malt_species.decontam_top50_cmc_clr_dist)
# malt_species.decontam_top50_cmc_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
sp_cmc_order <- malt_species.decontam_top50_cmc_clr_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
malt_species.decontam_top50_cmc_clr_order <- malt_species.decontam_top50_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(SpOrder = as.character(seq(1,50))) %>%
  select(Species, SpOrder, everything()) %>%
  mutate(SpOrder = fct_relevel(SpOrder, sp_cmc_order)) %>%
  arrange(SpOrder) %>%
  pull(Species)

# make the species a factor so they're in the correct order for the heatmap using the vector from the step above
malt_species.decontam_top50_cmc_clr_long <- malt_species.decontam_top50_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, malt_species.decontam_top50_cmc_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.))


# now cluster by sample
# convert the matrix to a data.frame
malt_species.decontam_top50_cmc_clr_smp <- malt_species.decontam_top50_cmc_clr %>%
  as.data.frame()

# perform a distance calculation for hierarchical clustering for the species ordering
malt_species.decontam_top50_cmc_clr_smp_dist <- vegdist(malt_species.decontam_top50_cmc_clr_smp, method = "euclidian")
# cluster the data with hclust
malt_species.decontam_top50_cmc_clr_smp_dist_hr <- hclust(malt_species.decontam_top50_cmc_clr_smp_dist)
# malt_species.decontam_top50_cmc_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
smp_cmc_order <- malt_species.decontam_top50_cmc_clr_smp_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
malt_species.decontam_top50_cmc_clr_smp_order <- malt_species.decontam_top50_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Species,CLR) %>%
  mutate(SmpOrder = as.character(seq(1,84))) %>%  
  select(SampleID, SmpOrder, everything()) %>%
  mutate(SmpOrder = fct_relevel(SmpOrder, smp_cmc_order)) %>%
  arrange(SmpOrder) %>%
  pull(SampleID)

# Plot the heatmap with samples ordered by the clustering from above
# make the SampleIDs a factor so they're in the correct order for the heatmap using the vector from the step above
malt_species.decontam_top50_cmc_clr_long <- malt_species.decontam_top50_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, malt_species.decontam_top50_cmc_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Village), by = "SampleID") %>%
  inner_join(., Village_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Village = c("202","205","204","203","206","Industrial plaque","Industrial calculus","ExtractionGauze","ExtractionBlank","LibraryBlank")), by = "Village") %>%
  mutate(SampleID = fct_relevel(SampleID, malt_species.decontam_top50_cmc_clr_smp_order)) %>%
  arrange(SampleID)

vector_color = malt_species.decontam_top50_cmc_clr_long %>%
  select(SampleID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_base <- ggplot(malt_species.decontam_top50_cmc_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_base

# Plot the heatmap with samples ordered by Village
# make the SampleIDs a factor so they're in the correct order for the heatmap using the vector from the step above
malt_species.decontam_top50_cmc_clr_long <- malt_species.decontam_top50_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, malt_species.decontam_top50_cmc_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Village), by = "SampleID") %>%
  inner_join(., Village_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Village = c("202","205","204","203","206","Industrial plaque","Industrial calculus","ExtractionGauze","ExtractionBlank","LibraryBlank")), by = "Village") %>%
  mutate(SampleID = fct_relevel(SampleID, each_order)) %>%
  arrange(SampleID)

vector_color = malt_species.decontam_top50_cmc_clr_long %>%
  select(SampleID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_base <- ggplot(malt_species.decontam_top50_cmc_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_base

```

```{r heatmaps_species_each}
# the section above for CMC samples has to be run before this one. this section uses output from that one
# select the top 50 most abundant species for HMP samples
nothmp <- metadata_nofactors %>%
  filter(!str_detect(Is_Oral, "HMP")) %>%
  select(SampleID) %>%
  pull()

malt_species.decontam_top50_hmpV <- malt_species.decontam %>%
  select(-one_of(outliers)) %>%
  select(-matches(nothmp)) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  top_n(50, Percent) %>%
  select(-one_of("Sum_species.decontam","Percent")) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  spread(SampleID,Counts) %>%
  select(Species) %>%
  mutate(HMP = 1)

# select the top 50 most abundant species for JAE samples
malt_species.decontam_top50_jaeV <- malt_species.decontam %>%
  select(-one_of(outliers)) %>%
  select(matches("Species|JAE|VLC")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam") %>%
  mutate(Percent = Sum_species.decontam/sum(Sum_species.decontam)*100) %>%
  top_n(50, Percent) %>%
  select(-one_of("Sum_species.decontam","Percent")) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  spread(SampleID,Counts) %>%
  select(Species) %>%
  mutate(JAE = 1)


# Now select only those species (top 50 of CMC, HMP, JAE) out of the table to create a new matrix
malt_species.decontam_top50_each_list <- malt_species.decontam_top50_cmcV %>%
  bind_rows(., malt_species.decontam_top50_hmpV) %>%
  bind_rows(., malt_species.decontam_top50_jaeV) %>%
  select(Species) %>%
  unique() %>%
  pull()

malt_species.decontam_top50_each <- malt_species.decontam %>%
  select(-one_of(outliers)) %>%
  select(-matches("SRR164|10M|EXB|LIB|ERR|SRS")) %>%
  filter(Species %in% malt_species.decontam_top50_each_list) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("SampleID")

# 77 of 150 species are left after unique() - how many species are in the top 50 of all 3 (26)? of JAE and HMP (the same 26)? of CMC and JAE (46)? of CMC and HMP (27)?
all3_sp <- malt_species.decontam_top50_cmcV %>%
  full_join(., malt_species.decontam_top50_jaeV) %>%
  full_join(., malt_species.decontam_top50_hmpV) %>%
  replace(is.na(.), 0) %>%
  adorn_totals(where = "col")

# fwrite(all3_sp, "./05-results.backup/top_50_sp.tsv", sep = "\t", quote = F)

all3_sp %>%
  mutate(all3 = CMC == 1 & HMP == 1 & JAE == 1) %>%
  select(all3) %>%
  count(all3)

all3_sp %>%
  mutate(cmc_pq = CMC == 1 & HMP == 1 & JAE == 0) %>%
  select(cmc_pq) %>%
  count(cmc_pq)

all3_sp %>%
  mutate(cmc_cal = CMC == 1 & HMP == 0 & JAE == 1) %>%
  select(cmc_cal) %>%
  count(cmc_cal)

all3_sp %>%
  mutate(pq_cal = CMC == 0 & HMP == 1 & JAE == 1) %>%
  select(pq_cal) %>%
  count(pq_cal)

```

```{r sxx8}
# CLR-transform the matrix for plotting the heatmap
malt_species.decontam_top50_each_clr <- clr(malt_species.decontam_top50_each)
malt_species.decontam_top50_each_clr <- as.matrix(malt_species.decontam_top50_each_clr)

# orient the matrix with correct rows/columns to run the distance calculation for the species, not the samples (columns are SampleID, rows are Species)
malt_species.decontam_top50_each_clr_sp <- malt_species.decontam_top50_each_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","Counts",2:ncol(.)) %>%
  spread(SampleID,Counts)

#add the rownames back
rownames(malt_species.decontam_top50_each_clr_sp) <- malt_species.decontam_top50_each_clr_sp$Species
malt_species.decontam_top50_each_clr_sp <- malt_species.decontam_top50_each_clr_sp %>% select(-Species)

# perform a distance calculation for hierarchical clustering for the species ordering
malt_species.decontam_top50_each_clr_dist <- vegdist(malt_species.decontam_top50_each_clr_sp, method = "euclidian")
# cluster the data with hclust
malt_species.decontam_top50_each_clr_dist_hr <- hclust(malt_species.decontam_top50_each_clr_dist)
# malt_species.decontam_top50_each_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
sp_each_order <- malt_species.decontam_top50_each_clr_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
malt_species.decontam_top50_each_clr_order <- malt_species.decontam_top50_each_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(SpOrder = as.character(seq(1,87))) %>%
  select(Species, SpOrder, everything()) %>%
  mutate(SpOrder = fct_relevel(SpOrder, sp_each_order)) %>%
  arrange(SpOrder) %>%
  pull(Species)

# make the species a factor so they're in the correct order for the heatmap using the vector from the step above
malt_species.decontam_top50_each_clr_long <- malt_species.decontam_top50_each_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, malt_species.decontam_top50_each_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.))

# now cluster by sample
# convert the matrix to a data.frame
malt_species.decontam_top50_each_clr_smp <- malt_species.decontam_top50_each_clr %>%
  as.data.frame()

# perform a distance calculation for hierarchical clustering for the species ordering
malt_species.decontam_top50_each_clr_smp_dist <- vegdist(malt_species.decontam_top50_each_clr_smp, method = "euclidian")
# cluster the data with hclust
malt_species.decontam_top50_each_clr_smp_dist_hr <- hclust(malt_species.decontam_top50_each_clr_smp_dist)
# malt_species.decontam_top50_each_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
smp_each_order <- malt_species.decontam_top50_each_clr_smp_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
malt_species.decontam_top50_each_clr_smp_order <- malt_species.decontam_top50_each_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Species,CLR) %>%
  mutate(SmpOrder = as.character(seq(1,122))) %>%  
  select(SampleID, SmpOrder, everything()) %>%
  mutate(SmpOrder = fct_relevel(SmpOrder, smp_each_order)) %>%
  arrange(SmpOrder) %>%
  pull(SampleID)

# Plot the heatmap with samples ordered by the clustering from above
# make the SampleIDs a factor so they're in the correct order for the heatmap using the vector from the step above
malt_species.decontam_top50_each_clr_long <- malt_species.decontam_top50_each_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, malt_species.decontam_top50_each_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Village), by = "SampleID") %>%
  inner_join(., Village_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Village = c("202","205","204","203","206","Industrial plaque","Industrial calculus","ExtractionGauze","ExtractionBlank","LibraryBlank")), by = "Village") %>%
  mutate(SampleID = fct_relevel(SampleID, malt_species.decontam_top50_each_clr_smp_order)) %>%
  arrange(SampleID)

vector_color = malt_species.decontam_top50_each_clr_long %>%
  select(SampleID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_base <- ggplot(malt_species.decontam_top50_each_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, vjust = 0.5, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_base

# ggsave("./06-publication/supplemental_figures/SXX8/Figure_SXX8_top50_sp_heatmap_clustered.pdf", plot = heatmap_base, device = "pdf",
#        scale = 1, width = 16, height = 13, units = c("in"), dpi = 300)
# 
# ggsave("./06-publication/supplemental_figures/SXX8/Figure_SXX8_top50_sp_heatmap_clustered.png", plot = heatmap_base, device = "png",
#        scale = 1, width = 16, height = 13, units = c("in"), dpi = 300)


# Plot the heatmap with samples ordered by Village
# make the SampleIDs a factor so they're in the correct order for the heatmap using the vector from the step above
malt_species.decontam_top50_each_clr_long <- malt_species.decontam_top50_each_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, malt_species.decontam_top50_each_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Village), by = "SampleID") %>%
  inner_join(., Village_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Village = c("202","205","204","203","206","Industrial plaque","Industrial calculus","ExtractionGauze","ExtractionBlank","LibraryBlank")), by = "Village") %>%
  mutate(SampleID = fct_relevel(SampleID, each_order)) %>%
  arrange(SampleID)

vector_color = malt_species.decontam_top50_each_clr_long %>%
  select(SampleID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_base <- ggplot(malt_species.decontam_top50_each_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 11) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_base


# ggsave("./05-results.backup/top50species_each_heatmap.pdf", plot = heatmap_base, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

```


```{r samples_heatmap_uky}
heatmap_base <- ggplot(malt_species.decontam_top50_each_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_base

# ggsave("05-results.backup/heatmap_species_UKY.pdf", plot = heatmap_base, device = "pdf",
#        scale = 1, width = 7, height = 7, units = c("in"),
#        dpi = 300)

```


```{r heatmap_from_james, eval = F}

data_heatmap <- otu_matrix_pseudo_clr %>%  
  as_tibble(rownames = "Individual") %>%
  gather(Taxon, CLR, 2:ncol(.)) %>%
  left_join(raw_metadata) %>%
  left_join(common_colours_tbl) %>%
  mutate(Individual = factor(Individual, levels = list_individual), 
         Taxon = factor(Taxon, levels = list_taxa)) %>%
  arrange(Individual) %>%
  mutate(Host_Common = as_factor(Host_Common),
         Colour = as_factor(Colour))

vector_colour <- data_heatmap %>% 
  dplyr::select(Individual, Colour) %>% 
  unique %>% 
  pull(Colour) %>% 
  as.character()

heatmap_base <- ggplot(data_heatmap, aes(Taxon, Individual, fill = CLR)) +
  geom_tile() +
  ggtitle(paste("Centered Log Ratio Transformed Heatmap at", tax_level ,"level"), subtitle = paste0("Database: ", db, 
                            ". Sources: ", sources, 
                            ". Controls: ", controls, 
                            ". Bad Samples: ", bad_samples,
                            ". Min Support: ", minsupp_threshold,
                            ". \nZero replacement: ", zero_trans,
                            ". Min. Prevalence (Inds): ", prevalence_filter,
                            ". Individual clustering: ", best_method,
                            ". Taxon clustering: ", best_method_tax)) +
  #scale_fill_viridis_c() +
  scale_fill_distiller(palette = "Spectral") +
  scale_colour_manual(values = NA) +
  scale_x_discrete(position = "top") +
  theme_minimal(base_family = "Roboto", base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = -0.001),
        axis.text.y = element_text(colour = vector_colour),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")
# if colour sample labels wanted theme(element_text(colour = vector_colour))


```


























