---
title: "Cameroon hunter-gatherer calculus/plaque MALT discriminant taxa"
author: "Irina Velsko"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output:
    github_document:
        fig_width: 8
        fig_height: 6
        toc: true
---

```{r load_libraries, echo = F, message = F}
library(knitr)
library(data.table)
library(psych)
library(ape)
library(mixOmics)
library(compositions)
library(vegan)
library(MASS)
library(janitor)
library(pander)
library(tidyverse)
library(gplots)
library(ggrepel)
library(viridis)
library(cowplot)
opts_chunk$set(echo=F, warning=F, message=F, dpi=150)
```

Set the working directory of the notebook to the parent directory of the 
notebook itself.  

```{r setup}
knitr::opts_knit$set(root.dir = normalizePath(".."))
```

```{r load_data}

# load the taxonomy tables that have been decontaminated and the column headers are cleaned up
load("./05-results.backup/CMC_taxonomy_tables.RData")

# load the metadata file
load("./05-results.backup/CMC_metadata.RData")

# so don't have extra unnecessary categories with factors
metadata_nofactors <- fread("./00-documentation.backup/01-cameroon_hunter_gatherer_metadata.tsv") %>%
  rename(SampleID = `#SampleID`) %>%
  filter(!str_detect(SampleID, "10M|SRR164|ERR|SRS|EXB|LIB"))

Age_group_colors <- c(`18-29` = "#FF3200", `30-39` = "#E9B186", `40-49` = "#82CDAA", `50-59` = "#0686B8", `60+` = "#172869")
Age_group_shapes <- c(`18-29` = 15, `30-39` = 16, `40-49` = 17, `50-59` = 18, `60+` = 25)
Ethnic_Group_shapes <- c(Baka = 19, Nzime = 17,  `Industrial plaque` = 7, `Industrial calculus` = 7)
Ethnic_Group_colors <- c(Baka = "#FF3200", Nzime = "#065FA3", `Industrial plaque` = "#969696", `Industrial calculus` = "#feb24c")
Market_integration_colors <- c(`Logging road` = "#FF3200", `Forest camp` = "#82CDAA", Farming = "#065FA3", Industrial  = "#969696")
Market_integration_shapes <- c(`Logging road` = 19, `Forest camp` = 18, Farming = 17, Industrial = 7)
Village_colors <- c(`202` = "#FF3200", `205` = "#EF8158", `204` = "#E9BD8E", `203` = "#CBDDA7", `206` = "#38BCAD", `Industrial plaque` = "#969696", `Industrial calculus` = "#feb24c")
Village_shapes <- c(`202` = 15, `205` = 17, `204` = 18,`203` = 16, `206` = 25, `Industrial plaque` = 7, `Industrial calculus` = 7)
Sex_colors <- c(Female = "#FF3200", Male = "#065FA3")
Sex_shapes <- c(Female = 19, Male = 17)
Tooth_site_colors <- c(Anterior = "#FF3200", Posterior = "#065FA3")
Tooth_site_shapes <- c(Anterior = 19, Posterior = 17)

```


```{r pca_plotting_functions}
# plotting PCA with colored dots
plot_pca <- function(df, pc1, pc2, metadata_group) {
    metadata_group_colors <- get(paste(metadata_group, "_colors", sep = ""))
    metadata_group_shapes <- get(paste(metadata_group, "_shapes", sep = ""))

    exp_var <- paste0(round(df$prop_exp_var$X * 100, 2), "%")
    df_X <- df$variates$X %>%
              as.data.frame() %>%
              rownames_to_column("SampleID") %>%
              inner_join(metadata_noblanks %>%
                           select(SampleID, Env, Industry, Ethnic_Group, Age_group, Sex, Market_integration, Village, Tooth_site, Type), by = "SampleID")
    
    metadata_group = df_X[[metadata_group]]
    
                       if (pc1 == 'PC1') {
                           pc1 <- df_X$PC1
                           exp_var_pc1 <- exp_var[1]
                           xaxis <- c("PC1")
                       }  else if (pc1 == 'PC2') {
                           pc1 <- df_X$PC2
                           exp_var_pc1 <- exp_var[2]
                           xaxis <- c("PC2")
                       } else if (pc1 == 'PC3') {
                           pc1 <- df_X$PC3
                           exp_var_pc1 <- exp_var[3]
                           xaxis <- c("PC3")
                       }

                       if (pc2 == 'PC1') {
                           pc2 <- df_X$PC1
                           exp_var_pc2 <- exp_var[1]
                           yaxis <- c("PC1")
                       }  else if (pc2 == 'PC2') {
                           pc2 <- df_X$PC2
                           exp_var_pc2 <- exp_var[2]
                           yaxis <- c("PC2")
                       } else if (pc2 == 'PC3') {
                           pc2 <- df_X$PC3
                           exp_var_pc2 <- exp_var[3]
                           yaxis <- c("PC3")
                       }

    pca_plot <- ggplot(df_X, aes(pc1, pc2, colour = metadata_group, shape = metadata_group)) +
                        geom_point(size = 4) +
                        scale_colour_manual(values = metadata_group_colors) +
                        scale_shape_manual(values = metadata_group_shapes) +
                        # stat_ellipse() +
                        xlab(paste(xaxis, " - ", exp_var_pc1)) +
                        ylab(paste(yaxis, " - ", exp_var_pc2)) +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

    return(pca_plot)
}

# this function plots the PCA with the sample names instead of points
plot_pca_names <- function(df, pc1, pc2, metadata_group) {
    metadata_group_colors <- get(paste(metadata_group, "_colors", sep = ""))

    exp_var <- paste0(round(df$prop_expl_var$X * 100, 2), "%")
    df_X <- df$variates$X %>%
              as.data.frame() %>%
              rownames_to_column("SampleID") %>%
              inner_join(metadata %>%
                           select(SampleID, Env, Industry, Ethnic_Group, Age_group, Sex, Market_integration, Village, Tooth_site, Type), by = "SampleID")
    
    metadata_group = df_X[[metadata_group]]
    
                       if (pc1 == 'PC1') {
                           pc1 <- df_X$PC1
                           exp_var_pc1 <- exp_var[1]
                           xaxis <- c("PC1")
                       }  else if (pc1 == 'PC2') {
                           pc1 <- df_X$PC2
                           exp_var_pc1 <- exp_var[2]
                           xaxis <- c("PC2")
                       } else if (pc1 == 'PC3') {
                           pc1 <- df_X$PC3
                           exp_var_pc1 <- exp_var[3]
                           xaxis <- c("PC3")
                       }

                       if (pc2 == 'PC1') {
                           pc2 <- df_X$PC1
                           exp_var_pc2 <- exp_var[1]
                           yaxis <- c("PC1")
                       }  else if (pc2 == 'PC2') {
                           pc2 <- df_X$PC2
                           exp_var_pc2 <- exp_var[2]
                           yaxis <- c("PC2")
                       } else if (pc2 == 'PC3') {
                           pc2 <- df_X$PC3
                           exp_var_pc2 <- exp_var[3]
                           yaxis <- c("PC3")
                       }

    pca_plot_names <- ggplot(df_X, aes(pc1, pc2, colour = metadata_group)) +
                        geom_text(aes(label = df_X$SampleID), size = 2) +
                        scale_colour_manual(values = metadata_group_colors) +
                        # stat_ellipse() +
                        xlab(paste(xaxis, " - ", exp_var_pc1)) +
                        ylab(paste(yaxis, " - ", exp_var_pc2)) +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

    return(pca_plot_names)
}

```

List the outliers from the plot in section `raw_plot` in `Cameroon_h-g_taxonomy.Rmd` and remove them from the taxonomy table. 
```{r outliers}
outliers <- c("CMC032.B0101",
              "EXB059.A1901","EXB059.A1301","EXB059.A1101","EXB059.A0901",
              "SRR1646041")

outliersF <- str_c(outliers, collapse = "|")

```


We'll need separate metadata files later b/c the factors stick around even when the samples with those factors are removed.
```{r metadata_for_factors}
metadata_original <- fread("00-documentation.backup/01-cameroon_hunter_gatherer_metadata.tsv")

# metadata_noblanks <- metadata_original %>%
#   rename(SampleID = `#SampleID`)  %>%
#   filter(!SampleID %in% outliers) %>%
#   filter(!str_detect(SampleID, "EXB|LIB|10M")) %>%
#   as_tibble() %>%
#   mutate(Market_integration = str_replace(Market_integration, "HMP","Industrial")) %>%
#   mutate(Ethnic_Group = fct_relevel(Ethnic_Group, "Baka","Nzime","Yanomami","HMP","JAE"),
#          Env = fct_relevel(Env, "HunterGatherer","HMP","JAE"),
#          Market_integration = fct_relevel(Market_integration, "Logging road","Forest camp","Farming","Yanomami","Industrial"),
#          Age_group = fct_relevel(Age_group, "10-18","18-29","30-39","40-49","50-59","60+","HMP"),
#          Sex = fct_relevel(Sex, "Male","Female"),
#          Tooth_site = fct_relevel(Tooth_site, "Anterior","Posterior","Buccal_mucosa","HMP"),
#          Village = fct_relevel(Village, "202","205","204","203","206","Yanomami","HMP","JAE"),
#          Industry = fct_relevel(Industry, "Non-industrial","Industrial")) %>%
#   select(SampleID, Age_group, Ethnic_Group, Env, Industry, Market_integration, Sex, Tooth_site, Village)

metadata_noblanks <- metadata_original %>%
  rename(SampleID = `#SampleID`)  %>%
  filter(!SampleID %in% outliers) %>%
  filter(!str_detect(SampleID, "SRR16460|EXB|LIB|10M|SRS|ERR")) %>%
  as_tibble() %>%
  mutate(Market_integration = str_replace(Market_integration, "HMP","Industrial")) %>%
  mutate(Ethnic_Group = fct_relevel(Ethnic_Group, "Baka","Nzime","HMP","JAE"),
         Env = fct_relevel(Env, "HunterGatherer","HMP","JAE"),
         Market_integration = fct_relevel(Market_integration, "Logging road","Forest camp","Farming","Industrial"),
         Age_group = fct_relevel(Age_group, "18-29","30-39","40-49","50-59","60+","HMP"),
         Sex = fct_relevel(Sex, "Male","Female"),
         Tooth_site = fct_relevel(Tooth_site, "Anterior","Posterior","HMP"),
         Village = fct_relevel(Village, "202","205","204","203","206","HMP","JAE"),
         Industry = fct_relevel(Industry, "Non-industrial","Industrial")) %>%
  select(SampleID, Age_group, Ethnic_Group, Env, Industry, Market_integration, Sex, Tooth_site, Village, Type)

metadata_cmc <- metadata_original %>%
  rename(SampleID = `#SampleID`) %>%
  filter(!SampleID %in% outliers) %>%
  filter(str_detect(SampleID, "CMC")) %>%
  select(SampleID, Age_group, Ethnic_Group, Market_integration, Sex, Tooth_site, Village) %>%
  as_tibble() %>%
  mutate(Age_group = fct_relevel(Age_group, "18-29","30-39","40-49","50-59","60+"),
         Ethnic_Group = fct_relevel(Ethnic_Group, "Baka","Nzime"),
         Market_integration = fct_relevel(Market_integration, "Logging road","Forest camp","Farming"),
         Sex = fct_relevel(Sex, "Male","Female"),
         Tooth_site = fct_relevel(Tooth_site, "Anterior","Posterior"),
         Village = fct_relevel(Village, "202","205","204","203","206"))

```


```{r input_tables}
# species, no blanks 
# malt_species.decontam_filtered_noblanks <- malt_species.decontam %>%
#                                          select(-one_of(outliers)) %>%
#                                          select(-starts_with("EXB")) %>%
#                                          select(-starts_with("LIB")) %>%
#                                          select(-contains("10M")) %>%
#                                          adorn_totals(where = "col", name = "Sum_species") %>%
#                                          mutate(Percent = Sum_species/sum(Sum_species)*100) %>%
#                                          filter(Percent > 0.0005) %>%
#                                          select(-one_of(c("Sum_species","Percent"))) %>%
#                                          gather("SampleID","Counts",2:ncol(.)) %>%
#                                          mutate(Counts = Counts + 1) %>%
#                                          spread(Species,Counts) %>%
#                                          column_to_rownames("SampleID")

# perform PCA to get a clr-transformed species table
# malt_species.decontam_filtered_noblanks.pca <- mixOmics::pca(malt_species.decontam_filtered_noblanks, ncomp = 3, logratio = 'CLR')
# save the clr-transformed species table
# malt_species.decontam_filtered_noblanks_clr <- as.data.frame.matrix(malt_species.decontam_filtered_noblanks.pca$X)


# species, no blanks, no other buccal mucosa, no saliva
malt_species.decontam_filtered_noblanks <- malt_species.decontam %>%
  select(-one_of(outliers)) %>%
  pivot_longer(!Species, names_to = "SampleID", values_to = "Counts") %>%
  pivot_wider(names_from = "Species", values_from = "Counts") %>%
  left_join(., metadata_noblanks %>% select(SampleID, Ethnic_Group), by = "SampleID") %>%
  filter(str_detect(Ethnic_Group, "Baka|Nzime|Industrial")) %>%
  select(-Ethnic_Group) %>%
  pivot_longer(!SampleID, names_to = "Species", values_to = "Counts") %>%
  pivot_wider(names_from = "SampleID", values_from = "Counts") %>%
  adorn_totals(where = "col", name = "Sum_species") %>%
  mutate(Percent = Sum_species/sum(Sum_species)*100) %>%
  filter(Percent > 0.0005) %>%
  select(-one_of(c("Sum_species","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("SampleID")

# perform PCA to get a clr-transformed species table
malt_species.decontam_filtered_noblanks.pca <- mixOmics::pca(malt_species.decontam_filtered_noblanks, ncomp = 3, logratio = 'CLR')
# save the clr-transformed species table
malt_species.decontam_filtered_noblanks_clr <- as.data.frame.matrix(malt_species.decontam_filtered_noblanks.pca$X)

# species, CMC samples only
malt_species.decontam_filtered_cmc <- malt_species.decontam %>%
  select(-one_of(outliers)) %>%
  select(matches("Species|CMC")) %>%
  adorn_totals(where = "col", name = "Sum_species") %>%
  mutate(Percent = Sum_species/sum(Sum_species)*100) %>%
  filter(Percent > 0.0005) %>%
  select(-one_of(c("Sum_species","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("SampleID")

# perform PCA to get a clr-transformed species table
malt_species.decontam_filtered_cmc.pca <- mixOmics::pca(malt_species.decontam_filtered_cmc, ncomp = 3, logratio = 'CLR')
# save the clr-transformed species table
malt_species.decontam_filtered_cmc_clr <- as.data.frame.matrix(malt_species.decontam_filtered_cmc.pca$X)

```


# CMC + Industrial
Run a factor analysis
```{r fa_species_decontam_noblanks}
# from the graphs, I selected fm = minres and rotate = oblimin
malt_species.decontam_filtered_noblanks.fa <- fa(malt_species.decontam_filtered_noblanks_clr, nfactors = 6, rotate = "oblimin", fm = "minres") # rotate = "varimax" "Varimax" "oblimin" # fm = "ols" "minres"
print(malt_species.decontam_filtered_noblanks.fa)
# print(malt_species.decontam_filtered_noblanks.fa$loadings,cutoff = 0.7)
# print(malt_species.decontam_filtered_noblanks.fa,sort=TRUE)

malt_species.decontam_filtered_noblanks.fa$values %>%
  as.data.frame(.) %>%
  rename(Eigenvalues = ".") %>%
  arrange(desc(Eigenvalues))%>%
  rownames_to_column("xvalue") %>%
  mutate(xvalue = as.numeric(xvalue)) %>%
  filter(xvalue <= 20) %>%
  ggplot(., aes(xvalue, Eigenvalues)) +
         geom_point() +
         theme_minimal() +
         geom_hline(yintercept = 10, linetype = "dashed", color = "red")

# get the minimum residual values into a datatable
graphinfo <- as.data.frame(factor2cluster(malt_species.decontam_filtered_noblanks.fa))
colnames(graphinfo) <- c("MR11","MR21","MR31","MR41","MR51","MR61")
graphinfo <- graphinfo %>%
  rownames_to_column("Species") %>%
  as_tibble(.)

# now make loadings into a table and designate each species in the residual with the highest absolute value
malt_species.decontam_filtered_noblanks.fa.df <- as.data.frame.matrix(malt_species.decontam_filtered_noblanks.fa$loadings)
# b/c of rotation, the MRs may not be in numerial order. Change the column titles to be in numerical order for downstream processing
colnames(malt_species.decontam_filtered_noblanks.fa.df) <- c("MR1","MR2","MR3","MR4","MR5","MR6")
malt_species.decontam_filtered_noblanks.fa.df <- malt_species.decontam_filtered_noblanks.fa.df %>%
  as_tibble(.) %>%
  bind_cols(., graphinfo) %>%
  mutate(MR11 = as.character(MR11),
         MR21 = as.character(MR21),
         MR31 = as.character(MR31),
         MR41 = as.character(MR41),
         MR51 = as.character(MR51)) %>%
  mutate(MR11 = replace(MR11, MR11 != "0", "MR1"),
         MR21 = replace(MR21, MR21 != "0", "MR2"),
         MR31 = replace(MR31, MR31 != "0", "MR3"),
         MR41 = replace(MR41, MR41 != "0", "MR4"),
         MR51 = replace(MR51, MR51 != "0", "MR5")) %>%
  select(Species,everything(.)) %>%
  select(-matches("MR5|MR6|MR7")) %>%
  gather("Group","Residual", 6:ncol(.)) %>%
  filter(Residual != "0") %>%
  select(Residual, Species, MR1, MR2, MR3, MR4)

head(malt_species.decontam_filtered_noblanks.fa.df)


# save the species using in downstream discriminant analyses as a table
malt_species.decontam_filtered_noblanks.fa_species <- malt_species.decontam_filtered_noblanks.fa.df %>% 
  filter(Residual %in% c("MR1","MR2","MR3")) %>%
  select(Species, Residual)

# fwrite(malt_species.decontam_filtered_noblanks.fa_species, file = "./05-results.backup/minres_oblimin_noblanks.fa_species.tsv", quote = F, sep = "\t")

```

Run a discriminant analysis using only the species in the first 2 factors (MR1, MR2)
```{r lda_species_decontam_noblanks_eg}
# select only the species that make up the 1st 2 residuals, based on the scree plot above
fa_species_noblanks <- malt_species.decontam_filtered_noblanks.fa.df %>% 
  filter(Residual %in% c("MR1")) %>%
  pull(Species)

# sub-sample the species table for only those species
malt_species.decontam_filtered_noblanks_da_table <- malt_species.decontam_filtered_noblanks_clr %>%
  select(one_of(fa_species_noblanks)) %>%
  rownames_to_column("SampleID") %>%
  inner_join(., metadata_nofactors %>%
               # change the column after SampleID to get the metadata category you want 
               # Age_group, Ethnic_Group, Env, Industry, Market_integration, Sex, Tooth_site, Village
               select(SampleID, Ethnic_Group)) %>%
  select(SampleID, Ethnic_Group, everything())

rownames(malt_species.decontam_filtered_noblanks_da_table) <- malt_species.decontam_filtered_noblanks_da_table$SampleID
malt_species.decontam_filtered_noblanks_da_table <- malt_species.decontam_filtered_noblanks_da_table %>% select(-SampleID)

malt_species.decontam_filtered_noblanks_lda <- lda(Ethnic_Group ~ ., malt_species.decontam_filtered_noblanks_da_table)
malt_species.decontam_filtered_noblanks_lda # show results

plot(malt_species.decontam_filtered_noblanks_lda, dimen = 2)

lda.data <- cbind(malt_species.decontam_filtered_noblanks_da_table, predict(malt_species.decontam_filtered_noblanks_lda)$x)

noyanomami_eg <- ggplot(lda.data, aes(LD1, LD2, colour = Ethnic_Group, shape = Ethnic_Group)) +
                        geom_point(size = 4) +
                        scale_colour_manual(values = Ethnic_Group_colors) +
                        scale_shape_manual(values = Ethnic_Group_shapes) +
                        xlab("LD1") +
                        ylab("LD2") +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

noyanomami_eg

x <- malt_species.decontam_filtered_noblanks_lda$means %>% 
  as_data_frame() %>% 
  mutate(names = rownames(malt_species.decontam_filtered_noblanks_lda$means)) %>% 
  select(names, everything()) %>%
  pivot_longer(!names, names_to = "Species", values_to = "Loadings") %>%
  pivot_wider(names_from = "names", values_from = "Loadings")

```


```{r lda_species_decontam_noblanks_age, eval = F}
# errors out b/c the VLC samples have no age

# select only the species that make up the 1st 2 residuals, based on the scree plot above
fa_species_noblanks <- malt_species.decontam_filtered_noblanks.fa.df %>% 
  filter(Residual %in% c("MR1")) %>%
  pull(Species)

# sub-sample the species table for only those species
malt_species.decontam_filtered_noblanks_da_table <- malt_species.decontam_filtered_noblanks_clr %>%
  select(one_of(fa_species_noblanks)) %>%
  rownames_to_column("SampleID") %>%
  inner_join(., metadata_noblanks %>%
               select(SampleID, Age_group)) %>%
  select(SampleID, Age_group, everything())

rownames(malt_species.decontam_filtered_noblanks_da_table) <- malt_species.decontam_filtered_noblanks_da_table$SampleID
malt_species.decontam_filtered_noblanks_da_table <- malt_species.decontam_filtered_noblanks_da_table %>% select(-SampleID)

malt_species.decontam_filtered_noblanks_lda <- lda(Age_group ~ ., malt_species.decontam_filtered_noblanks_da_table)
malt_species.decontam_filtered_noblanks_lda # show results

lda.data <- cbind(malt_species.decontam_filtered_noblanks_da_table, predict(malt_species.decontam_filtered_noblanks_lda)$x)

noyanomami_ag <- ggplot(lda.data, aes(LD1, LD2, colour = Age_group, shape = Age_group)) +
                        geom_point(size = 4) +
                        scale_colour_manual(values = Age_group_colors) +
                        scale_shape_manual(values = Age_group_shapes) +
                        xlab("LD1") +
                        ylab("LD2") +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

noyanomami_ag

```


```{r lda_species_decontam_noblanks_me}
# select only the species that make up the 1st 2 residuals, based on the scree plot above
fa_species_noblanks <- malt_species.decontam_filtered_noblanks.fa.df %>% 
  filter(Residual %in% c("MR1","MR2")) %>%
  pull(Species)

# sub-sample the species table for only those species
malt_species.decontam_filtered_noblanks_da_table <- malt_species.decontam_filtered_noblanks_clr %>%
  select(one_of(fa_species_noblanks)) %>%
  rownames_to_column("SampleID") %>%
  inner_join(., metadata_noblanks %>%
               select(SampleID, Market_integration)) %>%
  select(SampleID, Market_integration, everything())

rownames(malt_species.decontam_filtered_noblanks_da_table) <- malt_species.decontam_filtered_noblanks_da_table$SampleID
malt_species.decontam_filtered_noblanks_da_table <- malt_species.decontam_filtered_noblanks_da_table %>% select(-SampleID)

malt_species.decontam_filtered_noblanks_lda <- lda(Market_integration ~ ., malt_species.decontam_filtered_noblanks_da_table)
malt_species.decontam_filtered_noblanks_lda # show results

lda.data <- cbind(malt_species.decontam_filtered_noblanks_da_table, predict(malt_species.decontam_filtered_noblanks_lda)$x)

noyanomami_me <- ggplot(lda.data, aes(LD1, LD2, colour = Market_integration, shape = Market_integration, size = Market_integration)) +
                        geom_point() +
                        scale_colour_manual(values = Market_integration_colors) +
                        scale_shape_manual(values = Market_integration_shapes) +
                        scale_size_manual(values = c(3,4,3,3)) +
                        xlab("LD1") +
                        ylab("LD2") +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

noyanomami_me

```


```{r lda_species_decontam_noblanks_sex}
# select only the species that make up the 1st 2 residuals, based on the scree plot above
fa_species_noblanks <- malt_species.decontam_filtered_noblanks.fa.df %>% 
  filter(Residual %in% c("MR1","MR2")) %>%
  pull(Species)

# sub-sample the species table for only those species
malt_species.decontam_filtered_noblanks_da_table <- malt_species.decontam_filtered_noblanks_clr %>%
  select(one_of(fa_species_noblanks)) %>%
  rownames_to_column("SampleID") %>%
  inner_join(., metadata_noblanks %>%
               select(SampleID, Sex)) %>%
  select(SampleID, Sex, everything()) %>%
  filter(Sex != "Unknown")

rownames(malt_species.decontam_filtered_noblanks_da_table) <- malt_species.decontam_filtered_noblanks_da_table$SampleID
malt_species.decontam_filtered_noblanks_da_table <- malt_species.decontam_filtered_noblanks_da_table %>% select(-SampleID)

malt_species.decontam_filtered_noblanks_lda <- lda(Sex ~ ., malt_species.decontam_filtered_noblanks_da_table)
malt_species.decontam_filtered_noblanks_lda # show results

lda.data <- cbind(malt_species.decontam_filtered_noblanks_da_table, predict(malt_species.decontam_filtered_noblanks_lda)$x)

# # works only if the Unknown sample is left in
# ggplot(lda.data, aes(LD1, LD2, colour = Sex, shape = Sex)) +
#                         geom_point(size = 4) +
#                         scale_colour_manual(values = Sex_colors) +
#                         scale_shape_manual(values = Sex_shapes) +
#                         xlab("LD1") +
#                         ylab("LD2") +
#                         theme_minimal(base_size = 10) +
#                         theme(legend.position = "top") +
#                         theme(legend.title = element_blank())

noyanomami_sex <- ggplot(lda.data, aes(x = Sex, y = LD1, group = Sex, fill = Sex)) +
                        geom_boxplot() + 
                        geom_jitter(size = 2, aes(shape = Sex)) +
                        scale_fill_manual(values = Sex_colors) +
                        scale_shape_manual(values = c(3,4)) +
                        xlab("LD1") +
                        ylab("LD2") +
                        geom_hline(yintercept = 0, linetype = "dashed") +
                        coord_flip() +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())


noyanomami_sex

```


```{r lda_species_decontam_noblanks_ts, eval = F}
# fails b/c VLC doesn't have tooth site

# select only the species that make up the 1st 2 residuals, based on the scree plot above
fa_species_noblanks <- malt_species.decontam_filtered_noblanks.fa.df %>% 
  filter(Residual %in% c("MR1")) %>%
  pull(Species)

# sub-sample the species table for only those species
malt_species.decontam_filtered_noblanks_da_table <- malt_species.decontam_filtered_noblanks_clr %>%
  select(one_of(fa_species_noblanks)) %>%
  rownames_to_column("SampleID") %>%
  inner_join(., metadata_noblanks %>%
               select(SampleID, Tooth_site)) %>%
  select(SampleID, Tooth_site, everything())

rownames(malt_species.decontam_filtered_noblanks_da_table) <- malt_species.decontam_filtered_noblanks_da_table$SampleID
malt_species.decontam_filtered_noblanks_da_table <- malt_species.decontam_filtered_noblanks_da_table %>% select(-SampleID)

malt_species.decontam_filtered_noblanks_lda <- lda(Tooth_site ~ ., malt_species.decontam_filtered_noblanks_da_table)
malt_species.decontam_filtered_noblanks_lda # show results

lda.data <- cbind(malt_species.decontam_filtered_noblanks_da_table, predict(malt_species.decontam_filtered_noblanks_lda)$x)

noyanomami_ts <- lda.data %>%
  rownames_to_column("SampleID") %>%
  ggplot(., aes(LD1, LD2, colour = Tooth_site, shape = Tooth_site)) +
                        geom_point(size = 4) +
                        # geom_text(aes(label = SampleID), size = 2) +
                        scale_colour_manual(values = Tooth_site_colors) +
                        scale_shape_manual(values = Tooth_site_shapes) +
                        xlab("LD1") +
                        ylab("LD2") +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

noyanomami_ts

```


```{r lda_species_decontam_noblanks_vi}
# select only the species that make up the 1st 2 residuals, based on the scree plot above
fa_species_noblanks <- malt_species.decontam_filtered_noblanks.fa.df %>% 
  filter(Residual %in% c("MR1", "MR2")) %>%
  pull(Species)

# sub-sample the species table for only those species
malt_species.decontam_filtered_noblanks_da_table <- malt_species.decontam_filtered_noblanks_clr %>%
  select(one_of(fa_species_noblanks)) %>%
  rownames_to_column("SampleID") %>%
  inner_join(., metadata_noblanks %>%
               select(SampleID, Village)) %>%
  select(SampleID, Village, everything())

rownames(malt_species.decontam_filtered_noblanks_da_table) <- malt_species.decontam_filtered_noblanks_da_table$SampleID
malt_species.decontam_filtered_noblanks_da_table <- malt_species.decontam_filtered_noblanks_da_table %>% select(-SampleID)

malt_species.decontam_filtered_noblanks_lda <- lda(Village ~ ., malt_species.decontam_filtered_noblanks_da_table)
malt_species.decontam_filtered_noblanks_lda # show results

lda.data <- cbind(malt_species.decontam_filtered_noblanks_da_table, predict(malt_species.decontam_filtered_noblanks_lda)$x)

noyanomami_vi <- ggplot(lda.data, aes(LD1, LD2, colour = Village, shape = Village)) +
                        geom_point(size = 4) +
                        scale_colour_manual(values = Village_colors) +
                        scale_shape_manual(values = Village_shapes) +
                        xlab("LD1") +
                        ylab("LD2") +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

noyanomami_vi

```

```{r noblanks_images}

allplots_noyanomami <- plot_grid(noyanomami_eg, noyanomami_me, 
                                 noyanomami_sex, noyanomami_vi,
          nrow=2, labels = c("A", "B", "C", "D"), rel_widths = c(1, 1))
allplots_noyanomami


# ggsave("./06-publication/supplemental_figures/SXX9/SXX9_all_lda_plots.pdf", plot = allplots_noyanomami, device = "pdf",
#         scale = 1, width = 11, height = 10, units = c("in"), dpi = 300)
# ggsave("./06-publication/supplemental_figures/SXX9/SXX9_all_lda_plots.png", plot = allplots_noyanomami, device = "png",
#         scale = 1, width = 11, height = 10, units = c("in"), dpi = 300)

```

## Heatmaps
Make a heat map of the species in MR1 and MR2 to see how they're different between the groups
```{r metadata_heatmaps}
minres_oblimin_nobl_noyano_fa_species <- fread("./05-results.backup/minres_oblimin_noblanks.fa_species.tsv", sep = "\t")
minres_oblimin_cmc_fa_species <- fread("./05-results.backup/minres_oblimin_cmc.fa_species.tsv", sep = "\t")

# read in metadata again to get it without all the factors
metadata_hm <- fread("00-documentation.backup/01-cameroon_hunter_gatherer_metadata.tsv")

# order the samples so they can be ordered this way in the heat maps

# order the CMC samples by Village
cmc_order <- metadata_hm %>%
  rename(SampleID = `#SampleID`)  %>%
  as_tibble() %>%
  filter(str_detect(SampleID, "CMC")) %>%
  mutate(Village = fct_relevel(Village, "202","205","204","203","206")) %>%
  select(SampleID, Village) %>%
  arrange(Village) %>%
  pull(SampleID)

# order the HMP samples by subplaque, supraplaque
hmp_order <- metadata_hm %>%
  rename(SampleID = `#SampleID`)  %>%
  as_tibble() %>%
  filter(str_detect(SampleID, "SRR")) %>%
  filter(!str_detect(SampleID, "10M|SRR164")) %>%
  mutate(Description = fct_relevel(Description, "HMP_subPlaque","HMP_supPlaque")) %>%
  select(SampleID, Description) %>%
  arrange(Description) %>%
  pull(SampleID)

# keep JAE samples in alphabetical order
jae_order <- metadata_hm %>%
  rename(SampleID = `#SampleID`)  %>%
  as_tibble() %>%
  filter(str_detect(SampleID, "JAE|VLC")) %>%
  filter(!str_detect(SampleID, "10M")) %>%
  pull(SampleID)

# combine all 3 ordered vectors into a final ordered vector
each_order <- c(cmc_order, jae_order, hmp_order)

```

To change the heatmap label colors by different metadata categories swap out the
sections below
```{r heatmap_label_colors, eval = F}

Village_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Village = c("202","205","204","203","206","Yanomami","Industrial plaque","HMP10M","JAE10M","Industrial calculus","ExtractionGauze","ExtractionBlank","LibraryBlank")) %>%
               filter(!str_detect(Village, "Yanomami|10M|Gauze|Blank")), by = "Village"

Sex_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Sex = c("Female","Male","Unknown","ExtractionGauze","ExtractionBlank","LibraryBlank")) %>%
               filter(!str_detect(Sex, "Gauze|Blank")), by = "Sex"


Age_group_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Age_group = c("18-29","30-39","40-49","50-59","6+","10-18","HMP","HMP10M","ExtractionGauze","ExtractionBlank","LibraryBlank")) %>%
               filter(!str_detect(Age_group, "10|10M|Gauze|Blank")), by = "Age_group"


```

Try changing the sample order to group them by the different metadata categories
(currently have Industrialization/Ethnic group/Market integration/Village grouping).
Need to look at: Tooth site, Age group, Sex, others? Also try clustering the
samples to see if they fall into any recognizable categories.
```{r heatmap_noblanks}
# select the species in MR1 and MR2 for the FA
malt_species.decontam_FA_all <- malt_species.decontam %>%
                                  select(-one_of(outliers)) %>%
                                  select(-matches("SRR164|10M|EXB|LIB")) %>%
                                  inner_join(., minres_oblimin_nobl_noyano_fa_species %>%
                                               filter(str_detect(Residual, "MR1")) %>%
                                               select(-Residual)) %>%
                                  as_tibble(.) %>%
                                  gather("SampleID","Counts",2:ncol(.)) %>%
                                  mutate(Counts = as.numeric(Counts),
                                         Counts = Counts + 1) %>%
                                  spread(Species,Counts) %>%
                                  column_to_rownames("SampleID")

# # CLR-transform the matrix for plotting the heatmap
malt_species.decontam_FA_all_clr <- clr(malt_species.decontam_FA_all)
malt_species.decontam_FA_all_clr <- as.matrix(malt_species.decontam_FA_all_clr)

# orient the matrix with correct rows/columns to run the distance calculation for the species, not the samples (columns are SampleID, rows are Species)
malt_species.decontam_FA_all_clr_sp <- malt_species.decontam_FA_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","Counts",2:ncol(.)) %>%
  spread(SampleID,Counts)

#add the rownames back
rownames(malt_species.decontam_FA_all_clr_sp) <- malt_species.decontam_FA_all_clr_sp$Species
malt_species.decontam_FA_all_clr_sp <- malt_species.decontam_FA_all_clr_sp %>% select(-Species)

# perform a distance calculation for hierarchical clustering for the species ordering
malt_species.decontam_FA_all_clr_dist <- vegdist(malt_species.decontam_FA_all_clr_sp, method = "euclidian")
# cluster the data with hclust
malt_species.decontam_FA_all_clr_dist_hr <- hclust(malt_species.decontam_FA_all_clr_dist)
# malt_species.decontam_FA_all_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
sp_all_order <- malt_species.decontam_FA_all_clr_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
malt_species.decontam_FA_all_clr_order <- malt_species.decontam_FA_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(SpOrder = as.character(seq(1,123))) %>% # MR1 - 123
  select(Species, SpOrder, everything()) %>%
  mutate(SpOrder = fct_relevel(SpOrder, sp_all_order)) %>%
  arrange(SpOrder) %>%
  pull(Species)

# make the species a factor so they're in the correct order for the heatmap using the vector from the step above
malt_species.decontam_FA_all_clr_long <- malt_species.decontam_FA_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, malt_species.decontam_FA_all_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.))


# now cluster by sample
# convert the matrix to a data.frame
malt_species.decontam_FA_all_clr_smp <- malt_species.decontam_FA_all_clr %>%
  as.data.frame()

# perform a distance calculation for hierarchical clustering for the species ordering
malt_species.decontam_FA_all_clr_smp_dist <- vegdist(malt_species.decontam_FA_all_clr_smp, method = "euclidian")
# cluster the data with hclust
malt_species.decontam_FA_all_clr_smp_dist_hr <- hclust(malt_species.decontam_FA_all_clr_smp_dist)
# malt_species.decontam_FA_all_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
smp_all_order <- malt_species.decontam_FA_all_clr_smp_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
malt_species.decontam_FA_all_clr_smp_order <- malt_species.decontam_FA_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Species,CLR) %>%
  mutate(SmpOrder = as.character(seq(1,165))) %>%  
  select(SampleID, SmpOrder, everything()) %>%
  mutate(SmpOrder = fct_relevel(SmpOrder, smp_all_order)) %>%
  arrange(SmpOrder) %>%
  pull(SampleID)

# Plot the heatmap with samples ordered by the clustering from above
# make the SampleIDs a factor so they're in the correct order for the heatmap using the vector from the step above
malt_species.decontam_FA_all_clr_long <- malt_species.decontam_FA_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, malt_species.decontam_FA_all_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Market_integration_split), by = "SampleID") %>%
  inner_join(., minres_oblimin_nobl_noyano_fa_species, by = "Species") %>%
  inner_join(., Market_integration_split_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Market_integration_split = c("Logging road","Forest camp","Farming","Yanomami","Industrial plaque","Industrial calculus","ExtractionGauze","ExtractionBlank","LibraryBlank")), by = "Market_integration_split") %>%
  mutate(SampleID = fct_relevel(SampleID, malt_species.decontam_FA_all_clr_smp_order)) %>%
  arrange(SampleID)

vector_color = malt_species.decontam_FA_all_clr_long %>%
  select(SampleID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

sp_color = malt_species.decontam_FA_all_clr_long %>%
  select(Species, Residual) %>%
  unique %>%
  mutate(Residual = str_replace_all(Residual, "MR1", "magenta"),
         Residual = str_replace_all(Residual, "MR2", "cyan")) %>%
  pull(Residual) %>%
  as.character()

# make a heatmap with ggplot
heatmap_smp_cluster <- malt_species.decontam_FA_all_clr_long %>%
  mutate(Species = fct_relevel(Species, malt_species.decontam_FA_all_clr_order)) %>%
  ggplot(., aes(SampleID, Species, fill = CLR)) +
    geom_tile() +
    scale_fill_viridis_c(option = "A") +
    theme_minimal(base_size = 7) +
    theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
          plot.margin = margin(0, 0, 0, 0, "pt"),
          axis.title.y = element_blank(),
          legend.position = "left")

heatmap_smp_cluster

ggsave("./06-publication/supplemental_figures/SXX11/SXX11_all_fa_heatmaps.pdf", plot = heatmap_smp_cluster, device = "pdf",
       scale = 1, width = 10, height = 10, units = c("in"), dpi = 300)
ggsave("./06-publication/supplemental_figures/SXX11/SXX11_all_fa_heatmaps.png", plot = heatmap_smp_cluster, device = "png",
       scale = 1, width = 10, height = 10, units = c("in"), dpi = 300)


# Plot the heatmap with samples ordered by Village, then alphabetical
# make the SampleIDs a factor so they're in the correct order for the heatmap using the vector from the step above
malt_species.decontam_FA_all_clr_long <- malt_species.decontam_FA_all_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, malt_species.decontam_FA_all_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Village), by = "SampleID") %>%
  inner_join(., Village_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Village = c("202","205","204","203","206","Industrial plaque","Industrial calculus")), by = "Village") %>%
  mutate(SampleID = fct_relevel(SampleID, each_order)) %>%
  arrange(SampleID)

vector_color = malt_species.decontam_FA_all_clr_long %>%
  select(SampleID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_smp_village <- ggplot(malt_species.decontam_FA_all_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_smp_village


```

How does a PCA using only the species in MR1 look?
```{r discriminant_taxa_pca}
# decontaminated and filtered
malt_species.decontam_filtered_noblanks_FA <- malt_species.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("10M|SRR164|EXB|LIB|ERR|SRS")) %>%
                                         inner_join(., minres_oblimin_nobl_noyano_fa_species %>%
                                                      filter(str_detect(Residual, "MR1")) %>%
                                                      select(-Residual)) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         mutate(Counts = as.numeric(Counts),
                                                Counts = Counts + 1) %>%
                                         spread(Species,Counts) %>%
                                         column_to_rownames("SampleID")

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.pca(malt_species.decontam_filtered_noblanks_FA, logratio = 'CLR')

# perform a PCA to see how the data cluster
malt_species.decontam_filtered_noblanks_FA.pca <- pca(malt_species.decontam_filtered_noblanks_FA, ncomp = 3, logratio = 'CLR')

# perform and plot a PCA to see how the data cluster
# by Village
noblanks_fa_pca <- plot_pca(malt_species.decontam_filtered_noblanks_FA.pca, "PC1", "PC2", "Village")
noblanks_fa_pca

# ggsave("05-results.backup/noblanks_fa_pca.pdf", plot = noblanks_fa_pca, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

```

# CMC only
Now only CMC samples
```{r fa_species_decontam_cmc}
# fa.parallel(malt_species.decontam_filtered_cmc, fm = "minres", n.iter = 19)

# from the graphs, I selected fm = minres and rotate = oblimin
malt_species.decontam_filtered_cmc.fa <- fa(malt_species.decontam_filtered_cmc_clr, nfactors = 6, rotate = "oblimin", fm = "minres") # rotate = "varimax" "oblimin" "Varimax" # fm = "ols" "minres"
print(malt_species.decontam_filtered_cmc.fa)
# print(malt_species.decontam_filtered_cmc.fa$loadings,cutoff = 0.7)
# print(malt_species.decontam_filtered_cmc.fa,sort=TRUE)

malt_species.decontam_filtered_cmc.fa$values %>%
  as.data.frame(.) %>%
  rename(Eigenvalues = ".") %>%
  arrange(desc(Eigenvalues))%>%
  rownames_to_column("xvalue") %>%
  mutate(xvalue = as.numeric(xvalue)) %>%
  filter(xvalue <= 20) %>%
  ggplot(., aes(xvalue, Eigenvalues)) +
         geom_point() +
         theme_minimal() +
         geom_hline(yintercept = 10, linetype = "dashed", color = "red")

# get the minimum residual values into a datatable
graphinfo <- as.data.frame(factor2cluster(malt_species.decontam_filtered_cmc.fa))
colnames(graphinfo) <- c("MR11","MR21","MR31","MR41","MR51","MR61")
graphinfo <- graphinfo %>%
  rownames_to_column("Species") %>%
  as_tibble(.)

# now make loadings into a table and designate each species in the residual with the highest absolute value
malt_species.decontam_filtered_cmc.fa.df <- as.data.frame.matrix(malt_species.decontam_filtered_cmc.fa$loadings)
# b/c of rotation, the MRs may not be in numerial order. Change the column titles to be in numerical order for downstream processing
colnames(malt_species.decontam_filtered_cmc.fa.df) <- c("MR1","MR2","MR3","MR4","MR5","MR6")
malt_species.decontam_filtered_cmc.fa.df <- malt_species.decontam_filtered_cmc.fa.df %>%
  as_tibble(.) %>%
  bind_cols(., graphinfo) %>%
  mutate(MR11 = as.character(MR11),
         MR21 = as.character(MR21),
         MR31 = as.character(MR31)) %>%
  mutate(MR11 = replace(MR11, MR11 != "0", "MR1"),
         MR21 = replace(MR21, MR21 != "0", "MR2"),
         MR31 = replace(MR31, MR31 != "0", "MR3")) %>%
  select(Species,everything(.)) %>%
  gather("Group","Residual", 5:ncol(.)) %>%
  filter(Residual != "0") %>%
  select(Residual, Species, MR1, MR3, MR2)

head(malt_species.decontam_filtered_cmc.fa.df)

# now run a discriminant analysis

# save the species using in downstream discriminant analyses as a table
malt_species.decontam_filtered_cmc.fa_species <- malt_species.decontam_filtered_cmc.fa.df %>% 
  filter(Residual %in% c("MR1","MR2","MR3")) %>%
  select(Species, Residual)

# fwrite(malt_species.decontam_filtered_cmc.fa_species, file = "./05-results.backup/minres_oblimin_cmc.fa_species.tsv", quote = F, sep = "\t")

```

```{r lda_species_decontam_cmc_eg}

# select only the species that make up the 1st 2 residuals, based on the scree plot above
fa_species_cmc <- malt_species.decontam_filtered_cmc.fa.df %>% 
  filter(Residual %in% c("MR1")) %>%
  pull(Species)

# sub-sample the species table for only those species
malt_species.decontam_filtered_cmc_lda_table <- malt_species.decontam_filtered_cmc_clr %>%
  select(one_of(fa_species_cmc)) %>%
  rownames_to_column("SampleID") %>%
  inner_join(., metadata_cmc %>%
               # change the column after SampleID to get the metadata category you want 
               # Age_group, Ethnic_Group, Env, Industry, Market_integration, Sex, Tooth_site, Village
               select(SampleID, Ethnic_Group)) %>%
  select(SampleID, Ethnic_Group, everything())

rownames(malt_species.decontam_filtered_cmc_lda_table) <- malt_species.decontam_filtered_cmc_lda_table$SampleID
malt_species.decontam_filtered_cmc_lda_table <- malt_species.decontam_filtered_cmc_lda_table %>% select(-SampleID)

malt_species.decontam_filtered_cmc_lda <- lda(Ethnic_Group ~ ., malt_species.decontam_filtered_cmc_lda_table)
malt_species.decontam_filtered_cmc_lda # show results

plotit <- plot(malt_species.decontam_filtered_cmc_lda)
plotit

lda.data <- cbind(malt_species.decontam_filtered_cmc_lda_table, predict(malt_species.decontam_filtered_cmc_lda)$x)
# lda.data <- lda.data %>%
#   rownames_to_column("SampleID")


cmc_eg <- ggplot(lda.data, aes(x = Ethnic_Group, y = LD1, group = Ethnic_Group, fill = Ethnic_Group)) +
                        geom_boxplot() + 
                        geom_jitter(size = 2, aes(shape = Ethnic_Group)) +
                        scale_fill_manual(values = Ethnic_Group_colors) +
                        scale_shape_manual(values = c(3,4)) +
                        xlab("Ethnic Group") +
                        ylab("LD1") +
                        geom_hline(yintercept = 0, linetype = "dashed") +
                        coord_flip() +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

cmc_eg

```


```{r lda_species_decontam_cmc_age}

# select only the species that make up the 1st 2 residuals, based on the scree plot above
fa_species_cmc <- malt_species.decontam_filtered_cmc.fa.df %>% 
  filter(Residual %in% c("MR1")) %>%
  pull(Species)

# sub-sample the species table for only those species
malt_species.decontam_filtered_cmc_lda_table <- malt_species.decontam_filtered_cmc_clr %>%
  select(one_of(fa_species_cmc)) %>%
  rownames_to_column("SampleID") %>%
  inner_join(., metadata_cmc %>%
               select(SampleID, Age_group)) %>%
  select(SampleID, Age_group, everything())

rownames(malt_species.decontam_filtered_cmc_lda_table) <- malt_species.decontam_filtered_cmc_lda_table$SampleID
malt_species.decontam_filtered_cmc_lda_table <- malt_species.decontam_filtered_cmc_lda_table %>% select(-SampleID)

malt_species.decontam_filtered_cmc_lda <- lda(Age_group ~ ., malt_species.decontam_filtered_cmc_lda_table)
malt_species.decontam_filtered_cmc_lda # show results

lda.data <- cbind(malt_species.decontam_filtered_cmc_lda_table, predict(malt_species.decontam_filtered_cmc_lda)$x)

cmc_ag <- ggplot(lda.data, aes(LD1, LD2, colour = Age_group, shape = Age_group, size = Age_group)) +
                        geom_point() +
                        scale_colour_manual(values = Age_group_colors) +
                        scale_shape_manual(values = Age_group_shapes) +
                        scale_size_manual(values = c(4,4,4,5,4,4)) +
                        xlab("LD1") +
                        ylab("LD2") +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

cmc_ag
```


```{r lda_species_decontam_cmc_me}

# select only the species that make up the 1st 2 residuals, based on the scree plot above
fa_species_cmc <- malt_species.decontam_filtered_cmc.fa.df %>% 
  filter(Residual %in% c("MR1")) %>%
  pull(Species)

# sub-sample the species table for only those species
malt_species.decontam_filtered_cmc_lda_table <- malt_species.decontam_filtered_cmc_clr %>%
  select(one_of(fa_species_cmc)) %>%
  rownames_to_column("SampleID") %>%
  inner_join(., metadata_cmc %>%
               select(SampleID, Market_integration)) %>%
  select(SampleID, Market_integration, everything())

rownames(malt_species.decontam_filtered_cmc_lda_table) <- malt_species.decontam_filtered_cmc_lda_table$SampleID
malt_species.decontam_filtered_cmc_lda_table <- malt_species.decontam_filtered_cmc_lda_table %>% select(-SampleID)

malt_species.decontam_filtered_cmc_lda <- lda(Market_integration ~ ., malt_species.decontam_filtered_cmc_lda_table)
malt_species.decontam_filtered_cmc_lda # show results

lda.data <- cbind(malt_species.decontam_filtered_cmc_lda_table, predict(malt_species.decontam_filtered_cmc_lda)$x)

cmc_me <- ggplot(lda.data, aes(LD1, LD2, colour = Market_integration, shape = Market_integration, size = Market_integration)) +
                        geom_point() +
                        scale_colour_manual(values = Market_integration_colors) +
                        scale_shape_manual(values = Market_integration_shapes) +
                        scale_size_manual(values = c(4,6,4)) +
                        xlab("LD1") +
                        ylab("LD2") +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

cmc_me

```


```{r lda_species_decontam_cmc_sex}

# select only the species that make up the 1st 2 residuals, based on the scree plot above
fa_species_cmc <- malt_species.decontam_filtered_cmc.fa.df %>% 
  filter(Residual %in% c("MR1")) %>%
  pull(Species)

# sub-sample the species table for only those species
malt_species.decontam_filtered_cmc_lda_table <- malt_species.decontam_filtered_cmc_clr %>%
  select(one_of(fa_species_cmc)) %>%
  rownames_to_column("SampleID") %>%
  inner_join(., metadata_cmc %>%
               select(SampleID, Sex)) %>%
  select(SampleID, Sex, everything())

rownames(malt_species.decontam_filtered_cmc_lda_table) <- malt_species.decontam_filtered_cmc_lda_table$SampleID
malt_species.decontam_filtered_cmc_lda_table <- malt_species.decontam_filtered_cmc_lda_table %>% select(-SampleID)

malt_species.decontam_filtered_cmc_lda <- lda(Sex ~ ., malt_species.decontam_filtered_cmc_lda_table)
malt_species.decontam_filtered_cmc_lda # show results

plot(malt_species.decontam_filtered_cmc_lda)

lda.data <- cbind(malt_species.decontam_filtered_cmc_lda_table, predict(malt_species.decontam_filtered_cmc_lda)$x)

cmc_sex <- ggplot(lda.data, aes(x = Sex, y = LD1, group = Sex, fill = Sex)) +
                        geom_boxplot() + 
                        geom_jitter(size = 2, aes(shape = Sex)) +
                        scale_fill_manual(values = Sex_colors) +
                        scale_shape_manual(values = c(3,4)) +
                        xlab("Ethnic Group") +
                        ylab("LD1") +
                        geom_hline(yintercept = 0, linetype = "dashed") +
                        coord_flip() +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

cmc_sex

```


```{r lda_species_decontam_cmc_ts}

# select only the species that make up the 1st 2 residuals, based on the scree plot above
fa_species_cmc <- malt_species.decontam_filtered_cmc.fa.df %>% 
  filter(Residual %in% c("MR1")) %>%
  pull(Species)

# sub-sample the species table for only those species
malt_species.decontam_filtered_cmc_lda_table <- malt_species.decontam_filtered_cmc_clr %>%
  select(one_of(fa_species_cmc)) %>%
  rownames_to_column("SampleID") %>%
  inner_join(., metadata_cmc %>%
               # change the column after SampleID to get the metadata category you want 
               # Age_group, Ethnic_Group, Env, Industry, Market_integration, Sex, Tooth_site, Village
               select(SampleID, Tooth_site)) %>%
  select(SampleID, Tooth_site, everything())

rownames(malt_species.decontam_filtered_cmc_lda_table) <- malt_species.decontam_filtered_cmc_lda_table$SampleID
malt_species.decontam_filtered_cmc_lda_table <- malt_species.decontam_filtered_cmc_lda_table %>% select(-SampleID)

malt_species.decontam_filtered_cmc_lda <- lda(Tooth_site ~ ., malt_species.decontam_filtered_cmc_lda_table)
malt_species.decontam_filtered_cmc_lda # show results

lda.data <- cbind(malt_species.decontam_filtered_cmc_lda_table, predict(malt_species.decontam_filtered_cmc_lda)$x)

plot(malt_species.decontam_filtered_cmc_lda)

cmc_ts <- ggplot(lda.data, aes(x = Tooth_site, y = LD1, group = Tooth_site, fill = Tooth_site)) +
                        geom_boxplot() + 
                        geom_jitter(size = 2, aes(shape = Tooth_site)) +
                        scale_fill_manual(values = Tooth_site_colors) +
                        scale_shape_manual(values = c(3,4)) +
                        xlab("Ethnic Group") +
                        ylab("LD1") +
                        geom_hline(yintercept = 0, linetype = "dashed") +
                        coord_flip() +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

cmc_ts

```


```{r lda_species_decontam_cmc_village}

# select only the species that make up the 1st 2 residuals, based on the scree plot above
fa_species_cmc <- malt_species.decontam_filtered_cmc.fa.df %>% 
  filter(Residual %in% c("MR1")) %>%
  pull(Species)

# sub-sample the species table for only those species
malt_species.decontam_filtered_cmc_lda_table <- malt_species.decontam_filtered_cmc_clr %>%
  select(one_of(fa_species_cmc)) %>%
  rownames_to_column("SampleID") %>%
  inner_join(., metadata_cmc %>%
               # change the column after SampleID to get the metadata category you want 
               # Age_group, Ethnic_Group, Env, Industry, Market_integration, Sex, Tooth_site, Village
               select(SampleID, Village)) %>%
  select(SampleID, Village, everything())

rownames(malt_species.decontam_filtered_cmc_lda_table) <- malt_species.decontam_filtered_cmc_lda_table$SampleID
malt_species.decontam_filtered_cmc_lda_table <- malt_species.decontam_filtered_cmc_lda_table %>% select(-SampleID)

malt_species.decontam_filtered_cmc_lda <- lda(Village ~ ., malt_species.decontam_filtered_cmc_lda_table)
malt_species.decontam_filtered_cmc_lda # show results

lda.data <- cbind(malt_species.decontam_filtered_cmc_lda_table, predict(malt_species.decontam_filtered_cmc_lda)$x)

Village_colors <- c(`202` = "#FF3200", `205` = "#EF8158", `204` = "#E9BD8E", `203` = "#CBDDA7", `206` = "#38BCAD")
Village_shapes <- c(`202` = 15, `205` = 17, `204` = 18,`203` = 16, `206` = 25)

cmc_vi <- ggplot(lda.data, aes(LD1, LD2, colour = Village, shape = Village, size = Village)) +
                        geom_point() +
                        scale_colour_manual(values = Village_colors) +
                        scale_shape_manual(values = Village_shapes) +
                        scale_size_manual(values = c(4,4,4,5,4,4)) +
                        xlab("LD1") +
                        ylab("LD2") +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

cmc_vi

```

```{r cmc_images}

allplots_cmc <- plot_grid(cmc_eg, cmc_ag,
          cmc_me, cmc_sex,
          cmc_ts, cmc_vi,
          nrow=3, labels = c("A", "B", "C", "D", "E", "F"), rel_widths = c(1, 1))
allplots_cmc
# ggsave("05-results.backup/allplots_cmc.pdf", plot = allplots_cmc, device = "pdf",
#        scale = 1, width = 9, height = 10, units = c("in"), dpi = 300)

# ggsave("./06-publication/supplemental_figures/SXX10/SXX10_cmc_lda_plots.pdf", plot = allplots_cmc, device = "pdf",
#        scale = 1, width = 8, height = 10, units = c("in"), dpi = 300)
# ggsave("./06-publication/supplemental_figures/SXX10/SXX10_cmc_lda_plots.png", plot = allplots_cmc, device = "png",
#        scale = 1, width = 8, height = 10, units = c("in"), dpi = 300)

```

## Heatmaps
Try changing the sample order to group them by the different metadata categories
(currently have Industrialization/Ethnic group/Market integration/Village grouping).
Need to look at: Tooth site, Age group, Sex, others? Also try clustering the
samples to see if they fall into any recognizable categories.
```{r heatmap_cmc}
# select the species in MR1, MR2, and MR3 for the FA
malt_species.decontam_FA_cmc <- malt_species.decontam %>%
                                  select(-one_of(outliers)) %>%
                                  select(-matches("SRR|JAE|10M|EXB|LIB|ERR|VLC")) %>%
                                  inner_join(., minres_oblimin_cmc_fa_species %>%
                                               filter(str_detect(Residual, "MR1")) %>%
                                               select(-Residual)) %>%
                                  gather("SampleID","Counts",2:ncol(.)) %>%
                                  mutate(Counts = Counts + 1) %>%
                                  spread(Species,Counts) %>%
                                  column_to_rownames("SampleID")

# CLR-transform the matrix for plotting the heatmap
malt_species.decontam_FA_cmc_clr <- clr(malt_species.decontam_FA_cmc)
malt_species.decontam_FA_cmc_clr <- as.matrix(malt_species.decontam_FA_cmc_clr)

# orient the matrix with correct rows/columns to run the distance calculation for the species, not the samples (columns are SampleID, rows are Species)
malt_species.decontam_FA_cmc_clr_sp <- malt_species.decontam_FA_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","Counts",2:ncol(.)) %>%
  spread(SampleID,Counts)

#add the rownames back
rownames(malt_species.decontam_FA_cmc_clr_sp) <- malt_species.decontam_FA_cmc_clr_sp$Species
malt_species.decontam_FA_cmc_clr_sp <- malt_species.decontam_FA_cmc_clr_sp %>% select(-Species)

# perform a distance calculation for hierarchical clustering for the species ordering
malt_species.decontam_FA_cmc_clr_dist <- vegdist(malt_species.decontam_FA_cmc_clr_sp, method = "euclidian")
# cluster the data with hclust
malt_species.decontam_FA_cmc_clr_dist_hr <- hclust(malt_species.decontam_FA_cmc_clr_dist)
# malt_species.decontam_FA_cmc_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
sp_cmc_order <- malt_species.decontam_FA_cmc_clr_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
malt_species.decontam_FA_cmc_clr_order <- malt_species.decontam_FA_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(SpOrder = as.character(seq(1,117))) %>% 
  select(Species, SpOrder, everything()) %>%
  mutate(SpOrder = fct_relevel(SpOrder, sp_cmc_order)) %>%
  arrange(SpOrder) %>%
  pull(Species)

# make the species a factor so they're in the correct order for the heatmap using the vector from the step above
malt_species.decontam_FA_cmc_clr_long <- malt_species.decontam_FA_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, malt_species.decontam_FA_cmc_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.))


# now cluster by sample
# convert the matrix to a data.frame
malt_species.decontam_FA_cmc_clr_smp <- malt_species.decontam_FA_cmc_clr %>%
  as.data.frame()

# perform a distance calculation for hierarchical clustering for the species ordering
malt_species.decontam_FA_cmc_clr_smp_dist <- vegdist(malt_species.decontam_FA_cmc_clr_smp, method = "euclidian")
# cluster the data with hclust
malt_species.decontam_FA_cmc_clr_smp_dist_hr <- hclust(malt_species.decontam_FA_cmc_clr_smp_dist)
# malt_species.decontam_FA_cmc_clr_dist_hr$order gives the dendrogram order from the bottom to the top, but using the row numbers not the row names
# pull this order out and store as a vector to make the order a factor in the next step for plotting
smp_cmc_order <- malt_species.decontam_FA_cmc_clr_smp_dist_hr$order %>%
  as.character.numeric_version(.) %>%
  str_trim(.)

# use the dendrogram order to pull out the species in the correct order for the heatmap
malt_species.decontam_FA_cmc_clr_smp_order <- malt_species.decontam_FA_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(Species,CLR) %>%
  mutate(SmpOrder = as.character(seq(1,103))) %>%
  select(SampleID, SmpOrder, everything()) %>%
  mutate(SmpOrder = fct_relevel(SmpOrder, smp_cmc_order)) %>%
  arrange(SmpOrder) %>%
  pull(SampleID)

# Plot the heatmap with samples ordered by the clustering from above
# make the SampleIDs a factor so they're in the correct order for the heatmap using the vector from the step above
malt_species.decontam_FA_cmc_clr_long <- malt_species.decontam_FA_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, malt_species.decontam_FA_cmc_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Market_integration_split), by = "SampleID") %>%
  inner_join(., Market_integration_split_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Market_integration_split = c("Logging road","Forest camp","Farming","Yanomami","Industrial plaque","Industrial calculus","ExtractionGauze","ExtractionBlank","LibraryBlank")), by = "Market_integration_split") %>%
  mutate(SampleID = fct_relevel(SampleID, malt_species.decontam_FA_cmc_clr_smp_order)) %>%
  arrange(SampleID)

vector_color = malt_species.decontam_FA_cmc_clr_long %>%
  select(SampleID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_cmc_smp_cluster <- ggplot(malt_species.decontam_FA_cmc_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_cmc_smp_cluster

ggsave("./06-publication/supplemental_figures/SXX12/SXX12_cmc_fa_heatmaps.pdf", plot = heatmap_cmc_smp_cluster, device = "pdf",
       scale = 1, width = 10, height = 10, units = c("in"), dpi = 300)
ggsave("./06-publication/supplemental_figures/SXX12/SXX12_cmc_fa_heatmaps.png", plot = heatmap_cmc_smp_cluster, device = "png",
       scale = 1, width = 10, height = 10, units = c("in"), dpi = 300)

# Plot the heatmap with samples ordered by Village, then alphabetical
# make the SampleIDs a factor so they're in the correct order for the heatmap using the vector from the step above
malt_species.decontam_FA_cmc_clr_long <- malt_species.decontam_FA_cmc_clr %>%
  as.data.frame() %>%
  rownames_to_column("SampleID") %>%
  gather("Species","CLR",2:ncol(.)) %>%
  spread(SampleID,CLR) %>%
  mutate(Species = fct_relevel(Species, malt_species.decontam_FA_cmc_clr_order)) %>%
  arrange(Species) %>%
  gather("SampleID","CLR", 2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Village), by = "SampleID") %>%
  inner_join(., Village_colors %>%
               as_data_frame(.) %>%
               rename(Color = value) %>%
               mutate(Village = c("202","205","204","203","206")), by = "Village") %>%
  mutate(SampleID = fct_relevel(SampleID, cmc_order)) %>%
  arrange(SampleID)

vector_color = malt_species.decontam_FA_cmc_clr_long %>%
  select(SampleID, Color) %>%
  unique %>%
  pull(Color) %>%
  as.character()

# make a heatmap with ggplot
heatmap_cmc_smp_village <- ggplot(malt_species.decontam_FA_cmc_clr_long, aes(SampleID, Species, fill = CLR)) +
  geom_tile() +
  scale_fill_viridis_c(option = "A") +
  theme_minimal(base_size = 7) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.95, color = vector_color),
        plot.margin = margin(0, 0, 0, 0, "pt"),
        axis.title.y = element_blank(),
        legend.position = "left")

heatmap_cmc_smp_village



# ggsave("05-results.backup/cmc_fa_heatmap.pdf", plot = heatmap_base, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

```

How does a PCA using only the species in MR1 and MR2 look?
```{r discriminant_taxa_cmc_pca}
# decontaminated and filtered
malt_species.decontam_filtered_cmc_FA <- malt_species.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(matches("Species|CMC")) %>%
                                         inner_join(., minres_oblimin_cmc_fa_species %>%
                                               filter(str_detect(Residual, "MR1|MR2")) %>%
                                               select(-Residual)) %>%
                                         gather("SampleID","Counts",2:ncol(.)) %>%
                                         mutate(Counts = Counts + 1) %>%
                                         spread(Species,Counts) %>%
                                         column_to_rownames("SampleID")

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.pca(malt_species.decontam_filtered_cmc_FA, logratio = 'CLR')

# perform a PCA to see how the data cluster
malt_species.decontam_filtered_cmc_FA.pca <- pca(malt_species.decontam_filtered_cmc_FA, ncomp = 3, logratio = 'CLR')

# perform and plot a PCA to see how the data cluster
# by Village
cmc_fa_pca <- plot_pca(malt_species.decontam_filtered_cmc_FA.pca, "PC1", "PC2", "Tooth_site")
cmc_fa_pca
plot_pca(malt_species.decontam_filtered_cmc_FA.pca, "PC3", "PC2", "Tooth_site")

# ggsave("05-results.backup/cmc_fa_pca.pdf", plot = cmc_fa_pca, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

```


























