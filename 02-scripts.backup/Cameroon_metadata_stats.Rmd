---
title: "Cameroon hunter-gatherer calculus/plaque metadata_nofactors stats"
author: "Irina Velsko"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output:
    github_document:
        fig_width: 8
        fig_height: 6
        toc: true
---

```{r load_libraries, echo = F, message = F}
library(knitr)
library(decontam)
library(data.table)
library(psych)
library(vegan)
library(ape)
library(mixOmics)
library(compositions)
library(vegan)
library(janitor)
library(pander)
library(tidyverse)
library(gplots)
library(ggrepel)
library(viridis)
library(cowplot)
opts_chunk$set(echo=F, warning=F, message=F, dpi=150)
```

Set the working directory of the notebook to the parent directory of the 
notebook itself.  

```{r setup}
knitr::opts_knit$set(root.dir = normalizePath(".."))
```


```{r load_data}

# load the taxonomy tables that have been decontaminated and the column headers are cleaned up
load("./05-results.backup/CMC_taxonomy_tables.RData")

# load the metadata_nofactors file
load("./05-results.backup/CMC_metadata.RData")

metadata_nofactors <- fread("./00-documentation.backup/01-cameroon_hunter_gatherer_metadata.tsv") %>%
  rename(SampleID = `#SampleID`) %>%
  filter(str_detect(SampleID, "CMC"))


```

```{r}


Age_group_colors <- c(`18-29` = "#FF3200", `30-39` = "#E9B186", `40-49` = "#82CDAA", `50-59` = "#0686B8", `60+` = "#172869")

Ethnic_Group_colors <- c(Baka = "#FF3200", Nzime = "#065FA3")
Market_integration_colors <- c(`Logging road` = "#FF3200", `Forrest camp` = "#065FA3", Farming = "#82CDAA")
Village_colors <- c(`202` = "#FF3200", `205` = "#EF8158", `204` = "#E9BD8E", `203` = "#CBDDA7", `206` = "#38BCAD")
Sex_colors <- c(Female = "#FF3200", Male = "#065FA3")
Tooth_site_colors <- c(Anterior = "#FF3200", Posterior = "#065FA3")

```


```{r pca_plot}
# plotting PCA with colored dots
plot_pca <- function(df, pc1, pc2, metadata_group) {
    metadata_group_colors <- get(paste(metadata_group, "_colors", sep = ""))
    metadata_group_shapes <- get(paste(metadata_group, "_shapes", sep = ""))

    exp_var <- paste0(round(df$prop_expl_var$X * 100, 2), "%")
    df_X <- df$variates$X %>%
              as.data.frame() %>%
              rownames_to_column("SampleID") %>%
              inner_join(metadata_nofactors %>%
                           select(SampleID, Env, Description, Ethnic_Group, Age_group, Sex, Market_integration, Village, Tooth_site, 
                                  Type, Decayed, Missing, Moving, Altered, Root_visible, Bleeding), by = "SampleID")
    
    metadata_group = df_X[[metadata_group]]
    
                       if (pc1 == 'PC1') {
                           pc1 <- df_X$PC1
                           exp_var_pc1 <- exp_var[1]
                           xaxis <- c("PC1")
                       }  else if (pc1 == 'PC2') {
                           pc1 <- df_X$PC2
                           exp_var_pc1 <- exp_var[2]
                           xaxis <- c("PC2")
                       } else if (pc1 == 'PC3') {
                           pc1 <- df_X$PC3
                           exp_var_pc1 <- exp_var[3]
                           xaxis <- c("PC3")
                       }

                       if (pc2 == 'PC1') {
                           pc2 <- df_X$PC1
                           exp_var_pc2 <- exp_var[1]
                           yaxis <- c("PC1")
                       }  else if (pc2 == 'PC2') {
                           pc2 <- df_X$PC2
                           exp_var_pc2 <- exp_var[2]
                           yaxis <- c("PC2")
                       } else if (pc2 == 'PC3') {
                           pc2 <- df_X$PC3
                           exp_var_pc2 <- exp_var[3]
                           yaxis <- c("PC3")
                       }

    pca_plot <- ggplot(df_X, aes(pc1, pc2, colour = metadata_group, shape = metadata_group)) +
                        geom_point(size = 4) +
                        scale_colour_manual(values = metadata_group_colors) +
                        scale_shape_manual(values = metadata_group_shapes) +
                        # stat_ellipse() +
                        xlab(paste(xaxis, " - ", exp_var_pc1)) +
                        ylab(paste(yaxis, " - ", exp_var_pc2)) +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

    return(pca_plot)
}

```

```{r pca_names}
# this function plots the PCA with the sample names instead of points
plot_pca_names <- function(df, pc1, pc2, metadata_group) {
    metadata_group_colors <- get(paste(metadata_group, "_colors", sep = ""))

    exp_var <- paste0(round(df$prop_expl_var$X * 100, 2), "%")
    df_X <- df$variates$X %>%
              as.data.frame() %>%
              rownames_to_column("SampleID") %>%
              inner_join(metadata_nofactors %>%
                           select(SampleID, Env, Description, Ethnic_Group, Age_group, Sex, Market_integration, Village, Tooth_site,
                                  Type, Decayed, Missing, Moving, Altered, Root_visible, Bleeding), by = "SampleID")
    
    metadata_group = df_X[[metadata_group]]
    
                       if (pc1 == 'PC1') {
                           pc1 <- df_X$PC1
                           exp_var_pc1 <- exp_var[1]
                           xaxis <- c("PC1")
                       }  else if (pc1 == 'PC2') {
                           pc1 <- df_X$PC2
                           exp_var_pc1 <- exp_var[2]
                           xaxis <- c("PC2")
                       } else if (pc1 == 'PC3') {
                           pc1 <- df_X$PC3
                           exp_var_pc1 <- exp_var[3]
                           xaxis <- c("PC3")
                       }

                       if (pc2 == 'PC1') {
                           pc2 <- df_X$PC1
                           exp_var_pc2 <- exp_var[1]
                           yaxis <- c("PC1")
                       }  else if (pc2 == 'PC2') {
                           pc2 <- df_X$PC2
                           exp_var_pc2 <- exp_var[2]
                           yaxis <- c("PC2")
                       } else if (pc2 == 'PC3') {
                           pc2 <- df_X$PC3
                           exp_var_pc2 <- exp_var[3]
                           yaxis <- c("PC3")
                       }

    pca_plot_names <- ggplot(df_X, aes(pc1, pc2, colour = metadata_group)) +
                        geom_text(aes(label = df_X$SampleID), size = 2) +
                        scale_colour_manual(values = metadata_group_colors) +
                        # stat_ellipse() +
                        xlab(paste(xaxis, " - ", exp_var_pc1)) +
                        ylab(paste(yaxis, " - ", exp_var_pc2)) +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

    return(pca_plot_names)
}


# plot PCA with colored dots and the title including the # of species or genera
plot_pca_titles <- function(df, pc1, pc2, color_group, shape_group, size_group, ncomps, title_text) {
    metadata_group_colors <- get(paste(color_group, "_colors", sep = ""))
    metadata_group_shapes <- get(paste(shape_group, "_shapes", sep = ""))
    metadata_group_size <- get(paste(size_group, "_size", sep = ""))

    pca.list <- mixOmics::pca(df, ncomp = ncomps, logratio = 'CLR')

    exp_var <- paste0(round(pca.list$prop_expl_var$X * 100, 2), "%")
    df_X <- pca.list$variates$X %>%
              as.data.frame() %>%
              rownames_to_column("SampleID") %>%
              inner_join(metadata_nofactors %>%
                           select(SampleID, Env, Description, Ethnic_Group, Age_group, Sex, Market_integration, Village, Tooth_site, 
                                  Type, Decayed, Missing, Moving, Altered, Root_visible, Bleeding), by = "SampleID") %>%
      mutate(Decayed = ifelse(is.na(Decayed), "Yes", "No"),
             Missing = ifelse(is.na(Missing), "Yes","No"),
             Root_visible = ifelse(is.na(Root_visible), "Yes","No"),
             Altered = ifelse(is.na(Altered), "Yes","No"))

    color_group = df_X[[color_group]]
    shape_group = df_X[[shape_group]]
    size_group = df_X[[size_group]]
   
                       if (pc1 == 'PC1') {
                           pc1 <- df_X$PC1
                           exp_var_pc1 <- exp_var[1]
                           xaxis <- c("PC1")
                       }  else if (pc1 == 'PC2') {
                           pc1 <- df_X$PC2
                           exp_var_pc1 <- exp_var[2]
                           xaxis <- c("PC2")
                       } else if (pc1 == 'PC3') {
                           pc1 <- df_X$PC3
                           exp_var_pc1 <- exp_var[3]
                           xaxis <- c("PC3")
                       }

                       if (pc2 == 'PC1') {
                           pc2 <- df_X$PC1
                           exp_var_pc2 <- exp_var[1]
                           yaxis <- c("PC1")
                       }  else if (pc2 == 'PC2') {
                           pc2 <- df_X$PC2
                           exp_var_pc2 <- exp_var[2]
                           yaxis <- c("PC2")
                       } else if (pc2 == 'PC3') {
                           pc2 <- df_X$PC3
                           exp_var_pc2 <- exp_var[3]
                           yaxis <- c("PC3")
                       }

    # title_text <- df %>%
    #                  rownames_to_column("SampleID") %>%
    #                  gather("Species","Counts",2:ncol(.)) %>%
    #                  spread(SampleID, Counts) %>%
    #                  count
    
    pca_plot <- ggplot(df_X, aes(pc1, pc2, colour = color_group, shape = shape_group, size = size_group)) +
                        geom_point() +
                        scale_colour_manual(values = metadata_group_colors) +
                        scale_shape_manual(values = metadata_group_shapes) +
                        scale_size_manual(values = metadata_group_size) +
                        # stat_ellipse() +
                        xlab(paste(xaxis, " - ", exp_var_pc1)) +
                        ylab(paste(yaxis, " - ", exp_var_pc2)) +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        ggtitle(paste(title_text))

    return(pca_plot)
}

```

```{r graphing_functions}

# plotting box and whisker
plot_box_whisker <- function(df, hasmtdta = c("TRUE","FALSE"), stat_info, metadata_group, fill_group, title_text) {
    fill_group_colors <- get(paste(fill_group, "_colors", sep = ""))

    if (hasmtdta == T) { 
      df_X <- df
      fill_group = df_X[[fill_group]]
    } else {
      df_X <- df %>%
              inner_join(metadata_nofactors %>%
                           select(SampleID, Env, Description, Ethnic_Group, Age_group,
                                  Sex, Market_integration, Village, Tooth_site, Type), by = "SampleID")
      fill_group = df_X[[metadata_group]]
    }
   
    stat_info_table = df_X[[stat_info]]
    metadata_group = df_X[[metadata_group]]

    bx_wh_plot <- ggplot(df_X, aes(x = metadata_group, y = stat_info_table, fill = fill_group)) +
                         geom_boxplot() +
                         scale_fill_manual(values = fill_group_colors) +
                         theme_minimal() +
                         #scale_y_continuous(trans='log10') +
                         #scale_y_continuous(trans='pseudo_log') +
                         theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
                         ylab(stat_info) +
                         ggtitle(title_text)

    return(bx_wh_plot)
}

```

```{r avg_cmc_reads}

metadata %>%
  select(SampleID, Combined_Seq_Depth) %>%
  filter(str_detect(SampleID, "CMC")) %>%
  summarize(Avg_depth = mean(Combined_Seq_Depth),
            sd_depth = sd(Combined_Seq_Depth))


```


Let's also check the metadata_nofactors categories - are there clear differences between groups for any of them?
```{r metadata_barplots}
# plot percent of X in the population 

village_age <- metadata_nofactors %>%
  filter(str_detect(SampleID, "CMC")) %>%
  mutate(Individual_ID = str_trunc(SampleID, width = 6, side = "right", ellipsis = "")) %>%
  select(Individual_ID, Age_group, Village) %>%
  unique() %>%
  # filter(str_detect(Tooth_site, "Posterior")) %>%
  group_by(Village, Age_group) %>%
  count()

village_age_sex <- metadata_nofactors %>%
  filter(str_detect(SampleID, "CMC")) %>%
  mutate(Individual_ID = str_trunc(SampleID, width = 6, side = "right", ellipsis = "")) %>%
  select(Individual_ID, Age_group, Village, Sex) %>%
  unique() %>%
  # filter(str_detect(Tooth_site, "Posterior")) %>%
  group_by(Village, Age_group, Sex) %>%
  count()

village_sex <- metadata_nofactors %>%
  filter(str_detect(SampleID, "CMC")) %>%
  mutate(Individual_ID = str_trunc(SampleID, width = 6, side = "right", ellipsis = "")) %>%
  select(Individual_ID, Sex, Village) %>%
  unique() %>%
  # filter(str_detect(Tooth_site, "Posterior")) %>%
  group_by(Village, Sex) %>%
  count()

village_tooth <- metadata_nofactors %>%
  filter(str_detect(SampleID, "CMC")) %>%
  mutate(Individual_ID = str_trunc(SampleID, width = 6, side = "right", ellipsis = "")) %>%
  select(Individual_ID, Tooth_site, Village) %>%
  unique() %>%
  # filter(str_detect(Tooth_site, "Posterior")) %>%
  group_by(Village, Tooth_site) %>%
  count()

ethnicGroup_market <- metadata_nofactors %>%
  filter(str_detect(SampleID, "CMC")) %>%
  mutate(Individual_ID = str_trunc(SampleID, width = 6, side = "right", ellipsis = "")) %>%
  select(Individual_ID, Ethnic_Group, Market_integration) %>%
  unique() %>%
  # filter(str_detect(Tooth_site, "Posterior")) %>%
  group_by(Ethnic_Group, Market_integration) %>%
  count()

village_age_plot <- village_age %>%
  ggplot(., aes(x = Village, y = n, fill = Age_group)) +
         geom_bar(stat = "identity", position = position_dodge2(width = 0.9, preserve = "single"), color = "black") +
         scale_fill_manual(values = Age_group_colors) +
         theme_minimal(base_size = 14) +
         theme(axis.text.x = element_text(angle = 0, hjust = 0.5),
               axis.text = element_text(size = 14)) +
         ylab("Number of individuals") 
village_age_plot
ggsave("./06-publication/supplemental_figures/SXX41/panel_parts/SXX41_village_age_plot.pdf", plot = village_age_plot, device = "pdf",
       scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

village_age_sex_plot <- village_age_sex %>%
  ggplot(., aes(x = Village, y = n, fill = Age_group)) +
         geom_bar(stat = "identity", position = position_dodge2(width = 0.9, preserve = "single"), color = "black") +
         scale_fill_manual(values = Age_group_colors) +
         theme_minimal(base_size = 14) +
         theme(axis.text.x = element_text(angle = 0, hjust = 0.5),
               axis.text = element_text(size = 14)) +
         ylab("Number of individuals") +
  facet_wrap(~Sex, )
village_age_sex_plot
ggsave("./06-publication/supplemental_figures/SXX41/panel_parts/SXX41_village_age_sex_plot.pdf", plot = village_age_sex_plot, device = "pdf",
       scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

age_village_plot <- village_age %>%
  ggplot(., aes(x = Age_group, y = n, fill = Village)) +
         geom_bar(stat = "identity", position = position_dodge2(width = 0.9, preserve = "single"), color = "black") +
         scale_fill_manual(values = Village_colors) +
         theme_minimal(base_size = 14) +
         theme(axis.text.x = element_text(angle = 0, hjust = 0.5),
               axis.text = element_text(size = 14)) +
         ylab("Number of individuals") #+
age_village_plot
ggsave("./06-publication/supplemental_figures/SXX41/panel_parts/SXX41_age_village_plot.pdf", plot = age_village_plot, device = "pdf",
       scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

village_sex_plot <- village_sex %>%
    ggplot(., aes(x = Village, y = n, fill = Sex)) +
         geom_bar(stat = "identity", position = "dodge", color = "black") +
         scale_fill_manual(values = Sex_colors) +
         theme_minimal(base_size = 14) +
         theme(axis.text.x = element_text(angle = 0, hjust = 0.5),
               axis.text = element_text(size = 14)) +
         ylab("Number of individuals") #+
village_sex_plot
ggsave("./06-publication/supplemental_figures/SXX41/panel_parts/SXX41_village_sex_plot.pdf", plot = village_sex_plot, device = "pdf",
       scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

village_tooth_plot <- village_tooth %>%
    ggplot(., aes(x = Village, y = n, fill = Tooth_site)) +
         geom_bar(stat = "identity", position = "dodge", color = "black") +
         scale_fill_manual(values = Tooth_site_colors) +
         theme_minimal(base_size = 14) +
         theme(axis.text.x = element_text(angle = 0, hjust = 0.5),
               axis.text = element_text(size = 14)) +
         scale_y_continuous(breaks=scales::pretty_breaks(n=8)) +
         ylab("Number of individuals") #+
village_tooth_plot
ggsave("./06-publication/supplemental_figures/SXX41/panel_parts/SXX41_village_tooth_plot.pdf", plot = village_tooth_plot, device = "pdf",
       scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

eg_market <- ethnicGroup_market %>%
    ggplot(., aes(x = Ethnic_Group, y = n, fill = Market_integration)) +
         geom_bar(stat = "identity", position = position_dodge2(width = 0.9, preserve = "single"), color = "black") +
         scale_fill_manual(values = Market_integration_colors) +
         theme_minimal(base_size = 14) +
         theme(axis.text.x = element_text(angle = 0, hjust = 0.5),
               axis.text = element_text(size = 14)) +
         scale_y_continuous(breaks=scales::pretty_breaks(n=8)) +
         ylab("Number of individuals") #+
eg_market
ggsave("./06-publication/supplemental_figures/SXX41/panel_parts/SXX41_eg_market_plot.pdf", plot = eg_market, device = "pdf",
       scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)


```
Age groups are different between the villages (and therefore ethnic group and
the market integration). Villages 202 and 205, are Baka villages along the logging
road,  204 is a Baka village in a forrest camp, while 203 and 206 are Nzime
villages that practice farming. There is an imbalance in the nubmer of
individuals from the 18-29 and 60+ age ranges, with no individuals age 18-29 in
villages 203 or 206, and no individuals age 60+ in villages 202 or 205. Does
this difference in age affect the results we see? The oral microbiome (plaque
community) does change with age. The change is likely related to changes in
immune responses and immune status during ageing. To see whether the composition
of the age groups is substantially different, let's plot PCAs of the composition
at the species level where we leave out one age group each time. Does the
plot/clustering change substantially when leaving out the different age groups?
(Do I need to do this with only one tooth site per individual? Because the bar
plots above are only the posterior tooth samples, and the only separation
visible in the PCA is by tooth site. This is also the only metadata_nofactors category
with significantly differnt plotting according to PERMANOVA with vegan::adonis.
See Cameroon_h-g_plaque_assignment.Rmd)


```{r separate_groups_list}

age_18 <- metadata_nofactors %>%
  filter(Age_group == "18-29") %>%
  select(SampleID) %>%
  pull()

age_30 <- metadata_nofactors %>%
  filter(Age_group == "30-39") %>%
  select(SampleID) %>%
  pull()

age_40 <- metadata_nofactors %>%
  filter(Age_group == "40-49") %>%
  select(SampleID) %>%
  pull()

age_50 <- metadata_nofactors %>%
  filter(Age_group == "50-59") %>%
  select(SampleID) %>%
  pull()

age_60 <- metadata_nofactors %>%
  filter(Age_group == "60+") %>%
  select(SampleID) %>%
  pull()

posterior <- metadata_nofactors %>%
  filter(Tooth_site == "Posterior") %>%
  select(SampleID) %>%
  pull()

anterior <- metadata_nofactors %>%
  filter(Tooth_site == "Anterior") %>%
  select(SampleID) %>%
  pull()

```



```{r jackknife_pca_all_toothsites}
# All ages
malt_species.decontam_filtered <- malt_species.decontam %>%
  select(matches("Species|CMC")) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
  # select(-one_of(outliersCMC)) %>%
  mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
  filter(Percent > 0.005) %>%
  select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("SampleID")

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "All age groups, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "All age groups, PC3-PC2")

# no 18-29
malt_species.decontam_filtered <- malt_species.decontam %>%
  select(matches("CMC|Species")) %>%
  select(-one_of(age_18)) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
  # select(-one_of(outliersCMC)) %>%
  mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
  filter(Percent > 0.005) %>%
  select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("SampleID")

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "no 18-29, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "no 18-29, PC3-PC2")

# no 30-39
malt_species.decontam_filtered <- malt_species.decontam %>%
  select(matches("CMC|Species")) %>%
  select(-one_of(age_30)) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
  # select(-one_of(outliersCMC)) %>%
  mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
  filter(Percent > 0.005) %>%
  select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("SampleID")

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "no 30-39, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "no 30-39, PC3-PC2")

# no 40-49
malt_species.decontam_filtered <- malt_species.decontam %>%
  select(matches("CMC|Species")) %>%
  select(-one_of(age_40)) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
  # select(-one_of(outliersCMC)) %>%
  mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
  filter(Percent > 0.005) %>%
  select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("SampleID")

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "no 40-49, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "no 40-49, PC3-PC2")

# no 50-59
malt_species.decontam_filtered <- malt_species.decontam %>%
  select(matches("CMC|Species")) %>%
  select(-one_of(age_50)) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
  # select(-one_of(outliersCMC)) %>%
  mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
  filter(Percent > 0.005) %>%
  select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("SampleID")

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "no 50-59, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "no 50-59, PC3-PC2")

# no 60+
malt_species.decontam_filtered <- malt_species.decontam %>%
  select(matches("CMC|Species")) %>%
  select(-one_of(age_60)) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
  # select(-one_of(outliersCMC)) %>%
  mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
  filter(Percent > 0.005) %>%
  select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("SampleID")

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "no 60+, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "no 60+, PC3-PC2")


```
Each PCA plot with one of the age groups removed looks much like the full plot
with all age groups. The samples largely stay in a similar plotting pattern,
with separation between the anterior and posterior samples. Age does not appear
to affect the compositional profile of the samples. So no need to run linear
modelling? There are very few samples (relatively speaking),so having more might
change this.

```{r jackknife_pca_posterior_toothsites}

# All ages
malt_species.decontam_filtered <- malt_species.decontam %>%
  select(matches("CMC|Species")) %>%
  select(-one_of(anterior)) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
  # select(-one_of(outliersCMC)) %>%
  mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
  filter(Percent > 0.005) %>%
  select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("SampleID")

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "Posterior tooth site, all age groups, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "Posterior tooth site, all age groups, PC3-PC2")

# no 18-29
malt_species.decontam_filtered <- malt_species.decontam %>%
  select(matches("CMC|Species")) %>%
  select(-one_of(anterior)) %>%
  select(-one_of(age_18)) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
  # select(-one_of(outliersCMC)) %>%
  mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
  filter(Percent > 0.005) %>%
  select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("SampleID")

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "Posterior tooth site, no 18-29, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "Posterior tooth site, no 18-29, PC3-PC2")

# no 30-39
malt_species.decontam_filtered <- malt_species.decontam %>%
  select(matches("CMC|Species")) %>%
  select(-one_of(anterior)) %>%
  select(-one_of(age_30)) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
  # select(-one_of(outliersCMC)) %>%
  mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
  filter(Percent > 0.005) %>%
  select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("SampleID")

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "Posterior tooth site, no 30-39, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "Posterior tooth site, no 30-39, PC3-PC2")

# no 40-49
malt_species.decontam_filtered <- malt_species.decontam %>%
  select(matches("CMC|Species")) %>%
  select(-one_of(anterior)) %>%
  select(-one_of(age_40)) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
  # select(-one_of(outliersCMC)) %>%
  mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
  filter(Percent > 0.005) %>%
  select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("SampleID")

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "Posterior tooth site, no 40-49, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "Posterior tooth site, no 40-49, PC3-PC2")

# no 50-59
malt_species.decontam_filtered <- malt_species.decontam %>%
  select(matches("CMC|Species")) %>%
  select(-one_of(anterior)) %>%
  select(-one_of(age_50)) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
  # select(-one_of(outliersCMC)) %>%
  mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
  filter(Percent > 0.005) %>%
  select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("SampleID")

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "Posterior tooth site, no 50-59, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "Posterior tooth site, no 50-59, PC3-PC2")

# no 60+
malt_species.decontam_filtered <- malt_species.decontam %>%
  select(matches("CMC|Species")) %>%
  select(-one_of(anterior)) %>%
  select(-one_of(age_60)) %>%
  adorn_totals(where = "col", name = "Sum_species.decontam_filtered") %>%
  # select(-one_of(outliersCMC)) %>%
  mutate(Percent = Sum_species.decontam_filtered/sum(Sum_species.decontam_filtered)*100) %>%
  filter(Percent > 0.005) %>%
  select(-one_of(c("Sum_species.decontam_filtered","Percent"))) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Species,Counts) %>%
  column_to_rownames("SampleID")

# prepare to run a PCA
# check the number of components to retain by tuning the PCA
tune.species.decontam_filtered_pca <- tune.pca(malt_species.decontam_filtered, logratio = 'CLR')
tune.species.decontam_filtered_pca

# perform and plot a PCA to see how the data cluster
plot_pca_titles(malt_species.decontam_filtered, "PC1", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "Posterior tooth site, no 60+, PC1-PC2")
plot_pca_titles(malt_species.decontam_filtered, "PC3", "PC2", "Age_group", "Market_integration", "Market_integration", 3, "Posterior tooth site, no 60+, PC3-PC2")


```
Using only the posterior tooth sites gives a similar pattern, where removing
each age group doesn't really change the plotting/clustering in a noteicable way. So no
need to run linear modelling? There are very few samples (relatively
speaking),so having more might change this.










