---
title: "Cameroon hunter-gatherer calculus/plaque SEED"
author: "Irina Velsko"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output:
    github_document:
        fig_width: 8
        fig_height: 6
        toc: true
---


```{r load_libraries, echo = F, message = F}
library(knitr)
library(decontam)
library(data.table)
library(vegan)
library(ape)
library(pairwiseAdonis)
library(mixOmics)
library(janitor)
library(rstatix)
library(pander)
library(tidyverse)
library(gplots)
library(ggrepel)
library(viridis)
library(cowplot)
opts_chunk$set(echo=F, warning=F, message=F, dpi=150)
```

Set the working directory of the notebook to the parent directory of the 
notebook itself.  

```{r setup}
knitr::opts_knit$set(root.dir = normalizePath(".."))
```


# SEED category assignment stats
```{r load_data}
## load the species and genus tables generated with HUMAnN2
load("./05-results.backup/CMC_seed_tables.RData")

```

```{r load_metadata}

load("./05-results.backup/CMC_metadata.RData")

# try metadata w/o factors for pairwise.adonis2
metadata_noblanks <- fread("00-documentation.backup/01-cameroon_hunter_gatherer_metadata.tsv")

# make a separate table for adonis2 stats later
metadata_noblanks <- metadata_noblanks %>%
  rename(SampleID = `#SampleID`)  %>%
  filter(!str_detect(SampleID, "EXB|LIB|SRR164|10M")) %>%
  filter(SampleID != "CMC032.B0101") %>%  # this sample has very few reads
  select(SampleID, ExtractionBatch, LibraryBatch, Village, Age_group, Market_economy, Market_economy_split, Ethnic_Group, Sex, Industry, Tooth_site) %>%
  as_tibble() %>%
  mutate(Village = fct_relevel(Village, "202","205","204","203","206","HMP","JAE"),
         ExtractionBatch = fct_relevel(ExtractionBatch, "Ex01_VE_2019-01-23","Ex04_VE_2019-02-18","Ex05_VE_2019-02-18","Ex06_VE_2019-02-21","Ex07_VE_2019-02-21","Ex08_VE_2019-02-25","Ex09_VE_2019-03-13"),
         LibraryBatch = fct_relevel(LibraryBatch, "Li03_VE_2019-04-17","Li04_VE_2019-04-17","Li05_VE_2019-04-17","Li06_VE_2019-05-02","Li07_VE_2019-05-06","Li08_VE_2019-05-06","Li09_VE_2019-05-06"),
         Market_economy = fct_relevel(Market_economy, "Logging road","Forrest camp","Farming","Industrial"),
         Market_economy_split = fct_relevel(Market_economy_split, "Logging road","Forrest camp","Farming","Industrial plaque","Industrial calculus"),
         Age_group = fct_relevel(Age_group, "18-29","30-39","40-49","50-59","60+","HMP"),
         Sex = fct_relevel(Sex, "Male","Female"),
         Tooth_site = fct_relevel(Tooth_site, "Anterior","Posterior","HMP"))

metadata_cmc <- metadata %>%
  filter(!str_detect(SampleID, "EXB|LIB|SRR|JAE")) %>%
  filter(SampleID != "CMC032.B0101") %>%  # this sample has very few reads
  select(SampleID, ExtractionBatch, LibraryBatch, Village, Age_group, Market_economy, Ethnic_Group, Sex, Tooth_site) %>%
  as_tibble()



```

```{r pca_functions}
# add functions for:
# making the input table for PCA?

# plotting PCA with colored dots
plot_pca <- function(df, pc1, pc2, color_group, shape_group, size_group) {
    metadata_group_colors <- get(paste(color_group, "_colors", sep = ""))
    metadata_group_shapes <- get(paste(shape_group, "_shapes", sep = ""))
    metadata_group_size <- get(paste(size_group, "_size", sep = ""))

    exp_var <- paste0(round(df$explained_variance * 100, 2), "%")
    df_X <- df$variates$X %>%
              as.data.frame() %>%
              rownames_to_column("SampleID") %>%
              inner_join(metadata %>%
                           select(SampleID, Description, Ethnic_Group, Age_group, Sex, Market_economy, Village, Tooth_site, Type), by = "SampleID")
    
    color_group = df_X[[color_group]]
    shape_group = df_X[[shape_group]]
    size_group = df_X[[size_group]]
                      
                       if (pc1 == 'PC1') {
                           pc1 <- df_X$PC1
                           exp_var_pc1 <- exp_var[1]
                           xaxis <- c("PC1")
                       }  else if (pc1 == 'PC2') {
                           pc1 <- df_X$PC2
                           exp_var_pc1 <- exp_var[2]
                           xaxis <- c("PC2")
                       } else if (pc1 == 'PC3') {
                           pc1 <- df_X$PC3
                           exp_var_pc1 <- exp_var[3]
                           xaxis <- c("PC3")
                       }

                       if (pc2 == 'PC1') {
                           pc2 <- df_X$PC1
                           exp_var_pc2 <- exp_var[1]
                           yaxis <- c("PC1")
                       }  else if (pc2 == 'PC2') {
                           pc2 <- df_X$PC2
                           exp_var_pc2 <- exp_var[2]
                           yaxis <- c("PC2")
                       } else if (pc2 == 'PC3') {
                           pc2 <- df_X$PC3
                           exp_var_pc2 <- exp_var[3]
                           yaxis <- c("PC3")
                       }

    pca_plot <- ggplot(df_X, aes(pc1, pc2, colour = color_group, shape = shape_group, size = size_group)) +
                        geom_point() +
                        scale_colour_manual(values = metadata_group_colors) +
                        scale_shape_manual(values = metadata_group_shapes) +
                        scale_size_manual(values = metadata_group_size) +
                        # stat_ellipse() +
                        xlab(paste(xaxis, " - ", exp_var_pc1)) +
                        ylab(paste(yaxis, " - ", exp_var_pc2)) +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

    return(pca_plot)
}

# example: 
# pca_L4_plot <- plot_pca(seed_full_L4.pca, "PC1", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")



# this function plots the PCA with the sample names instead of points
plot_pca_names <- function(df, pc1, pc2, metadata_group) {
    metadata_group_colors <- get(paste(metadata_group, "_colors", sep = ""))

    exp_var <- paste0(round(df$explained_variance * 100, 2), "%")
    df_X <- df$variates$X %>%
              as.data.frame() %>%
              rownames_to_column("SampleID") %>%
              inner_join(metadata %>%
                           select(SampleID, Description, Ethnic_Group, Age_group, Sex, Market_economy, Village, Tooth_site, Type), by = "SampleID")
    
    metadata_group = df_X[[metadata_group]]
    
                      # select the correct PC column and explained variance for PC1
                       if (pc1 == 'PC1') {
                           pc1 <- df_X$PC1
                           exp_var_pc1 <- exp_var[1]
                           xaxis <- c("PC1")
                       }  else if (pc1 == 'PC2') {
                           pc1 <- df_X$PC2
                           exp_var_pc1 <- exp_var[2]
                           xaxis <- c("PC2")
                       } else if (pc1 == 'PC3') {
                           pc1 <- df_X$PC3
                           exp_var_pc1 <- exp_var[3]
                           xaxis <- c("PC3")
                       }

                       if (pc2 == 'PC1') {
                           pc2 <- df_X$PC1
                           exp_var_pc2 <- exp_var[1]
                           yaxis <- c("PC1")
                       }  else if (pc2 == 'PC2') {
                           pc2 <- df_X$PC2
                           exp_var_pc2 <- exp_var[2]
                           yaxis <- c("PC2")
                       } else if (pc2 == 'PC3') {
                           pc2 <- df_X$PC3
                           exp_var_pc2 <- exp_var[3]
                           yaxis <- c("PC3")
                       }

    pca_plot_names <- ggplot(df_X, aes(pc1, pc2, colour = metadata_group)) +
                        geom_text(aes(label = df_X$SampleID), size = 2) +
                        scale_colour_manual(values = metadata_group_colors) +
                        # stat_ellipse() +
                        xlab(paste(xaxis, " - ", exp_var_pc1)) +
                        ylab(paste(yaxis, " - ", exp_var_pc2)) +
                        theme_minimal(base_size = 10) +
                        theme(legend.position = "top") +
                        theme(legend.title = element_blank())

    return(pca_plot_names)
}

```

```{r pca_biplot_function}
# this function plots the PCA with biplots to look at the categories with strongest loadings
plot_pca_bi <- function(df, pc1, pc2, metadata_group, columntitle, pathways = c("TRUE","FALSE")) {
    metadata_group_colors <- get(paste(metadata_group, "_colors", sep = ""))
    metadata_group_shapes <- get(paste(metadata_group, "_shapes", sep = ""))
   
    arrow_pc <- enquo(columntitle)
    
    exp_var <- paste0(round(df$explained_variance * 100, 2), "%") # explained variance for x- and y-labels
    
    # select only the PCs from the PCA and add metadata
    df_X <- df$variates$X %>%
              as.data.frame() %>%
              rownames_to_column("SampleID") %>%
              inner_join(metadata %>%
                           select(SampleID, Description, Ethnic_Group, Age_group, Sex, Market_economy, Village, Tooth_site, Type), by = "SampleID")
    
    metadata_group = df_X[[metadata_group]]
    
    corr_lam <- df$sdev[c("PC1", "PC2", "PC3")] * sqrt(nrow(df_X))

    df_X <- df_X %>%
      mutate(PC1 = PC1 / corr_lam[1],
             PC2 = PC2 / corr_lam[2], 
             PC3 = PC3 / corr_lam[3])

    # select the correct PC column and explained variance for PC1
    if (pc1 == 'PC1') {
        Pc1 <- df_X$PC1
        exp_var_pc1 <- exp_var[1]
        xaxis <- c("PC1")
    } else if (pc1 == 'PC2') {
        Pc1 <- df_X$PC2
        exp_var_pc1 <- exp_var[2]
        xaxis <- c("PC2")
    } else if (pc1 == 'PC3') {
        Pc1 <- df_X$PC3
        exp_var_pc1 <- exp_var[3]
        xaxis <- c("PC3")
   }
    
    # select the correct PC column and explained variance for PC2
    if (pc2 == 'PC1') {
        Pc2 <- df_X$PC1
        exp_var_pc2 <- exp_var[1]
        yaxis <- c("PC1")
 } else if (pc2 == 'PC2') {
       Pc2 <- df_X$PC2
       exp_var_pc2 <- exp_var[2]
       yaxis <- c("PC2")
    } else if (pc2 == 'PC3') {
       Pc2 <- df_X$PC3
       exp_var_pc2 <- exp_var[3]
       yaxis <- c("PC3")
   }

    # Identify the 10 pathways that have highest positive and negative loadings in the selected PC
    pws_10 <- df$loadings$X %>%
      as.data.frame(.) %>%
      rownames_to_column(var = "Function") %>%
      top_n(10, !!arrow_pc)
   if (pathways == T) {
      pws_10 <- pws_10 %>%
        rename(pathway = Function) %>%
        mutate(Function = sapply(pathway, function(f) {
                                  unlist(str_split(f, ";"))[4]
                           })) 
    }

    neg_10 <- df$loadings$X %>%
      as.data.frame(.) %>%
      rownames_to_column(var = "Function") %>%
      top_n(-10, !!arrow_pc)
    if (pathways == T) {
      neg_10 <- neg_10 %>%
      rename(pathway = Function) %>%
       mutate(Function = sapply(pathway, function(f) {
                                  unlist(str_split(f, ";"))[4]
                           })) 
    }


    pca_plot_bi <- ggplot(df_X, aes(x = Pc1, y = Pc2, colour = metadata_group)) +
      geom_point(size = 2, aes(shape = metadata_group) )+
      geom_segment(data = pws_10,
                   aes(xend = get(paste(pc1)), yend = get(paste(pc2))),
                   x = 0, y = 0, colour = "black",
                   size = 0.5,
                   arrow = arrow(length = unit(0.03, "npc"))) +
      geom_label_repel(data = pws_10,
                   aes(x = get(paste(pc1)), y = get(paste(pc2)), label = Function),
                   size = 1.5, colour = "grey20", label.padding = 0.2) +
      geom_segment(data = neg_10,
                   aes(xend = get(paste(pc1)), yend = get(paste(pc2))),
                   x = 0, y = 0, colour = "grey50",
                   size = 0.5,
                   arrow = arrow(length = unit(0.03, "npc"))) +
      geom_label_repel(data = neg_10,
                   aes(x = get(paste(pc1)), y = get(paste(pc2)), label = Function),
                   size = 1.5, colour = "grey20", label.padding = 0.2) +
      labs(x = paste(xaxis, " - ", exp_var_pc1),
           y = paste(yaxis, " - ", exp_var_pc2)) +
      scale_colour_manual(values = metadata_group_colors) +
      scale_shape_manual(values = metadata_group_shapes) +
      theme_minimal() + theme(text = element_text(size = 10)) +
      theme(legend.position = "top")

    return(pca_plot_bi)
}

```

First look at the total number of reads assigned to a SEED category
```{r percent_assigned}

seed_assignments <- seed_full %>%
  filter(Pathway == "SEED;" | Pathway == "SEED;Not assigned;") %>%
  mutate(Pathway = str_replace(Pathway, "SEED;Not assigned;","Not assigned")) %>%
  adorn_totals(where = "row", name = "Assigned") %>%
  filter(!Pathway == "SEED;") %>%
  gather("SampleID","Counts", 2:ncol(.)) %>%
  spread("Pathway","Counts") %>%
  adorn_percentages(denominator = "row") %>%
  mutate(Assigned = Assigned*100,
         "Not assigned" = `Not assigned`*100) %>%
  # merge with the metadata for plotting
  inner_join(., metadata %>% 
               select(SampleID, Individual_Seq_Depth_NonHuman, Ethnic_Group, Village, Description))


seed_assignments_box <- seed_assignments %>%
  filter(!str_detect(SampleID, "EXB|LIB|10M")) %>%
  ggplot(., aes(Village, Assigned, fill = Village)) +
    geom_boxplot() +
    scale_fill_manual(values = Village_colors) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab("Percent") +
    ggtitle("Percent of reads assigned to SEED proteins")
seed_assignments_box

# ggsave("./05-results.backup/humann2_alignment_stats_box.pdf", plot = humann2_alignment_stats_box, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

seed_assignments_w <- seed_assignments %>%
  filter(!str_detect(SampleID, "EXB|LIB|10M")) 
pairwise.wilcox.test(seed_assignments_w$Assigned, seed_assignments_w$Village, p.adjust.method = "fdr")

```

SEED pathways are separated into 4 levels: SEED, general biomolecule processing
pathway, specific pathway, protein. I use L2, L3, and L4 to indicated the
general pathway, specific pathway, and protein assignments, respectively. All
assignments at levels higher than L4 are summs of the levels directly underneath
(to get the total counts for a specific L3 path, sum all L4 proteins under that
path, to get the total counts for a specific L2 path, sum all L3 paths under
that L2 path). All analysis here is on the protein level, L4, and this is the
abbreviation I use throughout. 

```{r number_proteins}
# start with the full table and pull out only the level 4 entries
seed_full_L4 <- seed_full[str_count(seed_full$Pathway, ";") == 4, ]

seed_full_L4 <- seed_full_L4 %>%
  select(-CMC032.B0101)  # this sample has very few reads

seed_counts <- seed_full_L4 %>%
  mutate_if(is.numeric, ~1 * (. > 0)) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  group_by(SampleID) %>%
  summarize(Total_detected = sum(Counts)) %>%
  inner_join(., metadata %>%
               select(SampleID, Village), by = "SampleID")

# make a box plot of the total number of proteins assigned in each group
seed_counts_box <- seed_counts %>%
  filter(!str_detect(SampleID, "EXB|LIB|10M")) %>%
  ggplot(., aes(Village, Total_detected, fill = Village)) +
    geom_boxplot() +
    scale_fill_manual(values = Village_colors) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab("Total number of proteins") +
    ggtitle("Total number of SEED proteins identified in samples")
seed_counts_box

# ggsave("./05-results.backup/humann2_alignment_stats_box.pdf", plot = humann2_alignment_stats_box, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

seed_counts_w <- seed_counts %>%
  filter(!str_detect(SampleID, "EXB|LIB|10M")) 
pairwise.wilcox.test(seed_counts_w$Total_detected, seed_counts_w$Village, p.adjust.method = "fdr")

```
HMP samples have more proteins assigned than all villages, and JAE samples have
more proteins assigned than all villages and HMP. There are no significant
differences in the number of proteins assigned between any of the villages.


```{r number_proteins_decontam}
# start with the decontaminated table that has only the level 4 entries
seed_counts_decontam <- seed_L4.decontam %>%
  select(-CMC032.B0101) %>% # this sample has very few reads
  mutate_if(is.numeric, ~1 * (. > 0)) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  group_by(SampleID) %>%
  summarize(Total_detected = sum(Counts)) %>%
  inner_join(., metadata %>%
               select(SampleID, Village), by = "SampleID")

# make a box plot of the total number of proteins assigned in each group
seed_counts_decontam_box <- seed_counts_decontam %>%
  filter(!str_detect(SampleID, "EXB|LIB|10M")) %>%
  ggplot(., aes(Village, Total_detected, fill = Village)) +
    geom_boxplot() +
    scale_fill_manual(values = Village_colors) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab("Total number of proteins") +
    ggtitle("Number of SEED proteins remaining after filtering contaminants")
seed_counts_decontam_box

# ggsave("./05-results.backup/humann2_alignment_stats_box.pdf", plot = humann2_alignment_stats_box, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

seed_counts_decontam_w <- seed_counts_decontam %>%
  filter(!str_detect(SampleID, "EXB|LIB|10M")) 
pairwise.wilcox.test(seed_counts_decontam_w$Total_detected, seed_counts_decontam_w$Village, p.adjust.method = "fdr")

```
HMP samples have significantly more proteins assigned than all villages after
removing potential contaminants identified by decontam. JAE samples have
significantly more proteins assigned than all villages and HMP after removing
potential contaminants identified by decontam. There are no significant
differences in the number of proteins assigned between any of the villages.


Start with a PCA to see if any of the samples fall with the controls based on
functional profile.
```{r pca_L4_with_controls}
# create the input matrix of only the protein-level assignments
# start with the full table and pull out only the level 4 entries
seed_full_L4 <- seed_full[str_count(seed_full$Pathway, ";") == 4, ]

# add +1 to all count cells and transpose
seed_full_L4 <- seed_full_L4 %>%
  select(-CMC032.B0101) %>%  # this sample has very few reads
  gather("SampleID","Counts", 2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Pathway, Counts) %>%
  column_to_rownames("SampleID") 

# check the number of components to retain by tuning the PCA
tune.seed_full_L4_pca <- tune.pca(seed_full_L4, logratio = 'CLR')
# perform a PCA to see how the data cluster
seed_full_L4.pca <- pca(seed_full_L4, ncomp = 3, logratio = 'CLR')

# plot the PCA
pca_L4_plot <- plot_pca(seed_full_L4.pca, "PC1", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")
pca_L4_plot

pca_L4_plot_names <- plot_pca_names(seed_full_L4.pca, "PC1", "PC2", "Ethnic_Group")
pca_L4_plot_names

# Now with the decontaminated table
seed_L4.decontam_filt <- seed_L4.decontam %>%
  select(-CMC032.B0101) %>%  # this sample has very few reads
  gather("SampleID","Counts", 2:ncol(.)) %>%
  spread(Pathway, Counts)

rownames(seed_L4.decontam_filt) <- seed_L4.decontam_filt$SampleID
seed_L4.decontam_filt <- as.matrix(seed_L4.decontam_filt %>% 
  select(-SampleID)) + 1 # add +1 to all values to be able to do a CLR transformation before running PCA

# check the number of components to retain by tuning the PCA
tune.seed_L4.decontam_filt_pca <- tune.pca(seed_L4.decontam_filt, logratio = 'CLR')
# perform a PCA to see how the data cluster
seed_L4.decontam_filt.pca <- pca(seed_L4.decontam_filt, ncomp = 3, logratio = 'CLR')

# plot the PCA
pca_L4_decontam_plot <- plot_pca(seed_L4.decontam_filt.pca, "PC1", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")

L4_pca_controls <- plot_grid(pca_L4_plot, pca_L4_decontam_plot,
          nrow=1, labels = c("A", "B"), rel_widths = c(1, 1))

L4_pca_controls

```
None of the samples appear to be outliers. The extraction gauze plots with the
samples, but is very likely contaminated with spit. This is what we saw in the
taxonomy. The decontaminated L4 plot doesn't look all that different from the
full L4 plot. Clearly in both plots, the subsampled HMP and JAE samples are
plotting closer to the CMC samples than their full counterparts. This suggests
that there is a stronger effect of read count on the functional profiles than
there is on the taxonomy. We will continue to use the full HMP and JAE samples
however, since that's what we used for taxonomy and HUMAnN2 analyses.


How do the samples plot when the controls are removed? What's the relationship
of the samples to eachother? Let's also look at how filtering and
decontaminating affects the relationships of the samples.
```{r pca_L4_full_filt}
# Start with a full table that is not filtered or decontaminated
seed_full_L4 <- seed_full[str_count(seed_full$Pathway, ";") == 4, ]

seed_full_L4 <- seed_full_L4 %>%
  select(-CMC032.B0101) %>%  # this sample has very few reads
  select(-matches("EXB|LIB|10M")) %>%
  gather("SampleID","Counts", 2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Pathway, Counts) %>%
  column_to_rownames("SampleID") 

# check the number of components to retain by tuning the PCA
tune.pca(seed_full_L4, logratio = 'CLR')
# perform a PCA to see how the data cluster
seed_full_L4.pca <- pca(seed_full_L4, ncomp = 3, logratio = 'CLR')

# plot the PCA
pca_L4_plot <- plot_pca(seed_full_L4.pca, "PC1", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")


# Now filter the full table, but don't decontaminate it
seed_full_L4 <- seed_full[str_count(seed_full$Pathway, ";") == 4, ]

seed_full_L4 <- seed_full_L4 %>%
  select(-CMC032.B0101) %>%  # this sample has very few reads
  select(-matches("EXB|LIB|10M")) %>%
  adorn_totals(where = "col", name = "Total") %>%
  mutate(Percent = Total/(sum(Total))*100) %>%
  filter(Percent >= 0.0001) %>%
  select(-c("Total","Percent")) %>%
  gather("SampleID","Counts", 2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Pathway, Counts) %>%
  column_to_rownames("SampleID") 

# check the number of components to retain by tuning the PCA
tune.pca(seed_full_L4, logratio = 'CLR')
# perform a PCA to see how the data cluster
seed_full_L4.pca <- pca(seed_full_L4, ncomp = 3, logratio = 'CLR')

# plot the PCA
pca_L4_filt_plot <- plot_pca(seed_full_L4.pca, "PC1", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")


# Now filter the full table for only proteins present in at least 1/3 of samples from any ethnic group, but don't decontaminate it
# Determine the prevalence of SEED proteins in each group
seed_full_L4 <- seed_full[str_count(seed_full$Pathway, ";") == 4, ]

seed_full_L4_more_33 <- seed_full_L4 %>%
  select(-CMC032.B0101) %>%  # this sample has very few reads
  select(-matches("EXB|LIB|10M")) %>%
  mutate_if(is.numeric, ~1 * (. > 0)) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Ethnic_Group), by = "SampleID") %>%
  group_by(Ethnic_Group, Pathway) %>%
  summarize(Percent_presence = sum(Counts)/length(SampleID)*100) %>%
  # select the SEED proteins that are present in at least 30% of at least one group
  ungroup() %>%
  filter(Percent_presence >= 33.33) %>%
  distinct(Pathway) %>%
  # pull out these proteins to keep
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  select(Pathway)

# keep only the proteins in at least 1/3 of at least one ethnic group 
seed_full_L4_33 <- seed_full_L4 %>%
  select(-CMC032.B0101) %>%  # this sample has very few reads
  select(-matches("EXB|LIB|10M")) %>%
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  select(-c("SEED","L2","L3")) %>%
  inner_join(., seed_full_L4_more_33, by = "Pathway") %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Pathway,Counts) %>%
  column_to_rownames("SampleID") 

# check the number of components to retain by tuning the PCA
tune.pca(seed_full_L4_33, logratio = 'CLR')
# perform a PCA to see how the data cluster
seed_full_L4_33.pca <- pca(seed_full_L4_33, ncomp = 3, logratio = 'CLR')

# plot the PCA
pca_L4_33_plot <- plot_pca(seed_full_L4_33.pca, "PC1", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")


# Now keep only the proteins that are in MR1 from the factor analysis
mr1_proteins <- fread("./05-results.backup/minres_oblimin_noblanks.fa_seed.tsv")

seed_full_L4 <- seed_full[str_count(seed_full$Pathway, ";") == 4, ]

seed_full_L4_mr1 <- seed_full_L4 %>%
  select(-CMC032.B0101) %>%  # this sample has very few reads
  select(-matches("EXB|LIB|10M")) %>%
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  select(-c("SEED","L2","L3")) %>%
  inner_join(., mr1_proteins %>%
               select(Pathway), by = "Pathway") %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Pathway,Counts) %>%
  column_to_rownames("SampleID") 

# check the number of components to retain by tuning the PCA
tune.pca(seed_full_L4_mr1, logratio = 'CLR')
# perform a PCA to see how the data cluster
seed_full_L4_mr1.pca <- pca(seed_full_L4_mr1, ncomp = 3, logratio = 'CLR')

# plot the PCA
pca_L4_mr1_plot <- plot_pca(seed_full_L4_mr1.pca, "PC1", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")


```

```{r pca_L4_decontam_filt}
# Now with the decontaminated table
seed_L4.decontam_filt <- seed_L4.decontam %>%
  select(-CMC032.B0101) %>%  # this sample has very few reads
  select(-matches("EXB|LIB|10M")) %>%
  gather("SampleID","Counts", 2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Pathway, Counts) %>%
  column_to_rownames("SampleID") 

# check the number of components to retain by tuning the PCA
tune.seed_L4.decontam_filt_pca <- tune.pca(seed_L4.decontam_filt, logratio = 'CLR')
# perform a PCA to see how the data cluster
seed_L4.decontam_filt.pca <- pca(seed_L4.decontam_filt, ncomp = 3, logratio = 'CLR')

# plot the PCA
pca_L4_decontam_plot <- plot_pca(seed_L4.decontam_filt.pca, "PC1", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")


# Now filter the decontaminated table
seed_L4.decontam_filt <- seed_L4.decontam %>%
  select(-CMC032.B0101) %>%  # this sample has very few reads
  select(-matches("EXB|LIB|10M")) %>%
  adorn_totals(where = "col", name = "Total") %>%
  mutate(Percent = Total/(sum(Total))*100) %>%
  filter(Percent >= 0.0001) %>%
  select(-c("Total","Percent")) %>%
  gather("SampleID","Counts", 2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Pathway, Counts) %>%
  column_to_rownames("SampleID")

# check the number of components to retain by tuning the PCA
tune.pca(seed_L4.decontam_filt, logratio = 'CLR')
# perform a PCA to see how the data cluster
seed_L4.decontam_filt.pca <- pca(seed_L4.decontam_filt, ncomp = 3, logratio = 'CLR')

# plot the PCAs
pca_L4_decontam_filt_plot <- plot_pca(seed_L4.decontam_filt.pca, "PC1", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")


# Now filter the full table for only proteins present in at least 1/3 of samples from any ethnic group, but don't decontaminate it
# Determine the prevalence of SEED proteins in each group
seed_L4.decontam_noblanks_presence_more_30 <- seed_L4.decontam %>%
  select(-CMC032.B0101) %>%  # this sample has very few reads
  select(-matches("EXB|LIB|10M")) %>%
  mutate_if(is.numeric, ~1 * (. > 0)) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Ethnic_Group), by = "SampleID") %>%
  group_by(Ethnic_Group, Pathway) %>%
  summarize(Percent_presence = sum(Counts)/length(SampleID)*100) %>%
  # select the SEED proteins that are present in at least 30% of at least one group
  ungroup() %>%
  filter(Percent_presence >= 33.33) %>%
  distinct(Pathway) %>%
  # pull out these proteins to keep
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  select(Pathway)

# keep only the proteins in at least 1/3 of at least one ethnic group 
seed_L4.decontam_noblanks_33 <- seed_L4.decontam %>%
  select(-CMC032.B0101) %>%  # this sample has very few reads
  select(-matches("EXB|LIB|10M")) %>%
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  select(-c("SEED","L2","L3")) %>%
  inner_join(., seed_L4.decontam_noblanks_presence_more_30, by = "Pathway") %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Pathway,Counts) %>%
  column_to_rownames("SampleID")

# check the number of components to retain by tuning the PCA
tune.pca(seed_L4.decontam_noblanks_33, logratio = 'CLR')
# perform a PCA to see how the data cluster
seed_L4.decontam_noblanks_33.pca <- pca(seed_L4.decontam_noblanks_33, ncomp = 3, logratio = 'CLR')

# plot the PCAs
pca_L4_decontam_33_plot <- plot_pca(seed_L4.decontam_noblanks_33.pca, "PC1", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")


# now filter for only the proteins in MR1
mr1_proteins <- fread("./05-results.backup/minres_oblimin_noblanks.fa_seed.tsv")

# keep only the proteins in at least 1/3 of at least one ethnic group 
seed_L4.decontam_noblanks_mr1 <- seed_L4.decontam %>%
  select(-CMC032.B0101) %>%  # this sample has very few reads
  select(-matches("EXB|LIB|10M")) %>%
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  select(-c("SEED","L2","L3")) %>%
  inner_join(., mr1_proteins %>%
               select(Pathway), by = "Pathway") %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Pathway,Counts) %>%
  column_to_rownames("SampleID")

# check the number of components to retain by tuning the PCA
tune.pca(seed_L4.decontam_noblanks_mr1, logratio = 'CLR')
# perform a PCA to see how the data cluster
seed_L4.decontam_noblanks_mr1.pca <- pca(seed_L4.decontam_noblanks_mr1, ncomp = 3, logratio = 'CLR')

# plot the PCAs
pca_L4_decontam_mr1_plot <- plot_pca(seed_L4.decontam_noblanks_mr1.pca, "PC1", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")

```


```{r filteringPCA_plots}

L4_pca_filtering <- plot_grid(pca_L4_plot, pca_L4_filt_plot, pca_L4_33_plot, pca_L4_mr1_plot,
                              pca_L4_decontam_plot, pca_L4_decontam_filt_plot, pca_L4_decontam_33_plot, pca_L4_decontam_mr1_plot,
                              nrow=2, labels = c("Full", "Full-filtered", "Full-33", "Full-MR1", "Decontam", "Decontam-filtered", "Decontam-33", "Decontam-MR1"), rel_widths = c(1, 1))

L4_pca_filtering

```
The full table and the decontaminated table plots look very similar, as do the
full-filtered and decontaminated-filtered plots. Clearly removing the
"contaminant" proteins a doesn't remove proteins that strongly influence the
relationship of the industrial and non-industrial samples to eachother.
Filtering out the low abundance proteins (<0.0001%, <0.00005%) does cause the
CMC and industrial samples to plot more closely, and in some cases overlap,
suggesting that the low abundance proteins are what are distinct between the two
sample types. Is this related to the pan-genome/accessory genome differences
that may exist between strains of species found in each sample group? The HMP
and JAE samples separate from eachother on PC2, which is more visible in the
PC3-PC2 plots than in the PC1-PC2 plots. The PCAs with only proteins present in
at least 1/3 of at least one ethnic group look similar to the filtered PCAs,
with overlap of JAE and HMP with CMC, although the JAE/HMP look a little more
separated than in the abundance filtered plot. The PCAs using only proteins in
MR1 from factor analysis maintain more separation between the HMP/JAE and CMC
samples.

So which table to use, the decontaminated and prevalence-filtered table
(Decontam-33 plot above), or the decontaminated and MR1 protein-filtered table
(Decontam-MR1 plot above)? I'lll try both to see what the differences are.
Additional filtering proteins based on abundance might be important for the
biplot visualizations to be able to see the arrows, otherwise, they'll all
cluster tightly around the center of the plot.

# Decontaminated and prevalence-filtered table

## Cameroon and industrial samples
```{r pca_decontam_33_noblanks_metadata}

# Determine the prevalence of SEED proteins in each group
seed_L4.decontam_noblanks_presence_more_30 <- seed_L4.decontam %>%
  select(-CMC032.B0101) %>%  # this sample has very few reads
  select(-matches("EXB|LIB|10M")) %>%
  mutate_if(is.numeric, ~1 * (. > 0)) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Ethnic_Group), by = "SampleID") %>%
  group_by(Ethnic_Group, Pathway) %>%
  summarize(Percent_presence = sum(Counts)/length(SampleID)*100) %>%
  # select the SEED proteins that are present in at least 30% of at least one group
  ungroup() %>%
  filter(Percent_presence >= 33.33) %>%
  distinct(Pathway) %>%
  # pull out these proteins to keep
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  select(Pathway)

# keep only the proteins in at least 1/3 of at least one ethnic group 
seed_L4.decontam_noblanks_33 <- seed_L4.decontam %>%
  select(-CMC032.B0101) %>%  # this sample has very few reads
  select(-matches("EXB|LIB|10M")) %>%
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  select(-c("SEED","L2","L3")) %>%
  inner_join(., seed_L4.decontam_noblanks_presence_more_30, by = "Pathway") %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Pathway,Counts) %>%
  column_to_rownames("SampleID")

# check the number of components to retain by tuning the PCA
tune.pca(seed_L4.decontam_noblanks_33, logratio = 'CLR')
# perform a PCA to see how the data cluster
seed_L4.decontam_noblanks_33.pca <- pca(seed_L4.decontam_noblanks_33, ncomp = 3, logratio = 'CLR')

# plot the PCA
plot_pca(seed_L4.decontam_noblanks_33.pca, "PC1", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")
plot_pca(seed_L4.decontam_noblanks_33.pca, "PC1", "PC2", "Age_group", "Age_group", "Age_group")
plot_pca(seed_L4.decontam_noblanks_33.pca, "PC1", "PC2", "Market_economy", "Market_economy", "Market_economy")
plot_pca(seed_L4.decontam_noblanks_33.pca, "PC1", "PC2", "Sex", "Sex", "Sex")
plot_pca(seed_L4.decontam_noblanks_33.pca, "PC1", "PC2", "Tooth_site", "Tooth_site", "Tooth_site")
plot_pca(seed_L4.decontam_noblanks_33.pca, "PC1", "PC2", "Village", "Village", "Village")


```

```{r adonis_decontam_33_noblanks}
# Use the CLR-transformed matrix from the mixOmics PCA in the section above
# Euclidean distance
seed_L4.decontam_noblanks_33.euc <- vegdist(seed_L4.decontam_noblanks_33.pca$X, method = "euclidean", na.rm = T)
seed_L4.decontam_noblanks_33.euc.pcoa <- ape::pcoa(seed_L4.decontam_noblanks_33.euc)

seed_L4.decontam_noblanks_33.euc.pcoavectors <- as.data.frame(seed_L4.decontam_noblanks_33.euc.pcoa$vectors)
seed_L4.decontam_noblanks_33.euc.pcoavectors <- seed_L4.decontam_noblanks_33.euc.pcoavectors %>%
  rownames_to_column("SampleID")

# seed_L4.decontam_noblanks_33.euc.vecmet <- seed_L4.decontam_noblanks_33.euc.pcoavectors %>%
#   select(1:11) %>%
#   inner_join(., metadata, by = "SampleID")

seed_L4.decontam_noblanks_33.euc.pcoavectors %>%
  select(1:11) %>%
  inner_join(., metadata, by = "SampleID")  %>%
  ggplot(., aes(Axis.1, Axis.2, colour = Tooth_site, shape = Tooth_site)) +
    geom_point(size = 4) +
    scale_colour_manual(values = Tooth_site_colors) +
    scale_shape_manual(values = Tooth_site_shapes) +
    stat_ellipse(aes(colour = Tooth_site, group = Tooth_site)) +
    theme_minimal(base_size = 7) +
    ggtitle("Tooth site")

# test for difference between different metadata categories 
adonis2(seed_L4.decontam_noblanks_33.euc ~ ExtractionBatch +  LibraryBatch, metadata_noblanks, permutations = 999, by = "margin")
# adonis2(seed_L4.decontam_noblanks_33.euc ~ Age_group, metadata_noblanks, permutations = 999, by = "margin")
# adonis2(seed_L4.decontam_noblanks_33.euc ~ Ethnic_Group, metadata_noblanks, permutations = 999, by = "margin")
# adonis2(seed_L4.decontam_noblanks_33.euc ~ Tooth_site, metadata_noblanks, permutations = 999, by = "margin")
# adonis2(seed_L4.decontam_noblanks_33.euc ~ Sex, metadata_noblanks, permutations = 999, by = "margin")
# adonis2(seed_L4.decontam_noblanks_33.euc ~ Village, metadata_noblanks, permutations = 999, by = "margin")
# adonis2(seed_L4.decontam_noblanks_33.euc ~ Industry, metadata_noblanks, permutations = 999, by = "margin")
# adonis2(seed_L4.decontam_noblanks_33.euc ~ Market_economy, metadata_noblanks, permutations = 999, by = "margin")
# adonis2(seed_L4.decontam_noblanks_33.euc ~ Village + Sex + Industry + Ethnic_Group + Age_group +  Market_economy, metadata_noblanks, permutations = 999, by = "margin")
# adonis2(seed_L4.decontam_noblanks_33.euc ~ Village + Sex + Industry + Ethnic_Group + Age_group +  Market_economy, metadata_noblanks, permutations = 999)

adonis2(seed_L4.decontam_noblanks_33.euc ~ Village + Sex + Industry + Ethnic_Group + Age_group +  Market_economy, data = metadata_noblanks, permutations = 999, by = "margin")

# controlled for tooth site
adonis2(seed_L4.decontam_noblanks_33.euc ~ Village + Sex + Industry + Ethnic_Group + Age_group +  Market_economy, metadata_noblanks, permutations = 999, by = "margin", strata = metadata_noblanks$Tooth_site)

adonis2(seed_L4.decontam_noblanks_33.euc ~ Village, metadata_noblanks, permutations = 999, by = "margin", strata = metadata_noblanks$Tooth_site)

# # pairwise adonis2
# perm <- how(nperm = 199)
# setBlocks(perm) <- with(metadata_noblanks, Tooth_site)
# adonis2(seed_L4.decontam_noblanks_33.euc ~ Village, data = metadata_noblanks, permutations = perm, by = "margin")
# pairwise.adonis2(seed_L4.decontam_noblanks_33.euc ~ Ethnic_Group, data = metadata_noblanks, nperm = perm,  by = "margin")
# # Error in if (xi > xj) 1L else -1L : missing value where TRUE/FALSE needed

```
No categories are significantly different. When controlling for tooth site,
still no categories are significantly different.


```{r biplots_decontam_33_noblanks_33}
# which paths distinguish sample types when HMP and JAE are included?
pca_EG_biplot_pc1 <- plot_pca_bi(seed_L4.decontam_noblanks_33.pca, "PC1", "PC2", "Ethnic_Group", PC1, pathways = F)
pca_EG_biplot_pc1

ggsave("./05-results.backup/pca_EG_bi_noyanomami_paths.pdf", plot = pca_EG_biplot_pc1, device = "pdf",
       scale = 1, width = 7, height = 5, units = c("in"),
        dpi = 300)

# what are those pathways?
pandoc.table(pca_EG_biplot_pc1$plot_env$pws_10 %>% arrange(desc(PC1)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC1 positive loadings")

pandoc.table(pca_EG_biplot_pc1$plot_env$neg_10 %>% arrange(PC1),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC1 negative loadings")

# make a table of the pathways to save, to use again later in another R notebook
seed_protein_biplot_list <- pca_EG_biplot_pc1$plot_env$pws_10 %>% arrange(desc(PC1)) %>% mutate(Direction = "PC1+", Samples = "Industrial+CMC")
seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_biplot_pc1$plot_env$neg_10 %>% arrange(desc(PC1)) %>% mutate(Direction = "PC1-", Samples = "Industrial+CMC"))

# which paths distinguish sample types when HMP and JAE are included?
pca_EG_biplot_pc2 <- plot_pca_bi(seed_L4.decontam_noblanks_33.pca, "PC1", "PC2", "Ethnic_Group", PC2, pathways = F)
pca_EG_biplot_pc2

# what are those pathways?
pandoc.table(pca_EG_biplot_pc2$plot_env$pws_10 %>% arrange(desc(PC2)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC2 positive loadings")

pandoc.table(pca_EG_biplot_pc2$plot_env$neg_10 %>% arrange(PC2),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC2 negative loadings")

seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_biplot_pc2$plot_env$pws_10 %>% arrange(desc(PC2)) %>% mutate(Direction = "PC2+", Samples = "Industrial+CMC"))
seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_biplot_pc2$plot_env$neg_10 %>% arrange(desc(PC2)) %>% mutate(Direction = "PC2-", Samples = "Industrial+CMC"))


# which paths distinguish sample types when HMP and JAE are included?
pca_EG_biplot_pc3 <- plot_pca_bi(seed_L4.decontam_noblanks_33.pca, "PC3", "PC2", "Ethnic_Group", PC2, pathways = F)
pca_EG_biplot_pc3

# what are those pathways?
pandoc.table(pca_EG_biplot_pc3$plot_env$pws_10 %>% arrange(desc(PC3)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC3 positive loadings")

pandoc.table(pca_EG_biplot_pc3$plot_env$neg_10 %>% arrange(PC3),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC3 negative loadings")

seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_biplot_pc2$plot_env$pws_10 %>% arrange(desc(PC3)) %>% mutate(Direction = "PC3+", Samples = "Industrial+CMC"))
seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_biplot_pc2$plot_env$neg_10 %>% arrange(desc(PC3)) %>% mutate(Direction = "PC3-", Samples = "Industrial+CMC"))


```
_PC1+_
Iron compound ABC uptake transporter permease protein - 
Adenylylsulfate reductase alpha-subunit (EC 1.8.99.2) - 
Phage shock protein A - 
Oxaloacetate decarboxylas involved in citrate fermentation, predicted (EC 4.1.1.3) - 
Adenylylsulfate reductase beta-subunit (EC 1.8.99.2) - 
CRISPR-associated protein TM1812 - 
SMT0609 replicon stabilization protein (antitoxin to SMT0608 - 
Predicted transcriptional regulator of N-Acetylglucosamine utilization, GntR family - 
Dihydroneopterin triphosphate pyrophosphohydolase
5'-nucleotidase YjjG (EC 3.1.3.5) - 

_PC1-_
Predicted NAD regulator in Alphaproteobacteria - 
Aldehyde dehydrogenase A (EC 1.2.1.22) - 
Cadmium resistance protein - 
Sulfite reductase [NADPH] flavoprotein alpha-component (EC 1.8.1.2) - 
Sulfite reductase [NADPH] hemoprotein beta-component (EC 1.8.1.2) - 
Hydrogenase-4 component D - 
NnrS protein involved in response to NO - 
Predicted thiazole transporter ThiU - 
Cyclohexadienyl dehydrogenase (EC 1.3.1.12)(EC 1.3.1.43) - 
Copper-sensing two-component system response regulator CpxR - 

_PC2+_
Haloalkane dehalogenase-like protein - 
ATP-dependent DNA helicase UvrD/PcrA, clostridial paralog - 
Glycosyltransferase MshA involved in mycothiol biosynthesis (EC 2.4.1.-) - 
Branched-chain alpha-keto acid dehydrogenase, E1 component, beta subunit (EC 1.2.4.4) - 
Manganese transport protein MntH - 
Possible hypoxanthine oxidase XdhD (EC 1.-.-.-) - 
Eukaryotic-type low-affinity urea transporter - 
FIG006789: Stage V sporulation protein - 
1,3-propanediol dehydrogenase (EC 1.1.1.202) - 
ATP-dependent RNA helicase BA2475 - 

_PC2-_
Probable glycerol transport protein - 
Lysyl-tRNA synthetase (class I) (EC 6.1.1.6) - 
TldD family protein, Beta/Gamma-proteobacterial subgroup - 
Fumarate hydratase class I (EC 4.2.1.2) - 
Propionyl-CoA carboxylase biotin-containing subunit (EC 6.4.1.3) - 
TldE/PmbA family protein, Beta/Gamma-proteobacterial subgroup - 
Glycerol-3-phosphate ABC transporter, periplasmic glycerol-3-phosphate-binding protein (TC 3.A.1.1.3) - 
Indolepyruvate oxidoreductase subunit IorA (EC 1.2.7.8) - 
Flagellar hook-associated protein FliD - 
Sulfite reduction-associated complex DsrMKJOP protein DsrK (=HmeD) - 

## Cameroon samples only
```{r pca_decontam_33_cmc_categories}

# Determine the prevalence of SEED proteins in each group
seed_L4.decontam_cmc_presence_more_30 <- seed_L4.decontam %>%
  select(-CMC032.B0101) %>%  # this sample has very few reads
  select(-matches("EXB|LIB|JAE|SRR")) %>%
  mutate_if(is.numeric, ~1 * (. > 0)) %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  inner_join(., metadata %>%
               select(SampleID, Ethnic_Group), by = "SampleID") %>%
  group_by(Ethnic_Group, Pathway) %>%
  summarize(Percent_presence = sum(Counts)/length(SampleID)*100) %>%
  # select the SEED proteins that are present in at least 30% of at least one group
  ungroup() %>%
  filter(Percent_presence >= 33.33) %>%
  distinct(Pathway) %>%
  # pull out these proteins to keep
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  select(Pathway)

# keep only the proteins in at least 1/3 of at least one ethnic group 
seed_L4.decontam_cmc_33 <- seed_L4.decontam %>%
  select(-CMC032.B0101) %>%  # this sample has very few reads
  select(-matches("EXB|LIB|JAE|SRR")) %>%
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  select(-c("SEED","L2","L3")) %>%
  inner_join(., seed_L4.decontam_cmc_presence_more_30, by = "Pathway") %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Pathway,Counts) %>%
  column_to_rownames("SampleID")

# check the number of components to retain by tuning the PCA
tune.seed_L4.decontam_cmc_33_pca <- tune.pca(seed_L4.decontam_cmc_33, logratio = 'CLR')
# perform a PCA to see how the data cluster
seed_L4.decontam_cmc_33.pca <- pca(seed_L4.decontam_cmc_33, ncomp = 3, logratio = 'CLR')

# plot the PCA
plot_pca(seed_L4.decontam_cmc_33.pca, "PC1", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")
plot_pca(seed_L4.decontam_cmc_33.pca, "PC1", "PC2", "Age_group", "Age_group", "Age_group")
plot_pca(seed_L4.decontam_cmc_33.pca, "PC1", "PC2", "Market_economy", "Market_economy", "Market_economy")
plot_pca(seed_L4.decontam_cmc_33.pca, "PC1", "PC2", "Sex", "Sex", "Sex")
plot_pca(seed_L4.decontam_cmc_33.pca, "PC1", "PC2", "Tooth_site", "Tooth_site", "Tooth_site")
plot_pca(seed_L4.decontam_cmc_33.pca, "PC1", "PC2", "Village", "Village", "Village")

plot_pca(seed_L4.decontam_cmc_33.pca, "PC3", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")
plot_pca(seed_L4.decontam_cmc_33.pca, "PC3", "PC2", "Age_group", "Age_group", "Age_group")
plot_pca(seed_L4.decontam_cmc_33.pca, "PC3", "PC2", "Market_economy", "Market_economy", "Market_economy")
plot_pca(seed_L4.decontam_cmc_33.pca, "PC3", "PC2", "Sex", "Sex", "Sex")
plot_pca(seed_L4.decontam_cmc_33.pca, "PC3", "PC2", "Tooth_site", "Tooth_site", "Tooth_site")
plot_pca(seed_L4.decontam_cmc_33.pca, "PC3", "PC2", "Village", "Village", "Village")

```

```{r adonis_decontam_33_cmc}
# Use the CLR-transformed matrix from the mixOmics PCA in the section above
# Euclidean distance
seed_L4.decontam_cmc_33.euc <- vegdist(seed_L4.decontam_cmc_33.pca$X, method = "euclidean", na.rm = T)
seed_L4.decontam_cmc_33.euc.pcoa <- ape::pcoa(seed_L4.decontam_cmc_33.euc)

seed_L4.decontam_cmc_33.euc.pcoavectors <- as.data.frame(seed_L4.decontam_cmc_33.euc.pcoa$vectors)
seed_L4.decontam_cmc_33.euc.pcoavectors <- seed_L4.decontam_cmc_33.euc.pcoavectors %>%
  rownames_to_column("SampleID")

seed_L4.decontam_cmc_33.euc.vecmet <- seed_L4.decontam_cmc_33.euc.pcoavectors %>%
  select(1:11) %>%
  inner_join(., metadata, by = "SampleID")

seed_L4.decontam_cmc_33.euc.vecmet %>%
  ggplot(., aes(Axis.1, Axis.2, colour = Tooth_site, shape = Tooth_site)) +
  geom_point(size = 4) +
  scale_colour_manual(values = Tooth_site_colors) +
  scale_shape_manual(values = Tooth_site_shapes) +
  stat_ellipse(aes(colour = Tooth_site, group = Tooth_site)) +
  theme_minimal(base_size = 7) +
  ggtitle("Tooth site")

# test for difference between different metadata categories 
adonis2(seed_L4.decontam_cmc_33.euc ~ ExtractionBatch +  LibraryBatch, seed_L4.decontam_cmc_33.euc.vecmet, permutations = 999, by = "margin")

adonis2(seed_L4.decontam_cmc_33.euc ~ Village + Sex + Tooth_site + Ethnic_Group + Age_group +  Market_economy, metadata_cmc, permutations = 999, by = "margin")

# controlled for tooth site
adonis2(seed_L4.decontam_cmc_33.euc ~ Village + Sex + Ethnic_Group + Age_group + Market_economy, metadata_cmc, permutations = 999, by = "margin", strata = metadata_cmc$Tooth_site)

```
Village (p < 0.05) and tooth site are significantly different (p < 0.001). When
controlling for tooth site, only no categories are significantly different.


```{r biplots_decontam_33_cmc}
# which paths distinguish sample groups when only CMC samples are included?
pca_EG_cmc_33_biplot_pc1 <- plot_pca_bi(seed_L4.decontam_cmc_33.pca, "PC1", "PC2", "Ethnic_Group", PC1, pathways = F)
pca_EG_cmc_33_biplot_pc1

# ggsave("./05-results.backup/pca_EG_bi_cmc_33_paths.pdf", plot = pca_EG_cmc_33_biplot_pc1, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

# what are those pathways?
pandoc.table(pca_EG_cmc_33_biplot_pc1$plot_env$pws_10 %>% arrange(desc(PC1)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC1 positive loadings")

pandoc.table(pca_EG_cmc_33_biplot_pc1$plot_env$neg_10 %>% arrange(PC1),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC1 negative loadings")

seed_protein_biplot_list <- pca_EG_cmc_33_biplot_pc1$plot_env$pws_10 %>% arrange(desc(PC1)) %>% mutate(Direction = "PC1+", Samples = "CMC", Filter = "33")
seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_biplot_pc1$plot_env$neg_10 %>% arrange(desc(PC1)) %>% mutate(Direction = "PC1-", Samples = "CMC", Filter = "33"))

pca_EG_cmc_33_biplot_pc2 <- plot_pca_bi(seed_L4.decontam_cmc_33.pca, "PC1", "PC2", "Ethnic_Group", PC2, pathways = F)
pca_EG_cmc_33_biplot_pc2

pandoc.table(pca_EG_cmc_33_biplot_pc2$plot_env$pws_10 %>% arrange(desc(PC2)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC1 positive loadings")

pandoc.table(pca_EG_cmc_33_biplot_pc2$plot_env$neg_10 %>% arrange(PC2),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC1 negative loadings")

seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_cmc_33_biplot_pc1$plot_env$pws_10 %>% arrange(desc(PC2)) %>% mutate(Direction = "PC2+", Samples = "CMC", Filter = "33"))
seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_biplot_pc1$plot_env$neg_10 %>% arrange(desc(PC2)) %>% mutate(Direction = "PC2-", Samples = "CMC", Filter = "33"))

fwrite(seed_protein_biplot_list, file = "./05-results.backup/seed_protein_33_cmc_biplot_list.tsv", quote = F, sep = "\t")

pca_EG_cmc_33_biplot_pc3 <- plot_pca_bi(seed_L4.decontam_cmc_33.pca, "PC3", "PC2", "Ethnic_Group", PC3, pathways = F)
pca_EG_cmc_33_biplot_pc3

pandoc.table(pca_EG_cmc_33_biplot_pc3$plot_env$pws_10 %>% arrange(desc(PC3)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC1 positive loadings")

pandoc.table(pca_EG_cmc_33_biplot_pc3$plot_env$neg_10 %>% arrange(PC3),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC1 negative loadings")

seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_cmc_33_biplot_pc1$plot_env$pws_10 %>% arrange(desc(PC3)) %>% mutate(Direction = "PC3+", Samples = "CMC"))
seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_biplot_pc1$plot_env$neg_10 %>% arrange(desc(PC3)) %>% mutate(Direction = "PC3-", Samples = "CMC"))

# fwrite(seed_protein_biplot_list, file = "./05-results.backup/seed_protein_33_cmc_biplot_list.tsv", quote = F, sep = "\t")


```
_PC1+_
ATP-dependent protease LonB-like Type I - 
Predicted cell-wall-anchored protein SasA (LPXTG motif) - 
Colicin I receptor precursor - 
Adenylylsulfate reductase alpha-subunit (EC 1.8.99.2) - 
Outer surface protein of unknown function, cellobiose operon - 
PTS system, trehalose-specific IIB component (EC 2.7.1.69) - 
rubredoxin-oxygen oxidoreductase - 
(S)-2-hydroxy-acid oxidase (EC 1.1.3.15) - 
Cell envelope-associated transcriptional attenuator LytR-CpsA-Psr, subfamily M (as in PMID19099556) - 
Endo-1,4-beta-xylanase A precursor (EC 3.2.1.8) - 

_PC1-_
Predicted NAD regulator in Alphaproteobacteria - 
Excinuclease ABC subunit A, dimeric form - 
ATP-dependent RNA helicase Bcep18194_A5658 - 
Acetate permease ActP (cation/acetate symporter) - 
Aconitate hydratase 2 (EC 4.2.1.3) - 
NnrS protein involved in response to NO - 
Sulfite reductase [NADPH] flavoprotein alpha-component (EC 1.8.1.2) - 
Sulfite reductase [NADPH] hemoprotein beta-component (EC 1.8.1.2) - 
Aldehyde dehydrogenase A (EC 1.2.1.22) - 
Isocitrate lyase (EC 4.1.3.1) - 

_PC2+_
Inositol transport system sugar-binding protein - 
Glycosyltransferase MshA involved in mycothiol biosynthesis (EC 2.4.1.-) - 
Haloalkane dehalogenase-like protein - 
periplasmic fructose-binding protein component of signal transduction system LevT - 
Nitrite reductase [NAD(P)H] large subunit (EC 1.7.1.4) - 
Glutathione S-transferase, omega (EC 2.5.1.18) - 
Mitogenic factor 2 - 
Glutathione S-transferase, Streptococcal type (EC 2.5.1.18) - 
Manganese transport protein MntH - 
Glycine betaine ABC transport system, ATP-binding protein OpuAA (EC 3.6.3.32) - 

_PC2-_
Flagellar hook-associated protein FlgL - 
Flagellar hook-associated protein FlgK - 
Trehalase (EC 3.2.1.28) - 
Flagellar assembly protein FliH - 
Flagellar hook-associated protein FliD - 
NAD(P)HX epimerase - 
CoB--CoM heterodisulfide reductase subunit A (EC 1.8.98.1) - 
Cell envelope-associated transcriptional attenuator LytR-CpsA-Psr, subfamily S (as in PMID19099556) - 
Oxaloacetate decarboxylase involved in citrate fermentation, predicted (EC 4.1.1.3) - 
Probable glycerol transport protein - 

```{r pathways_biplot_proteins_cmc_33}
# noblanks samples only
seed_protein_mr1_noblanks_biplot_list <- fread("./05-results.backup/seed_protein_mr1_noblanks_biplot_list.tsv")
mr1_noblanks_biplot_list <- seed_protein_mr1_noblanks_biplot_list %>%
  pull(Function)

# how many different (and which) pathways do the proteins come from?
seed_L4.decontam %>%
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  filter(Pathway %in% mr1_noblanks_biplot_list) %>%
  select(L3, Pathway) %>%
  full_join(., seed_protein_mr1_noblanks_biplot_list %>%
              select(-c("PC1","PC2","PC3")) %>%
              rename(Pathway = Function), by = "Pathway") %>%
  select(L3, Direction) %>%
  group_by(Direction) %>%
  count(L3)

# how many different (and which) higher-level pathways do the proteins come from?
seed_L4.decontam %>%
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  filter(Pathway %in% mr1_noblanks_biplot_list) %>%
  select(L2, Pathway) %>%
  full_join(., seed_protein_mr1_noblanks_biplot_list %>%
              select(-c("PC1","PC2","PC3")) %>%
              rename(Pathway = Function), by = "Pathway") %>%
  select(L2, Direction) %>%
  group_by(Direction) %>%
  count(L2)

```

# Decontaminated and MR1 protein only-filtered table

## Cameroon and idustrial samples
```{r pca_decontam_mr1_noblanks_metadata}

# now filter for only the proteins in MR1
mr1_proteins <- fread("./05-results.backup/minres_oblimin_noblanks.fa_seed.tsv")

# keep only the proteins in at least 1/3 of at least one ethnic group 
seed_L4.decontam_noblanks_mr1 <- seed_L4.decontam %>%
  select(-CMC032.B0101) %>%  # this sample has very few reads
  select(-matches("EXB|LIB|10M")) %>%
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  select(-c("SEED","L2","L3")) %>%
  inner_join(., mr1_proteins %>%
               filter(Residual == "MR1") %>%
               select(Pathway), by = "Pathway") %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Pathway,Counts) %>%
  column_to_rownames("SampleID")

# check the number of components to retain by tuning the PCA
tune.seed_L4.decontam_noblanks_mr1_pca <- tune.pca(seed_L4.decontam_noblanks_mr1, logratio = 'CLR')
# perform a PCA to see how the data cluster
seed_L4.decontam_noblanks_mr1.pca <- pca(seed_L4.decontam_noblanks_mr1, ncomp = 3, logratio = 'CLR')

# plot the PCA
plot_pca(seed_L4.decontam_noblanks_mr1.pca, "PC1", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")
plot_pca(seed_L4.decontam_noblanks_mr1.pca, "PC1", "PC2", "Age_group", "Age_group", "Age_group")
plot_pca(seed_L4.decontam_noblanks_mr1.pca, "PC1", "PC2", "Market_economy", "Market_economy", "Market_economy")
plot_pca(seed_L4.decontam_noblanks_mr1.pca, "PC1", "PC2", "Sex", "Sex", "Sex")
plot_pca(seed_L4.decontam_noblanks_mr1.pca, "PC1", "PC2", "Tooth_site", "Tooth_site", "Tooth_site")
plot_pca(seed_L4.decontam_noblanks_mr1.pca, "PC1", "PC2", "Village", "Village", "Village")

plot_pca(seed_L4.decontam_noblanks_mr1.pca, "PC3", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")
plot_pca(seed_L4.decontam_noblanks_mr1.pca, "PC3", "PC2", "Age_group", "Age_group", "Age_group")
plot_pca(seed_L4.decontam_noblanks_mr1.pca, "PC3", "PC2", "Market_economy", "Market_economy", "Market_economy")
plot_pca(seed_L4.decontam_noblanks_mr1.pca, "PC3", "PC2", "Sex", "Sex", "Sex")
plot_pca(seed_L4.decontam_noblanks_mr1.pca, "PC3", "PC2", "Tooth_site", "Tooth_site", "Tooth_site")
plot_pca(seed_L4.decontam_noblanks_mr1.pca, "PC3", "PC2", "Village", "Village", "Village")


```


```{r adonis_decontam_mr1_noblanks}
# Use the CLR-transformed matrix from the mixOmics PCA in the section above
# Euclidean distance
seed_L4.decontam_noblanks_mr1.euc <- vegdist(seed_L4.decontam_noblanks_mr1.pca$X, method = "euclidean", na.rm = T)
seed_L4.decontam_noblanks_mr1.euc.pcoa <- ape::pcoa(seed_L4.decontam_noblanks_mr1.euc)

seed_L4.decontam_noblanks_mr1.euc.pcoavectors <- as.data.frame(seed_L4.decontam_noblanks_mr1.euc.pcoa$vectors)
seed_L4.decontam_noblanks_mr1.euc.pcoavectors <- seed_L4.decontam_noblanks_mr1.euc.pcoavectors %>%
  rownames_to_column("SampleID")

seed_L4.decontam_noblanks_mr1.euc.pcoavectors %>%
  select(1:11) %>%
  inner_join(., metadata, by = "SampleID") %>%
  ggplot(., aes(Axis.1, Axis.2, colour = Tooth_site, shape = Tooth_site)) +
    geom_point(size = 4) +
    scale_colour_manual(values = Tooth_site_colors) +
    scale_shape_manual(values = Tooth_site_shapes) +
    stat_ellipse(aes(colour = Tooth_site, group = Tooth_site)) +
    theme_minimal(base_size = 7) +
    ggtitle("Tooth site")

# test for difference between different metadata categories 
adonis2(seed_L4.decontam_noblanks_mr1.euc ~ ExtractionBatch +  LibraryBatch, metadata_noblanks, permutations = 999, by = "margin")

adonis2(seed_L4.decontam_noblanks_mr1.euc ~ Village + Sex + Industry + Tooth_site + Ethnic_Group + Age_group + Market_economy, metadata_noblanks, permutations = 999, by = "margin")

# controlled for tooth site
adonis2(seed_L4.decontam_noblanks_mr1.euc ~ Village + Sex + Industry + Ethnic_Group + Age_group + Market_economy, metadata_noblanks, permutations = 999, by = "margin", strata = metadata_cmc$Tooth_site)

```
When using only proteins in MR1, sex (p < 0.05) and tooth site (p < 0.01) are
significantly different, but when controlling for tooth site none are is
significantly different.


```{r biplots_decontam_mr1_noblanks}
# which paths distinguish sample types when HMP and JAE are included?
pca_EG_biplot_pc1 <- plot_pca_bi(seed_L4.decontam_noblanks_mr1.pca, "PC1", "PC2", "Ethnic_Group", PC1, pathways = F)
pca_EG_biplot_pc1

# ggsave("./05-results.backup/pca_EG_bi_noyanomami_paths.pdf", plot = pca_EG_biplot_pc1, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"),
#         dpi = 300)

# what are those pathways?
pandoc.table(pca_EG_biplot_pc1$plot_env$pws_10 %>% arrange(desc(PC1)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC1 positive loadings")

pandoc.table(pca_EG_biplot_pc1$plot_env$neg_10 %>% arrange(PC1),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC1 negative loadings")

# make a table of the pathways to save, to use again later in another R notebook
seed_protein_biplot_list <- pca_EG_biplot_pc1$plot_env$pws_10 %>% arrange(desc(PC1)) %>% mutate(Direction = "PC1+", Samples = "Industrial+CMC", Filter = "MR1")
seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_biplot_pc1$plot_env$neg_10 %>% arrange(desc(PC1)) %>% mutate(Direction = "PC1-", Samples = "Industrial+CMC", Filter = "MR1"))

# which paths distinguish sample types when HMP and JAE are included?
pca_EG_biplot_pc2 <- plot_pca_bi(seed_L4.decontam_noblanks_mr1.pca, "PC1", "PC2", "Ethnic_Group", PC2, pathways = F)
pca_EG_biplot_pc2

# what are those pathways?
pandoc.table(pca_EG_biplot_pc2$plot_env$pws_10 %>% arrange(desc(PC2)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC2 positive loadings")

pandoc.table(pca_EG_biplot_pc2$plot_env$neg_10 %>% arrange(PC2),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC2 negative loadings")

seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_biplot_pc2$plot_env$pws_10 %>% arrange(desc(PC2)) %>% mutate(Direction = "PC2+", Samples = "Industrial+CMC", Filter = "MR1"))
seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_biplot_pc2$plot_env$neg_10 %>% arrange(desc(PC2)) %>% mutate(Direction = "PC2-", Samples = "Industrial+CMC", Filter = "MR1"))

fwrite(seed_protein_biplot_list, file = "./05-results.backup/seed_protein_mr1_noblanks_biplot_list.tsv", quote = F, sep = "\t")

# which paths distinguish sample types when HMP and JAE are included?
pca_EG_biplot_pc3 <- plot_pca_bi(seed_L4.decontam_noblanks_mr1.pca, "PC3", "PC2", "Ethnic_Group", PC3, pathways = F)
pca_EG_biplot_pc3

# what are those pathways?
pandoc.table(pca_EG_biplot_pc3$plot_env$pws_10 %>% arrange(desc(PC3)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC3 positive loadings")

pandoc.table(pca_EG_biplot_pc3$plot_env$neg_10 %>% arrange(PC3),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC3 negative loadings")

# seed_protein_biplot_list <- seed_protein_biplot_list %>%
#   bind_rows(pca_EG_biplot_pc2$plot_env$pws_10 %>% arrange(desc(PC3)) %>% mutate(Direction = "PC2+", Samples = "Industrial+CMC", Filter = "MR1"))
# seed_protein_biplot_list <- seed_protein_biplot_list %>%
#   bind_rows(pca_EG_biplot_pc2$plot_env$neg_10 %>% arrange(desc(PC3)) %>% mutate(Direction = "PC2-", Samples = "Industrial+CMC", Filter = "MR1"))

```
_PC1+_
Type IV fimbrial biogenesis protein PilW - 
Type IV secretion system protein VirD4 - 
Type IV fimbrial biogenesis protein PilX - 
Type IV pilus biogenesis protein PilO - 
Sialic acid biosynthesis protein NeuD, O-acetyltransferase - 
UDP-glucose:(glucosyl)lipopolysaccharide alpha-1,2-glucosyltransferase (EC 2.4.1.58) - 
Type IV pilus biogenesis protein PilP - 
Outer membrane component of tripartite multidrug resistance system - 
Legionaminic acid cytidylyltransferase (EC 2.7.7.43) - 
putative ATP-dependent DNA helicase YjcD - 

_PC1-_
NAD-dependent malic enzyme (EC 1.1.1.38) - 
Excinuclease ABC subunit A paralog of unknown function - 
Biosynthetic Aromatic amino acid aminotransferase beta (EC 2.6.1.57) - 
Epi-inositol hydrolase (EC 3.7.1.-) - 
Acting phosphoribosylanthranilate isomerase (EC 5.3.1.24) - 
Streptothricin acetyltransferase, Streptomyces lavendulae type - 
Major myo-inositol transporter IolT - 
Copper chaperone - 
Methylmalonate-semialdehyde dehydrogenase [inositol] (EC 1.2.1.27) - 
Ribonuclease HI (EC 3.1.26.4) - 

_PC2+_
Major myo-inositol transporter IolT - 
Inosine-uridine preferring nucleoside hydrolase (EC 3.2.2.1) - 
Cytosine/purine/uracil/thiamine/allantoin permease family protein - 
RNA polymerase sigma-70 factor - 
N-Acetyltransferase PseH involved in the biosynthesis of pseudaminic acid - 
4-amino-6-deoxy-N-Acetyl-D-hexosaminyl-(Lipid carrier) acetyltrasferase - 
internalin, putative (LPXTG motif) - 
Legionaminic acid biosynthesis protein PtmF - 
Legionaminic acid cytidylyltransferase (EC 2.7.7.43) - 
Pyrophosphate-dependent fructose 6-phosphate-1-kinase (EC 2.7.1.90) - 

_PC2-_
Universal stress protein A - 
Nitrate reductase cytochrome c550-type subunit - 
Primosomal replication protein N - 
Putative thiol:disulfide oxidoreductase, nitrite reductase complex assembly - 
Glutaredoxin 1 - 
Z-ring-associated protein ZapA - 
Ribosome hibernation protein YfiA - 
[NiFe] hydrogenase nickel incorporation protein HybF - 
N-acetylglucosamine-6P-responsive transcriptional repressor NagC, ROK family - 
Outer membrane stress sensor protease DegQ, serine protease - 

```{r pathways_biplot_proteins_noblanks_mr1}
# Industrial and CMC samples
seed_protein_mr1_noblanks_biplot_list <- fread("./05-results.backup/seed_protein_mr1_noblanks_biplot_list.tsv")
mr1_noblanks_biplot_list <- seed_protein_mr1_noblanks_biplot_list %>%
  pull(Function)

# how many different (and which) pathways do the proteins come from?
seed_L4.decontam %>%
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  filter(Pathway %in% mr1_noblanks_biplot_list) %>%
  select(L3, Pathway) %>%
  full_join(., seed_protein_mr1_noblanks_biplot_list %>%
              select(-c("PC1","PC2","PC3")) %>%
              rename(Pathway = Function), by = "Pathway") %>%
  select(L3, Direction) %>%
  group_by(Direction) %>%
  count(L3)

# how many different (and which) higher-level pathways do the proteins come from?
seed_L4.decontam %>%
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  filter(Pathway %in% mr1_noblanks_biplot_list) %>%
  select(L2, Pathway) %>%
  full_join(., seed_protein_mr1_noblanks_biplot_list %>%
              select(-c("PC1","PC2","PC3")) %>%
              rename(Pathway = Function), by = "Pathway") %>%
  select(L2, Direction) %>%
  group_by(Direction) %>%
  count(L2)

```

## Cameroon samples only

```{r pca_decontam_mr1_cmc_categories}

# now filter for only the proteins in MR1
mr1_proteins <- fread("./05-results.backup/minres_oblimin_noblanks.fa_seed.tsv")

# keep only the proteins in at least 1/3 of at least one ethnic group 
seed_L4.decontam_cmc_mr1 <- seed_L4.decontam %>%
  select(-CMC032.B0101) %>%  # this sample has very few reads
  select(-matches("EXB|LIB|JAE|SRR")) %>%
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  select(-c("SEED","L2","L3")) %>%
  inner_join(., mr1_proteins %>%
               filter(Residual == "MR1") %>%
               select(Pathway), by = "Pathway") %>%
  gather("SampleID","Counts",2:ncol(.)) %>%
  mutate(Counts = Counts +1) %>%
  spread(Pathway,Counts) %>%
  column_to_rownames("SampleID")

# check the number of components to retain by tuning the PCA
tune.seed_L4.decontam_cmc_mr1_pca <- tune.pca(seed_L4.decontam_cmc_mr1, logratio = 'CLR')
# perform a PCA to see how the data cluster
seed_L4.decontam_cmc_mr1.pca <- pca(seed_L4.decontam_cmc_mr1, ncomp = 3, logratio = 'CLR')

# plot the PCA
plot_pca(seed_L4.decontam_cmc_mr1.pca, "PC1", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")
plot_pca(seed_L4.decontam_cmc_mr1.pca, "PC1", "PC2", "Age_group", "Age_group", "Age_group")
plot_pca(seed_L4.decontam_cmc_mr1.pca, "PC1", "PC2", "Market_economy", "Market_economy", "Market_economy")
plot_pca(seed_L4.decontam_cmc_mr1.pca, "PC1", "PC2", "Sex", "Sex", "Sex")
plot_pca(seed_L4.decontam_cmc_mr1.pca, "PC1", "PC2", "Tooth_site", "Tooth_site", "Tooth_site")
plot_pca(seed_L4.decontam_cmc_mr1.pca, "PC1", "PC2", "Village", "Village", "Village")

plot_pca(seed_L4.decontam_cmc_mr1.pca, "PC3", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")
plot_pca(seed_L4.decontam_cmc_mr1.pca, "PC3", "PC2", "Age_group", "Age_group", "Age_group")
plot_pca(seed_L4.decontam_cmc_mr1.pca, "PC3", "PC2", "Market_economy", "Market_economy", "Market_economy")
plot_pca(seed_L4.decontam_cmc_mr1.pca, "PC3", "PC2", "Sex", "Sex", "Sex")
plot_pca(seed_L4.decontam_cmc_mr1.pca, "PC3", "PC2", "Tooth_site", "Tooth_site", "Tooth_site")
plot_pca(seed_L4.decontam_cmc_mr1.pca, "PC3", "PC2", "Village", "Village", "Village")

```
PC1 separates by tooth site (anterior/posterior) and PC3 separates by sex
(male/female). It's not clear to me what PC2 is separating by.


```{r adonis_decontam_mr1_cmc}
# Use the CLR-transformed matrix from the mixOmics PCA in the section above
# Euclidean distance
seed_L4.decontam_cmc_mr1.euc <- vegdist(seed_L4.decontam_cmc_mr1.pca$X, method = "euclidean", na.rm = T)
seed_L4.decontam_cmc_mr1.euc.pcoa <- ape::pcoa(seed_L4.decontam_cmc_mr1.euc)

seed_L4.decontam_cmc_mr1.euc.pcoavectors <- as.data.frame(seed_L4.decontam_cmc_mr1.euc.pcoa$vectors)
seed_L4.decontam_cmc_mr1.euc.pcoavectors <- seed_L4.decontam_cmc_mr1.euc.pcoavectors %>%
  rownames_to_column("SampleID")

seed_L4.decontam_cmc_mr1.euc.pcoavectors %>%
  select(1:11) %>%
  inner_join(., metadata, by = "SampleID") %>%
  ggplot(., aes(Axis.1, Axis.2, colour = Tooth_site, shape = Tooth_site)) +
    geom_point(size = 4) +
    scale_colour_manual(values = Tooth_site_colors) +
    scale_shape_manual(values = Tooth_site_shapes) +
    stat_ellipse(aes(colour = Tooth_site, group = Tooth_site)) +
    theme_minimal(base_size = 7) +
    ggtitle("Tooth site")

# test for difference between different metadata categories 
# adonis2(seed_L4.decontam_cmc_mr1.euc ~ ExtractionBatch + Village + Sex + Tooth_site + Ethnic_Group + Age_group +  LibraryBatch + Market_economy, metadata_cmc, permutations = 999, by = "margin")

adonis2(seed_L4.decontam_cmc_mr1.euc ~ ExtractionBatch +  LibraryBatch, metadata_cmc, permutations = 999, by = "margin")

adonis2(seed_L4.decontam_cmc_mr1.euc ~ Village + Sex + Tooth_site + Ethnic_Group + Age_group + Market_economy, metadata_cmc, permutations = 999, by = "margin")

# adonis2(seed_L4.decontam_cmc_mr1.euc ~ Ethnic_Group, metadata_cmc, permutations = 999, by = "margin")

# controlled for tooth site
adonis2(seed_L4.decontam_cmc_mr1.euc ~ ExtractionBatch + Village + Sex + Ethnic_Group + Age_group +  LibraryBatch + Market_economy, metadata_cmc, permutations = 999, by = "margin", strata = metadata_cmc$Tooth_site)

```
When including proteins from only MR1, villate (p < 0.05), sex (p < 0.01), and
tooth site (p < 0.001) are significantly different, and further controlling for
tooth site shows sex (p < 0.05) is significantly different.


```{r biplots_decontam_mr1_cmc}
# which paths distinguish sample groups when only CMC samples are included?
pca_EG_cmc_biplot_pc1 <- plot_pca_bi(seed_L4.decontam_cmc_mr1.pca, "PC1", "PC2", "Ethnic_Group", PC1, pathways = F)
pca_EG_cmc_biplot_pc1

# ggsave("./05-results.backup/pca_EG_bi_cmc_paths.pdf", plot = pca_EG_cmc_biplot_pc1, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

# what are those pathways?
pandoc.table(pca_EG_cmc_biplot_pc1$plot_env$pws_10 %>% arrange(desc(PC1)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC1 positive loadings")

pandoc.table(pca_EG_cmc_biplot_pc1$plot_env$neg_10 %>% arrange(PC1),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC1 negative loadings")

seed_protein_biplot_list <- pca_EG_cmc_biplot_pc1$plot_env$pws_10 %>% arrange(desc(PC1)) %>% mutate(Direction = "PC1+", Samples = "CMC", Filter = "MR1")
seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_biplot_pc1$plot_env$neg_10 %>% arrange(desc(PC1)) %>% mutate(Direction = "PC1-", Samples = "CMC", Filter = "MR1"))

pca_EG_cmc_biplot_pc2 <- plot_pca_bi(seed_L4.decontam_cmc_mr1.pca, "PC1", "PC2", "Ethnic_Group", PC2, pathways = F)
pca_EG_cmc_biplot_pc2

pandoc.table(pca_EG_cmc_biplot_pc2$plot_env$pws_10 %>% arrange(desc(PC2)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC2 positive loadings")

pandoc.table(pca_EG_cmc_biplot_pc2$plot_env$neg_10 %>% arrange(PC2),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC2 negative loadings")

seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_cmc_biplot_pc1$plot_env$pws_10 %>% arrange(desc(PC2)) %>% mutate(Direction = "PC2+", Samples = "CMC", Filter = "MR1"))
seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_biplot_pc1$plot_env$neg_10 %>% arrange(desc(PC2)) %>% mutate(Direction = "PC2-", Samples = "CMC", Filter = "MR1"))

fwrite(seed_protein_biplot_list, file = "./05-results.backup/seed_protein_mr1_cmc_biplot_list.tsv", quote = F, sep = "\t")

pca_EG_cmc_biplot_pc3 <- plot_pca_bi(seed_L4.decontam_cmc_mr1.pca, "PC3", "PC2", "Sex", PC3, pathways = F)
pca_EG_cmc_biplot_pc3

pandoc.table(pca_EG_cmc_biplot_pc3$plot_env$pws_10 %>% arrange(desc(PC3)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC3 positive loadings")

pandoc.table(pca_EG_cmc_biplot_pc3$plot_env$neg_10 %>% arrange(PC3),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC3 negative loadings")

# seed_protein_biplot_list <- seed_protein_biplot_list %>%
#   bind_rows(pca_EG_cmc_biplot_pc1$plot_env$pws_10 %>% arrange(desc(PC2)) %>% mutate(Direction = "PC3+", Samples = "CMC", Filter = "MR1"))
# seed_protein_biplot_list <- seed_protein_biplot_list %>%
#   bind_rows(pca_EG_biplot_pc1$plot_env$neg_10 %>% arrange(desc(PC2)) %>% mutate(Direction = "PC3-", Samples = "CMC", Filter = "MR1"))


```

_PC1+_
Major myo-inositol transporter IolT - 
Cytosine/purine/uracil/thiamine/allantoin permease family protein - 
Excinuclease ABC subunit A paralog of unknown function - 
Inosine-uridine preferring nucleoside hydrolase (EC 3.2.2.1) - 
Teichoic acid export ATP-binding protein TagH (EC 3.6.3.40) - 
Superoxide dismutase [Mn] (EC 1.15.1.1) - 
RNA polymerase sigma-70 factor - 
Phosphoribosylformylglycinamidine synthase, synthetase subunit (EC 6.3.5.3) - 
Glutamyl-tRNA(Gln) amidotransferase subunit A (EC 6.3.5.7) - 
ATP-dependent Clp protease, ATP-binding subunit ClpC - 

_PC1-_
Putative thiol:disulfide oxidoreductase, nitrite reductase complex assembly - 
Outer membrane component of tripartite multidrug resistance system - 
Mll9366 protein - 
Universal stress protein A - 
Nitrate reductase cytochrome c550-type subunit - 
Primosomal replication protein N - 
Uncharacterized protein ImpA - 
Outer membrane stress sensor protease DegQ, serine protease - 
N-acetylglucosamine-6P-responsive transcriptional repressor NagC, ROK family - 
Type IV secretion system protein VirD4 - 

_PC2+_
Type IV secretion system protein VirD4 - 
Uncharacterized protein ImpA - 
Type IV pilus biogenesis protein PilO - 
Capsular polysaccharide export system inner membrane protein KpsE - 
Type IV fimbrial biogenesis protein PilW - 
Outer membrane component of tripartite multidrug resistance system - 
Type IV fimbrial biogenesis protein PilX - 
Capsular polysaccharide export system protein KpsC - 
Ribonuclease E (EC 3.1.26.12) - 
Uncharacterized protein ImpH/VasB

_PC2-_
Evolved beta-D-galactosidase, alpha subunit - 
Putative ABC transporter (ATP-binding protein), spy1791 homolog - 
N-linked glycosylation glycosyltransferase PglG - 
3-aminobutyrl-CoA ammonia lyase (EC 4.3.1.14) - 
Ferredoxin-like protein - 
Cytochrome c oxidase subunit CcoQ (EC 1.9.3.1) - 
Formate hydrogenlyase subunit 4 - 
putative ATP-dependent DNA helicase YjcD - 
Potassium uptake protein TrkH - 
L-fucose mutarotase - 

Do the proteins in the top 10 PC loadings tend to be in the same paths, or the
same general biomolecule type processing paths?
```{r pathways_biplot_proteins_cmc_mr1}
# CMC samples only
seed_protein_mr1_cmc_biplot_list <- fread("./05-results.backup/seed_protein_mr1_cmc_biplot_list.tsv")
mr1_cmc_biplot_list <- seed_protein_mr1_cmc_biplot_list %>%
  pull(Function)

# how many different (and which) pathways do the proteins come from?
seed_L4.decontam %>%
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  filter(Pathway %in% mr1_cmc_biplot_list) %>%
  select(L3, Pathway) %>%
  full_join(., seed_protein_mr1_cmc_biplot_list %>%
              select(-c("PC1","PC2","PC3")) %>%
              rename(Pathway = Function), by = "Pathway") %>%
  select(L3, Direction) %>%
  group_by(Direction) %>%
  count(L3)

# how many different (and which) higher-level pathways do the proteins come from?
seed_L4.decontam %>%
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  filter(Pathway %in% mr1_cmc_biplot_list) %>%
  select(L2, Pathway) %>%
  full_join(., seed_protein_mr1_cmc_biplot_list %>%
              select(-c("PC1","PC2","PC3")) %>%
              rename(Pathway = Function), by = "Pathway") %>%
  select(L2, Direction) %>%
  group_by(Direction) %>%
  count(L2)

```


# MR1 protein pathway check
```{r protein_difference_stats}
mr1_proteins <- fread("./05-results.backup/minres_oblimin_noblanks.fa_seed.tsv")

# keep only the proteins in at least 1/3 of at least one ethnic group 
seed_L4_mr1_proteins <- seed_L4.decontam %>%
  select(-CMC032.B0101) %>%  # this sample has very few reads
  select(-matches("EXB|LIB|10M")) %>%
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  inner_join(., mr1_proteins %>%
               filter(Residual == "MR1") %>%
               select(Pathway), by = "Pathway")

# how many proteins in each metabolic pathway
L3_counts <- seed_L4_mr1_proteins %>%
  group_by(L3) %>%
  summarize(ProteinCount = length(Pathway))

# how many proteins in each higher-level processing pathway?  
L2_counts <- seed_L4_mr1_proteins %>%
  group_by(L2) %>%
  summarize(ProteinCount = length(Pathway))


# convert to a long table
seed_L4_mr1_proteinsL <- seed_L4.decontam %>%
  select(-CMC032.B0101) %>%  # this sample has very few reads
  select(-matches("EXB|LIB|10M")) %>%
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  inner_join(., mr1_proteins %>%
               filter(Residual == "MR1") %>%
               select(Pathway), by = "Pathway") %>%
  gather("SampleID","Counts", 5:ncol(.)) %>%
  full_join(., metadata %>%
              select(SampleID, Ethnic_Group), by = "SampleID")

seed_L4_mr1_proteinsL %>% group_by(Ethnic_Group, L3) %>% summarize(Totals = sum(Counts)) # total counts at L3 by Ethnic group
seed_L4_mr1_proteinsL %>% group_by(Ethnic_Group, L3) %>% filter(Counts > 0) %>% summarize(Totals = length(unique(SampleID))) # number of samples in each ethnic group with each L3 pathway
seed_L4_mr1_proteinsL %>% group_by(Ethnic_Group, L3) %>% filter(Counts > 0) %>% summarize(Totals = length(unique(Pathway))) # total number of proteins in each L3 by ethnic group
seed_L4_mr1_proteinsL %>% group_by(Ethnic_Group, L2) %>% filter(Counts > 0) %>% summarize(Totals = length(unique(Pathway))) # total number of proteins in each L2 by ethnic group

```


# Carbohydrate pathway proteins only
Now we'll look at whether there are differences in the sample groups based only
on proteins in carbohydrate processing pathways. There are differences in the
carbohydrates consumed by each group, and bacteria are able to process a wide
variety of carbohydrates. 
```{r carb_proteins}

# select only proteins in the Carbohydrates pathway
seed_L4_carbohydrates <- seed_L4.decontam %>%
  select(-CMC032.B0101) %>%
  select(-matches("EXB|LIB|SRR164|10M")) %>%
  filter(str_detect(Pathway, "Carbohydrates")) %>%
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  select(-c("SEED","L2","L3")) %>%
  adorn_totals(where = "col") %>%
  filter(Total > 0) %>% # remove any that are not found in the remaining samples (HMP, JAE, CMC)
  select(-Total) %>%
  gather("SampleID","Counts", 2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Pathway,Counts) %>%
  column_to_rownames("SampleID")

# check the number of components to retain by tuning the PCA
tune.seed_L4_carbohydrates_pca <- tune.pca(seed_L4_carbohydrates, logratio = 'CLR')
# perform a PCA to see how the data cluster
seed_L4_carbohydrates.pca <- pca(seed_L4_carbohydrates, ncomp = 3, logratio = 'CLR')

# plot the PCA
plot_pca(seed_L4_carbohydrates.pca, "PC1", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")
plot_pca(seed_L4_carbohydrates.pca, "PC1", "PC2", "Age_group", "Age_group", "Age_group")
plot_pca(seed_L4_carbohydrates.pca, "PC1", "PC2", "Market_economy", "Market_economy", "Market_economy")
plot_pca(seed_L4_carbohydrates.pca, "PC1", "PC2", "Sex", "Sex", "Sex")
plot_pca(seed_L4_carbohydrates.pca, "PC1", "PC2", "Tooth_site", "Tooth_site", "Tooth_site")
plot_pca(seed_L4_carbohydrates.pca, "PC1", "PC2", "Village", "Village", "Village")

plot_pca(seed_L4_carbohydrates.pca, "PC3", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")
plot_pca(seed_L4_carbohydrates.pca, "PC3", "PC2", "Age_group", "Age_group", "Age_group")
plot_pca(seed_L4_carbohydrates.pca, "PC3", "PC2", "Market_economy", "Market_economy", "Market_economy")
plot_pca(seed_L4_carbohydrates.pca, "PC3", "PC2", "Sex", "Sex", "Sex")
plot_pca(seed_L4_carbohydrates.pca, "PC3", "PC2", "Tooth_site", "Tooth_site", "Tooth_site")
plot_pca(seed_L4_carbohydrates.pca, "PC3", "PC2", "Village", "Village", "Village")

```
There is a clear separation between the Cameroon plaque samples and the
industrial plaque and calculus samples along PC1. The CMC samples separate by
tooth site along PC2, with posterior samples plotting in more positive values
and anterior samples plotting in more negative values. This is a little
unexpected, b/c the HMP samples plot in more positice PC2 values and the JAE
samples plot in more negative PC2 values, and I'd expect the posterior samples
to plot more with the JAE samples.

Are there significant differences between the groups?
```{r adonis_carbohydrates_noblanks}
# Use the CLR-transformed matrix from the mixOmics PCA in the section above
# Euclidean distance
seed_L4_carbohydrates_noblanks.euc <- vegdist(seed_L4_carbohydrates.pca$X, method = "euclidean", na.rm = T)
seed_L4_carbohydrates_noblanks.euc.pcoa <- ape::pcoa(seed_L4_carbohydrates_noblanks.euc)

seed_L4_carbohydrates_noblanks.euc.pcoavectors <- as.data.frame(seed_L4_carbohydrates_noblanks.euc.pcoa$vectors)
seed_L4_carbohydrates_noblanks.euc.pcoavectors <- seed_L4_carbohydrates_noblanks.euc.pcoavectors %>%
  rownames_to_column("SampleID")

seed_L4_carbohydrates_noblanks.euc.vecmet <- seed_L4_carbohydrates_noblanks.euc.pcoavectors %>%
  select(1:11) %>%
  inner_join(., metadata, by = "SampleID")

seed_L4_carbohydrates_noblanks.euc.vecmet %>%
  ggplot(., aes(Axis.1, Axis.2, colour = Tooth_site, shape = Tooth_site)) +
  geom_point(size = 4) +
  scale_colour_manual(values = Tooth_site_colors) +
  scale_shape_manual(values = Tooth_site_shapes) +
  stat_ellipse(aes(colour = Tooth_site, group = Tooth_site)) +
  theme_minimal(base_size = 7) +
  ggtitle("Tooth site")

# test for difference between different metadata categories 
adonis2(seed_L4_carbohydrates_noblanks.euc ~ ExtractionBatch +  LibraryBatch, metadata_noblanks, permutations = 999, by = "margin")

adonis2(seed_L4_carbohydrates_noblanks.euc ~ Village + Sex + Industry + Tooth_site + Ethnic_Group + Age_group + Market_economy, metadata_noblanks, permutations = 999, by = "margin")

# controlled for tooth site
adonis2(seed_L4_carbohydrates_noblanks.euc ~ Village + Sex + Industry + Ethnic_Group + Age_group + Market_economy, metadata_noblanks, permutations = 999, by = "margin", strata = metadata_noblanks$Tooth_site)

```
Only tooth site is significantly different (p < 0.01). When controlling for
tooth site, none of the groups are significantly different.

What are the differences if we look only within the Cameroon plaque samples?
```{r carb_proteins_cmc}
# select only proteins in the Carbohydrates pathway
seed_L4_carbohydrates_cmc <- seed_L4.decontam %>%
  select(-CMC032.B0101) %>%
  select(-matches("EXB|LIB|SRR|JAE")) %>%
  filter(str_detect(Pathway, "Carbohydrates")) %>%
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  select(-c("SEED","L2","L3")) %>%
  adorn_totals(where = "col") %>%
  filter(Total > 0) %>% # remove any that are not found in the remaining samples (HMP, JAE, CMC)
  select(-Total) %>%
  gather("SampleID","Counts", 2:ncol(.)) %>%
  mutate(Counts = Counts + 1) %>%
  spread(Pathway,Counts) %>%
  column_to_rownames("SampleID")

# check the number of components to retain by tuning the PCA
tune.seed_L4_carbohydrates_cmc_pca <- tune.pca(seed_L4_carbohydrates_cmc, logratio = 'CLR')
# perform a PCA to see how the data cluster
seed_L4_carbohydrates_cmc.pca <- pca(seed_L4_carbohydrates_cmc, ncomp = 3, logratio = 'CLR')

# plot the PCA
plot_pca(seed_L4_carbohydrates_cmc.pca, "PC1", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")
plot_pca(seed_L4_carbohydrates_cmc.pca, "PC1", "PC2", "Age_group", "Age_group", "Age_group")
plot_pca(seed_L4_carbohydrates_cmc.pca, "PC1", "PC2", "Market_economy", "Market_economy", "Market_economy")
plot_pca(seed_L4_carbohydrates_cmc.pca, "PC1", "PC2", "Sex", "Sex", "Sex")
plot_pca(seed_L4_carbohydrates_cmc.pca, "PC1", "PC2", "Tooth_site", "Tooth_site", "Tooth_site")
plot_pca(seed_L4_carbohydrates_cmc.pca, "PC1", "PC2", "Village", "Village", "Village")

# plot_pca(seed_L4_carbohydrates_cmc.pca, "PC3", "PC2", "Ethnic_Group", "Ethnic_Group", "Ethnic_Group")
# plot_pca(seed_L4_carbohydrates_cmc.pca, "PC3", "PC2", "Age_group", "Age_group", "Age_group")
# plot_pca(seed_L4_carbohydrates_cmc.pca, "PC3", "PC2", "Market_economy", "Market_economy", "Market_economy")
# plot_pca(seed_L4_carbohydrates_cmc.pca, "PC3", "PC2", "Sex", "Sex", "Sex")
# plot_pca(seed_L4_carbohydrates_cmc.pca, "PC3", "PC2", "Tooth_site", "Tooth_site", "Tooth_site")
# plot_pca(seed_L4_carbohydrates_cmc.pca, "PC3", "PC2", "Village", "Village", "Village")

```
The samples separate by tooth site along PC1, but no other potential clusterings are clear. 

Are there significant differences between the groups?
```{r adonis_carbohydrates_cmc}
# Use the CLR-transformed matrix from the mixOmics PCA in the section above
# Euclidean distance
seed_L4_carbohydrates_cmc.euc <- vegdist(seed_L4_carbohydrates_cmc.pca$X, method = "euclidean", na.rm = T)
seed_L4_carbohydrates_cmc.euc.pcoa <- ape::pcoa(seed_L4_carbohydrates_cmc.euc)

seed_L4_carbohydrates_cmc.euc.pcoavectors <- as.data.frame(seed_L4_carbohydrates_cmc.euc.pcoa$vectors)
seed_L4_carbohydrates_cmc.euc.pcoavectors <- seed_L4_carbohydrates_cmc.euc.pcoavectors %>%
  rownames_to_column("SampleID")

seed_L4_carbohydrates_cmc.euc.pcoavectors %>%
  select(1:11) %>%
  inner_join(., metadata, by = "SampleID")%>%
  ggplot(., aes(Axis.1, Axis.2, colour = Tooth_site, shape = Tooth_site)) +
    geom_point(size = 4) +
    scale_colour_manual(values = Tooth_site_colors) +
    scale_shape_manual(values = Tooth_site_shapes) +
    stat_ellipse(aes(colour = Tooth_site, group = Tooth_site)) +
    theme_minimal(base_size = 7) +
    ggtitle("Tooth site")

# test for difference between different metadata categories 
adonis2(seed_L4_carbohydrates_cmc.euc ~ ExtractionBatch + Village + Sex + Tooth_site + Ethnic_Group + Age_group +  LibraryBatch + Market_economy, metadata_cmc, permutations = 999, by = "margin")

# controlled for tooth site
adonis2(seed_L4_carbohydrates_cmc.euc ~ Village + Sex + Ethnic_Group + Age_group +  Market_economy, metadata_cmc, permutations = 999, by = "margin", strata = metadata_cmc$Tooth_site)

```
Only sex (p < 0.05) and tooth site (p < 0.01) are significantly different. When
controlling for tooth site, sex is significantly different (p < 0.05).


Which carbohydrate processing pathway proteins are contributing most to the
separation of samples?
```{r biplots_decontam_carbs_noblanks}
# which paths distinguish sample groups when only CMC samples are included?
pca_EG_noblanks_biplot_pc1 <- plot_pca_bi(seed_L4_carbohydrates.pca, "PC1", "PC2", "Ethnic_Group", PC1, pathways = F)
pca_EG_noblanks_biplot_pc1

# ggsave("./05-results.backup/pca_EG_bi_noblanks_paths.pdf", plot = pca_EG_noblanks_biplot_pc1, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

# what are those pathways?
pandoc.table(pca_EG_noblanks_biplot_pc1$plot_env$pws_10 %>% arrange(desc(PC1)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC1 positive loadings")

pandoc.table(pca_EG_noblanks_biplot_pc1$plot_env$neg_10 %>% arrange(PC1),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC1 negative loadings")

seed_protein_biplot_list <- pca_EG_noblanks_biplot_pc1$plot_env$pws_10 %>% arrange(desc(PC1)) %>% mutate(Direction = "PC1+", Samples = "CMC+Industrial", Filter = "Carbs")
seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_noblanks_biplot_pc1$plot_env$neg_10 %>% arrange(desc(PC1)) %>% mutate(Direction = "PC1-", Samples = "CMC+Industrial", Filter = "Carbs"))

pca_EG_noblanks_biplot_pc2 <- plot_pca_bi(seed_L4_carbohydrates.pca, "PC1", "PC2", "Ethnic_Group", PC2, pathways = F)
pca_EG_noblanks_biplot_pc2

pandoc.table(pca_EG_noblanks_biplot_pc2$plot_env$pws_10 %>% arrange(desc(PC2)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC2 positive loadings")

pandoc.table(pca_EG_noblanks_biplot_pc2$plot_env$neg_10 %>% arrange(PC2),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC2 negative loadings")

seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_noblanks_biplot_pc2$plot_env$pws_10 %>% arrange(desc(PC2)) %>% mutate(Direction = "PC2+", Samples = "CMC+Industrial", Filter = "Carbs"))
seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_noblanks_biplot_pc2$plot_env$neg_10 %>% arrange(desc(PC2)) %>% mutate(Direction = "PC2-", Samples = "CMC+Industrial", Filter = "Carbs"))

fwrite(seed_protein_biplot_list, file = "./05-results.backup/seed_protein_carb_noblanks_biplot_list.tsv", quote = F, sep = "\t")

pca_EG_cmc_biplot_pc1 <- plot_pca_bi(seed_L4_carbohydrates_cmc.pca, "PC1", "PC2", "Sex", PC1, pathways = F)
pca_EG_cmc_biplot_pc1

pandoc.table(pca_EG_cmc_biplot_pc1$plot_env$pws_10 %>% arrange(desc(PC1)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC1 positive loadings")

pandoc.table(pca_EG_cmc_biplot_pc1$plot_env$neg_10 %>% arrange(PC1),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC1 negative loadings")

seed_protein_biplot_list <- pca_EG_cmc_biplot_pc1$plot_env$pws_10 %>% arrange(desc(PC1)) %>% mutate(Direction = "PC1+", Samples = "CMC", Filter = "Carbs")
seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_cmc_biplot_pc1$plot_env$neg_10 %>% arrange(desc(PC1)) %>% mutate(Direction = "PC1-", Samples = "CMC", Filter = "Carbs"))


pca_EG_cmc_biplot_pc2 <- plot_pca_bi(seed_L4_carbohydrates_cmc.pca, "PC1", "PC2", "Sex", PC2, pathways = F)
pca_EG_cmc_biplot_pc2

pandoc.table(pca_EG_cmc_biplot_pc2$plot_env$pws_10 %>% arrange(desc(PC2)),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC2 positive loadings")

pandoc.table(pca_EG_cmc_biplot_pc2$plot_env$neg_10 %>% arrange(PC2),
             digits = 5,
             keep.trailing.zeros = T,
             justify = "lrrr",
             split.tables = Inf,
             caption = "PC2 negative loadings")

seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_cmc_biplot_pc2$plot_env$pws_10 %>% arrange(desc(PC2)) %>% mutate(Direction = "PC2+", Samples = "CMC", Filter = "Carbs"))
seed_protein_biplot_list <- seed_protein_biplot_list %>%
  bind_rows(pca_EG_cmc_biplot_pc2$plot_env$neg_10 %>% arrange(desc(PC2)) %>% mutate(Direction = "PC2-", Samples = "CMC", Filter = "Carbs"))

fwrite(seed_protein_biplot_list, file = "./05-results.backup/seed_protein_carb_cmc_biplot_list.tsv", quote = F, sep = "\t")

```

*Industrial and Cameroon samples*
_PC1+_
Aldehyde dehydrogenase A (EC 1.2.1.22) - 
Glycolate dehydrogenase (EC 1.1.99.14), iron-sulfur subunit GlcF - 
Acetate permease ActP (cation/acetate symporter) - 
Glycolate dehydrogenase (EC 1.1.99.14), subunit GlcD - 
Aconitate hydratase 2 (EC 4.2.1.3) - 
2,3-butanediol dehydrogenase, R-alcohol forming, (R)- and (S)-acetoin-specific (EC 1.1.1.4) - 
D-amino acid dehydrogenase small subunit (EC 1.4.99.1) - 
Pyruvate decarboxylase (EC 4.1.1.1) - 
Phosphogluconate dehydratase (EC 4.2.1.12) - 
Dihydrolipoamide dehydrogenase of pyruvate dehydrogenase complex (EC 1.8.1.4) - 


_PC1-_
Oxaloacetate decarboxylase involved in citrate fermentation, predicted (EC 4.1.1.3) - 
Predicted transcriptional regulator of N-Acetylglucosamine utilization, GntR family - 
Alpha-L-arabinofuranosidase II precursor (EC 3.2.1.55) - 
PTS system, diacetylchitobiose-specific IIB component (EC 2.7.1.69) - 
Outer membrane protein SusE - 
Outer membrane protein SusF - 
L-idonate 5-dehydrogenase (EC 1.1.1.264) - 
Two-component sensor histidine kinase, malate (EC 2.7.3.-) - 
Alpha-N-acetylglucosaminidase (EC 3.2.1.50) - 
Glycogen branching enzyme, GH-57-type, archaeal (EC 2.4.1.18) - 

_PC2+_
1,3-propanediol dehydrogenase (EC 1.1.1.202) - 
Outer surface protein of unknown function, cellobiose operon - 
Polygalacturonase (EC 3.2.1.15) - 
(S)-2-hydroxy-acid oxidase (EC 1.1.3.15) - 
Two-component sensor kinase YesM (EC 2.7.3.-) - 
2,3-butanediol dehydrogenase, S-alcohol forming, (R)-acetoin-specific (EC 1.1.1.4) - 
PTS system, trehalose-specific IIB component (EC 2.7.1.69) - 
Sorbitol operon transcription regulator - 
Acetolactate synthase, catabolic (EC 2.2.1.6) - 
predicted xylose isomerase - 

_PC2-_
Propionyl-CoA carboxylase biotin-containing subunit (EC 6.4.1.3) - 
Fumarate hydratase class I (EC 4.2.1.2) - 
D-Lactate dehydrogenase, cytochrome c-dependent (EC 1.1.2.4) - 
Probable glycerol transport protein - 
Propionyl-CoA carboxylase carboxyl transferase subunit (EC 6.4.1.3) - 
Pyruvate:ferredoxin oxidoreductase, alpha subunit (EC 1.2.7.1) - 
Glycerol-3-phosphate ABC transporter, periplasmic glycerol-3-phosphate-binding protein (TC 3.A.1.1.3) - 
Acetate permease ActP (cation/acetate symporter) - 
Aconitate hydratase 2 (EC 4.2.1.3) - 
2-methylcitrate synthase (EC 2.3.3.5) - 


*Cameroon samples only*
_PC1+_
PTS system, trehalose-specific IIB component (EC 2.7.1.69) - 
Outer surface protein of unknown function, cellobiose operon - 
PTS system, diacetylchitobiose-specific IIB component (EC 2.7.1.69) - 
(S)-2-hydroxy-acid oxidase (EC 1.1.3.15) - 
Endo-1,4-beta-xylanase A precursor (EC 3.2.1.8) - 
Trehalose operon transcriptional repressor - 
Sorbitol operon transcription regulator - 
N-acetyl glucosamine transporter, NagP - 
Polygalacturonase (EC 3.2.1.15) - 
Predicted transcriptional regulator of N-Acetylglucosamine utilization, GntR family - 

_PC1-_
Acetate permease ActP (cation/acetate symporter) - 
Aconitate hydratase 2 (EC 4.2.1.3) - 
Isocitrate lyase (EC 4.1.3.1) - 
Malate synthase G (EC 2.3.3.9) - 
Aldehyde dehydrogenase A (EC 1.2.1.22) - 
Glycolate dehydrogenase (EC 1.1.99.14), subunit GlcD - 
Propionyl-CoA carboxylase biotin-containing subunit (EC 6.4.1.3) - 
D-amino acid dehydrogenase small subunit (EC 1.4.99.1) - 
D-Lactate dehydrogenase, cytochrome c-dependent (EC 1.1.2.4) - 
Glycolate dehydrogenase (EC 1.1.99.14), iron-sulfur subunit GlcF - 

_PC2+_
Oxaloacetate decarboxylase involved in citrate fermentation, predicted (EC 4.1.1.3) - 
Trehalase (EC 3.2.1.28) - 
Beta-mannosidase (EC 3.2.1.25) - 
CoB--CoM heterodisulfide reductase subunit A (EC 1.8.98.1) - 
Predicted glucose transporter in maltodextrin utilization gene cluster - 
Probable glycerol transport protein - 
Predicted L-lactate dehydrogenase, hypothetical protein subunit SO1518 - 
Methylmalonyl-CoA decarboxylase, alpha chain (EC 4.1.1.41) - 
Putative glycogen debranching enzyme, archaeal type, TIGR01561 - 
Arabinan endo-1,5-alpha-L-arabinosidase (EC 3.2.1.99) - 

_PC2-_
Inositol transport system sugar-binding protein - 
Transcriptional antiterminator of lichenan operon, BglG family - 
Acetolactate synthase, catabolic (EC 2.2.1.6) - 
Transcriptional antiterminator with PTS regulation domain, SPy0181 ortholog - 
2,3-butanediol dehydrogenase, S-alcohol forming, (R)-acetoin-specific (EC 1.1.1.4) - 
Succinate-semialdehyde dehydrogenase [NADP+] (EC 1.2.1.79) - 
Arabinose operon protein AraL - 
Trehalose synthase (EC 5.4.99.16) - 
Ascorbate-specific PTS system, EIIB component (EC 2.7.1.69) - 
Propanediol utilization polyhedral body protein PduA - 

Do the proteins in the top 10 PC loadings tend to be in the same paths, or the
same general biomolecule type processing paths?
In this case no, there are typically only 1-2 prtoeins from any single path. 
```{r pathways_biplot_proteins_carbs}
# Industrial and CMC samples
seed_protein_carb_noblanks_biplot_list <- fread("./05-results.backup/seed_protein_carb_noblanks_biplot_list.tsv")
carb_noblanks_biplot_list <- seed_protein_carb_noblanks_biplot_list %>%
  pull(Function)

# how many different (and which) pathways do the proteins come from?
seed_L4.decontam %>%
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  filter(Pathway %in% carb_noblanks_biplot_list) %>%
  select(L3, Pathway) %>%
  full_join(., seed_protein_carb_noblanks_biplot_list %>%
              select(-c("PC1","PC2","PC3")) %>%
              rename(Pathway = Function), by = "Pathway") %>%
  select(L3, Direction) %>%
  group_by(Direction) %>%
  count(L3)


# CMC samples only
seed_protein_carb_cmc_biplot_list <- fread("./05-results.backup/seed_protein_carb_cmc_biplot_list.tsv")
carb_cmc_biplot_list <- seed_protein_carb_cmc_biplot_list %>%
  pull(Function)

# how many different (and which) pathways do the proteins come from?
seed_L4.decontam %>%
  separate(., Pathway, into = c("SEED","L2","L3","Pathway"), sep = ";") %>%
  filter(Pathway %in% carb_cmc_biplot_list) %>%
  select(L3, Pathway) %>%
  full_join(., seed_protein_carb_cmc_biplot_list %>%
              select(-c("PC1","PC2","PC3")) %>%
              rename(Pathway = Function), by = "Pathway") %>%
  select(L3, Direction) %>%
  group_by(Direction) %>%
  count(L3)

```






