---
title: "Cameroon hunter-gatherer calculus/plaque HUMAnN2 species contributions"
author: "Irina Velsko"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output:
    github_document:
        fig_width: 8
        fig_height: 6
        toc: true
---


```{r load_libraries, echo = F, message = F}
library(knitr)
library(decontam)
library(data.table)
library(vegan)
library(ape)
library(mixOmics)
library(janitor)
library(rstatix)
library(pander)
library(tidyverse)
library(gplots)
library(ggrepel)
library(viridis)
library(cowplot)
opts_chunk$set(echo=F, warning=F, message=F, dpi=150)
```

Set the working directory of the notebook to the parent directory of the 
notebook itself.  

```{r setup}
knitr::opts_knit$set(root.dir = normalizePath(".."))
```

```{r load_data}
## load the species and genus tables generated with HUMAnN2
humann2_path <- fread("./05-results.backup/pathabundance_joined_cpm.tsv")
humann2_path <- as_tibble(humann2_path)
humann2_KOs_full <- fread("./05-results.backup/genefamilies_joined_cpm_ur90rxn.tsv.gz")
humann2_KOs_full <- as_tibble(humann2_KOs_full)

# clean the file names
humann2_KOs_full <- rename(humann2_KOs_full, Ortholog = `# Gene Family`)
colnames(humann2_KOs_full) <- gsub(".unmapped_Abundance-RPKs","", colnames(humann2_KOs_full))
colnames(humann2_KOs_full) <- gsub(".SG1","", colnames(humann2_KOs_full))

humann2_path <- rename(humann2_path, Pathway = `# Pathway`)
colnames(humann2_path) <- gsub(".unmapped_Abundance","", colnames(humann2_path))
colnames(humann2_path) <- gsub(".SG1","", colnames(humann2_path))

# remove unmapped and ungrouped reads
humann2_KOs <- humann2_KOs_full %>% filter(Ortholog != "UNMAPPED") %>% filter(!str_detect(Ortholog, "UNGROUPED"))


```


```{r pc_biplot_top10s}
# PC biplot loading top 10s
humann2_pathway_biplot_list <- fread("./05-results.backup/humann2_pathway_biplot_list.tsv") 
humann2_pathway_biplot_list <- humann2_pathway_biplot_list %>%
  rename(Pathway = pathway) %>%
  mutate(Path = sapply(Pathway, function(f) {
                                  unlist(str_split(f, ":"))[1]
                                  })) %>%
  select(Pathway, Path, everything())

# read in the list of orthologs that are the top 10 loading in PC1 and PC2, based on the MR1 orthologs
humann2_KO_biplot_list <- fread("./05-results.backup/humann2_KO_biplot_list.tsv") # file "./05-results.backup/humann2_KO_biplot_list_abund.tsv" has the KOs from the abundance cut-off table
humann2_KO_biplot_list <- humann2_KO_biplot_list %>%
  rename(Ortholog = Function)

```


## CMC and industrial samples PC-based
```{r path_pc1pws_cmc_indust}
# list the 10 orthologs with strongest loading in PC1 + values
humann2_path_biplot_pc <- humann2_pathway_biplot_list %>%
  filter(Direction == "PC1+", Samples == "Industrial+CMC") %>%
  pull(Path) %>%
  str_c(., collapse = "|") # need this format for filtering in the next step


# select only those 10 pathways from the list, and split the column with names into 3 (Pathway, Genus, Species)
humann2_path_pc1pws <- humann2_path %>%
  filter(str_detect(Pathway, humann2_path_biplot_pc)) %>%
  filter(str_detect(Pathway, "\\|")) %>%
  gather("SampleID", "CPM", 2:ncol(.)) %>%
  mutate(Pathway = str_replace_all(Pathway, "\\.s__", "|s__")) %>%
  separate(., Pathway, into = c("Pathway", "Genus", "Species"), sep = "\\|") %>%
  mutate(Species = replace_na(Species, "unclassified"),
         Genus = str_replace_all(Genus, "g__", ""),
         Species = str_replace_all(Species, "s__", "")) %>%
  inner_join(., humann2_pathway_biplot_list %>%
              select(Pathway, Path) %>%
               distinct(.), by = "Pathway") %>%
  inner_join(.,  humann2_pathway_biplot_list %>%
               filter(Direction == "PC1+", Samples == "Industrial+CMC") %>%
               select(Path), by = "Path") %>%
  select(-Pathway) %>%
  select(Path, everything()) %>%
  arrange(Path)

# calculate the % for each ortholog contributed by each genus         
humann2_path_pc1pws_stats <- humann2_path_pc1pws %>%
  group_by(Path, Genus) %>%
  summarize(Sum = sum(CPM)) %>%
  mutate(Percent = Sum/sum(Sum)*100) %>%
  ungroup(.)

# create the list of 10 orthologs again, but don't collapse the list as above
humann2_path_biplot_pc <- humann2_pathway_biplot_list %>%
  filter(Direction == "PC1+", Samples == "Industrial+CMC") %>%
  arrange(Path) %>%
  pull(Path)

# calculate the total % of all genera that contribute < X% to each ortholog
humann2_path_pc1pws_stats_extra <- lapply(humann2_path_biplot_pc, function(eclass) {
 high_percent <- humann2_path_pc1pws_stats %>%
   filter(Path == eclass) %>%
   filter(Percent < 5) %>%
   summarise(Remaining = sum(Percent)) %>%
   mutate(Path = eclass,
          Genus = "Other")
}) %>%
 bind_rows(.)

# add this additional % to the main table
humann2_path_pcbi_bar_df <- humann2_path_pc1pws_stats_extra %>%
  rename(Percent = Remaining) %>%
  bind_rows(., humann2_path_pc1pws_stats %>%
              select(-Sum)) %>% 
  select(Path, Genus, Percent) %>%
  mutate(Direction = "PC1+",
         Samples = "CMC+Industrial") %>%
  distinct()
  
# plot the values in a bar chart
humann2_path_pcbi_bar_df %>%
  # filter(Direction == "PC1+", Genus != "Other") %>% # removing Other plots all species/unassigned - no need to filter the pathways
  filter(Percent >= 5 | (Percent <= 5 & Genus == "Other")) %>% # filter out the genera with % < 5, but keep Other < 5
  # filter(Percent >= 5) %>% # filter out the genera with % < 5, but keep Other < 5
  mutate(Genus = fct_relevel(Genus, "Other","unclassified","Actinomyces","Campylobacter","Megasphaera","Porphyromonas","Prevotella","Selenomonas","Staphylococcus","Streptococcus","Veillonella"),
         Path = fct_relevel(Path, humann2_pathway_biplot_list %>%
                              filter(Direction == "PC1+", Samples == "Industrial+CMC") %>%
                              pull(Path))) %>%
  ggplot(., aes(x=Path, y=Percent, fill = Genus)) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    # scale_fill_manual(values = c("#440154FF","#39558CFF","#1F968BFF","#74D055FF",
    #                              "#07071DFF","#6B1D81FF","#D6456CFF","#FEB37BFF",
    #                              "#453781FF","#287D8EFF","#3CBC75FF","#DCE318FF",
    #                              "#FA815FFF","#FCFDBFFF","#bdbdbd")) +
    theme(text = element_text(size=18),
          axis.text.x = element_text(angle = 90, vjust = 0.5)) +
    ylab("Percent") +
    ggtitle("Metacyc pathways - CMC + Industrial, PC1 positive") +
    theme(title = element_text(size=10))


```

Carbohydrate processing by unidentifed taxa

```{r path_pc1neg_cmc_indust}
# list the 10 orthologs with strongest loading in PC1 + values
humann2_path_biplot_pc <- humann2_pathway_biplot_list %>%
  filter(Direction == "PC1-", Samples == "Industrial+CMC") %>%
  arrange(Path) %>%
  pull(Path) %>%
  str_c(., collapse = "|") # need this format for filtering in the next step

# select only those 10 orthologs from the list, and split the column with names into 3 (Ortholog, Genus, Species)
humann2_path_pc1neg <- humann2_path %>%
  filter(str_detect(Pathway, humann2_path_biplot_pc)) %>%
  filter(str_detect(Pathway, "\\|")) %>%
  gather("SampleID", "CPM", 2:ncol(.)) %>%
  mutate(Pathway = str_replace_all(Pathway, "\\.s__", "|s__")) %>%
  separate(., Pathway, into = c("Pathway", "Genus", "Species"), sep = "\\|") %>%
  mutate(Species = replace_na(Species, "unclassified"),
         Genus = str_replace_all(Genus, "g__", ""),
         Species = str_replace_all(Species, "s__", "")) %>%
  inner_join(., humann2_pathway_biplot_list %>%
              select(Pathway, Path) %>%
               distinct(.), by = "Pathway") %>%
  inner_join(.,  humann2_pathway_biplot_list %>%
               filter(Direction == "PC1-", Samples == "Industrial+CMC") %>%
               select(Path), by = "Path") %>%
  select(-Pathway) %>%
  select(Path, everything()) %>%
  arrange(Path)

# calculate the % for each ortholog contributed by each genus         
humann2_path_pc1neg_stats <- humann2_path_pc1neg %>%
  group_by(Path, Genus) %>%
  summarize(Sum = sum(CPM)) %>%
  mutate(Percent = Sum/sum(Sum)*100) %>%
  ungroup(.)

# create the list of 10 orthologs again, but don't collapse the list as above
humann2_path_biplot_pc <- humann2_pathway_biplot_list %>%
  filter(Direction == "PC1-", Samples == "Industrial+CMC") %>%
  arrange(Path) %>%
  pull(Path)

# calculate the total % of all genera that contribute < X% to each ortholog
humann2_path_pc1neg_stats_extra <- lapply(humann2_path_biplot_pc, function(eclass) {
 high_percent <- humann2_path_pc1neg_stats %>%
   filter(Path == eclass) %>%
   filter(Percent < 5) %>%
   summarise(Remaining = sum(Percent)) %>%
   mutate(Path = eclass,
          Genus = "Other")
}) %>%
 bind_rows(.)

# add this additional % to the main table
humann2_path_pcbi_bar_df <- humann2_path_pcbi_bar_df %>%
  bind_rows(humann2_path_pc1neg_stats_extra %>%
            rename(Percent = Remaining) %>%
            bind_rows(., humann2_path_pc1neg_stats %>%
                      select(-Sum)) %>% 
            select(Path, Genus, Percent) %>%
            mutate(Direction = "PC1-",
                   Samples = "CMC+Industrial")) %>%
  distinct()

# plot the values in a bar chart
humann2_path_pcbi_bar_df %>%
  filter(Direction == "PC1-") %>% # removing Other plots all species/unassigned - no need to filter the pathways
  filter(Percent >= 5 | (Percent <= 5 & Genus == "Other")) %>% # filter out the genera with % < 5, but keep Other < 5
  mutate(Genus = fct_relevel(Genus, "Other","unclassified","Aggregatibacter","Burkholderia","Campylobacter","Eikenella","Enterobacter","Haemophilus","Kingella","Neisseria","Ottowia","Ralstonia","Streptococcus"),
         Path = fct_relevel(Path, humann2_pathway_biplot_list %>%
                              filter(Direction == "PC1-", Samples == "Industrial+CMC") %>%
                              pull(Path))) %>%
  ggplot(., aes(x=Path, y=Percent, fill = Genus)) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    # scale_fill_manual(values = c("#440154FF","#39558CFF","#1F968BFF","#74D055FF",
    #                              "#07071DFF","#6B1D81FF","#D6456CFF","#FEB37BFF",
    #                              "#453781FF","#287D8EFF","#3CBC75FF","#DCE318FF",
    #                              "#FA815FFF","#FCFDBFFF","#bdbdbd")) +
    theme(text = element_text(size=18),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    # facet_wrap(~pathrtholog, nrow=2) +
    ylab("Percent") +
    ggtitle("Metacyc pathways - CMC + Industrial, PC1 negative") +
    theme(title = element_text(size=12))


```

redox reactions with HAECK organisms

```{r path_pc2pws_cmc_indust}
# list the 10 orthologs with strongest loading in PC1 + values
humann2_path_biplot_pc <- humann2_pathway_biplot_list %>%
  filter(Direction == "PC2+", Samples == "Industrial+CMC") %>%
  arrange(Path) %>%
  pull(Path) %>%
  str_c(., collapse = "|") # need this format for filtering in the next step

# select only those 10 orthologs from the list, and split the column with names into 3 (Ortholog, Genus, Species)
humann2_path_pc2pws <- humann2_path %>%
  filter(str_detect(Pathway, humann2_path_biplot_pc)) %>%
  filter(str_detect(Pathway, "\\|")) %>%
  gather("SampleID", "CPM", 2:ncol(.)) %>%
  mutate(Pathway = str_replace_all(Pathway, "\\.s__", "|s__")) %>%
  separate(., Pathway, into = c("Pathway", "Genus", "Species"), sep = "\\|") %>%
  mutate(Species = replace_na(Species, "unclassified"),
         Genus = str_replace_all(Genus, "g__", ""),
         Species = str_replace_all(Species, "s__", "")) %>%
  inner_join(., humann2_pathway_biplot_list %>%
              select(Pathway, Path) %>%
               distinct(.), by = "Pathway") %>%
  inner_join(.,  humann2_pathway_biplot_list %>%
               filter(Direction == "PC2+", Samples == "Industrial+CMC") %>%
               select(Path), by = "Path") %>%
  select(-Pathway) %>%
  select(Path, everything()) %>%
  arrange(Path)

# calculate the % for each ortholog contributed by each genus         
humann2_path_pc2pws_stats <- humann2_path_pc2pws %>%
  group_by(Path, Genus) %>%
  summarize(Sum = sum(CPM)) %>%
  mutate(Percent = Sum/sum(Sum)*100) %>%
  ungroup(.)

# create the list of 10 orthologs again, but don't collapse the list as above
humann2_path_biplot_pc <- humann2_pathway_biplot_list %>%
  filter(Direction == "PC2+", Samples == "Industrial+CMC") %>%
  arrange(Path) %>%
  pull(Path)

# calculate the total % of all genera that contribute < X% to each ortholog
humann2_path_pc2pws_stats_extra <- lapply(humann2_path_biplot_pc, function(eclass) {
 high_percent <- humann2_path_pc2pws_stats %>%
   filter(Path == eclass) %>%
   filter(Percent < 5) %>%
   summarise(Remaining = sum(Percent)) %>%
   mutate(Path = eclass,
          Genus = "Other")
}) %>%
 bind_rows(.)

# add this additional % to the main table
humann2_path_pcbi_bar_df <- humann2_path_pcbi_bar_df %>%
  bind_rows(humann2_path_pc2pws_stats_extra %>%
            rename(Percent = Remaining) %>%
            bind_rows(., humann2_path_pc2pws_stats %>%
                      select(-Sum)) %>% 
            select(Path, Genus, Percent) %>%
            mutate(Direction = "PC2+",
                   Samples = "CMC+Industrial")) %>%
  distinct()
 
# plot the values in a bar chart
# Most of these come from 'unclassified'
humann2_path_pcbi_bar_df %>%
  filter(Direction == "PC2+") %>%  # removing Other plots all species/unassigned - no need to filter the pathways
  filter(Percent >= 5 | (Percent <= 5 & Genus == "Other")) %>% # filter out the genera with % < 5, but keep Other < 5
  mutate(Genus = fct_relevel(Genus, "Other","unclassified","Desulfobulbus","Desulfomicrobium","Prevotella","Staphylococcus"),
         Path = fct_relevel(Path, humann2_pathway_biplot_list %>%
                              filter(Direction == "PC2+", Samples == "Industrial+CMC") %>%
                              pull(Path))) %>%
  ggplot(., aes(x=Path, y=Percent, fill = Genus)) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    # scale_fill_manual(values = c("#440154FF","#39558CFF","#1F968BFF","#74D055FF",
    #                              "#07071DFF","#6B1D81FF","#D6456CFF","#FEB37BFF",
    #                              "#453781FF","#287D8EFF","#3CBC75FF","#DCE318FF",
    #                              "#FA815FFF","#FCFDBFFF","#bdbdbd")) +
    theme(text = element_text(size=18),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1,)) +
    # facet_wrap(~pathrtholog, nrow=2) +
    ylab("Percent") +
    ggtitle("Metacyc pathways - CMC + Industrial, PC2+") +
    theme(title = element_text(size=12))


```

Redox reactions?

```{r path_pc2neg_cmc_indust}
# list the 10 orthologs with strongest loading in PC1 + values
humann2_path_biplot_pc <- humann2_pathway_biplot_list %>%
  filter(Direction == "PC2-", Samples == "Industrial+CMC") %>%
  arrange(Path) %>%
  pull(Path) %>%
  str_c(., collapse = "|") # need this format for filtering in the next step

# select only those 10 orthologs from the list, and split the column with names into 3 (Ortholog, Genus, Species)
humann2_path_pc2neg <- humann2_path %>%
  filter(str_detect(Pathway, humann2_path_biplot_pc)) %>%
  filter(str_detect(Pathway, "\\|")) %>%
  gather("SampleID", "CPM", 2:ncol(.)) %>%
  mutate(Pathway = str_replace_all(Pathway, "\\.s__", "|s__")) %>%
  separate(., Pathway, into = c("Pathway", "Genus", "Species"), sep = "\\|") %>%
  mutate(Species = replace_na(Species, "unclassified"),
         Genus = str_replace_all(Genus, "g__", ""),
         Species = str_replace_all(Species, "s__", "")) %>%
  inner_join(., humann2_pathway_biplot_list %>%
              select(Pathway, Path) %>%
               distinct(.), by = "Pathway") %>%
  inner_join(.,  humann2_pathway_biplot_list %>%
               filter(Direction == "PC2-", Samples == "Industrial+CMC") %>%
               select(Path), by = "Path") %>%
  select(-Pathway) %>%
  select(Path, everything()) %>%
  arrange(Path)

# calculate the % for each ortholog contributed by each genus         
humann2_path_pc2neg_stats <- humann2_path_pc2neg %>%
  group_by(Path, Genus) %>%
  summarize(Sum = sum(CPM)) %>%
  mutate(Percent = Sum/sum(Sum)*100) %>%
  ungroup(.)

# create the list of 10 orthologs again, but don't collapse the list as above
humann2_path_biplot_pc <- humann2_pathway_biplot_list %>%
  filter(Direction == "PC2-", Samples == "Industrial+CMC") %>%
  arrange(Path) %>%
  pull(Path)

# calculate the total % of all genera that contribute < X% to each ortholog
humann2_path_pc2neg_stats_extra <- lapply(humann2_path_biplot_pc, function(eclass) {
 high_percent <- humann2_path_pc2neg_stats %>%
   filter(Path == eclass) %>%
   filter(Percent < 5) %>%
   summarise(Remaining = sum(Percent)) %>%
   mutate(Path = eclass,
          Genus = "Other")
}) %>%
 bind_rows(.)

# add this additional % to the main table
humann2_path_pcbi_bar_df <- humann2_path_pcbi_bar_df %>%
  bind_rows(humann2_path_pc2neg_stats_extra %>%
            rename(Percent = Remaining) %>%
            bind_rows(., humann2_path_pc2neg_stats %>%
                      select(-Sum)) %>% 
            select(Path, Genus, Percent) %>%
            mutate(Direction = "PC2-",
                   Samples = "CMC+Industrial")) %>%
  distinct()

  
# plot the values in a bar chart
humann2_path_pcbi_bar_df %>%
  filter(Direction == "PC2-") %>% # removing Other plots all species/unassigned - no need to filter the pathways
  filter(Percent >= 5 | (Percent <= 5 & Genus == "Other")) %>% # filter out the genera with % < 5, but keep Other < 5
  mutate(Genus = fct_relevel(Genus, "Other","unclassified","Actinomyces","Corynebacterium","Enterobacter","Haemophilus","Neisseria","Streptococcus","Veillonella"),
         Path = fct_relevel(Path, humann2_pathway_biplot_list %>%
                              filter(Direction == "PC2-", Samples == "Industrial+CMC") %>%
                              pull(Path))) %>%
  ggplot(., aes(x=Path, y=Percent, fill = Genus)) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    # scale_fill_manual(values = c("#440154FF","#39558CFF","#1F968BFF","#74D055FF",
    #                              "#07071DFF","#6B1D81FF","#D6456CFF","#FEB37BFF",
    #                              "#453781FF","#287D8EFF","#3CBC75FF","#DCE318FF",
    #                              "#FA815FFF","#FCFDBFFF","#bdbdbd")) +
    theme(text = element_text(size=18),
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    # facet_wrap(~pathrtholog, nrow=2) +
    ylab("Percent") +
    ggtitle("Genus-level assignents to Metacyc pathways - CMC + Industrial, PC2 negative") +
    theme(title = element_text(size=12))


```

## CMC samples only
```{r path_pc1pws_cmc}
# list the 10 orthologs with strongest loading in PC1 + values
humann2_path_cmc_biplot_pc <- humann2_pathway_biplot_list %>%
  filter(Direction == "PC1+", Samples == "CMC") %>%
  arrange(Path) %>%
  pull(Path) %>%
  str_c(., collapse = "|") # need this format for filtering in the next step

# select only those 10 orthologs from the list, and split the column with names into 3 (Ortholog, Genus, Species)
humann2_path_cmc_pc1pws <- humann2_path %>%
  filter(str_detect(Pathway, humann2_path_cmc_biplot_pc)) %>%
  filter(str_detect(Pathway, "\\|")) %>%
  gather("SampleID", "CPM", 2:ncol(.)) %>%
  mutate(Pathway = str_replace_all(Pathway, "\\.s__", "|s__")) %>%
  separate(., Pathway, into = c("Pathway", "Genus", "Species"), sep = "\\|") %>%
  mutate(Species = replace_na(Species, "unclassified"),
         Genus = str_replace_all(Genus, "g__", ""),
         Species = str_replace_all(Species, "s__", "")) %>%
  inner_join(., humann2_pathway_biplot_list %>%
              select(Pathway, Path) %>%
               distinct(.), by = "Pathway") %>%
   inner_join(.,  humann2_pathway_biplot_list %>%
               filter(Direction == "PC1+", Samples == "CMC") %>%
               select(Path), by = "Path") %>%
 select(-Pathway) %>%
  select(Path, everything()) %>%
  arrange(Path)

# calculate the % for each ortholog contributed by each genus         
humann2_path_cmc_pc1pws_stats <- humann2_path_cmc_pc1pws %>%
  group_by(Path, Genus) %>%
  summarize(Sum = sum(CPM)) %>%
  mutate(Percent = Sum/sum(Sum)*100) %>%
  ungroup(.)

# create the list of 10 orthologs again, but don't collapse the list as above
humann2_path_cmc_biplot_pc <- humann2_pathway_biplot_list %>%
  filter(Direction == "PC1+", Samples == "CMC") %>%
  arrange(Path) %>%
  pull(Path)

# calculate the total % of all genera that contribute < X% to each ortholog
humann2_path_cmc_pc1pws_stats_extra <- lapply(humann2_path_cmc_biplot_pc, function(eclass) {
 high_percent <- humann2_path_cmc_pc1pws_stats %>%
   filter(Path == eclass) %>%
   filter(Percent < 5) %>%
   summarise(Remaining = sum(Percent)) %>%
   mutate(Path = eclass,
          Genus = "Other")
}) %>%
 bind_rows(.)

# add this additional % to the main table
humann2_path_cmc_pcbi_bar_df <- humann2_path_cmc_pc1pws_stats_extra %>%
  rename(Percent = Remaining) %>%
  bind_rows(., humann2_path_cmc_pc1pws_stats %>%
              select(-Sum)) %>% 
  select(Path, Genus, Percent) %>%
  mutate(Direction = "PC1+",
         Samples = "CMC")
  
# plot the values in a bar chart
# **Note** PWY-5941 and PWY-7209 have no species-level designations, and therefore are blank spaces instead of bars
humann2_path_cmc_pcbi_bar_df %>%
  filter(Direction == "PC1+") %>%
  filter(Percent >= 5 | (Percent <= 5 & Genus == "Other")) %>% # filter out the genera with % < 5, but keep Other < 5
  mutate(Genus = fct_relevel(Genus, "Other","unclassified","Actinomyces","Campylobacter","Centipeda","Selenomonas","Staphylococcus","Streptococcus","Veillonella"),
         Path = fct_relevel(Path, humann2_pathway_biplot_list %>%
                              filter(Direction == "PC1+", Samples == "CMC") %>%
                              pull(Path))) %>%
  ggplot(., aes(x=Path, y=Percent, fill = Genus)) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    # scale_fill_manual(values = c("#440154FF","#39558CFF","#1F968BFF","#74D055FF",
    #                              "#07071DFF","#6B1D81FF","#D6456CFF","#FEB37BFF",
    #                              "#453781FF","#287D8EFF","#3CBC75FF","#DCE318FF",
    #                              "#FA815FFF","#FCFDBFFF","#bdbdbd")) +
    theme(text = element_text(size=18),
          axis.text.x = element_text(angle = 90, hjust = 0.5)) +
    ylab("Percent") +
    ggtitle("Metacyc pathways - CMC only, PC1 positive") +
    theme(title = element_text(size=10))


```

```{r path_pc1neg_cmc}
# list the 10 orthologs with strongest loading in PC1 + values
humann2_path_cmc_biplot_pc <- humann2_pathway_biplot_list %>%
  filter(Direction == "PC1-", Samples == "CMC") %>%
  arrange(Path) %>%
  pull(Path) %>%
  str_c(., collapse = "|") # need this format for filtering in the next step

# select only those 10 orthologs from the list, and split the column with names into 3 (Ortholog, Genus, Species)
humann2_path_cmc_pc1neg <- humann2_path %>%
  filter(str_detect(Pathway, humann2_path_cmc_biplot_pc)) %>%
  filter(str_detect(Pathway, "\\|")) %>%
  gather("SampleID", "CPM", 2:ncol(.)) %>%
  mutate(Pathway = str_replace_all(Pathway, "\\.s__", "|s__")) %>%
  separate(., Pathway, into = c("Pathway", "Genus", "Species"), sep = "\\|") %>%
  mutate(Species = replace_na(Species, "unclassified"),
         Genus = str_replace_all(Genus, "g__", ""),
         Species = str_replace_all(Species, "s__", "")) %>%
  inner_join(., humann2_pathway_biplot_list %>%
              select(Pathway, Path) %>%
               distinct(.), by = "Pathway") %>%
  inner_join(.,  humann2_pathway_biplot_list %>%
               filter(Direction == "PC1-", Samples == "CMC") %>%
               select(Path), by = "Path") %>%
  select(-Pathway) %>%
  select(Path, everything()) %>%
  arrange(Path)

# calculate the % for each ortholog contributed by each genus         
humann2_path_cmc_pc1neg_stats <- humann2_path_cmc_pc1neg %>%
  group_by(Path, Genus) %>%
  summarize(Sum = sum(CPM)) %>%
  mutate(Percent = Sum/sum(Sum)*100) %>%
  ungroup(.)

# create the list of 10 orthologs again, but don't collapse the list as above
humann2_path_cmc_biplot_pc <- humann2_pathway_biplot_list %>%
  filter(Direction == "PC1-", Samples == "CMC") %>%
  arrange(Path) %>%
  pull(Path)

# calculate the total % of all genera that contribute < X% to each ortholog
humann2_path_cmc_pc1neg_stats_extra <- lapply(humann2_path_cmc_biplot_pc, function(eclass) {
 high_percent <- humann2_path_cmc_pc1neg_stats %>%
   filter(Path == eclass) %>%
   filter(Percent < 5) %>%
   summarise(Remaining = sum(Percent)) %>%
   mutate(Path = eclass,
          Genus = "Other")
}) %>%
 bind_rows(.)

# add this additional % to the main table
humann2_path_cmc_pcbi_bar_df <- humann2_path_cmc_pcbi_bar_df %>%
  bind_rows(humann2_path_cmc_pc1neg_stats_extra %>%
            rename(Percent = Remaining) %>%
            bind_rows(., humann2_path_cmc_pc1neg_stats %>%
                      select(-Sum)) %>% 
            select(Path, Genus, Percent) %>%
            mutate(Direction = "PC1-",
                   Samples = "CMC"))

# plot the values in a bar chart
humann2_path_cmc_pcbi_bar_df %>%
  filter(Direction == "PC1-") %>%
  filter(Percent >= 5 | (Percent <= 5 & Genus == "Other")) %>% # filter out the genera with % < 5, but keep Other < 5
  mutate(Genus = fct_relevel(Genus, "Other","unclassified","Aggregatibacter","Burkholderia","Campylobacter","Eikenella","Enterobacter","Haemophilus","Kingella","Neisseria","Ottowia","Ralstonia","Streptococcus"),
         Path = fct_relevel(Path, humann2_pathway_biplot_list %>%
                              filter(Direction == "PC1-", Samples == "CMC") %>%
                              pull(Path))) %>%
  ggplot(., aes(x=Path, y=Percent, fill = Genus)) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    # scale_fill_manual(values = c("#440154FF","#39558CFF","#1F968BFF","#74D055FF",
    #                              "#07071DFF","#6B1D81FF","#D6456CFF","#FEB37BFF",
    #                              "#453781FF","#287D8EFF","#3CBC75FF","#DCE318FF",
    #                              "#FA815FFF","#FCFDBFFF","#bdbdbd")) +
    theme(text = element_text(size=18),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    # facet_wrap(~pathrtholog, nrow=2) +
    ylab("Percent") +
    ggtitle("Metacyc pathways - CMC only, PC1 negative") +
    theme(title = element_text(size=10))


```

Redox reactions with ubiquinone synthesis in Neisseria

```{r path_pc2pws_cmc}
# list the 10 orthologs with strongest loading in PC1 + values
humann2_path_cmc_biplot_pc <- humann2_pathway_biplot_list %>%
  filter(Direction == "PC2+", Samples == "CMC") %>%
  arrange(Path) %>%
  pull(Path) %>%
  str_c(., collapse = "|") # need this format for filtering in the next step

# select only those 10 orthologs from the list, and split the column with names into 3 (Ortholog, Genus, Species)
humann2_path_cmc_pc2pws <- humann2_path %>%
  filter(str_detect(Pathway, humann2_path_cmc_biplot_pc)) %>%
  filter(str_detect(Pathway, "\\|")) %>%
  gather("SampleID", "CPM", 2:ncol(.)) %>%
  mutate(Pathway = str_replace_all(Pathway, "\\.s__", "|s__")) %>%
  separate(., Pathway, into = c("Pathway", "Genus", "Species"), sep = "\\|") %>%
  mutate(Species = replace_na(Species, "unclassified"),
         Genus = str_replace_all(Genus, "g__", ""),
         Species = str_replace_all(Species, "s__", "")) %>%
  inner_join(., humann2_pathway_biplot_list %>%
              select(Pathway, Path) %>%
               distinct(.), by = "Pathway") %>%
  inner_join(.,  humann2_pathway_biplot_list %>%
               filter(Direction == "PC2+", Samples == "CMC") %>%
               select(Path), by = "Path") %>%
  select(-Pathway) %>%
  select(Path, everything()) %>%
  arrange(Path)

# calculate the % for each ortholog contributed by each genus         
humann2_path_cmc_pc2pws_stats <- humann2_path_cmc_pc2pws %>%
  group_by(Path, Genus) %>%
  summarize(Sum = sum(CPM)) %>%
  mutate(Percent = Sum/sum(Sum)*100) %>%
  ungroup(.)

# create the list of 10 orthologs again, but don't collapse the list as above
humann2_path_cmc_biplot_pc <- humann2_pathway_biplot_list %>%
  filter(Direction == "PC2+", Samples == "CMC") %>%
  arrange(Path) %>%
  pull(Path)

# calculate the total % of all genera that contribute < X% to each ortholog
humann2_path_cmc_pc2pws_stats_extra <- lapply(humann2_path_cmc_biplot_pc, function(eclass) {
 high_percent <- humann2_path_cmc_pc2pws_stats %>%
   filter(Path == eclass) %>%
   filter(Percent < 5) %>%
   summarise(Remaining = sum(Percent)) %>%
   mutate(Path = eclass,
          Genus = "Other")
}) %>%
 bind_rows(.)

# add this additional % to the main table
humann2_path_cmc_pcbi_bar_df <- humann2_path_cmc_pcbi_bar_df %>%
  bind_rows(humann2_path_cmc_pc2pws_stats_extra %>%
            rename(Percent = Remaining) %>%
            bind_rows(., humann2_path_cmc_pc2pws_stats %>%
                      select(-Sum)) %>% 
            select(Path, Genus, Percent) %>%
            mutate(Direction = "PC2+",
                   Samples = "CMC")) %>%
  distinct()
 
# plot the values in a bar chart
# **Note** PWY-5941 and PWY-7209 have no species-level designations, and therefore are blank spaces instead of bars
humann2_path_cmc_pcbi_bar_df %>%
  filter(Direction == "PC2+") %>%
  filter(Percent >= 5 | (Percent <= 5 & Genus == "Other")) %>% # filter out the genera with % < 5, but keep Other < 5
  mutate(Genus = fct_relevel(Genus, "Other","unclassified","Actinomyces","Atopobium","Corynebacterium","Enterobacter","Haemophilus","Neisseria","Streptococcus"),
         Path = fct_relevel(Path, humann2_pathway_biplot_list %>%
                              filter(Direction == "PC2+", Samples == "CMC") %>%
                              pull(Path))) %>%
  ggplot(., aes(x=Path, y=Percent, fill = Genus)) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    # scale_fill_manual(values = c("#440154FF","#39558CFF","#1F968BFF","#74D055FF",
    #                              "#07071DFF","#6B1D81FF","#D6456CFF","#FEB37BFF",
    #                              "#453781FF","#287D8EFF","#3CBC75FF","#DCE318FF",
    #                              "#FA815FFF","#FCFDBFFF","#bdbdbd")) +
    theme(text = element_text(size=18),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    # facet_wrap(~pathrtholog, nrow=2) +
    ylab("Percent") +
    ggtitle("Metacyc pathways - CMC only, PC2 positive") +
    theme(title = element_text(size=10))


```

```{r path_pc2neg_cmc}
# list the 10 orthologs with strongest loading in PC1 + values
humann2_path_cmc_biplot_pc <- humann2_pathway_biplot_list %>%
  filter(Direction == "PC2-", Samples == "CMC") %>%
  arrange(Path) %>%
  pull(Path) %>%
  str_c(., collapse = "|") # need this format for filtering in the next step

# select only those 10 orthologs from the list, and split the column with names into 3 (Ortholog, Genus, Species)
humann2_path_cmc_pc2neg <- humann2_path %>%
  filter(str_detect(Pathway, humann2_path_cmc_biplot_pc)) %>%
  filter(str_detect(Pathway, "\\|")) %>%
  gather("SampleID", "CPM", 2:ncol(.)) %>%
  mutate(Pathway = str_replace_all(Pathway, "\\.s__", "|s__")) %>%
  separate(., Pathway, into = c("Pathway", "Genus", "Species"), sep = "\\|") %>%
  mutate(Species = replace_na(Species, "unclassified"),
         Genus = str_replace_all(Genus, "g__", ""),
         Species = str_replace_all(Species, "s__", "")) %>%
  inner_join(., humann2_pathway_biplot_list %>%
              select(Pathway, Path) %>%
               distinct(.), by = "Pathway") %>%
  inner_join(.,  humann2_pathway_biplot_list %>%
               filter(Direction == "PC2-", Samples == "CMC") %>%
               select(Path), by = "Path") %>%
  select(-Pathway) %>%
  select(Path, everything()) %>%
  arrange(Path)

# calculate the % for each ortholog contributed by each genus         
humann2_path_cmc_pc2neg_stats <- humann2_path_cmc_pc2neg %>%
  group_by(Path, Genus) %>%
  summarize(Sum = sum(CPM)) %>%
  mutate(Percent = Sum/sum(Sum)*100) %>%
  ungroup(.)

# create the list of 10 orthologs again, but don't collapse the list as above
humann2_path_cmc_biplot_pc <- humann2_pathway_biplot_list %>%
  filter(Direction == "PC2-", Samples == "CMC") %>%
  arrange(Path) %>%
  pull(Path)

# calculate the total % of all genera that contribute < X% to each ortholog
humann2_path_cmc_pc2neg_stats_extra <- lapply(humann2_path_cmc_biplot_pc, function(eclass) {
 high_percent <- humann2_path_cmc_pc2neg_stats %>%
   filter(Path == eclass) %>%
   filter(Percent < 5) %>%
   summarise(Remaining = sum(Percent)) %>%
   mutate(Path = eclass,
          Genus = "Other")
}) %>%
 bind_rows(.)

# add this additional % to the main table
humann2_path_cmc_pcbi_bar_df <- humann2_path_cmc_pcbi_bar_df %>%
  bind_rows(humann2_path_cmc_pc2neg_stats_extra %>%
            rename(Percent = Remaining) %>%
            bind_rows(., humann2_path_cmc_pc2neg_stats %>%
                      select(-Sum)) %>% 
            select(Path, Genus, Percent) %>%
            mutate(Direction = "PC2-",
                   Samples = "CMC"))

  
# plot the values in a bar chart
humann2_path_cmc_pcbi_bar_df %>%
  filter(Direction == "PC2-") %>%
  filter(Percent >= 5 | (Percent <= 5 & Genus == "Other")) %>% # filter out the genera with % < 5, but keep Other < 5
  mutate(Genus = fct_relevel(Genus, "Other","unclassified","Actinomyces","Aggregatibacter","Corynebacterium","Enterobacter","Haemophilus","Neisseria","Streptococcus","Veillonella"),
         Path = fct_relevel(Path, humann2_pathway_biplot_list %>%
                              filter(Direction == "PC2-", Samples == "CMC") %>%
                              pull(Path))) %>%
  ggplot(., aes(x=Path, y=Percent, fill = Genus)) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    # scale_fill_manual(values = c("#440154FF","#39558CFF","#1F968BFF","#74D055FF",
    #                              "#07071DFF","#6B1D81FF","#D6456CFF","#FEB37BFF",
    #                              "#453781FF","#287D8EFF","#3CBC75FF","#DCE318FF",
    #                              "#FA815FFF","#FCFDBFFF","#bdbdbd")) +
    theme(text = element_text(size=18),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    # facet_wrap(~pathrtholog, nrow=2) +
    ylab("Percent") +
    ggtitle("Metacyc pathways - CMC only, PC2 negative") +
    theme(title = element_text(size=10))


```


# Gene Families
## CMC and industrial samples
```{r KO_pc1pws_cmc_indust}
# list the 10 orthologs with strongest loading in PC1 + values
humann2_KO_biplot_pc <- humann2_KO_biplot_list %>%
  filter(Direction == "PC1+", Samples == "Industrial+CMC") %>%
  arrange(Ortholog) %>%
  pull(Ortholog) %>%
  str_c(., collapse = "|") # need this format for filtering in the next step

# select only those 10 orthologs from the list, and split the column with names into 3 (Ortholog, Genus, Species)
humann2_KOs_pc1pws <- humann2_KOs_full %>%
  filter(str_detect(Ortholog, humann2_KO_biplot_pc)) %>%
  filter(str_detect(Ortholog, "\\|")) %>%
  gather("SampleID", "CPM", 2:ncol(.)) %>%
  mutate(Ortholog = str_replace_all(Ortholog, "\\.s", "|s")) %>%
  separate(., Ortholog, into = c("Ortholog", "Genus", "Species"), sep = "\\|") %>%
  mutate(Species = replace_na(Species, "unclassified"),
         Genus = str_replace_all(Genus, "g__", ""),
         Species = str_replace_all(Species, "s__", "")) 
# %>%
#   inner_join(.,  humann2_KO_biplot_list %>%
#               filter(Direction == "PC1+", Samples == "Industrial+CMC") %>%
#                select(Ortholog), by = "Ortholog")


# calculate the % for each ortholog contributed by each genus         
humann2_KOs_pc1pws_stats <- humann2_KOs_pc1pws %>%
  group_by(Ortholog, Genus) %>%
  summarize(Sum = sum(CPM)) %>%
  mutate(Percent = Sum/sum(Sum)*100) %>%
  ungroup(.)

# create the list of 10 orthologs again, but don't collapse the list as above
humann2_KO_biplot_pc <- humann2_KO_biplot_list %>%
  filter(Direction == "PC1+", Samples == "Industrial+CMC") %>%
  arrange(Ortholog) %>%
  pull(Ortholog)

# calculate the total % of all genera that contribute < X% to each ortholog
humann2_KOs_pc1pws_stats_extra <- lapply(humann2_KO_biplot_pc, function(eclass) {
 high_percent <- humann2_KOs_pc1pws_stats %>%
   # group_by(Host_Genus) %>%
   filter(Ortholog == eclass) %>%
   filter(Percent < 5) %>%
   summarise(Remaining = sum(Percent)) %>%
   mutate(Ortholog = eclass,
          Genus = "Other")
}) %>%
 bind_rows(.)

# add this additional % to the main table
humann2_KOs_pcbi_bar_df <- humann2_KOs_pc1pws_stats_extra %>%
  rename(Percent = Remaining) %>%
  bind_rows(., humann2_KOs_pc1pws_stats %>%
              select(-Sum)) %>% 
  select(Ortholog, Genus, Percent) %>%
  mutate(Direction = "PC1+",
         Samples = "CMC+Industrial")
  
# plot the values in a bar chart
humann2_KOs_pcbi_bar_df %>%
  filter(Percent >= 5 | (Percent <= 5 & Genus == "Other")) %>% # filter out the genera with % < 5, but keep Other < 5
  mutate(Genus = fct_relevel(Genus, "Other","unclassified","Actinomyces","Anaeroglobus","Corynebacterium","Johnsonella","Lachnoanaerobaculum","Lachnospiraceae_unclassified","Megasphaera","Mogibacterium","Oribacterium","Prevotella","Pseudomonas","Rothia"),
         Ortholog = fct_relevel(Ortholog, humann2_KO_biplot_list %>%
                              filter(Direction == "PC1+", Samples == "Industrial+CMC") %>%
                              pull(Ortholog))) %>%
  ggplot(., aes(x=Ortholog, y=Percent, fill = Genus)) +
    geom_bar(stat = "identity") +
    theme_minimal(base_size = 10) +
    # scale_fill_manual(values = c("#440154FF","#39558CFF","#1F968BFF","#74D055FF",
    #                              "#07071DFF","#6B1D81FF","#D6456CFF","#FEB37BFF",
    #                              "#453781FF","#287D8EFF","#3CBC75FF","#DCE318FF",
    #                              "#FA815FFF","#FCFDBFFF","#bdbdbd")) +
    theme(text = element_text(size=18),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    # facet_wrap(~KOrtholog, nrow=2) +
    ylab("Percent") +
    xlab("") +
    ggtitle("Gene Families, PC1 positive") +
    theme(title = element_text(size=12))


```

Corynebacterium dominates the genes that define the PC1+-plotting samples
(mostly CMC, more posterior than anterior, and not industrial plaque +
industrial calculus). The CMC sampls also have very high proportions of C.
matruchotii.

```{r pc1neg_cmc_indust}
# list the 10 orthologs with strongest loading in PC1 + values
humann2_KO_biplot_pc <- humann2_KO_biplot_list %>%
  filter(Direction == "PC1-", Samples == "Industrial+CMC") %>%
  arrange(Ortholog) %>%
  pull(Ortholog) %>%
  str_c(., collapse = "|") # need this format for filtering in the next step

# select only those 10 orthologs from the list, and split the column with names into 3 (Ortholog, Genus, Species)
humann2_KOs_pc1neg <- humann2_KOs_full %>%
  filter(str_detect(Ortholog, humann2_KO_biplot_pc)) %>%
  filter(str_detect(Ortholog, "\\|")) %>%
  gather("SampleID", "CPM", 2:ncol(.)) %>%
  mutate(Ortholog = str_replace_all(Ortholog, "\\.s", "|s")) %>%
  separate(., Ortholog, into = c("Ortholog", "Genus", "Species"), sep = "\\|") %>%
  mutate(Species = replace_na(Species, "unclassified"),
         Genus = str_replace_all(Genus, "g__", ""),
         Species = str_replace_all(Species, "s__", ""))

# calculate the % for each ortholog contributed by each genus         
humann2_KOs_pc1neg_stats <- humann2_KOs_pc1neg %>%
  group_by(Ortholog, Genus) %>%
  summarize(Sum = sum(CPM)) %>%
  mutate(Percent = Sum/sum(Sum)*100) %>%
  ungroup(.)

# create the list of 10 orthologs again, but don't collapse the list as above
humann2_KO_biplot_pc <- humann2_KO_biplot_list %>%
  filter(Direction == "PC1-", Samples == "Industrial+CMC") %>%
  arrange(Ortholog) %>%
  pull(Ortholog)

# calculate the total % of all genera that contribute < X% to each ortholog
humann2_KOs_pc1neg_stats_extra <- lapply(humann2_KO_biplot_pc, function(eclass) {
 high_percent <- humann2_KOs_pc1neg_stats %>%
   # group_by(Host_Genus) %>%
   filter(Ortholog == eclass) %>%
   filter(Percent < 5) %>%
   summarise(Remaining = sum(Percent)) %>%
   mutate(Ortholog = eclass,
          Genus = "Other")
}) %>%
 bind_rows(.)

# add this additional % to the main table
humann2_KOs_pcbi_bar_df <- humann2_KOs_pcbi_bar_df %>%
  bind_rows(., humann2_KOs_pc1neg_stats_extra %>%
            rename(Percent = Remaining) %>%
            bind_rows(., humann2_KOs_pc1neg_stats %>%
              select(-Sum) %>% 
              filter(Percent >= 5)) %>%
            select(Ortholog, Genus, Percent) %>%
            mutate(Direction = "PC1-",
                   Samples = "CMC+Industrial")) %>%
  arrange(Direction, Ortholog)

# plot the values in a bar chart
humann2_KOs_pcbi_bar_df %>%
  filter(Direction == "PC1-") %>%
  filter(Percent >= 5 | (Percent <= 5 & Genus == "Other")) %>% # filter out the genera with % < 5, but keep Other < 5
  mutate(Genus = fct_relevel(Genus, "Other","unclassified","Aggregatibacter","Cardiobacterium","Eikenella","Haemophilus","Kingella","Lautropia","Neisseria","Ottowia","Prevotella","Streptococcus"),
         Ortholog = fct_relevel(Ortholog, humann2_KO_biplot_list %>%
                              filter(Direction == "PC1-", Samples == "Industrial+CMC") %>%
                              pull(Ortholog))) %>%
  ggplot(., aes(x=Ortholog, y=Percent, fill = Genus)) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    # scale_fill_manual(values = c("#440154FF","#39558CFF","#1F968BFF","#74D055FF",
    #                              "#07071DFF","#6B1D81FF","#D6456CFF","#FEB37BFF",
    #                              "#453781FF","#287D8EFF","#3CBC75FF","#DCE318FF",
    #                              "#FA815FFF","#FCFDBFFF","#bdbdbd")) +
    theme(text = element_text(size=18),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    # facet_wrap(~KOrtholog, nrow=2) +
    ylab("Percent") +
    ggtitle("Gene Families, PC1 negative") +
    theme(title = element_text(size=12))
  
```

HAECK organisms, redox reactions with ubiquinol and sulfite reduction

```{r pc2pws_cmc_indust}
# list the 10 orthologs with strongest loading in pc2 + values
humann2_KO_biplot_pc <- humann2_KO_biplot_list %>%
  filter(Direction == "PC2+", Samples == "Industrial+CMC") %>%
  arrange(Ortholog) %>%
  pull(Ortholog) %>%
  str_c(., collapse = "|") # need this format for filtering in the next step

# select only those 10 orthologs from the list, and split the column with names into 3 (Ortholog, Genus, Species)
humann2_KOs_pc2pws <- humann2_KOs_full %>%
  filter(str_detect(Ortholog, humann2_KO_biplot_pc)) %>%
  filter(str_detect(Ortholog, "\\|")) %>%
  gather("SampleID", "CPM", 2:ncol(.)) %>%
  mutate(Ortholog = str_replace_all(Ortholog, "\\.s", "|s")) %>%
  separate(., Ortholog, into = c("Ortholog", "Genus", "Species"), sep = "\\|") %>%
  mutate(Species = replace_na(Species, "unclassified"),
         Genus = str_replace_all(Genus, "g__", ""),
         Species = str_replace_all(Species, "s__", ""))

# calculate the % for each ortholog contributed by each genus         
humann2_KOs_pc2pws_stats <- humann2_KOs_pc2pws %>%
  group_by(Ortholog, Genus) %>%
  summarize(Sum = sum(CPM)) %>%
  mutate(Percent = Sum/sum(Sum)*100) %>%
  ungroup(.)

# create the list of 10 orthologs again, but don't collapse the list as above
humann2_KO_biplot_pc <- humann2_KO_biplot_list %>%
  filter(Direction == "PC2+", Samples == "Industrial+CMC") %>%
  arrange(Ortholog) %>%
  pull(Ortholog)

# calculate the total % of all genera that contribute < X% to each ortholog
humann2_KOs_pc2pws_stats_extra <- lapply(humann2_KO_biplot_pc, function(eclass) {
 high_percent <- humann2_KOs_pc2pws_stats %>%
   # group_by(Host_Genus) %>%
   filter(Ortholog == eclass) %>%
   filter(Percent < 5) %>%
   summarise(Remaining = sum(Percent)) %>%
   mutate(Ortholog = eclass,
          Genus = "Other")
}) %>%
 bind_rows(.)

# add this additional % to the main table
humann2_KOs_pcbi_bar_df <- humann2_KOs_pcbi_bar_df %>%
  bind_rows(., humann2_KOs_pc2pws_stats_extra %>%
            rename(Percent = Remaining) %>%
            bind_rows(., humann2_KOs_pc2pws_stats %>%
              select(-Sum) %>% 
              filter(Percent >= 5)) %>%
            select(Ortholog, Genus, Percent) %>%
            mutate(Direction = "PC2+",
                   Samples = "CMC+Industrial")) %>%
  arrange(Direction, Ortholog)

# plot the values in a bar chart
humann2_KOs_pcbi_bar_df %>%
  filter(Direction == "PC2+") %>%
  filter(Percent >= 5 | (Percent <= 5 & Genus == "Other")) %>% # filter out the genera with % < 5, but keep Other < 5
  mutate(Genus = fct_relevel(Genus, "Other","Corynebacterium","Propionibacterium","Pseudopropionibacterium"),
         Ortholog = fct_relevel(Ortholog, humann2_KO_biplot_list %>%
                              filter(Direction == "PC2+", Samples == "Industrial+CMC") %>%
                              pull(Ortholog))) %>%
  ggplot(., aes(x=Ortholog, y=Percent, fill = Genus)) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    # scale_fill_manual(values = c("#440154FF","#39558CFF","#1F968BFF","#74D055FF",
    #                              "#07071DFF","#6B1D81FF","#D6456CFF","#FEB37BFF",
    #                              "#453781FF","#287D8EFF","#3CBC75FF","#DCE318FF",
    #                              "#FA815FFF","#FCFDBFFF","#bdbdbd")) +
    theme(text = element_text(size=18),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    # facet_wrap(~KOrtholog, nrow=2) +
    ylab("Percent") +
    ggtitle("Gene Families, PC2 positive") +
    theme(title = element_text(size=12))
  
```

Mycolic acid production in Corynebacterium

```{r pc2neg_cmc_indust}
# list the 10 orthologs with strongest loading in PC1 + values
humann2_KO_biplot_pc <- humann2_KO_biplot_list %>%
  filter(Direction == "PC2-", Samples == "Industrial+CMC") %>%
  arrange(Ortholog) %>%
  pull(Ortholog) %>%
  str_c(., collapse = "|") # need this format for filtering in the next step

# select only those 10 orthologs from the list, and split the column with names into 3 (Ortholog, Genus, Species)
humann2_KOs_pc2neg <- humann2_KOs_full %>%
  filter(str_detect(Ortholog, humann2_KO_biplot_pc)) %>%
  filter(str_detect(Ortholog, "\\|")) %>%
  gather("SampleID", "CPM", 2:ncol(.)) %>%
  mutate(Ortholog = str_replace_all(Ortholog, "\\.s", "|s")) %>%
  separate(., Ortholog, into = c("Ortholog", "Genus", "Species"), sep = "\\|") %>%
  mutate(Species = replace_na(Species, "unclassified"),
         Genus = str_replace_all(Genus, "g__", ""),
         Species = str_replace_all(Species, "s__", ""))

# calculate the % for each ortholog contributed by each genus         
humann2_KOs_pc2neg_stats <- humann2_KOs_pc2neg %>%
  group_by(Ortholog, Genus) %>%
  summarize(Sum = sum(CPM)) %>%
  mutate(Percent = Sum/sum(Sum)*100) %>%
  ungroup(.)

# create the list of 10 orthologs again, but don't collapse the list as above
humann2_KO_biplot_pc <- humann2_KO_biplot_list %>%
  filter(Direction == "PC2-", Samples == "Industrial+CMC") %>%
  arrange(Ortholog) %>%
  pull(Ortholog)

# calculate the total % of all genera that contribute < X% to each ortholog
humann2_KOs_pc2neg_stats_extra <- lapply(humann2_KO_biplot_pc, function(eclass) {
 high_percent <- humann2_KOs_pc2neg_stats %>%
   # group_by(Host_Genus) %>%
   filter(Ortholog == eclass) %>%
   filter(Percent < 5) %>%
   summarise(Remaining = sum(Percent)) %>%
   mutate(Ortholog = eclass,
          Genus = "Other")
}) %>%
 bind_rows(.)

# add this additional % to the main table
humann2_KOs_pcbi_bar_df <- humann2_KOs_pcbi_bar_df %>%
  bind_rows(., humann2_KOs_pc2neg_stats_extra %>%
            rename(Percent = Remaining) %>%
            bind_rows(., humann2_KOs_pc2neg_stats %>%
              select(-Sum) %>% 
              filter(Percent >= 5)) %>%
            select(Ortholog, Genus, Percent) %>%
            mutate(Direction = "PC2-",
                   Samples = "CMC+Industrial")) %>%
  arrange(Direction, Ortholog) %>%
  distinct()
 
# plot the values in a bar chart
humann2_KOs_pcbi_bar_df %>%
  filter(Direction == "PC2-") %>%
  filter(Percent >= 5 | (Percent <= 5 & Genus == "Other")) %>% # filter out the genera with % < 5, but keep Other < 5
  mutate(Genus = fct_relevel(Genus, "Other","unclassified","Actinomyces","Aggregatibacter","Fusobacterium","Haemophilus","Lachnospiraceae_unclassified","Porphyromonas","Prevotella","Selenomonas","Streptococcus","Treponema","Veillonella"),
         Ortholog = fct_relevel(Ortholog, humann2_KO_biplot_list %>%
                              filter(Direction == "PC2-", Samples == "Industrial+CMC") %>%
                              pull(Ortholog))) %>%
  ggplot(., aes(x=Ortholog, y=Percent, fill = Genus)) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    # scale_fill_manual(values = c("#440154FF","#39558CFF","#1F968BFF","#74D055FF",
    #                              "#07071DFF","#6B1D81FF","#D6456CFF","#FEB37BFF",
    #                              "#453781FF","#287D8EFF","#3CBC75FF","#DCE318FF",
    #                              "#FA815FFF","#FCFDBFFF","#bdbdbd")) +
    theme(text = element_text(size=18),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    # facet_wrap(~KOrtholog, nrow=2) +
    ylab("Percent") +
    ggtitle("Gene Families, PC2 negative") +
    theme(title = element_text(size=12))
  
```

```{r cmc_industrial_ortholog_genera, eval = F}
# this won't work b/c there are different orthologs in each direction, and facet wrap puts all together on the x-axis
humann2_KOs_pcbi_bar_df %>%
  filter(Percent >= 5 | (Percent <= 5 & Genus == "Other")) %>% # filter out the genera with % < 5, but keep Other < 5
  # mutate(Genus = fct_relevel(Genus, "Other","unclassified","Aggregatibacter","Capnocytophaga","Fusobacterium","Haemophilus","Leptotrichia","Neisseria","Prevotella","Propionibacterium","Rothia","Streptococcus","Veillonella")) %>%
  ggplot(., aes(x=Ortholog, y=Percent, fill = Genus)) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    # scale_fill_manual(values = c("#440154FF","#39558CFF","#1F968BFF","#74D055FF",
    #                              "#07071DFF","#6B1D81FF","#D6456CFF","#FEB37BFF",
    #                              "#453781FF","#287D8EFF","#3CBC75FF","#DCE318FF",
    #                              "#FA815FFF","#FCFDBFFF","#bdbdbd")) +
    theme(text = element_text(size=18),
          axis.text.x = element_text(angle = 90, hjust = 0.5)) +
    facet_wrap(~Direction, nrow=2) +
    ylab("Percent") +
    ggtitle("Genus-level assignents to KEGG Orthologs, PC2 negative") +
    theme(title = element_text(size=10))


```

# Gene Families
## CMC samples only
```{r pc1pws_cmc}
# list the 10 orthologs with strongest loading in PC1 + values
humann2_KO_biplot_pc <- humann2_KO_biplot_list %>%
  filter(Direction == "PC1+", Samples == "CMC") %>%
  arrange(Ortholog) %>%
  pull(Ortholog) %>%
  str_c(., collapse = "|") # need this format for filtering in the next step

# select only those 10 orthologs from the list, and split the column with names into 3 (Ortholog, Genus, Species)
humann2_KOs_pc1pws <- humann2_KOs_full %>%
  filter(str_detect(Ortholog, humann2_KO_biplot_pc)) %>%
  filter(str_detect(Ortholog, "\\|")) %>%
  gather("SampleID", "CPM", 2:ncol(.)) %>%
  mutate(Ortholog = str_replace_all(Ortholog, "\\.s", "|s")) %>%
  separate(., Ortholog, into = c("Ortholog", "Genus", "Species"), sep = "\\|") %>%
  mutate(Species = replace_na(Species, "unclassified"),
         Genus = str_replace_all(Genus, "g__", ""),
         Species = str_replace_all(Species, "s__", ""))

# calculate the % for each ortholog contributed by each genus         
humann2_KOs_pc1pws_stats <- humann2_KOs_pc1pws %>%
  group_by(Ortholog, Genus) %>%
  summarize(Sum = sum(CPM)) %>%
  mutate(Percent = Sum/sum(Sum)*100) %>%
  ungroup(.)

# create the list of 10 orthologs again, but don't collapse the list as above
humann2_KO_biplot_pc <- humann2_KO_biplot_list %>%
  filter(Direction == "PC1+", Samples == "CMC") %>%
  arrange(Ortholog) %>%
  pull(Ortholog)

# calculate the total % of all genera that contribute < X% to each ortholog
humann2_KOs_pc1pws_stats_extra <- lapply(humann2_KO_biplot_pc, function(eclass) {
 high_percent <- humann2_KOs_pc1pws_stats %>%
   # group_by(Host_Genus) %>%
   filter(Ortholog == eclass) %>%
   filter(Percent < 5) %>%
   summarise(Remaining = sum(Percent)) %>%
   mutate(Ortholog = eclass,
          Genus = "Other")
}) %>%
 bind_rows(.)

# add this additional % to the main table
humann2_KOs_pcbi_bar_df <- humann2_KOs_pcbi_bar_df %>%
  bind_rows(., humann2_KOs_pc1pws_stats_extra %>%
            rename(Percent = Remaining) %>%
            bind_rows(., humann2_KOs_pc1pws_stats %>%
              select(-Sum) %>% 
              filter(Percent >= 5)) %>%
            select(Ortholog, Genus, Percent) %>%
            mutate(Direction = "PC1+",
                   Samples = "CMC")) %>%
  arrange(Direction, Ortholog)

  
# plot the values in a bar chart
humann2_KOs_pcbi_bar_df %>%
  filter(Samples == "CMC", Direction == "PC1+") %>%
  filter(Percent >= 5 | (Percent <= 5 & Genus == "Other")) %>% # filter out the genera with % < 5, but keep Other < 5
  mutate(Genus = fct_relevel(Genus, "Other","unclassified","Actinomyces","Corynebacterium","Lachnospiraceae_unclassified","Prevotella","Propionibacterium","Ralstonia","Selenomonas","Streptococcus","Treponema","Veillonella"),
         Ortholog = fct_relevel(Ortholog, humann2_KO_biplot_list %>%
                              filter(Direction == "PC1+", Samples == "CMC") %>%
                              pull(Ortholog))) %>%
  ggplot(., aes(x=Ortholog, y=Percent, fill = Genus)) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    # scale_fill_manual(values = c("#440154FF","#39558CFF","#1F968BFF","#74D055FF",
    #                              "#07071DFF","#6B1D81FF","#D6456CFF","#FEB37BFF",
    #                              "#453781FF","#287D8EFF","#3CBC75FF","#DCE318FF",
    #                              "#FA815FFF","#FCFDBFFF","#bdbdbd")) +
    theme(text = element_text(size=18),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    ylab("Percent") +
    ggtitle("Gene Families - CMC only, PC1 positive") +
    theme(title = element_text(size=10))


```

Nothing stands out. Mannose transportation in PC1 Selenomonas/Streptococcus

```{r pc1neg_cmc}
# list the 10 orthologs with strongest loading in PC1 + values
humann2_KO_biplot_pc <- humann2_KO_biplot_list %>%
  filter(Direction == "PC1-", Samples == "CMC") %>%
  arrange(Ortholog) %>%
  pull(Ortholog) %>%
  str_c(., collapse = "|") # need this format for filtering in the next step

# select only those 10 orthologs from the list, and split the column with names into 3 (Ortholog, Genus, Species)
humann2_KOs_pc1neg <- humann2_KOs_full %>%
  filter(str_detect(Ortholog, humann2_KO_biplot_pc)) %>%
  filter(str_detect(Ortholog, "\\|")) %>%
  gather("SampleID", "CPM", 2:ncol(.)) %>%
  mutate(Ortholog = str_replace_all(Ortholog, "\\.s", "|s")) %>%
  separate(., Ortholog, into = c("Ortholog", "Genus", "Species"), sep = "\\|") %>%
  mutate(Species = replace_na(Species, "unclassified"),
         Genus = str_replace_all(Genus, "g__", ""),
         Species = str_replace_all(Species, "s__", ""))

# calculate the % for each ortholog contributed by each genus         
humann2_KOs_pc1neg_stats <- humann2_KOs_pc1neg %>%
  group_by(Ortholog, Genus) %>%
  summarize(Sum = sum(CPM)) %>%
  mutate(Percent = Sum/sum(Sum)*100) %>%
  ungroup(.)

# create the list of 10 orthologs again, but don't collapse the list as above
humann2_KO_biplot_pc <- humann2_KO_biplot_list %>%
  filter(Direction == "PC1-", Samples == "CMC") %>%
  arrange(Ortholog) %>%
  pull(Ortholog)

# calculate the total % of all genera that contribute < X% to each ortholog
humann2_KOs_pc1neg_stats_extra <- lapply(humann2_KO_biplot_pc, function(eclass) {
 high_percent <- humann2_KOs_pc1neg_stats %>%
   filter(Ortholog == eclass) %>%
   filter(Percent < 5) %>%
   summarise(Remaining = sum(Percent)) %>%
   mutate(Ortholog = eclass,
          Genus = "Other")
}) %>%
 bind_rows(.)

# add this additional % to the main table
humann2_KOs_pcbi_bar_df <- humann2_KOs_pcbi_bar_df %>%
  bind_rows(., humann2_KOs_pc1neg_stats_extra %>%
            rename(Percent = Remaining) %>%
            bind_rows(., humann2_KOs_pc1neg_stats %>%
              select(-Sum) %>% 
              filter(Percent >= 5)) %>%
            select(Ortholog, Genus, Percent) %>%
            mutate(Direction = "PC1-",
                   Samples = "CMC")) %>%
  arrange(Direction, Ortholog)

# plot the values in a bar chart
humann2_KOs_pcbi_bar_df %>%
  filter(Samples == "CMC", Direction == "PC1-") %>%
  filter(Percent >= 5 | (Percent <= 5 & Genus == "Other")) %>% # filter out the genera with % < 5, but keep Other < 5
  mutate(Genus = fct_relevel(Genus, "Other","unclassified","Aggregatibacter","Cardiobacterium","Haemophilus","Lautropia","Neisseria","Ottowia","Streptococcus"),
         Ortholog = fct_relevel(Ortholog, humann2_KO_biplot_list %>%
                              filter(Direction == "PC1-", Samples == "CMC") %>%
                              pull(Ortholog))) %>%
  ggplot(., aes(x=Ortholog, y=Percent, fill = Genus)) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    # scale_fill_manual(values = c("#440154FF","#39558CFF","#1F968BFF","#74D055FF",
    #                              "#07071DFF","#6B1D81FF","#D6456CFF","#FEB37BFF",
    #                              "#453781FF","#287D8EFF","#3CBC75FF","#DCE318FF",
    #                              "#FA815FFF","#FCFDBFFF","#bdbdbd")) +
    theme(text = element_text(size=18),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    ylab("Percent") +
    ggtitle("Gene Families - CMC only, PC1 negative") +
    theme(title = element_text(size=12))
  
```

HAECK organisms, redox reactions with ubiquinol and sulfite reduction

```{r pc2pws_cmc}
# list the 10 orthologs with strongest loading in pc2 + values
humann2_KO_biplot_pc <- humann2_KO_biplot_list %>%
  filter(Direction == "PC2+", Samples == "CMC") %>%
  arrange(Ortholog) %>%
  pull(Ortholog) %>%
  str_c(., collapse = "|") # need this format for filtering in the next step

# select only those 10 orthologs from the list, and split the column with names into 3 (Ortholog, Genus, Species)
humann2_KOs_pc2pws <- humann2_KOs_full %>%
  filter(str_detect(Ortholog, humann2_KO_biplot_pc)) %>%
  filter(str_detect(Ortholog, "\\|")) %>%
  gather("SampleID", "CPM", 2:ncol(.)) %>%
  mutate(Ortholog = str_replace_all(Ortholog, "\\.s", "|s")) %>%
  separate(., Ortholog, into = c("Ortholog", "Genus", "Species"), sep = "\\|") %>%
  mutate(Species = replace_na(Species, "unclassified"),
         Genus = str_replace_all(Genus, "g__", ""),
         Species = str_replace_all(Species, "s__", ""))

# calculate the % for each ortholog contributed by each genus         
humann2_KOs_pc2pws_stats <- humann2_KOs_pc2pws %>%
  group_by(Ortholog, Genus) %>%
  summarize(Sum = sum(CPM)) %>%
  mutate(Percent = Sum/sum(Sum)*100) %>%
  ungroup(.)

# create the list of 10 orthologs again, but don't collapse the list as above
humann2_KO_biplot_pc <- humann2_KO_biplot_list %>%
  filter(Direction == "PC2+", Samples == "CMC") %>%
  arrange(Ortholog) %>%
  pull(Ortholog)

# calculate the total % of all genera that contribute < X% to each ortholog
humann2_KOs_pc2pws_stats_extra <- lapply(humann2_KO_biplot_pc, function(eclass) {
 high_percent <- humann2_KOs_pc2pws_stats %>%
   filter(Ortholog == eclass) %>%
   filter(Percent < 5) %>%
   summarise(Remaining = sum(Percent)) %>%
   mutate(Ortholog = eclass,
          Genus = "Other")
}) %>%
 bind_rows(.)

# add this additional % to the main table
humann2_KOs_pcbi_bar_df <- humann2_KOs_pcbi_bar_df %>%
  bind_rows(., humann2_KOs_pc2pws_stats_extra %>%
            rename(Percent = Remaining) %>%
            bind_rows(., humann2_KOs_pc2pws_stats %>%
              select(-Sum) %>% 
              filter(Percent >= 5)) %>%
            select(Ortholog, Genus, Percent) %>%
            mutate(Direction = "PC2+",
                   Samples = "CMC")) %>%
  arrange(Direction, Ortholog)

# plot the values in a bar chart
humann2_KOs_pcbi_bar_df %>%
  filter(Samples == "CMC", Direction == "PC2+") %>%
  filter(Percent >= 5 | (Percent <= 5 & Genus == "Other")) %>% # filter out the genera with % < 5, but keep Other < 5
  mutate(Genus = fct_relevel(Genus, "Other","Corynebacterium","Propionibacterium"),
         Ortholog = fct_relevel(Ortholog, humann2_KO_biplot_list %>%
                              filter(Direction == "PC2+", Samples == "CMC") %>%
                              pull(Ortholog))) %>%
  ggplot(., aes(x=Ortholog, y=Percent, fill = Genus)) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    # scale_fill_manual(values = c("#440154FF","#39558CFF","#1F968BFF","#74D055FF",
    #                              "#07071DFF","#6B1D81FF","#D6456CFF","#FEB37BFF",
    #                              "#453781FF","#287D8EFF","#3CBC75FF","#DCE318FF",
    #                              "#FA815FFF","#FCFDBFFF","#bdbdbd")) +
    theme(text = element_text(size=18),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    ylab("Percent") +
    ggtitle("Gene Families - CMC only, PC2 positive") +
    theme(title = element_text(size=12))
  
```

Mycolic acid production in Corynebacterium

```{r pc2neg_cmc}
# list the 10 orthologs with strongest loading in PC1 + values
humann2_KO_biplot_pc <- humann2_KO_biplot_list %>%
  filter(Direction == "PC2-", Samples == "CMC") %>%
  arrange(Ortholog) %>%
  pull(Ortholog) %>%
  str_c(., collapse = "|") # need this format for filtering in the next step

# select only those 10 orthologs from the list, and split the column with names into 3 (Ortholog, Genus, Species)
humann2_KOs_pc2neg <- humann2_KOs_full %>%
  filter(str_detect(Ortholog, humann2_KO_biplot_pc)) %>%
  filter(str_detect(Ortholog, "\\|")) %>%
  gather("SampleID", "CPM", 2:ncol(.)) %>%
  mutate(Ortholog = str_replace_all(Ortholog, "\\.s", "|s")) %>%
  separate(., Ortholog, into = c("Ortholog", "Genus", "Species"), sep = "\\|") %>%
  mutate(Species = replace_na(Species, "unclassified"),
         Genus = str_replace_all(Genus, "g__", ""),
         Species = str_replace_all(Species, "s__", ""))

# calculate the % for each ortholog contributed by each genus         
humann2_KOs_pc2neg_stats <- humann2_KOs_pc2neg %>%
  group_by(Ortholog, Genus) %>%
  summarize(Sum = sum(CPM)) %>%
  mutate(Percent = Sum/sum(Sum)*100) %>%
  ungroup(.)

# create the list of 10 orthologs again, but don't collapse the list as above
humann2_KO_biplot_pc <- humann2_KO_biplot_list %>%
  filter(Direction == "PC2-", Samples == "CMC") %>%
  arrange(Ortholog) %>%
  pull(Ortholog)

# calculate the total % of all genera that contribute < X% to each ortholog
humann2_KOs_pc2neg_stats_extra <- lapply(humann2_KO_biplot_pc, function(eclass) {
 high_percent <- humann2_KOs_pc2neg_stats %>%
   filter(Ortholog == eclass) %>%
   filter(Percent < 5) %>%
   summarise(Remaining = sum(Percent)) %>%
   mutate(Ortholog = eclass,
          Genus = "Other")
}) %>%
 bind_rows(.)

# add this additional % to the main table
humann2_KOs_pcbi_bar_df <- humann2_KOs_pcbi_bar_df %>%
  bind_rows(., humann2_KOs_pc2neg_stats_extra %>%
            rename(Percent = Remaining) %>%
            bind_rows(., humann2_KOs_pc2neg_stats %>%
              select(-Sum) %>% 
              filter(Percent >= 5)) %>%
            select(Ortholog, Genus, Percent) %>%
            mutate(Direction = "PC2-",
                   Samples = "CMC")) %>%
  arrange(Direction, Ortholog)
 
# plot the values in a bar chart
humann2_KOs_pcbi_bar_df %>%
  filter(Samples == "CMC", Direction == "PC2-") %>%
  filter(Percent >= 5 | (Percent <= 5 & Genus == "Other")) %>% # filter out the genera with % < 5, but keep Other < 5
  mutate(Genus = fct_relevel(Genus, "Other","unclassified","Actinomyces","Aggregatibacter","Anaerolineaceae_unclassified","Haemophilus","Lachnospiraceae_unclassified","Selenomonas","Streptococcus","Treponema"),
         Ortholog = fct_relevel(Ortholog, humann2_KO_biplot_list %>%
                              filter(Direction == "PC2-", Samples == "CMC") %>%
                              pull(Ortholog))) %>%
  ggplot(., aes(x=Ortholog, y=Percent, fill = Genus)) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    # scale_fill_manual(values = c("#440154FF","#39558CFF","#1F968BFF","#74D055FF",
    #                              "#07071DFF","#6B1D81FF","#D6456CFF","#FEB37BFF",
    #                              "#453781FF","#287D8EFF","#3CBC75FF","#DCE318FF",
    #                              "#FA815FFF","#FCFDBFFF","#bdbdbd")) +
    theme(text = element_text(size=18),
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    ylab("Percent") +
    ggtitle("Gene Families - CMC only, PC2 negative") +
    theme(title = element_text(size=12))
  
```

Mannose degredation in Selenomonas/Streptococcus






























