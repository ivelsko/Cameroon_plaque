---
title: "Cameroon hunter-gatherer calculus/plaque SEED cumulative decay curves"
author: "Irina Velsko"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output: html_notebook
---

```{r load_libraries, echo = F, message = F}
library(knitr)
library(cuperdec)
library(data.table)
library(janitor)
library(magrittr) ## for pipes!
library(dplyr) # for mutate()!
library(tidyverse)
```

Set the working directory of the notebook to the parent directory of the 
notebook itself.  

```{r setup}
knitr::opts_knit$set(root.dir = normalizePath(".."))
```

Read in the full species and genus tables.
```{r load_data}
# read in the species table
malt_species_raw <- fread("./05-results.backup/MALT_all_data_combined_Comparison_species_names.tsv")

# clean the file names
malt_species_raw <- rename(malt_species_raw, Species = `#Datasets`)
colnames(malt_species_raw) <- gsub(".SG1.unmapped","", colnames(malt_species_raw))
colnames(malt_species_raw) <- gsub(".unmapped","", colnames(malt_species_raw))
colnames(malt_species_raw) <- gsub("-1","", colnames(malt_species_raw))

# remove human and unassigned reads, and remove the sub-sampled HMP and JAE samples
malt_species_raw <- malt_species_raw %>% 
  filter(!str_detect(Species, "Homo sapiens|Not assigned")) %>%
  select(-matches("VLC")) %>%
  # remove extra samples from Clemente study (these might be industrial samples) 
  select(-matches("SRR1646026|SRR1646027|SRR1646028|SRR1646029|SRR1646034|SRR1646035|SRR1646036|SRR1646037"))

```

```{r}

malt_missed_table <- fread("~/archgen/projects1/microbiome_calculus/iberian/05-results.backup/Iberian_samples-controls_comparison_species.txt") %>%
  select(matches("Data|JAE014|JAE015|VLC|SRR061192|SRR061294|SRR061320|SRR061365|SRR061562|SRR062083|SRR062298|SRR062299|SRR063517|SRR1804664|SRR1804823|SRR512767|SRR513165|SRR513768|SRR513775|SRR513828|SRR514202|SRR514239|SRR514306|SRR514329")) %>%
  adorn_totals(where = "col") %>%
  filter(Total > 0) %>%
  select(-Total )%>%
  rename(Species = `#Datasets`) %>%
  filter(!str_detect(Species, "Homo sapiens|Not assigned"))

colnames(malt_missed_table) <- gsub(".unmapped","", colnames(malt_missed_table))

```

```{r}

malt_species <- malt_species_raw %>%
  full_join(., malt_missed_table, by = "Species") %>%
  pivot_longer(!Species, names_to = "SampleID", values_to = "Counts") %>%
  mutate(Counts = replace_na(Counts, 0)) %>%
  arrange(SampleID) %>%
  pivot_wider(names_from = "SampleID", values_from = "Counts") %>%
  adorn_totals(where = "col") %>%
  filter(Total > 0) %>%
  select(-Total ) %>%
  filter(!str_detect(Species, "Homo sapiens|Not assigned"))


```


Load metadata
```{r load_metadata}

metadata <- fread("00-documentation.backup/01-cameroon_hunter_gatherer_metadata.tsv")

#set the columns of interest to factors
metadata <- metadata %>%
  rename(SampleID = `#SampleID`)  %>%
  as_tibble() %>%
  mutate(Env = str_replace_all(Env, "Yanomami","Buccal mucosa"),
         Env = str_replace_all(Env, "HMP","Plaque"),
         Env = str_replace_all(Env, "JAE","Calculus"),
         Env = str_replace_all(Env, "VLC","Calculus")) %>%
  mutate(Env = fct_relevel(Env, "CMC","Plaque","Calculus","Buccal mucosa","Saliva",
                                "ExtractionGauze","ExtractionBlank","LibraryBlank"))

```

Use the example database
```{r set_database}
# load the example database
example_database <- system.file("extdata",
                                "example_database.tsv",
                                package = "cuperdec")

# convert the example database to a tibble
database <- load_database(example_database, target = "oral") # %>% print()

```

```{r taxatable}

taxatable <- load_taxa_table(malt_species) # %>% print()

```

```{r metamap}
metadata_map <- load_map(metadata,
                     sample_col = "SampleID",
                     source_col = "Env") # %>% print()

```

```{r simple_curve}
curves <- calculate_curve(taxatable, database = database) %>%
  print()

plot_cuperdec(curves)

```

```{r metadata_curve}
plot_cuperdec(curves, metadata_map)

```

```{r filter_curve}

filter_result <- simple_filter(curves, percent_threshold = 81) # percent_threshold = 82 starts to color some of the CMC samples red

plot_cuperdec(curves, metadata_map, filter_result)

```

```{r hard_rank_burnin}

rank_burnin_result <- hard_burnin_filter(curves, percent_threshold = 50, rank_burnin = 0.1) # percent_threshold = 50, rank_burnin = 0.4 allows the highest ExtractionBlank line to turn turquoise; percent_threshold = 81, rank_burnin 0.1-0.9 keeps all CMC turquoise and all ExtractionBlank red
# plot_cuperdec(curves, metadata_map, rank_burnin_result)

# restrict the plot to only the 1st 250 taxa
plot_cuperdec(curves, metadata_map, rank_burnin_result, restrict_x = 250)

```

```{r adaptive_rank_burnin}

rank_burnin_result <- adaptive_burnin_filter(curves, percent_threshold = 53) # percent_threshold = 50 allows the highest ExtractionBlank line to turn turquoise; percent_threshold = 60 keeps the highest ExtractionBlank line red but turns one CMC sample line red; percent_threshold = 59 keeps all CMC turquoise and all ExtractionBlanks red; going higher turns more CMC red
cd_curve_plot <- plot_cuperdec(curves, metadata_map, rank_burnin_result, restrict_x = 150)
cd_curve_plot

# ggsave("./06-publication/supplemental_figures/SXX1/SXX1_cuperdec_adaptive_59pct.pdf", plot = cd_curve_plot, device = "pdf",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)
# 
# ggsave("./06-publication/supplemental_figures/SXX1/SXX1_cuperdec_adaptive_59pct.png", plot = cd_curve_plot, device = "png",
#        scale = 1, width = 7, height = 5, units = c("in"), dpi = 300)

```

```{r discard_list}
# this will not have any CMC samples
discard_list <- rank_burnin_result %>% filter(!Passed)
discard_list

```
