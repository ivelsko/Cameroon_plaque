---
title: "Cameroon calculus/plaque MALT differentially abundant taxa by ANCOM-BC"
author: "Irina Velsko"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output:
    github_document:
        fig_width: 8
        fig_height: 6
        toc: true
---

```{r load_libraries, echo = F, message = F}
library(knitr)
library(data.table)
library(tidyverse)
library(gplots)
library(viridis)
library(cowplot)
# source("./02-scripts.backup/ancom_v2.1.R") # source the ancom2 script to be able to use it here
opts_chunk$set(echo=F, warning=F, message=F, dpi=150)
```

Set the working directory of the notebook to the parent directory of the 
notebook itself.  

```{r setup}
knitr::opts_knit$set(root.dir = normalizePath(".."))

```

```{r ancom_script}
source("./02-scripts.backup/ancom_bc.R") # source the ancom2 script to be able to use it here

```


```{r load_data}

# load the taxonomy tables that have been decontaminated and the column headers are cleaned up
load("./05-results.backup/CMC_taxonomy_tables.RData")

```

Read in the tables that have the species that are in MR1, for filtering the results later
```{r mr_species}
# read in the files that have the MR1, MR2, MR3 species/genera
mr_species <- fread("./05-results.backup/minres_oblimin_noyanomami.fa_species.tsv")
mr_cmc_species <- fread("./05-results.backup/minres_oblimin_cmc.fa_species.tsv")

```


List the outliers from the plot in section `raw_plot` in `Cameroon_h-g_taxonomy.Rmd` and remove them from the taxonomy table. 
```{r outliers}
outliers <- c("CMC002.B0201","CMC032.B0101","CMC037.B0201","CMC047.A0201",
              "EXB059.A1901","EXB059.A1301","EXB059.A1101","EXB059.A0901",
              "SRR1646041","SRR1646032","SRR1646042","SRR1646045","SRR1646030","SRR1646047")

outliersF <- str_c(outliers, collapse = "|")

```


```{r input_tables}
# new metadata table without factors, in case that's messing this up (Baka isn't appearing)
metadata <- fread("./00-documentation.backup/01-cameroon_hunter_gatherer_metadata.tsv")
metadata <- metadata %>%
  rename(SampleID = `#SampleID`) %>%
  filter(!SampleID %in% outliers,
         !str_detect(SampleID, "EXB|LIB|10M|SRR164")) %>%
  # rename(Sample.ID = SampleID) %>%
  as_tibble() %>%
  mutate(Market_economy = str_replace(Market_economy, "Forrest camp", "ForrestCamp"),
         Market_economy = str_replace(Market_economy, "Logging road", "LoggingRoad"),
         Market_economy_split = str_replace(Market_economy_split, "Forrest camp", "ForrestCamp"),
         Market_economy_split = str_replace(Market_economy_split, "Logging road", "LoggingRoad"),
         Market_economy_split = str_replace(Market_economy_split, "Industrial calculus", "IndustrialCalculus"),
         Market_economy_split = str_replace(Market_economy_split, "Industrial plaque", "IndustrialPlaque"),
         Industry = str_replace(Industry, "Non-industrial","nonIndustrial")) %>%
  select(SampleID, Env, Industry, Age_group, Env, Ethnic_Group, Market_economy, Market_economy_split, Sex, Tooth_site, Village)

# now re-name it for input to ancom-bc so I have to change fewer names
meta_data <- metadata


# species, no blanks, no Yanomami
malt_species.decontam_filtered_noblanks_noyanomami <- malt_species.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("EXB|LIB|10M|SRR164")) 

# species, CMC samples only
malt_species.decontam_filtered_cmc <- malt_species.decontam %>%
                                         select(-one_of(outliers)) %>%
                                         select(-matches("EXB|LIB|JAE|SRR")) 


```

# ANCOM-BC
```{r ancomBC_test, eval = F}
library(microbiome)

# Load example data
data(dietswap)
pseq = dietswap
n_taxa = ntaxa(pseq)
n_samp = nsamples(pseq)
# Metadata
meta_data = meta(pseq)
# Taxonomy table
taxonomy = tax_table(pseq)
# Absolute abundances
otu_absolute = abundances(pseq)

# 2-group comparison
# Pre-processing
feature.table = otu_absolute; sample.var = "sample"; group.var = "nationality"; 
zero.cut = 0.90; lib.cut = 1000; neg.lb = TRUE
pre.process = feature_table_pre_process(feature.table, meta_data, sample.var, 
                                        group.var, zero.cut, lib.cut, neg.lb)
feature.table = pre.process$feature.table
group.name = pre.process$group.name
group.ind = pre.process$group.ind
struc.zero = pre.process$structure.zeros

# Paras for ANCOM-BC
grp.name = group.name; grp.ind = group.ind; adj.method = "bonferroni"
tol.EM = 1e-5; max.iterNum = 100; perNum = 1000; alpha = 0.05

out = ANCOM_BC(feature.table, grp.name, grp.ind, struc.zero,
               adj.method, tol.EM, max.iterNum, perNum, alpha)
res = cbind(taxon = rownames(out$feature.table), out$res)
# write_csv(res, "demo_two_group.csv")

# Test result
res.ANCOM_BC <- data.frame(phylum=rownames(out$feature.table), out$res, 
                        struc.zero[rownames(out$feature.table), ], 
                        row.names = NULL, stringsAsFactors=FALSE, check.names = FALSE)
alpha.adj=0.05/nrow(res.ANCOM_BC)
critic.val=qnorm(1-alpha.adj/2)
res.ANCOM_BC <- res.ANCOM_BC%>%transmute(phylum,
                                      `log fold change (AAM - AFR)` = -`mean.difference (AFR - AAM)`,
                                      se = `se (AFR - AAM)`,
                                      ci.lo.adj=`log fold change (AAM - AFR)`-critic.val*se, 
                                      ci.up.adj=`log fold change (AAM - AFR)`+critic.val*se, 
                                      p.val, q.val, diff.abn, 
                                      `structural.zero (AAM)`, 
                                      `structural.zero (AFR)`)
res.ANCOM_BC <- res.ANCOM_BC%>%arrange(q.val)
# fwrite(res.ANCOM_BC, "../data/global_gut/<pick a new file name>.tsv", sep = "\t", quote = F)



# multi-group comparison
feature.table = otu_absolute; sample.var = "sample"; group.var = "bmi_group"; 
zero.cut = 0.90; lib.cut = 1000; neg.lb = TRUE
pre.process = feature_table_pre_process(feature.table, meta_data, sample.var, 
                                        group.var, zero.cut, lib.cut, neg.lb)
feature.table = pre.process$feature.table
group.name = pre.process$group.name
group.ind = pre.process$group.ind
struc.zero = pre.process$structure.zeros

# Paras for ANCOM-BC
grp.name = group.name; grp.ind = group.ind; adj.method = "bonferroni"
tol.EM = 1e-5; max.iterNum = 100; perNum = 1000; alpha = 0.05

out = ANCOM_BC(feature.table, grp.name, grp.ind, struc.zero,
               adj.method, tol.EM, max.iterNum, perNum, alpha)
res = cbind(taxon = rownames(out$feature.table), out$res)
# write_csv(res, "demo_multi_group.csv")


```


```{r ancomBC_noblanks_env}

otu_data <- malt_species.decontam_filtered_noblanks_noyanomami
taxonomy = otu_data$Species
otu_data <- otu_data %>%
  column_to_rownames("Species")

# Pre-processing
feature.table = otu_data
sample.var = "SampleID"
group.var = "Env"
zero.cut = 0.90
lib.cut = 1000
neg.lb = TRUE
pre.process = feature_table_pre_process(feature.table, meta_data, sample.var, 
                                        group.var, zero.cut, lib.cut, neg.lb)
feature.table = pre.process$feature.table
group.name = pre.process$group.name
group.ind = pre.process$group.ind
struc.zero = pre.process$structure.zeros

# Paras for ANCOM-BC
grp.name = group.name
grp.ind = group.ind
adj.method = "fdr"
tol.EM = 1e-5
max.iterNum = 100
perNum = 1000
alpha = 0.05

out_noblanks <- ANCOM_BC(feature.table, grp.name, grp.ind, struc.zero,
               adj.method, tol.EM, max.iterNum, perNum, alpha)
res_noblanks <- cbind(taxon = rownames(out_noblanks$feature.table), out_noblanks$res)
# fwrite(res_noblanks, "./05-results.backup/ancomBC_noblanks_ethnic_group.tsv", sep = "\t", quote = F)

# Test result (taken from https://github.com/FrederickHuangLin/ANCOM-BC/blob/master/scripts/figure_6_table_s1_s2_s3.Rmd)
res_noblanks.ANCOM_BC <- data.frame(species=rownames(out_noblanks$feature.table), out_noblanks$res, 
                        struc.zero[rownames(out_noblanks$feature.table), ], 
                        row.names = NULL, stringsAsFactors=FALSE, check.names = FALSE)
alpha.adj=0.05/nrow(res_noblanks.ANCOM_BC)
critic.val=qnorm(1-alpha.adj/2)
res_noblanks.ANCOM_BC <- res_noblanks.ANCOM_BC %>% transmute(species,
                                      `log fold change (HunterGatherer - HMP)` = `mean.difference (HunterGatherer - HMP)`,
                                      se = `se (HunterGatherer - HMP)`,
                                      ci.lo.adj=`log fold change (HunterGatherer - HMP)`-critic.val*se, 
                                      ci.up.adj=`log fold change (HunterGatherer - HMP)`+critic.val*se, 
                                      p.val, q.val, diff.abn, 
                                      `structural.zero (HMP)`, 
                                      `structural.zero (HunterGatherer)`)

# I think in the structural zero columns, 0 indicates False (not a structural 0) and 1 indicates True (is a structural 0)
ancom_bc_noblanks_HMP_HG <- res_noblanks.ANCOM_BC %>%
  rename(Species = species) %>%
  arrange(q.val) %>%
  filter(diff.abn == "TRUE") %>%
  filter(`log fold change (HunterGatherer - HMP)` < -1 | `log fold change (HunterGatherer - HMP)` > 1)

# fwrite(ancom_bc_noblanks_HMP, "../data/global_gut/ancom_bc_noblanks_HMP.tsv", sep = "\t", quote = F) # equivalent to ma_us_phylum_age2.csv in the example below

res.ANCOM_BC <- data.frame(species=rownames(out_noblanks$feature.table), out_noblanks$res, 
                        struc.zero[rownames(out_noblanks$feature.table), ], 
                        row.names = NULL, stringsAsFactors=FALSE, check.names = FALSE)
alpha.adj=0.05/nrow(res.ANCOM_BC)
critic.val=qnorm(1-alpha.adj/2)
res.ANCOM_BC <- res.ANCOM_BC %>% transmute(species,
                                      `log fold change (HunterGatherer - JAE)` = -`mean.difference (JAE - HunterGatherer)`,
                                      se = `se (JAE - HunterGatherer)`,
                                      ci.lo.adj=`log fold change (HunterGatherer - JAE)`-critic.val*se, 
                                      ci.up.adj=`log fold change (HunterGatherer - JAE)`+critic.val*se, 
                                      p.val, q.val, diff.abn, 
                                      `structural.zero (HunterGatherer)`, 
                                      `structural.zero (JAE)`)
ancom_bc_noblanks_JAE_HG <- res.ANCOM_BC %>%
  rename(Species = species) %>%
  arrange(q.val) %>%
  filter(diff.abn == "TRUE")
  # possiblly filter out the species that have a differential abundance of less than |1|
  # filter(`log fold change (HunterGatherer - JAE)` < -1 | `log fold change (HunterGatherer - JAE)` > 1)
  
# fwrite(ancom_bc_noblanks_HMP, "../data/global_gut/ancom_bc_noblanks_JAE.tsv", sep = "\t", quote = F)

```


```{r noblanks_mr_filter_env}

# filter the table to include only the species that are in MR1 (if any)
ancom_bc_noblanks_JAE_HG_mr1 <- ancom_bc_noblanks_JAE_HG %>%
  inner_join(., mr_species %>%
               select(Species), by = "Species") %>%
  filter(`log fold change (HunterGatherer - JAE)` < -2 | `log fold change (HunterGatherer - JAE)` > 2) %>%
  transmute(Species, 
            log_fold_change = `log fold change (HunterGatherer - JAE)`, 
            se = se, 
            ci.lo = ci.lo.adj, 
            ci.up = ci.up.adj, 
            struct.zero = ifelse(se == 0, 1, 0), 
            q.val, 
            Env = "JAE", 
            star = ifelse(q.val<0.001, "***", 
                      ifelse(q.val<0.01, "**",
                         ifelse(q.val<0.05, "*", ""))))

ancom_bc_noblanks_HMP_HG_mr1 <- ancom_bc_noblanks_HMP_HG %>%
  inner_join(., mr_species %>%
               select(Species), by = "Species") %>%
  filter(`log fold change (HunterGatherer - HMP)` < -2 | `log fold change (HunterGatherer - HMP)` > 2) %>%
  transmute(Species, 
            log_fold_change = `log fold change (HunterGatherer - HMP)`, 
            se = se, 
            ci.lo = ci.lo.adj, 
            ci.up = ci.up.adj, 
            struct.zero = ifelse(se == 0, 1, 0), 
            q.val, 
            Env = "HMP", 
            star = ifelse(q.val<0.001, "***", 
                      ifelse(q.val<0.01, "**",
                         ifelse(q.val<0.05, "*", ""))))

# list the species shared between the 2 comparisons
Env_species = unique(c(ancom_bc_noblanks_JAE_HG_mr1$Species, ancom_bc_noblanks_HMP_HG_mr1$Species))

```

Plots showing fold changes
```{r noblanks_plot_env}

ancom_bc_noblanks_env_mr1 <- bind_rows(ancom_bc_noblanks_JAE_HG_mr1, ancom_bc_noblanks_HMP_HG_mr1) %>%
  filter(se != 0) # thes have error bars in both directions as big as each data bar

# plot the fold change as a bar plot (also adapted from (https://github.com/FrederickHuangLin/ANCOM-BC/blob/master/scripts/figure_6_table_s1_s2_s3.Rmd))  
p1 = ggplot(ancom_bc_noblanks_env_mr1, aes(x=Species, y=log_fold_change, ymin=ci.lo, ymax=ci.up, group=Env)) + 
  geom_bar(aes(fill=Env), stat="identity", width=0.4, position=position_dodge())+
  geom_errorbar(width=0.2, size=0.25, position=position_dodge(width = 0.4))+
  geom_abline(slope = 0, intercept = 0, linetype="dashed", alpha=0.5)+
  labs(x=NULL, y="Log Fold Change")+coord_flip()+
  scale_fill_discrete(name=NULL)+
  scale_x_discrete(limits = rev(levels(ancom_bc_noblanks_env_mr1$Species)))+
  theme_bw()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_rect(fill="white"))+
  geom_text(aes(y=log_fold_change+4*sign(log_fold_change), label=star), 
            vjust=.7, color="black", position=position_dodge(width = .5))

p1

p1 = p1+geom_point(data = ancom_bc_noblanks_env_mr1 %>% filter(struct.zero == 1), aes(x=Species, y=log_fold_change),
                   position=position_dodge(width = 0.4), shape=18)

p1


```


For plots (from https://github.com/FrederickHuangLin/ANCOM-BC/blob/master/scripts/figure_6_table_s1_s2_s3.Rmd)
```{r, eval = F}
## 3.1 MA vs US
ma_us_0_2=read_csv("../data/global_gut/ma_us_phylum_age2.csv") # HMP-HG
ma_us_18_40=read_csv("../data/global_gut/ma_us_phylum_age18_40.csv") # JAE-HG
ma_us_phyla=unique(c(ma_us_0_2$phylum, ma_us_18_40$phylum)) # list the species shared between the 2 comparisons
ma_us_0_2=ma_us_0_2%>%transmute(phylum, log.fold.change=`log fold change (MA - US)`, # HMP-HunterGatherer
                                se=se, ci.lo=ci.lo.adj, ci.up=ci.up.adj,
                                struc.zero=ifelse(se==0, 1, 0), 
                                q.val, age.group = "Infants", # Env = "HMP"
                                star=ifelse(q.val<.001, "***", 
                                                ifelse(q.val<.01, "**",
                                                       ifelse(q.val<.05, "*", ""))))
if(length(setdiff(ma_us_phyla, ma_us_0_2$phylum))>0){
  ma_us_0_2.1=data.frame(phylum=setdiff(ma_us_phyla, ma_us_0_2$phylum),
                         log.fold.change=0, se=0, ci.lo=0, ci.up=0, 
                         struc.zero=1, q.val=1, age.group="Infants", star="")
  ma_us_0_2=rbind(ma_us_0_2, ma_us_0_2.1)
}
ma_us_18_40=ma_us_18_40%>%transmute(phylum, log.fold.change=`log fold change (MA - US)`,
                                    se=se, ci.lo=ci.lo.adj, ci.up=ci.up.adj,
                                    struc.zero=ifelse(se==0, 1, 0), 
                                    q.val, age.group = "Adults",
                                    star=ifelse(q.val<.001, "***", 
                                                ifelse(q.val<.01, "**",
                                                       ifelse(q.val<.05, "*", ""))))
if(length(setdiff(ma_us_phyla, ma_us_18_40$phylum))>0){
  ma_us_18_40.1=data.frame(phylum=setdiff(ma_us_phyla, ma_us_18_40$phylum),
                           log.fold.change=0, se=0, ci.lo=0, ci.up=0, 
                           struc.zero=1, q.val=1, age.group="Adults", star="")
  ma_us_18_40=rbind(ma_us_18_40, ma_us_18_40.1)
}
dat.fig_ma_us=rbind(ma_us_0_2, ma_us_18_40)
dat.fig_ma_us$age.group=factor(dat.fig_ma_us$age.group, 
                               levels = c("Infants", "Adults"))
dat.fig_ma_us$phylum=sapply(dat.fig_ma_us$phylum, function(x) strsplit(x, "__")[[1]][2])
dat.fig_ma_us$phylum=factor(dat.fig_ma_us$phylum, levels = sort(unique(dat.fig_ma_us$phylum)))
dat.fig_ma_us$struc.zero=factor(dat.fig_ma_us$struc.zero)




## 3.4 Fig. 6a

dat.fig_ma_us2=cbind(dat.fig_ma_us, type="MA - US")
dat.fig_ven_us2=cbind(dat.fig_ven_us, type="VEN - US")
dat.fig_ma_ven2=cbind(dat.fig_ma_ven, type="MA - VEN")
dat.fig_ma_ven2=dat.fig_ma_ven2[-which(dat.fig_ma_ven2$phylum%in%c("Acidobacteria", "Chloroflexi")), ]
dat.fig_ma_ven2$phylum=factor(dat.fig_ma_ven2$phylum)
dat.fig=rbind(dat.fig_ma_us2, dat.fig_ven_us2, dat.fig_ma_ven2)
dat.fig$type=factor(dat.fig$type, levels = c("MA - US", "VEN - US", "MA - VEN"))

p1=ggplot(dat.fig, aes(x=phylum, y=log.fold.change, ymin=ci.lo, ymax=ci.up, group=age.group)) + 
  geom_bar(aes(fill=age.group), stat="identity", width=0.4, position=position_dodge())+
  geom_errorbar(width=0.2, size=0.25, position=position_dodge(width = 0.4))+
  geom_abline(slope = 0, intercept = 0, linetype="dashed", alpha=0.5)+
  labs(x=NULL, y="Log Fold Change")+coord_flip()+
  scale_fill_discrete(name=NULL)+
  scale_x_discrete(limits = rev(levels(dat.fig$phylum)))+
  facet_grid(.~type, scales = "free_x")+
  theme_bw()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_rect(fill="white"))+
  geom_text(aes(y=log.fold.change+4*sign(log.fold.change), label=star), 
            vjust=.7, color="black", position=position_dodge(width = .5))
p1 = p1+geom_point(data = dat.fig%>%filter(struc.zero==1), aes(x=phylum, y=log.fold.change),
                   position=position_dodge(width = 0.4), shape=18)
ggarrange(p1, labels = "a")



```


# Cameroon samples only
## Market Economy
```{r ancomBC_cmc_mareco}

otu_data <- malt_species.decontam_filtered_cmc
taxonomy = otu_data$Species
otu_data <- otu_data %>%
  column_to_rownames("Species")

# Pre-processing
feature.table = otu_data
sample.var = "SampleID"
group.var = "Market_economy"
zero.cut = 0.90
lib.cut = 1000
neg.lb = TRUE
pre.process = feature_table_pre_process(feature.table, meta_data, sample.var, 
                                        group.var, zero.cut, lib.cut, neg.lb)
feature.table = pre.process$feature.table
group.name = pre.process$group.name
group.ind = pre.process$group.ind
struc.zero = pre.process$structure.zeros

# Paras for ANCOM-BC
grp.name = group.name
grp.ind = group.ind
adj.method = "fdr"
tol.EM = 1e-5
max.iterNum = 100
perNum = 1000
alpha = 0.05

out_cmc <- ANCOM_BC(feature.table, grp.name, grp.ind, struc.zero,
               adj.method, tol.EM, max.iterNum, perNum, alpha)
res_cmc <- cbind(taxon = rownames(out_cmc$feature.table), out_cmc$res)

# fwrite(res_cmc, "./05-results.backup/ancomBC_cmc_ethnic_group.tsv", sep = "\t", quote = F)

# Test result (taken from https://github.com/FrederickHuangLin/ANCOM-BC/blob/master/scripts/figure_6_table_s1_s2_s3.Rmd)
res.ANCOM_BC <- data.frame(species=rownames(out_cmc$feature.table), out_cmc$res, 
                        struc.zero[rownames(out_cmc$feature.table), ], 
                        row.names = NULL, stringsAsFactors=FALSE, check.names = FALSE)
alpha.adj=0.05/nrow(res.ANCOM_BC)
critic.val=qnorm(1-alpha.adj/2)
res.ANCOM_BC <- res.ANCOM_BC %>% transmute(species,
                                      `log fold change (Farming - ForrestCamp)` = -`mean.difference (ForrestCamp - Farming)`,
                                      se = `se (ForrestCamp - Farming)`,
                                      ci.lo.adj=`log fold change (Farming - ForrestCamp)`-critic.val*se, 
                                      ci.up.adj=`log fold change (Farming - ForrestCamp)`+critic.val*se, 
                                      p.val, q.val, diff.abn, 
                                      `structural.zero (Farming)`, 
                                      `structural.zero (ForrestCamp)`)

# I think in the structural zero columns, 0 indicates False (not a structural 0) and 1 indicates True (is a structural 0)
ancom_bc_cmc_Fa_FC <- res.ANCOM_BC %>%
  rename(Species = species) %>%
  arrange(q.val) %>%
  filter(diff.abn == "TRUE")
  # filter(`log fold change (Farming - ForrestCamp)` < -1 | `log fold change (Farming - ForrestCamp)` > 1)

# fwrite(ancom_bc_noblanks_HMP, "../data/global_gut/ancom_bc_noblanks_HMP.tsv", sep = "\t", quote = F)

```


```{r cmc_mr_filter_mareco}

# filter the table to include only the species that are in MR1 (if any)
ancom_bc_cmc_Fa_FC_mr1 <- ancom_bc_cmc_Fa_FC %>%
  inner_join(., mr_cmc_species %>%
               select(Species), by = "Species") %>%
  filter(`log fold change (Farming - ForrestCamp)` < -2 | `log fold change (Farming - ForrestCamp)` > 2)

# filter the table to include only the species that are in MR1 (if any)
ancom_bc_cmc_Fa_FC_mr1 <- ancom_bc_cmc_Fa_FC %>%
  inner_join(., mr_species %>%
               select(Species), by = "Species") %>%
  filter(`log fold change (Farming - ForrestCamp)` < -2 | `log fold change (Farming - ForrestCamp)` > 2) %>%
  transmute(Species, 
            log_fold_change = `log fold change (Farming - ForrestCamp)`, 
            se = se, 
            ci.lo = ci.lo.adj, 
            ci.up = ci.up.adj, 
            struct.zero = ifelse(se == 0, 1, 0), 
            q.val, 
            Env = "JAE", 
            star = ifelse(q.val<0.001, "***", 
                      ifelse(q.val<0.01, "**",
                         ifelse(q.val<0.05, "*", ""))))

# ancom_bc_noblanks_HMP_HG_mr1 <- ancom_bc_noblanks_HMP_HG %>%
#   inner_join(., mr_species %>%
#                select(Species), by = "Species") %>%
#   filter(`log fold change (HunterGatherer - HMP)` < -2 | `log fold change (HunterGatherer - HMP)` > 2) %>%
#   transmute(Species, 
#             log_fold_change = `log fold change (HunterGatherer - HMP)`, 
#             se = se, 
#             ci.lo = ci.lo.adj, 
#             ci.up = ci.up.adj, 
#             struct.zero = ifelse(se == 0, 1, 0), 
#             q.val, 
#             Env = "HMP", 
#             star = ifelse(q.val<0.001, "***", 
#                       ifelse(q.val<0.01, "**",
#                          ifelse(q.val<0.05, "*", ""))))

# list the species shared between the 2 comparisons
Env_species = unique(c(ancom_bc_cmc_Fa_FC_mr1$Species, XXXXX$Species))

```

Plots showing fold changes
```{r noblanks_plot_env}

ancom_bc_cmc_mareco_mr1 <- bind_rows(ancom_bc_cmc_Fa_FC_mr1, ancom_bc_noblanks_HMP_HG_mr1) %>%
  filter(se != 0) # thes have error bars in both directions as big as each data bar

# plot the fold change as a bar plot (also adapted from (https://github.com/FrederickHuangLin/ANCOM-BC/blob/master/scripts/figure_6_table_s1_s2_s3.Rmd))  
p1 = ggplot(ancom_bc_cmc_mareco_mr1, aes(x=Species, y=log_fold_change, ymin=ci.lo, ymax=ci.up, group=Market_economy)) + 
  geom_bar(aes(fill=Market_economy), stat="identity", width=0.4, position=position_dodge())+
  geom_errorbar(width=0.2, size=0.25, position=position_dodge(width = 0.4))+
  geom_abline(slope = 0, intercept = 0, linetype="dashed", alpha=0.5)+
  labs(x=NULL, y="Log Fold Change")+coord_flip()+
  scale_fill_discrete(name=NULL)+
  scale_x_discrete(limits = rev(levels(ancom_bc_cmc_mareco_mr1$Species)))+
  theme_bw()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_rect(fill="white"))+
  geom_text(aes(y=log_fold_change+4*sign(log_fold_change), label=star), 
            vjust=.7, color="black", position=position_dodge(width = .5))

p1

p1 = p1+geom_point(data = ancom_bc_cmc_mareco_mr1 %>% filter(struct.zero == 1), aes(x=Species, y=log_fold_change),
                   position=position_dodge(width = 0.4), shape=18)

p1


```

## Tooth Site


## Sex


## Village
































